<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>

    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
    .linhas-topo{display:flex;gap:16px;margin-bottom:16px}
    .col-50{flex:1;min-width:0}
    button{
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      text-transform:uppercase;
      font-size:11px;
      line-height:1;
      height:30px;
      min-width:110px;
    }
    .btn-primario{background:#22c55e;color:#022c22}
    .btn-secundario{background:#0ea5e9;color:#0f172a}
    .btn-perigo{background:#ef4444;color:#f9fafb}
    .btn-neutro{background:#f97316;color:#0f172a}
    .btn-chegou{background:#10b981;color:#022c22;min-width:120px}
    .btn-sair{background:#f97316;color:#0f172a;min-width:70px;height:34px;border-radius:6px;font-size:11px}
    .btn-nao-joga{background:#64748b;color:#e5e7eb;min-width:140px}
    .btn-excluir{background:#ef4444;color:#f9fafb;min-width:90px}
    /* Ajustes de escalação: manter 1º e 2º tempo com mesmo tamanho e evitar colunas estouradas */
    .grid-escalacao table{table-layout:fixed;}
    .grid-escalacao th,.grid-escalacao td{overflow:hidden;text-overflow:ellipsis;}
    .btn-saiu{min-width:56px !important;height:24px !important;font-size:10px !important;padding:0 8px !important;line-height:1 !important;}

    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
    th{background:#111827;color:#f97316;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .status-info{font-size:12px;margin-top:6px;color:#cbd5e1}
    .painel-scroll{overflow-y:auto;max-height:320px}
    .riscado{text-decoration:line-through;opacity:.55}
    .obs-pago{color:#22c55e;font-weight:bold}
    .obs-inad{color:#ef4444;font-weight:bold}
    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
@media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
    .col-escalacao{flex:1;min-width:0}
    .totais{font-weight:bold;text-align:right;margin-top:6px;font-size:12px;color:#cbd5e1}
    .msg-salvar{font-size:13px;font-weight:bold;color:#22c55e;margin:6px 0 0;text-align:right;min-height:18px}
    .legenda{font-size:11px;margin-top:10px;color:#cbd5e1}
    .t-amarelo{color:#facc15;font-weight:bold}
    .t-azul{color:#38bdf8;font-weight:bold}
    @media print{
      body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
      header,.no-print{display:none !important}
      .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
      table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
      th{background:#eee;color:#000}
      tr:nth-child(even),tr:nth-child(odd){background:#fff}
      .t-amarelo,.t-azul,.obs-pago,.obs-inad{color:#000 !important}
      .riscado{opacity:1}
      .page-break{page-break-before:always}
    
/* PRINT_SEPARADO_R5 */
/* Não imprimir lista de jogadores */
.linhas-topo .col-50:first-child{display:none !important;}
.linhas-topo{display:block !important;}
.linhas-topo .col-50{width:100% !important; display:block !important;}
/* Presença ocupa a página(s) inicial(is) */
.painel-presenca{page-break-inside: avoid;}
/* Escalação em página separada */
.grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
@media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
.grid-escalacao table{page-break-inside: avoid;}
/* Remover sombras/efeitos para imprimir limpo */
*{box-shadow:none !important; text-shadow:none !important;}
body{background:#fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
}
  
    /* === AJUSTES PADRÃO (compacto) === */
    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
    .painel-scroll{overflow-y:auto;max-height:320px}
    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th, td { padding: 2px 3px; }
    button{
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      text-transform:uppercase;
      font-size:11px;
      line-height:1;
      height:30px;
      min-width:110px;
    }
    .btn-chegou { width:120px; }
    .btn-nao-joga { width:140px; }
    .btn-excluir { width:90px; }
    .btn-sair { width:70px; }

    /* ESCALAÇÃO: 1º e 2º tempo com MESMO tamanho */
    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
@media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
    .col-escalacao { display: flex; flex-direction: column; }
    .col-escalacao table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}

    /* TÍTULOS AMARELO/AZUL SEM FUNDO */
    th { background: #f97316; color: #0f172a; } /* padrão do projeto */
    .grid-escalacao th { background: transparent; }
    /* cabeçalhos específicos da escalação */
    .th-amarelo { color: #facc15 !important; font-weight: 900; }
    .th-azul { color: #38bdf8 !important; font-weight: 900; }

    /* === IMPRESSÃO / PDF (não quebrar um painel em 2 folhas) === */
    @media print {
      body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
      header { color: #000000 !important; background: #ffffff !important; }
      .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
      .linhas-topo { page-break-after: always; break-after: page; }
      button, .btn-primario, .btn-secundario, .btn-perigo, .btn-neutro { display: none !important; }
      .painel-scroll{overflow-y:auto;max-height:320px}
      th, td { border: 1px solid #444 !important; }
    }

  
/* R2 - Ajustes de layout (padrão do projeto) */
table th, table td { padding: 6px 8px !important; font-size: 12px !important; }
button{
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      text-transform:uppercase;
      font-size:11px;
      line-height:1;
      height:30px;
      min-width:110px;
    }
#listaJogadores, #listaPresentes { max-height: 320px !important; overflow: auto !important; }
#painelEscalacao .col { flex: 1 1 0 !important; }
#painelEscalacao .col table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
#painelEscalacao .col { min-height: 420px !important; }
#painelEscalacao .col .tblwrap { max-height: 360px !important; overflow: auto !important; }

/* Impressão: 1 página (evitar quebrar o painel no meio) */
@media print {
  body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
  .container, .card, #painelEscalacao { page-break-inside: avoid; break-inside: avoid; }
  .btn, button{
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      text-transform:uppercase;
      font-size:11px;
      line-height:1;
      height:30px;
      min-width:110px;
    }
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}

/* === R3: layout compacto (linhas e botões menores) === */
header{padding:10px 14px}
.container{padding:12px;max-width:1400px}
.painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
.status-info{font-size:11px}
label{font-size:10px}
button{
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      text-transform:uppercase;
      font-size:11px;
      line-height:1;
      height:30px;
      min-width:110px;
    }
table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
.painel-scroll{overflow-y:auto;max-height:320px}
.btn-chegou{width:120px}
.btn-nao-joga{width:140px}
.btn-excluir{width:90px}
.btn-sair{width:70px}


/* LAYOUT_ALTURA_R5 */
.grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
@media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
.col-escalacao{display:flex; flex-direction:column;}
.col-escalacao table{flex:1; width:100%;}
/* Padroniza altura de linha nas tabelas da escalação */
.grid-escalacao table td, .grid-escalacao table th{padding-top:6px; padding-bottom:6px; line-height:1.1;}

  .subinfo{margin-top:6px;font-size:13px;color:#cfd9ff;opacity:.95}
  .cutinfo{margin-left:12px;font-size:13px;color:#cfd9ff;opacity:.95}
  .legend-inline{margin-top:10px;font-size:12px;color:#cfd9ff;opacity:.95;line-height:1.3}


.bloco-regras{margin-top:14px;background:rgba(0,0,0,0.15);border:1px solid rgba(255,127,39,0.35);border-radius:12px;padding:12px}
.bloco-regras .col-regras h3{margin:0 0 8px 0;color:#ffb35a;font-size:14px}
.bloco-regras .col-regras ul{margin:0 0 8px 18px;padding:0;font-size:12px;line-height:1.35}
.bloco-regras{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.bloco-regras .obs-legenda{grid-column:1 / -1;font-size:12px;margin-top:2px}
.pago-ok{color:#22c55e;font-weight:bold}
.pago-bad{color:#ef4444;font-weight:bold}
@media (max-width: 980px){.bloco-regras{grid-template-columns:1fr}}
.painel-1t, .painel-2t{min-width:0}


  </style>
</head>
<body>
  <header>TESOURA - PRESENÇA / ESCALAÇÃO</header>

  <div class="no-print" style="text-align:right; padding:6px 16px 0 16px;">
  </div>

  <div class="container">

    <div class="linhas-topo">
      <div class="col-50">
        <div class="painel">
          <h2>Jogadores (todos)</h2>
          <div class="status-info">Clique em <b>CHEGOU AGORA</b> quando o jogador chegar.</div>
          <div id="status-jogadores" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th>APELIDO</th>
                  <th style="width:170px">CHEGOU AGORA</th>
                </tr>
              </thead>
              <tbody id="tbody-jogadores-todos"></tbody>
            </table>
          </div>

          <div id="status-total-jogadores" class="status-info"></div>
        </div>
      </div>

      <div class="col-50">
        <div class="painel">
          <h2>Presença hoje</h2>

          <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
            <div id="info-presentes" class="status-info"></div>
            <div id="info-data-jogo" class="status-info"></div>
          </div>

          <div class="no-print" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btn-limpar-presentes" class="btn-perigo">Limpar hoje</button>
<button id="btn-escalar-1t" class="btn-primario">Escalar 1º tempo</button>
<button id="btn-desfazer-1t" class="btn-neutro">Desfazer 1º tempo</button>
<button id="btn-baixar-presenca" class="btn-neutro">Baixar presença</button>
<span style="margin-left:10px;color:#cbd5e1;font-size:12px;">Horário de corte: 06:15</span>
            
          </div>

          <div id="status-presentes" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th style="width:70px">ORDEM</th>
                  <th>APELIDO</th>
                  <th style="width:110px">HORA</th>
                  <th style="width:110px">OBS</th>
                  <th style="width:170px">NÃO VAI JOGAR</th>
                  <th style="width:120px">EXCLUIR</th>
                </tr>
              </thead>
              <tbody id="tbody-presentes-hoje"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="painel">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h2 style="margin:0;">Escalação do jogo</h2>
        <div class="no-print" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div id="msg-salvar" class="msg-salvar"></div>
          <button id="btn-escalar-2t" class="btn-primario">Escalar 2º tempo</button>
          <button id="btn-desfazer-2t" class="btn-neutro">Desfazer 2º tempo</button>
          <button id="btn-baixar-1t" class="btn-neutro">Baixar 1º tempo</button>
          <button id="btn-baixar-2t" class="btn-neutro">Baixar 2º tempo</button>
          <button id="btn-salvar-jogo" class="btn-neutro">Salvar</button>
        </div>
      </div>

      <div class="grid-escalacao">
        <div class="col-escalacao">
          <div style="display:flex; justify-content:space-between; align-items:center;">
           <div class="t-amarelo" style="font-size:13px">1º TEMPO — JOGO DAS 06:40 ÀS 07:40</div> 
            <div class="status-info">Botão <b>SAIU</b> risca o nome.</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:70px">ID</th>
                <th style="width:60px">POS</th>
                <th class="t-amarelo">AMARELO</th>
                <th style="width:60px">SAIU</th>
                <th class="t-azul">AZUL</th>
                <th style="width:60px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-1t"></tbody>
          </table>
          <div class="totais" id="totais-1t">TOTAL PONTOS: 0 x 0</div>
</div>

        <div class="col-escalacao">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="t-amarelo" style="font-size:13px">2º TEMPO — JOGO DAS 08:00 ÀS 09:00</div>
             <div class="status-info">Prioridade: quem não jogou.</div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:70px">ID</th>
                <th style="width:60px">POS</th>
                <th class="t-amarelo">AMARELO</th>
                <th class="t-azul">AZUL</th>
              </tr>
            </thead>
            <tbody id="tbody-2t"></tbody>
          </table>
          <div class="totais" id="totais-2t">TOTAL PONTOS: 0 x 0</div>
        </div>
      </div>

      <div class="legenda">
        <b>OBS:</b>
C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) |
<span class="obs-pago">P (verde) pagou</span> |
<span class="obs-inad">P (vermelho) não pagou</span>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
// ===== SUPABASE =====
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    var supabase = window.__TESOURA_SUPABASE__;
    // ===== ESTADO =====
    let dataJogoIso = null;
    let todosJogadores = [];  // {id, apelido, pontos, inadimplente}
    let mapaJogadores = {};   // apelido -> jogador

    // presentesHoje: {id, apelido, horaChegada, naoVaiJogar, escalou1, escalou2, saiu, obs, pontos}
    let presentesHoje = [];

    // escalações: cada item {id, apelido}
    let escala1 = { amarelo: [], azul: [] };
    let escala2 = { amarelo: [], azul: [] };

    // ===== DOM =====
    const statusJogadoresEl = document.getElementById("status-jogadores");
    const statusBaseEl = statusJogadoresEl;
    const statusTotalJogadoresEl = document.getElementById("status-total-jogadores");
    const tbodyJogadoresTodos = document.getElementById("tbody-jogadores-todos");

    const infoDataJogoEl = document.getElementById("info-data-jogo");
    const infoPresentesEl = document.getElementById("info-presentes");
    const statusPresentesEl = document.getElementById("status-presentes");
    const tbodyPresentesHoje = document.getElementById("tbody-presentes-hoje");

    const btnLimparPresentes = document.getElementById("btn-limpar-presentes");
    const btnEscalar1T = document.getElementById("btn-escalar-1t");
    const btnEscalar2T = document.getElementById("btn-escalar-2t");
    const btnSalvarJogo = document.getElementById("btn-salvar-jogo");

    const btnDesfazer1T = document.getElementById("btn-desfazer-1t");
    const btnDesfazer2T = document.getElementById("btn-desfazer-2t");
    const btnBaixarPresenca = document.getElementById("btn-baixar-presenca");
    const btnBaixar1T = document.getElementById("btn-baixar-1t");
    const btnBaixar2T = document.getElementById("btn-baixar-2t");

    const tbody1T = document.getElementById("tbody-1t");
    const tbody2T = document.getElementById("tbody-2t");
    const totais1TEl = document.getElementById("totais-1t");
    const totais2TEl = document.getElementById("totais-2t");
    const msgSalvarEl = document.getElementById("msg-salvar");

function toast(msg, ok=false){
  try{
    if (msgSalvarEl) {
      msgSalvarEl.textContent = msg;
      msgSalvarEl.style.color = ok ? "#22c55e" : "#ff4d4d";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ msgSalvarEl.textContent = ""; }, 4000);
    }
  } catch(e) {}
  console.log(msg);
}


    // ===== DATA/HORA =====
    function hojeIso() {
      const d = new Date();
      const ano = d.getFullYear();
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const dia = String(d.getDate()).padStart(2, "0");
      return `${ano}-${mes}-${dia}`;
    }

function getDataJogoISO() {
  return dataJogoIso || hojeIso();
}

    function formatHora(d) {
      return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false });
    }
    function comparaHoraStr(a,b){ return (a||"").localeCompare(b||""); }

    function atualizarInfoPresentes(){
      infoPresentesEl.textContent = `Presentes hoje: ${presentesHoje.length}`;
    }

    // ===== REGRA PAGAMENTO =====
    // - Até 1 dia depois do 2º domingo do mês: TODO MUNDO É P VERDE (ninguém é inadimplente).
    // - Depois disso: P vermelho só para quem estiver atrasado (mês atual em aberto) OU meses anteriores em aberto.
    function segundoDomingo(ano, mes){ // mes 1-12
      const d = new Date(ano, mes-1, 1);
      let domingos = 0;
      while (true){
        if (d.getDay() === 0) { // domingo
          domingos++;
          if (domingos === 2) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        }
        d.setDate(d.getDate()+1);
      }
    }
    function addDias(dt, n){
      const d = new Date(dt.getTime());
      d.setDate(d.getDate()+n);
      return d;
    }
    function ymd(dt){
      const y=dt.getFullYear();
      const m=String(dt.getMonth()+1).padStart(2,"0");
      const d=String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function isoToBr(iso){
      if(!iso || typeof iso !== "string") return "";
      const parts = iso.split("-");
      if(parts.length !== 3) return iso;
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    // mensMap: { "YYYY-MM": {apelido: {pago, status, data_pagamento}} }
    let mensPorApelido = {}; // apelido -> array de {ano,mes,pago,status,data_pagamento}

    function isPagoHoje(apelido){
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = hoje.getMonth()+1;

      const venc = segundoDomingo(ano, mes);
      const viraVermelho = addDias(venc, 1); // segunda-feira após 2º domingo (venc+1)

      // antes da virada: todo mundo verde
      if (hoje < viraVermelho) return true;

      const regs = mensPorApelido[apelido] || [];

      // 1) se tem mês anterior em aberto => vermelho (já virou o mês seguinte)
      for (const r of regs){
        const key = r.ano*100 + r.mes;
        const keyAtual = ano*100 + mes;
        if (key < keyAtual){
          if (!r.pago) return false;
        }
      }

      // 2) mês atual: se existe pago true => verde; se existe pago false => vermelho; se não existe => vermelho (após virada)
      const regAtual = regs.find(r => r.ano===ano && r.mes===mes);
      if (regAtual) return !!regAtual.pago;
      return false;
    }

    // ===== LOAD BASE =====
        async function carregarBase(){
      statusBaseEl.textContent = "Carregando base...";
      try{
        // 1) Jogadores: no banco o campo ATIVO pode ser "SIM" (texto) ou boolean.
        const { data: jogadoresRaw, error: errJ } = await supabase
          .from("jogadores")
          .select("id, apelido, posicao, hab, vel, mov, pontos, ativo")
          .order("apelido", { ascending: true });

        if(errJ) throw errJ;

        const jogadoresAtivos = (jogadoresRaw || []).filter(j => {
          const a = j.ativo;
          return (a === true) || (a === 1) || (a === "SIM") || (a === "sim") || (a === "S") || (a === "s");
        });

        todosJogadores = jogadoresAtivos.map(j => {
          const apelido = (j.apelido || "").trim();
          const hab = (j.hab == null || j.hab === "") ? null : Number(j.hab);
          const vel = (j.vel == null || j.vel === "") ? null : Number(j.vel);
          const mov = (j.mov == null || j.mov === "") ? null : Number(j.mov);
          const pontosCalc = (hab || 0) + (vel || 0) + (mov || 0);
          const pontosDB = (j.pontos == null || j.pontos === "" || Number.isNaN(Number(j.pontos))) ? null : Number(j.pontos);
          const pontos = (pontosDB != null && pontosDB > 0) ? pontosDB : pontosCalc;

          return {
            id: j.id,
            apelido,
            posicao: (j.posicao || "").trim(),
            hab, vel, mov,
            pontos
          };
        });

        // monta mapa por APELIDO (chave normalizada) para cálculo de pontos
        mapaJogadores = {};
        todosJogadores.forEach(j => {
          const k = keyApelido(j.apelido);
          if(k) mapaJogadores[k] = j;
        });


        // 2) Mensalidade (para regra de inadimplente) - SEM coluna status.
        //    Se não existir mensalidade do mês/ano e já passou do prazo, considera inadimplente.
        mensalidadesMap = {};
        try{
          const d = new Date(dia);
          const ano = d.getFullYear();
          const mes = d.getMonth() + 1;

          const { data: mens, error: errM } = await supabase
            .from("mensalidades")
            .select("apelido, ano, mes, pago, data_pagamento")
            .eq("ano", ano).eq("mes", mes);

          if(errM) throw errM;

          (mens || []).forEach(r=>{
            const ap = (r.apelido || "").trim();
            mensalidadesMap[ap] = !!(r.pago || r.data_pagamento);
          });
        }catch(e){
          console.warn("Aviso: não consegui ler mensalidades (seguindo sem inadimplência).", e);
          mensalidadesMap = {};
        }

        // 3) Faltas (histórico): usa presencas.obs = "F" (sem coluna status).
        faltasMap = {};
        try{
          const d = new Date(dia);
          const ano = d.getFullYear();

          const { data: faltas, error: errF } = await supabase
            .from("presencas")
            .select("apelido, obs, data_jogo")
            .gte("data_jogo", `${ano}-01-01`)
            .lte("data_jogo", `${ano}-12-31`);

          if(errF) throw errF;

          (faltas || []).forEach(r=>{
            const ap = (r.apelido || "").trim();
            const obs = (r.obs || "").trim();
            if(obs === "F"){
              faltasMap[ap] = (faltasMap[ap] || 0) + 1;
            }
          });
        }catch(e){
          console.warn("Aviso: não consegui calcular faltas (seguindo com 0).", e);
          faltasMap = {};
        }

        // Render: jogadores e presença do dia
        renderJogadoresTodos();

        await carregarPresencaHoje();

        statusBaseEl.textContent = "Base carregada.";
      }catch(err){
        console.error(err);
        statusBaseEl.textContent = "ERRO ao carregar base. Ver F12 > Console.";
        alert("Erro ao carregar base (ver Console).");
      }
    }

    
    // ===== CARREGAR PRESENÇA DO DIA (para estabilidade) =====
    async function carregarPresencaHoje(){
      const dia = getDataJogoISO();
      dataJogoIso = dia; // habilita SALVAR

      statusPresentesEl.textContent = "Carregando presença...";
      try{
        const { data: rows, error } = await supabase
          .from("presencas")
          .select("apelido, presenca")
          .eq("data_jogo", dia);

        if(error) throw error;

        const setPresentes = new Set(
          (rows || [])
            .filter(r => r && (r.presenca === true || r.presenca === 1))
            .map(r => String(r.apelido || "").trim())
        );

        presentesHoje = (todosJogadores || [])
          .filter(j => setPresentes.has(j.apelido))
          .map(j => ({
            id: j.id,
            apelido: j.apelido,
            horaChegada: "",
            naoVaiJogar: false,
            escalou1: false,
            escalou2: false,
            saiu: false,
            obs: "",
            pontos: Number(j.pontos || 0),
          }));

        atualizarInfoPresentes();
        renderPresentes();
        syncEscalacoesComPresenca();
        renderEscalacoes();

        statusPresentesEl.textContent = "Presença carregada.";
      }catch(err){
        console.error(err);
        statusPresentesEl.textContent = "Erro ao carregar presença (ver Console).";
        // não derruba a base toda
      }
    }

function renderJogadoresTodos(){
      tbodyJogadoresTodos.innerHTML = "";
      todosJogadores.forEach(j=>{
        const tr=document.createElement("tr");

        const tdId=document.createElement("td");
        tdId.textContent = j.id ?? "";
        tr.appendChild(tdId);

        const tdAp=document.createElement("td");
        tdAp.textContent = (j.apelido||"").toUpperCase();
        tr.appendChild(tdAp);

        const tdBtn=document.createElement("td");
        const bt=document.createElement("button");
        bt.textContent="CHEGOU AGORA";
        bt.className="btn-chegou";
        bt.onclick=()=>marcarChegada(j);
        tdBtn.appendChild(bt);
        tr.appendChild(tdBtn);

        tbodyJogadoresTodos.appendChild(tr);
      });
    }

    function marcarChegada(j){
      const apelido = j?.apelido;
      if(!apelido) return;

      if(presentesHoje.find(p=>p.apelido===apelido)){
        alert("Este jogador já está na lista de presença hoje.");
        return;
      }

      const agora=new Date();
      const registro = {
        id: j.id,
        apelido,
        horaChegada: formatHora(agora),
        naoVaiJogar: false,
        escalou1: false,
        escalou2: false,
        saiu: false, // saiu do 1º tempo
        obs: "",
        pontos: j.pontos ?? 0
      };
      presentesHoje.push(registro);
      presentesHoje.sort((a,b)=>comparaHoraStr(a.horaChegada,b.horaChegada));

      // NÃO pode apagar a escalação quando chega mais gente.
      syncEscalacoesComPresenca();
      atualizarInfoPresentes();
      renderPresentes();
      renderEscalacoes();
    }

    function toggleNaoVaiJogar(apelido){
      const p=presentesHoje.find(x=>x.apelido===apelido);
      if(!p) return;

      p.naoVaiJogar=!p.naoVaiJogar;

      // Se marcou "não vai jogar", remove da escalação (mas NÃO mexe na lista de presença).
      if(p.naoVaiJogar){
        removerApelidoDasEscalacoes(apelido);
        p.saiu=false;
      }

      syncEscalacoesComPresenca();
      renderPresentes();
      renderEscalacoes();
    }

    function excluirPresente(apelido){
      // remove da lista de presença
      presentesHoje = presentesHoje.filter(p=>p.apelido!==apelido);

      // remove também da escalação (se estava)
      removerApelidoDasEscalacoes(apelido);

      atualizarInfoPresentes();
      syncEscalacoesComPresenca();
      renderPresentes();
      renderEscalacoes();
    }

    // ===== SINCRONIZAÇÃO (NÃO DESFAZER RISCOS AO CHEGAR NOVO JOGADOR) =====
    function removerApelidoDasEscalacoes(apelido){
      const filt = (arr)=> (arr||[]).filter(e=>e && e.apelido !== apelido);
      escala1.amarelo = filt(escala1.amarelo);
      escala1.azul   = filt(escala1.azul);
      escala2.amarelo = filt(escala2.amarelo);
      escala2.azul   = filt(escala2.azul);
    }

    function syncEscalacoesComPresenca(){
      // Mantém escalação, mas remove:
      // - quem não está mais presente hoje
      // - quem está marcado como "não vai jogar"
      const presentesSet = new Set((presentesHoje||[]).map(p=>p.apelido));
      const naoSet = new Set((presentesHoje||[]).filter(p=>p.naoVaiJogar).map(p=>p.apelido));

      const keep = (arr)=> (arr||[]).filter(e => e && presentesSet.has(e.apelido) && !naoSet.has(e.apelido));

      escala1.amarelo = keep(escala1.amarelo);
      escala1.azul    = keep(escala1.azul);
      escala2.amarelo = keep(escala2.amarelo);
      escala2.azul    = keep(escala2.azul);

      atualizarObs(); // recalcula riscos/OBS com base na escalação atual
    }

    function renderPresentes(){
      tbodyPresentesHoje.innerHTML="";
      presentesHoje.forEach((p,idx)=>{
        const tr=document.createElement("tr");

        const tdId=document.createElement("td");
        tdId.textContent = p.id ?? "";
        tr.appendChild(tdId);

        const tdOrd=document.createElement("td");
        tdOrd.textContent=idx+1;
        tr.appendChild(tdOrd);

        const tdAp=document.createElement("td");
        tdAp.textContent=p.apelido.toUpperCase();
        // risco visual no painel presença:
        // - NÃO VAI JOGAR
        // - escalou 1º
        // - escalou 2º
        if(p.naoVaiJogar || p.escalou1 || p.escalou2){
          tdAp.classList.add("riscado");
        }
        tr.appendChild(tdAp);

        const tdHora=document.createElement("td");
        tdHora.textContent=p.horaChegada;
        tr.appendChild(tdHora);

        const tdObs=document.createElement("td");
        // OBS: base (C/1/2/1-2) + pagamento (P verde/vermelho)
        const base = (p.obs||"").split("-")[0] || "";
        const pago = isPagoHoje(p.apelido);
        const spanBase=document.createElement("span");
        spanBase.textContent = base ? (base+"-") : "";
        tdObs.appendChild(spanBase);

        const spanP=document.createElement("span");
        spanP.textContent="P";
        spanP.className = pago ? "obs-pago" : "obs-inad";
        tdObs.appendChild(spanP);

        tr.appendChild(tdObs);

        const tdNao=document.createElement("td");
        const btNao=document.createElement("button");
        btNao.textContent = p.naoVaiJogar ? "VAI JOGAR" : "NÃO VAI JOGAR";
        btNao.className="btn-nao-joga";
        btNao.onclick=()=>toggleNaoVaiJogar(p.apelido);
        tdNao.appendChild(btNao);
        tr.appendChild(tdNao);

        const tdExc=document.createElement("td");
        const btExc=document.createElement("button");
        btExc.textContent="EXCLUIR";
        btExc.className="btn-excluir";
        btExc.onclick=()=>excluirPresente(p.apelido);
        tdExc.appendChild(btExc);
        tr.appendChild(tdExc);

        tbodyPresentesHoje.appendChild(tr);
      });

      statusPresentesEl.textContent = presentesHoje.length ? "Lista carregada." : "Nenhum jogador cadastrado hoje.";
    }

    function limparEscalacoes(){
      escala1={amarelo:[],azul:[]};
      escala2={amarelo:[],azul:[]};
      presentesHoje.forEach(p=>{
        p.escalou1=false;
        p.escalou2=false;
        p.saiu=false;
        p.obs="";
      });
      atualizarObs();
    }

    function atualizarObs(){
      const set1 = new Set([...escala1.amarelo, ...escala1.azul].map(e=>e.apelido));
      const set2 = new Set([...escala2.amarelo, ...escala2.azul].map(e=>e.apelido));

      presentesHoje.forEach(p=>{
        const j1=set1.has(p.apelido);
        const j2=set2.has(p.apelido);

        // flags (para riscar nomes e regras do 2º tempo)
        p.escalou1 = j1;
        p.escalou2 = j2;

        // OBS base
        if (j1 && j2) p.obs="1-2";
        else if (j1) p.obs="1";
        else if (j2) p.obs="2";
        else p.obs="C";
      });
    }


    // ===== ESCALAÇÃO (BALANCEAMENTO DE PONTOS) =====
    function keyApelido(a){
      return String(a || "").trim().toUpperCase();
    }

    function pts(apelido){
      const j = mapaJogadores[keyApelido(apelido)];
      if(!j) return 0;

      // se pontos vier vazio, calcula por HAB + VEL + MOV (mesma regra do painel Jogadores)
      const pRaw = (j.pontos != null && j.pontos !== "") ? Number(j.pontos) : NaN;
      if(!Number.isNaN(pRaw)) return pRaw;

      const hab = (j.hab == null || j.hab === "") ? 0 : Number(j.hab);
      const vel = (j.vel == null || j.vel === "") ? 0 : Number(j.vel);
      const mov = (j.mov == null || j.mov === "") ? 0 : Number(j.mov);
      return (hab || 0) + (vel || 0) + (mov || 0);
    }

    function balancearEmDoisTimes(listaApelidos){
      // Equilibra por POSIÇÃO + PONTOS (heurística simples e estável)
      const normPos = (apelido)=>{
        const raw = String(mapaJogadores[apelido]?.posicao || "").toUpperCase().trim();
        if(!raw) return "OUT";

        // formatos esperados: GOL / DEF / MEI / ATA, ou abreviações: G, D, M, A, ou "D/M/A"
        if(raw.includes("GOL") || raw === "G" || raw === "GK") return "GOL";

        // se vier "D/M/A" pega o primeiro caractere (prioridade)
        const first = raw[0];

        if(raw.includes("ZAG") || raw.includes("DEF") || first === "D") return "DEF";
        if(raw.includes("LAT") || raw.includes("ALA") || first === "L") return "LAT";
        if(raw.includes("MEI") || raw.includes("MID") || first === "M") return "MEI";
        if(raw.includes("ATA") || raw.includes("FWD") || first === "A") return "ATA";

        return "OUT";
      };

      const grupos = { GOL:[], DEF:[], LAT:[], MEI:[], ATA:[], OUT:[] };
      (listaApelidos || []).forEach(ap=>{
        const k = normPos(ap);
        (grupos[k] || grupos.OUT).push(ap);
      });

      const ordenarPontosDesc = (arr)=> arr.sort((a,b)=>pts(b)-pts(a));

      const A=[], B=[];
      let sa=0, sb=0;
      const ca={GOL:0,DEF:0,LAT:0,MEI:0,ATA:0,OUT:0};
      const cb={GOL:0,DEF:0,LAT:0,MEI:0,ATA:0,OUT:0};

      const pushTeam = (team, ap, k)=>{
        if(team === "A"){ A.push(ap); sa += pts(ap); ca[k]++; }
        else { B.push(ap); sb += pts(ap); cb[k]++; }
      };

      const chooseTeam = (k, ap)=>{
        // limites
        if(A.length >= 10) return "B";
        if(B.length >= 10) return "A";

        // 1) balanceia quantidade da posição
        if(ca[k] < cb[k]) return "A";
        if(cb[k] < ca[k]) return "B";

        // 2) balanceia pontos totais
        if(sa <= sb) return "A";
        return "B";
      };

      // Ordem de prioridade de posição
      const ordem = ["GOL","DEF","LAT","MEI","ATA","OUT"];
      ordem.forEach(k=>{
        ordenarPontosDesc(grupos[k]);
        grupos[k].forEach(ap=>{
          const t = chooseTeam(k, ap);
          pushTeam(t, ap, k);
        });
      });

      return { amarelo:A, azul:B, somaAm:sa, somaAz:sb };
    }

// ===== Regras (REV 6) =====
    const HORARIO_CORTE_1T = "06:15";

    function pad2(n){ return String(n).padStart(2,"0"); }

    function parseDataISO(iso){ // yyyy-mm-dd
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d, 0,0,0,0);
    }

    function formataDataISO(dt){
      const y = dt.getFullYear();
      const m = pad2(dt.getMonth()+1);
      const d = pad2(dt.getDate());
      return `${y}-${m}-${d}`;
    }

    function domingoAnterior(dataISO){
      const dt = parseDataISO(dataISO);
      // volta 7 dias
      dt.setDate(dt.getDate()-7);
      return formataDataISO(dt);
    }

    function horaMenorOuIgual(hhmm, limite){
      // hhmm pode vir "06:14" ou "06:14:30"
      const h = (hhmm||"").slice(0,5);
      return h && h <= limite;
    }

    const cacheFaltas = {}; // chave: apelido|ano

    async function getFaltasAno(apelido, ano){
      const k = `${apelido}|${ano}`;
      if (cacheFaltas[k] != null) return cacheFaltas[k];

      // Conta quantas vezes status = 'F' no ano
      const ini = `${ano}-01-01`;
      const fim = `${ano}-12-31`;
      const { data, error } = await supabase
        .from("presencas")
        .select("id, data_jogo, apelido, obs")
        .eq("apelido", apelido)
        .eq("obs", "F")
        .gte("data_jogo", ini)
        .lte("data_jogo", fim);

      if (error) { console.warn("Erro faltas:", error.message); cacheFaltas[k]=0; return 0; }
      cacheFaltas[k] = (data||[]).length;
      return cacheFaltas[k];
    }

    async function getStatusDomingoAnterior(apelido, dataISO){
      const prev = domingoAnterior(dataISO);
      const { data, error } = await supabase
        .from("presencas")
        .select("obs")
        .eq("apelido", apelido)
        .eq("data_jogo", prev)
        .limit(1);

      if (error) { console.warn("Erro domingo anterior:", error.message); return null; }
      return (data && data[0] && data[0].obs) ? data[0].obs : null;
    }

    async function enrichMetricas(apelidos, dataISO){
      const ano = Number((dataISO||"").slice(0,4)) || (new Date()).getFullYear();
      const out = {};
      for (const ap of apelidos){
        const [faltasAno, statusPrev] = await Promise.all([
          getFaltasAno(ap, ano),
          getStatusDomingoAnterior(ap, dataISO),
        ]);
        out[ap] = {
          faltasAno,
          faltouDomingoAnterior: statusPrev === "F",
          jogouDoisDomingoAnterior: statusPrev === "1-2"
        };
      }
      return out;
    }


    async function escalarPrimeiroTempo(){
      const dataISO = getDataJogoISO();

      // elegíveis hoje
      const listaHoje = (presentesHoje || []).filter(p => !p.naoVaiJogar);

      // quem chegou até o corte (06:15)
      let listaCorte = listaHoje
        .filter(p => horaMenorOuIgual(p.horaChegada, HORARIO_CORTE_1T))
        .sort((a,b)=>comparaHoraStr(a.horaChegada,b.horaChegada));

      if (!listaCorte.length) {
        toast("Sem jogadores no corte (06:15). Vou escalar com os presentes.");
        listaCorte = [...listaHoje];
      }
      if (!listaCorte.length) {
        // nenhum presente
        escala1 = { amarelo: [], azul: [] };
        atualizarObs();
        renderPresentes();
        renderEscalacoes();
        toast("Sem presentes para escalar o 1º tempo.");
        return;
      }

// se até 20 no corte: escala todos. se >20: cortar para 20 por regra.
      const apelidosCorte = listaCorte.map(p=>p.apelido);
      let selecionados = [...apelidosCorte];

      if (apelidosCorte.length > 20){
        const metricas = await enrichMetricas(apelidosCorte, dataISO);

        selecionados.sort((a,b)=>{
          const ma = metricas[a] || {};
          const mb = metricas[b] || {};

          const ja = mapaJogadores[a] || {};
          const jb = mapaJogadores[b] || {};

          // 1) faltou domingo anterior (sai primeiro) => quem NÃO faltou fica primeiro
          if (!!ma.faltouDomingoAnterior !== !!mb.faltouDomingoAnterior){
            return (ma.faltouDomingoAnterior ? 1 : 0) - (mb.faltouDomingoAnterior ? 1 : 0);
          }
          // 2) inadimplente (sai primeiro) => quem NÃO é inadimplente fica primeiro
          if (!!ja.inadimplente !== !!jb.inadimplente){
            return (ja.inadimplente ? 1 : 0) - (jb.inadimplente ? 1 : 0);
          }
          // 3) maior número de faltas no ano (sai primeiro) => menos faltas fica primeiro
          if ((ma.faltasAno||0) !== (mb.faltasAno||0)){
            return (ma.faltasAno||0) - (mb.faltasAno||0);
          }
          // 4) desempate: ordem de chegada (quem chegou antes fica)
          const pa = listaCorte.find(x=>x.apelido===a);
          const pb = listaCorte.find(x=>x.apelido===b);
          return comparaHoraStr(pa?.horaChegada||"", pb?.horaChegada||"");
        });

        selecionados = selecionados.slice(0, 20);
      }

      // balancear times por pontos
      const bal = balancearEmDoisTimes(selecionados);

      const toObj = (ap)=>({ id: (mapaJogadores[ap]?.id ?? ""), apelido: ap, posicao: (mapaJogadores[ap]?.posicao ?? ""), pontos: pts(ap) });

      escala1 = {
        amarelo: (bal.amarelo||[]).map(toObj),
        azul: (bal.azul||[]).map(toObj)
      };

      // ao reescalar 1º tempo, não mexe no 2º tempo automaticamente (o operador decide)
      atualizarObs();
      renderPresentes();
      renderEscalacoes();
      toast("1º tempo escalado.");
    }

function toggleSaiu(apelido){
      const p = presentesHoje.find(x=>x.apelido===apelido);
      if(!p) return;
      p.saiu = !p.saiu; // saiu do 1º tempo
      renderEscalacoes();
    }

        
    async function escalarSegundoTempo(){
      const dataISO = getDataJogoISO();

      const presentes = (presentesHoje || []).filter(p => !p.naoVaiJogar);
      if (!presentes.length){
        escala2 = { amarelo: [], azul: [] };
        atualizarObs();
        renderPresentes();
        renderEscalacoes();
        toast("Sem jogadores para escalar o 2º tempo.");
        return;
      }

      const set1 = new Set([...escala1.amarelo, ...escala1.azul].map(e=>e.apelido));
      const desejado = Math.min(20, presentes.length);

      // prioridade: quem NÃO jogou o 1º tempo
      const naoJogou1 = presentes.filter(p=>!set1.has(p.apelido)).map(p=>p.apelido);
      const jogou1 = presentes.filter(p=>set1.has(p.apelido)).map(p=>p.apelido);

      let pool = [];
      if (naoJogou1.length >= desejado){
        pool = [...naoJogou1];
      } else {
        pool = [...naoJogou1, ...jogou1];
      }

      // se pool tem mais que o desejado, corta por regras (sai primeiro: saiu, faltou dom. anterior, jogou 2 tempos dom. anterior, mais faltas, mais novos)
      if (pool.length > desejado){
        const metricas = await enrichMetricas(pool, dataISO);

        pool.sort((a,b)=>{
          const ma = metricas[a] || {};
          const mb = metricas[b] || {};

          const pa = presentes.find(x=>x.apelido===a) || {};
          const pb = presentes.find(x=>x.apelido===b) || {};

          // 0) quem não jogou 1º tempo vem primeiro (quando misturar)
          const aNao = !set1.has(a);
          const bNao = !set1.has(b);
          if (aNao !== bNao) return (aNao ? -1 : 1);

          // 1) saiu do 1º tempo (sai primeiro) => quem NÃO saiu fica primeiro
          if (!!pa.saiu !== !!pb.saiu){
            return (pa.saiu ? 1 : 0) - (pb.saiu ? 1 : 0);
          }
          // 2) faltou domingo anterior (sai primeiro) => quem NÃO faltou fica primeiro
          if (!!ma.faltouDomingoAnterior !== !!mb.faltouDomingoAnterior){
            return (ma.faltouDomingoAnterior ? 1 : 0) - (mb.faltouDomingoAnterior ? 1 : 0);
          }
          // 3) jogou 2 tempos no domingo anterior (sai primeiro) => quem NÃO jogou 2 tempos fica primeiro
          if (!!ma.jogouDoisDomingoAnterior !== !!mb.jogouDoisDomingoAnterior){
            return (ma.jogouDoisDomingoAnterior ? 1 : 0) - (mb.jogouDoisDomingoAnterior ? 1 : 0);
          }
          // 4) mais faltas no ano (sai primeiro) => menos faltas fica primeiro
          if ((ma.faltasAno||0) !== (mb.faltasAno||0)){
            return (ma.faltasAno||0) - (mb.faltasAno||0);
          }
          // 5) mais novos (id maior sai primeiro) => id menor fica primeiro
          const ja = mapaJogadores[a] || {};
          const jb = mapaJogadores[b] || {};
          if ((ja.id||0) !== (jb.id||0)){
            return (ja.id||0) - (jb.id||0);
          }
          // 6) desempate: ordem de chegada
          return comparaHoraStr(pa.horaChegada||"", pb.horaChegada||"");
        });

        pool = pool.slice(0, desejado);
      } else {
        pool = pool.slice(0, desejado);
      }

            // Manter jogadores que jogaram o 1º tempo no MESMO time quando forem escalados no 2º tempo
      const time1ByAp = {};
      (escala1.amarelo||[]).forEach(e=>{ if(e && e.apelido) time1ByAp[e.apelido] = "amarelo"; });
      (escala1.azul||[]).forEach(e=>{ if(e && e.apelido) time1ByAp[e.apelido] = "azul"; });

      const fixAm = [];
      const fixAz = [];
      const restantes = [];

      for (const ap of (pool||[])){
        const t = time1ByAp[ap];
        if (t === "amarelo") fixAm.push(ap);
        else if (t === "azul") fixAz.push(ap);
        else restantes.push(ap);
      }

      const A = [...fixAm];
      const B = [...fixAz];

      let somaA = A.reduce((s,ap)=>s + pts(ap), 0);
      let somaB = B.reduce((s,ap)=>s + pts(ap), 0);

      // Preencher vagas com quem não jogou 1º tempo, balanceando pontos
      const restantesOrdenados = [...restantes].sort((a,b)=>pts(b)-pts(a));
      for (const ap of restantesOrdenados){
        const pa = pts(ap);
        if (A.length >= 10){ B.push(ap); somaB += pa; continue; }
        if (B.length >= 10){ A.push(ap); somaA += pa; continue; }
        if (somaA <= somaB){ A.push(ap); somaA += pa; }
        else { B.push(ap); somaB += pa; }
      }

      const toObj = (ap)=>({ id: (mapaJogadores[ap]?.id ?? ""), apelido: ap, posicao: (mapaJogadores[ap]?.posicao ?? ""), pontos: pts(ap) });

      escala2 = {
        amarelo: A.map(toObj),
        azul: B.map(toObj)
      };

      atualizarObs();
      renderPresentes();
      renderEscalacoes();
      toast("2º tempo escalado.");
    }

function calcularTotalPontos(lista){
      return (lista||[]).reduce((s,e)=>s+(pts(e.apelido)||0),0);
    }

    function renderEscalacoes(){
      // 1º tempo
      tbody1T.innerHTML="";
      const maxPos=10;
      for(let i=0;i<maxPos;i++){
        const tr=document.createElement("tr");

        const a=escala1.amarelo[i];
        const b=escala1.azul[i];

        const tdId=document.createElement("td"); tdId.textContent = a?.id ?? b?.id ?? ""; tr.appendChild(tdId);
        const tdPos=document.createElement("td"); tdPos.textContent=i+1; tr.appendChild(tdPos);

        const tdAm=document.createElement("td");
        tdAm.textContent = a ? a.apelido.toUpperCase() : "";
        tdAm.className = a ? "t-amarelo" : "";
        // risca no 1º tempo quando: saiu OU está no 2º tempo também
        if (a){
          const p = presentesHoje.find(x=>x.apelido===a.apelido);
          if (p && (p.saiu || p.escalou2)) tdAm.classList.add("riscado");
        }
        tr.appendChild(tdAm);

        const tdSaiAm=document.createElement("td");
        if(a){
          const bt=document.createElement("button");
          bt.textContent="SAIU";
          bt.className="btn-sair btn-saiu";
          bt.onclick=()=>toggleSaiu(a.apelido);
          tdSaiAm.appendChild(bt);
        }
        tr.appendChild(tdSaiAm);

        const tdAz=document.createElement("td");
        tdAz.textContent = b ? b.apelido.toUpperCase() : "";
        tdAz.className = b ? "t-azul" : "";
        if (b){
          const p = presentesHoje.find(x=>x.apelido===b.apelido);
          if (p && (p.saiu || p.escalou2)) tdAz.classList.add("riscado");
        }
        tr.appendChild(tdAz);

        const tdSaiAz=document.createElement("td");
        if(b){
          const bt2=document.createElement("button");
          bt2.textContent="SAIU";
          bt2.className="btn-sair btn-saiu";
          bt2.onclick=()=>toggleSaiu(b.apelido);
          tdSaiAz.appendChild(bt2);
        }
        tr.appendChild(tdSaiAz);

        tbody1T.appendChild(tr);
      }

      // 2º tempo
      tbody2T.innerHTML="";
      for(let i=0;i<10;i++){
        const tr=document.createElement("tr");
        const a=escala2.amarelo[i];
        const b=escala2.azul[i];

        const tdId=document.createElement("td"); tdId.textContent = a?.id ?? b?.id ?? ""; tr.appendChild(tdId);
        const tdPos=document.createElement("td"); tdPos.textContent=i+1; tr.appendChild(tdPos);

        const tdAm=document.createElement("td");
        tdAm.textContent = a ? a.apelido.toUpperCase() : "";
        tdAm.className = a ? "t-amarelo" : "";
        tr.appendChild(tdAm);

        const tdAz=document.createElement("td");
        tdAz.textContent = b ? b.apelido.toUpperCase() : "";
        tdAz.className = b ? "t-azul" : "";
        tr.appendChild(tdAz);

        tbody2T.appendChild(tr);
      }

      const totalAm1=calcularTotalPontos(escala1.amarelo);
      const totalAz1=calcularTotalPontos(escala1.azul);
      totais1TEl.textContent = `TOTAL PONTOS: ${totalAm1} x ${totalAz1}`;

      const totalAm2=calcularTotalPontos(escala2.amarelo);
      const totalAz2=calcularTotalPontos(escala2.azul);
      const dif2 = Math.abs(totalAm2-totalAz2);
      totais2TEl.textContent = `TOTAL PONTOS: ${totalAm2} x ${totalAz2}  (DIF: ${dif2})`;
    }

    function limparPresentesHoje(){
      if(!confirm("Limpar toda a presença de hoje?")) return;
      presentesHoje=[];
      limparEscalacoes();
      atualizarInfoPresentes();
      renderPresentes();
      renderEscalacoes();
    }

    // ===== DESFAZER ESCALAÇÃO (não mexe na lista de presença) =====
    function desfazerEscalacao1T(){
      if(!confirm("Desfazer escalação do 1º tempo?")) return;
      escala1 = { amarelo: [], azul: [] };

      // limpa "saiu" (só faz sentido quando existe 1º tempo)
      (presentesHoje||[]).forEach(p=>{ p.saiu=false; });

      syncEscalacoesComPresenca();
      renderPresentes();
      renderEscalacoes();
      toast("Escalação 1º tempo desfeita.", true);
    }

    function desfazerEscalacao2T(){
      if(!confirm("Desfazer escalação do 2º tempo?")) return;
      escala2 = { amarelo: [], azul: [] };

      syncEscalacoesComPresenca();
      renderPresentes();
      renderEscalacoes();
      toast("Escalação 2º tempo desfeita.", true);
    }

    // ===== BAIXAR (rápido) =====
    function downloadBlob(filename, mime, content){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
    }

        
        // ===== EXPORTAR (SEM POP-UP, NÃO QUEBRA O PAINEL) =====
        function escapeHtml(s){
          return String(s ?? "")
            .replaceAll("&","&amp;")
            .replaceAll("<","&lt;")
            .replaceAll(">","&gt;")
            .replaceAll('"',"&quot;")
            .replaceAll("'","&#039;");
        }

        function downloadTextFile(filename, text, mime="text/html"){
          const blob = new Blob([text], { type: `${mime};charset=utf-8` });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        }

        function baixarPresenca(){
          try{
            const dia = getDataJogoISO();
            const titulo = `Presença (${isoToBr(dia)})`;
            const cols = ["ID","ORDEM","APELIDO","HORA","OBS","NÃO VAI JOGAR"];

            const rows = (presentesHoje || []).map((p, idx) => ([
              p.id ?? "",
              String(idx+1),
              (p.apelido || ""),
              (p.horaChegada || ""),
              (p.obs || ""),
              p.naoVaiJogar ? "SIM" : ""
            ]));

            const thead = "<tr>" + cols.map(c=>"<th>"+escapeHtml(c)+"</th>").join("") + "</tr>";
            const tbody = rows.map(r=>"<tr>" + r.map(v=>"<td>"+escapeHtml(v)+"</td>").join("") + "</tr>").join("");

            const htmlDoc =
`<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${escapeHtml(titulo)}</title>
<style>
  body{font-family:Arial, sans-serif; padding:18px;}
  h2{margin:0 0 12px 0;}
  table{border-collapse:collapse; width:100%;}
  th,td{border:1px solid #999; padding:6px 8px; font-size:12px;}
  th{background:#f2f2f2; text-align:left;}
</style>
</head>
<body>
<h2>${escapeHtml(titulo)}</h2>
<table>
  <thead>${thead}</thead>
  <tbody>${tbody}</tbody>
</table>
</body>
</html>`;

            downloadTextFile(`presenca_${dia}.html`, htmlDoc, "text/html");
          }catch(e){
            console.error(e);
            alert("Erro ao baixar presença (ver Console).");
          }
        }

        function printEscalacao(tempo){
          try{
            const dia = getDataJogoISO();
            const titulo = tempo === 1 ? `Escalação 1º Tempo (${isoToBr(dia)})` : `Escalação 2º Tempo (${isoToBr(dia)})`;
            const esc = (tempo===1) ? (escala1 || {amarelo:[],azul:[]}) : (escala2 || {amarelo:[],azul:[]});

            const maxLen = Math.max((esc.amarelo||[]).length, (esc.azul||[]).length, 10);
            let rowsHtml = "";
            for(let i=0;i<maxLen;i++){
              const am = esc.amarelo[i]?.apelido ? String(esc.amarelo[i].apelido).toUpperCase() : "";
              const az = esc.azul[i]?.apelido ? String(esc.azul[i].apelido).toUpperCase() : "";
              rowsHtml += "<tr><td class=\"am\">"+escapeHtml(am)+"</td><td class=\"az\">"+escapeHtml(az)+"</td></tr>";
            }

            const htmlDoc =
`<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${escapeHtml(titulo)}</title>
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
  .wrap{padding:16px}
  h2{margin:0 0 10px 0;color:#ff7f27}
  table{border-collapse:collapse;width:100%;background:#0b1220}
  th,td{border:1px solid #334155;padding:8px;font-size:14px}
  th{background:#ff7f27;color:#000;font-weight:900;text-align:center}
  .am{color:#fbbf24;font-weight:900}
  .az{color:#60a5fa;font-weight:900}
  @media print{
    body{background:#fff;color:#000}
    th{background:#ff7f27 !important;color:#000 !important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h2>${escapeHtml(titulo)}</h2>
    <table>
      <thead><tr><th>AMARELO</th><th>AZUL</th></tr></thead>
      <tbody>${rowsHtml}</tbody>
    </table>
  </div>
</body>
</html>`;

            downloadTextFile(`escalacao_${tempo}t_${dia}.html`, htmlDoc, "text/html");
          }catch(e){
            console.error(e);
            alert("Erro ao baixar escalação (ver Console).");
          }
        }

// ===== SALVAR (SEM UPSERT, PARA NÃO DEPENDER DE CONSTRAINT) =====
    async function salvarJogo(){
      try{
        if(!dataJogoIso){ alert("Base não carregada."); return; }
        msgSalvarEl.textContent="";

        const dia=dataJogoIso;

        // 1) presenças: apaga do dia e insere novamente
        const { error: errDelPres } = await supabase.from("presencas").delete().eq("data_jogo", dia);
        if(errDelPres){ console.error(errDelPres); alert("Erro ao limpar presenças do dia."); return; }

        const presentesSet=new Set(presentesHoje.map(p=>p.apelido));
        const presRows = todosJogadores.map(j=>({
          data_jogo: dia,
          apelido: j.apelido,
          presenca: presentesSet.has(j.apelido),
          faltoso: !presentesSet.has(j.apelido)
        }));

        if(presRows.length){
          const { error: errInsPres } = await supabase.from("presencas").insert(presRows);
          if(errInsPres){ console.error(errInsPres); alert("Erro ao salvar presenças."); return; }
        }

        // 2) escalação: apaga do dia e insere
        const { error: errDelEsc } = await supabase.from("escalacao").delete().eq("data_jogo", dia);
        if(errDelEsc){ console.error(errDelEsc); alert("Erro ao limpar escalação."); return; }

        const escRows=[];
        escala1.amarelo.forEach(e=>escRows.push({data_jogo:dia, apelido:e.apelido, tempo:1, time:"AMARELO"}));
        escala1.azul.forEach(e=>escRows.push({data_jogo:dia, apelido:e.apelido, tempo:1, time:"AZUL"}));
        escala2.amarelo.forEach(e=>escRows.push({data_jogo:dia, apelido:e.apelido, tempo:2, time:"AMARELO"}));
        escala2.azul.forEach(e=>escRows.push({data_jogo:dia, apelido:e.apelido, tempo:2, time:"AZUL"}));

        if(escRows.length){
          const { error: errInsEsc } = await supabase.from("escalacao").insert(escRows);
          if(errInsEsc){ console.error(errInsEsc); alert("Erro ao salvar escalação."); return; }
        }


        // 3) ARQUIVAR NO BANCO DE DADOS (arquivos_app)
        try{
          const dtRef = new Date(dia+"T00:00:00");
          const mes_ref = dtRef.getMonth()+1;
          const ano_ref = dtRef.getFullYear();

          // Presença (arquivo semanal)
          const presPayload = todosJogadores.map(j=> {
            const p = presentesHoje.find(x=>x.apelido===j.apelido);
            return {
              id: j.id,
              apelido: j.apelido,
              posicao: (j.posicao||"").toUpperCase(),
              pontos: j.pontos ?? "",
              presente: !!p,
              hora_chegada: p ? (p.horaChegada||"") : "",
              nao_vai_jogar: p ? !!p.naoVaiJogar : false,
              pago: isPagoHoje(j.apelido)
            };
          });

          // limpa registro anterior do mesmo domingo (evita acumular testes)
          await supabase.from("arquivos_app").delete()
            .eq("painel","presenca").eq("periodo","semanal").eq("data_ref", dia);

                    const presTableHtml = document.getElementById("tblPresencaHoje")?.outerHTML || "";
          const presConteudo = { table_html: presTableHtml };

          const { error: errArqPres } = await supabase.from("arquivos_app").insert([{
            painel: "presenca",
            periodo: "semanal",
            data_ref: dia,
            mes_ref,
            ano_ref,
            referencia: isoToBr(dia),
            titulo: `Presença (${isoToBr(dia)})`,
            conteudo: presConteudo
          }]);
          if(errArqPres) throw errArqPres;

          // Escalação (arquivo semanal)
          const escPayload = [];
          escala1.amarelo.forEach(e=>escPayload.push({tempo:1, time:"AMARELO", apelido:e.apelido}));
          escala1.azul.forEach(e=>escPayload.push({tempo:1, time:"AZUL", apelido:e.apelido}));
          escala2.amarelo.forEach(e=>escPayload.push({tempo:2, time:"AMARELO", apelido:e.apelido}));
          escala2.azul.forEach(e=>escPayload.push({tempo:2, time:"AZUL", apelido:e.apelido}));

          await supabase.from("arquivos_app").delete()
            .eq("painel","escalacao").eq("periodo","semanal").eq("data_ref", dia);

                    const escAreaHtml = document.getElementById("areaEscalacao")?.outerHTML
            || document.getElementById("painelEscalacao")?.outerHTML
            || "";

          const escConteudo = { table_html: escAreaHtml };

          const { error: errArqEsc } = await supabase.from("arquivos_app").insert([{
            painel: "escalacao",
            periodo: "semanal",
            data_ref: dia,
            mes_ref,
            ano_ref,
            referencia: isoToBr(dia),
            titulo: `Escalação (${isoToBr(dia)})`,
            conteudo: escConteudo
          }]);
          if(errArqEsc) throw errArqEsc;

        }catch(eArq){
          console.error(eArq);
          alert("⚠️ Salvou PRESENÇA/ESCALAÇÃO, mas NÃO arquivou no BANCO DE DADOS. (Veja o Console)");
        }

        msgSalvarEl.textContent="PÁGINA SALVA";
        alert("Página salva.");
      }catch(e){
        console.error(e);
        alert("Erro ao salvar (veja F12 > Console).");
      }
    }

    // ===== EVENTOS =====
    btnLimparPresentes.addEventListener("click", limparPresentesHoje);
    btnEscalar1T.addEventListener("click", escalarPrimeiroTempo);
    btnEscalar2T.addEventListener("click", escalarSegundoTempo);
    btnSalvarJogo.addEventListener("click", salvarJogo);

    if(btnDesfazer1T) btnDesfazer1T.addEventListener("click", desfazerEscalacao1T);
    if(btnDesfazer2T) btnDesfazer2T.addEventListener("click", desfazerEscalacao2T);
    if(btnBaixarPresenca) btnBaixarPresenca.addEventListener("click", baixarPresenca);
    if(btnBaixar1T) btnBaixar1T.addEventListener("click", ()=>printEscalacao(1));
    if(btnBaixar2T) btnBaixar2T.addEventListener("click", ()=>printEscalacao(2));

    carregarBase();
</script>

<div class="bloco-regras">
  <div class="col-regras">
    <h3>Regras 1º tempo (corte 06:15)</h3>
    <ul>
      <li>Se até 06:15 tiver até 20 presentes (ex.: 15, 19, 20): sem eliminação (todos jogam).</li>
      <li>Se até 06:15 tiver mais de 20 presentes (ex.: 25): o app corta até ficar 20, na ordem: faltou no domingo anterior → inadimplente → maior nº de faltas.</li>
    </ul>
  </div>
  <div class="col-regras">
    <h3>Regras 2º tempo (resumo)</h3>
    <ul>
      <li>Prioridade: quem está presente e não jogou no 1º tempo.</li>
      <li>Para abrir vagas, sai primeiro: (1) quem marcou SAIU/SAIU, (2) faltou no domingo anterior, (3) jogou os dois tempos no domingo anterior, (4) maior nº de faltas, (5) mais novos.</li>
      <li>Manter base dos times e distribuir quem entra equilibrando pontos e posições.</li>
    </ul>
  </div>
  <div class="obs-legenda">
    <strong>OBS:</strong>
    C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) | 
    <span class="pago-ok">P (verde) pagou</span> | <span class="pago-bad">P (vermelho) não pagou</span>
  </div>
</div>

</body>
</html>
