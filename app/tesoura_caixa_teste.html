<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tesoura - Caixa</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#050a14;
      --panel:#0b1220;
      --panel2:#0a1020;
      --line:#18233a;
      --text:#e7eefc;
      --muted:#9fb2d7;
      --orange:#ff8a2a;
      --blue:#12b5ea;
      --green:#18d37b;
      --red:#ff3b3b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    \.wrap{max-width:1400px;margin:0 auto;padding:18px}
    .card{background:linear-gradient(180deg,rgba(18,24,45,.92),rgba(10,16,32,.92));border:1px solid var(--line);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.35)}
    .title{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:2px solid rgba(255,138,42,.55)}
    .title h1{margin:0;font-size:18px;letter-spacing:.4px;color:var(--orange)}
    .title small{color:var(--muted)}
    .section{padding:16px 18px}
    .section h2{margin:0 0 10px 0;color:var(--orange);font-size:14px;letter-spacing:.4px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    select,input{height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:#0a1020;color:#fff;padding:0 10px;outline:none}
    input::placeholder{color:#5f6f93}
    .btn{height:36px;border-radius:10px;border:0;padding:0 14px;font-weight:700;cursor:pointer}
    .btn.blue{background:var(--blue);color:#00111a}
    .btn.orange{background:var(--orange);color:#1a0a00}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:#fff}
    .meta{margin-top:8px;color:var(--muted);font-size:12px}
    .stats{display:flex;gap:14px;flex-wrap:wrap;color:var(--text);font-size:12px;margin-top:8px}
    .stats b{color:#fff}
    .table-wrap{margin-top:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);overflow:hidden}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{background:var(--orange);color:#fff;font-size:12px;padding:10px;border-right:1px solid rgba(0,0,0,.18)}
    thead th:last-child{border-right:0}
    tbody td{padding:10px;border-top:1px solid rgba(255,255,255,.08);vertical-align:middle;font-size:12px;color:#e9f1ff}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    .col-date{width:110px}
    .col-desc{width:280px}
    .col-obs{width:140px}
    .col-money{width:120px;text-align:right}
    .col-actions{width:260px;text-align:center}

    td.col-desc, td.col-obs{white-space:normal;}
    td.col-desc{text-align:left;}
    td.col-obs{text-align:left;}
    .money.pos{color:var(--green);font-weight:800}
    .money.neg{color:var(--red);font-weight:800}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.14);color:#dbe7ff;background:rgba(0,0,0,.18)}
    .badge.lock{border-color:rgba(255,138,42,.55);color:#ffd9b5}
    .actions{display:flex;gap:10px;justify-content:center;align-items:center}
    .btnSmall{height:30px;border-radius:10px;border:0;padding:0 12px;font-weight:800;cursor:pointer;font-size:12px}
    .btnEdit{background:var(--green);color:#02140b}
    .btnDel{background:var(--red);color:#1a0000}
    .btnDisabled{opacity:.55;cursor:not-allowed}
    .readonly{opacity:.75}
    .line{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    /* impressão */
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:0;border-radius:0;background:#fff}
      .title,.section h2,.row,.meta,.stats,.actions,.btn{display:none !important}
      .table-wrap{border:0}
      table{table-layout:auto;width:100%}
      thead th{position:static}
    }
    @page{size:A4 landscape;margin:10mm}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>TESOURA - CAIXA</h1>
        <small>(auto-save)</small>
      </div>

      <div class="section">
        <h2>FILTRO</h2>
        <div class="row">
          <div class="field">
            <label>ANO:</label>
            <select id="selAno"></select>
          </div>
          <div class="field">
            <label>MÊS:</label>
            <select id="selMes"></select>
          </div>
</div>

      <div class="section">
        <h2>LANÇAMENTOS</h2>
        <div class="row">
          <input id="inData" type="date" style="width:160px"/>
          <select id="inTipo" style="width:140px">
            <option value="RECEITA">RECEITA</option>
            <option value="DESPESA">DESPESA</option>
          </select>
          <input id="inDesc" placeholder="DESCRIÇÃO" style="flex:1;min-width:220px"/>
          <input id="inObs" placeholder="OBS" style="width:220px"/>
          <input id="inValor" placeholder="VALOR (R$)" inputmode="decimal" style="width:160px"/>
          <button class="btn blue" id="btnSalvar">SALVAR</button>
          <button class="btn ghost" id="btnCancelar" style="display:none">CANCELAR</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="col-date">DATA</th>
                <th class="col-desc">DESCRIÇÃO</th>
                <th class="col-obs">OBS</th>
                <th class="col-money">RECEITA (R$)</th>
                <th class="col-money">DESPESA (R$)</th>
                <th class="col-money">SALDO (R$)</th>
                <th class="col-actions">AÇÕES</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


<script>
/* TESOURA - CAIXA (FIX)
   - Tela: sempre mostra o MÊS corrente (ou o mês escolhido em Ano/Mês)
   - Sem MENSAL / sem MÊS
   - Lê dados da view: vw_caixa_painel (com saldo + flags pode_editar/pode_excluir)
   - CRUD (Salvar/Editar/Excluir) na tabela: caixa
*/

const el = (id)=>document.getElementById(id);

const statusEl = el("status");
const selAno   = el("selAno");
const selMes   = el("selMes");
const btnCons  = el("btnConsultar");
const btnPdf   = el("btnPdf");

const inData   = el("inData");
const inTipo   = el("inTipo");
const inDesc   = el("inDesc");
const inObs    = el("inObs");
const inValor  = el("inValor");
const btnSalvar= el("btnSalvar");
const btnLimpar= el("btnLimpar");

const tbody    = el("tbody");

let editId = null;

// ===== Config (tentamos TESOURA_CONFIG; se não tiver, usamos fallback do seu projeto) =====
const CFG = (window.TESOURA_CONFIG || {});
const SB_URL = CFG.SUPABASE_URL || window.SUPABASE_URL || "https://xumsbprhlpqnulskldrl.supabase.co";
const SB_KEY = CFG.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || "sb_publishable_qtRHm8yo7PXADifAIaxqNM_0Z6kS9U4C8NfNUZTxH6uR5NjZcOknVBJ3LLb4QhE2";

let sb = null;

function setStatus(msg){
  if(statusEl) statusEl.textContent = msg;
}

function pad2(n){ return String(n).padStart(2,"0"); }

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = pad2(d.getMonth()+1);
  const day = pad2(d.getDate());
  return `${y}-${m}-${day}`;
}

function ymRange(ano, mes1to12){
  const y = Number(ano);
  const m = Number(mes1to12); // 1..12
  const start = `${y}-${pad2(m)}-01`;
  const next = (m===12) ? {y:y+1, m:1} : {y, m:m+1};
  const end = `${next.y}-${pad2(next.m)}-01`; // exclusivo
  return {start, end};
}

function money(v){
  const n = Number(v||0);
  return n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});
}

function inferTipo(r){
  const rec = Number(r.receita||0);
  const dep = Number(r.despesa||0);
  if(rec>0) return {tipo:"RECEITA", valor:rec};
  if(dep>0) return {tipo:"DESPESA", valor:dep};
  return {tipo:"RECEITA", valor:0};
}

function clearForm(){
  editId = null;
  inData.value = todayISO();
  inTipo.value = "RECEITA";
  inDesc.value = "";
  inObs.value = "";
  inValor.value = "";
  btnSalvar.textContent = "SALVAR";
}

async function initSupabase(){
  try{
    if(!window.supabase || !window.supabase.createClient){
      setStatus("ERRO: biblioteca do Supabase não carregou.");
      return;
    }
    sb = window.supabase.createClient(SB_URL, SB_KEY);
  }catch(e){
    console.error(e);
    setStatus("ERRO: não foi possível iniciar Supabase (veja o console).");
  }
}

function initSelects(){
  // Ano: atual -2 até atual +2
  const y = new Date().getFullYear();
  selAno.innerHTML = "";
  for(let yy=y-2; yy<=y+2; yy++){
    const opt = document.createElement("option");
    opt.value = String(yy);
    opt.textContent = String(yy);
    if(yy===y) opt.selected = true;
    selAno.appendChild(opt);
  }

  // Mês: 01..12
  const meses = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
  selMes.innerHTML = "";
  for(let i=1;i<=12;i++){
    const opt = document.createElement("option");
    opt.value = pad2(i);
    opt.textContent = `${pad2(i)} - ${meses[i-1]}`;
    if(i===(new Date().getMonth()+1)) opt.selected = true;
    selMes.appendChild(opt);
  }
}

function renderRows(rows, saldoAnterior){
  tbody.innerHTML = "";

  if(!rows || rows.length===0){
    tbody.innerHTML = `<tr><td colspan="7" class="small">Sem lançamentos no mês.</td></tr>`;
    return {saldoFinal: saldoAnterior};
  }

  let saldoFinal = saldoAnterior;

  for(const r of rows){
    const dt = r.data || "";
    const desc = r.descricao || "";
    const obs  = r.obs || "";
    const rec  = Number(r.receita||0);
    const dep  = Number(r.despesa||0);
    const sal  = Number(r.saldo||0);

    saldoFinal = sal;

    const podeEditar = !!r.pode_editar;
    const podeExcluir= !!r.pode_excluir;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dt}</td>
      <td>${desc}</td>
      <td>${obs}</td>
      <td class="pos">${rec>0?money(rec):""}</td>
      <td class="neg">${dep>0?money(dep):""}</td>
      <td class="saldo">${money(sal)}</td>
      <td class="acoes"></td>
    `;

    const tdA = tr.querySelector(".acoes");

    if(podeEditar){
      const bE = document.createElement("button");
      bE.className = "btn btn-editar";
      bE.textContent = "EDITAR";
      bE.onclick = ()=> startEdit(r);
      tdA.appendChild(bE);
    }else{
      const tag = document.createElement("span");
      tag.className = "tag-auto";
      tag.textContent = "AUTO";
      tdA.appendChild(tag);
    }

    if(podeExcluir){
      const bD = document.createElement("button");
      bD.className = "btn btn-excluir";
      bD.textContent = "EXCLUIR";
      bD.onclick = ()=> deleteRow(r.id);
      tdA.appendChild(bD);
    }

    tbody.appendChild(tr);
  }

  return {saldoFinal};
}

function setSaldos(saldoAnterior, saldoFinal){
  el("saldoAnterior").textContent = `SALDO ANTERIOR: R$ ${money(saldoAnterior)}`;
  const saldoPeriodo = (Number(saldoFinal||0) - Number(saldoAnterior||0));
  el("saldoPeriodo").textContent  = `SALDO NO MÊS: R$ ${money(saldoPeriodo)}`;
  el("saldoFinal").textContent    = `SALDO FINAL: R$ ${money(saldoFinal)}`;
}

async function fetchSaldoAnterior(startIso){
  // Pega o último saldo antes do início do mês
  const { data, error } = await sb
    .from("vw_caixa_painel")
    .select("saldo,data,id")
    .lt("data", startIso)
    .order("data", { ascending:false })
    .order("id", { ascending:false })
    .limit(1);

  if(error){
    console.error(error);
    return 0;
  }
  if(!data || data.length===0) return 0;
  return Number(data[0].saldo||0);
}

async function loadMonth(){
  if(!sb){
    setStatus("ERRO: Supabase não iniciou.");
    return;
  }
  const ano = selAno.value;
  const mes = selMes.value; // "01".."12"
  const {start, end} = ymRange(ano, mes);

  setStatus("Carregando...");
  try{
    const saldoAnterior = await fetchSaldoAnterior(start);

    const { data, error } = await sb
      .from("vw_caixa_painel")
      .select("id,data,descricao,obs,receita,despesa,saldo,pode_editar,pode_excluir")
      .gte("data", start)
      .lt("data", end)
      .order("data", { ascending:true })
      .order("id", { ascending:true });

    if(error){
      console.error(error);
      setStatus("ERRO ao buscar CAIXA (veja console).");
      renderRows([], saldoAnterior);
      setSaldos(saldoAnterior, saldoAnterior);
      return;
    }

    const rows = data || [];
    const {saldoFinal} = renderRows(rows, saldoAnterior);
    setSaldos(saldoAnterior, saldoFinal);
    setStatus(`LISTA CARREGADA. Registros: ${rows.length}`);
  }catch(e){
    console.error(e);
    setStatus("ERRO ao carregar (veja console).");
  }
}

function startEdit(r){
  if(!r || !r.id) return;
  editId = r.id;

  const {tipo, valor} = inferTipo(r);

  inData.value = r.data || todayISO();
  inTipo.value = tipo;
  inDesc.value = r.descricao || "";
  inObs.value  = r.obs || "";
  inValor.value= String(valor||"");

  btnSalvar.textContent = "ATUALIZAR";
  window.scrollTo({top:0, behavior:"smooth"});
}

async function saveForm(){
  if(!sb) return;

  const data = inData.value || todayISO();
  const tipo = (inTipo.value || "RECEITA").toUpperCase();
  const descricao = (inDesc.value || "").trim();
  const obs = (inObs.value || "").trim();
  const valor = Number(String(inValor.value||"0").replace(",", "."));

  if(!descricao){
    alert("Preencha a DESCRIÇÃO.");
    return;
  }
  if(!valor || valor<=0){
    alert("Preencha o VALOR (maior que zero).");
    return;
  }

  const payload = { data, tipo, descricao, obs, valor };

  try{
    setStatus("Salvando...");
    let resp;
    if(editId){
      resp = await sb.from("caixa").update(payload).eq("id", editId);
    }else{
      resp = await sb.from("caixa").insert(payload);
    }

    if(resp.error){
      console.error(resp.error);
      alert("Erro ao salvar (veja console).");
      setStatus("ERRO ao salvar.");
      return;
    }

    clearForm();
    await loadMonth();
    setStatus("Salvo.");
  }catch(e){
    console.error(e);
    alert("Erro ao salvar (veja console).");
    setStatus("ERRO ao salvar.");
  }
}

async function deleteRow(id){
  if(!sb || !id) return;
  if(!confirm("Excluir este lançamento?")) return;

  try{
    setStatus("Excluindo...");
    const { error } = await sb.from("caixa").delete().eq("id", id);
    if(error){
      console.error(error);
      alert("Erro ao excluir (veja console).");
      setStatus("ERRO ao excluir.");
      return;
    }
    await loadMonth();
    setStatus("Excluído.");
  }catch(e){
    console.error(e);
    alert("Erro ao excluir (veja console).");
    setStatus("ERRO ao excluir.");
  }
}

function buildPdfHTML(rows, ano, mes){
  const titulo = `TESOURA - CAIXA (${mes}/${ano})`;
  const linhas = rows.map(r=>{
    const rec = Number(r.receita||0);
    const dep = Number(r.despesa||0);
    return `
      <tr>
        <td>${r.data||""}</td>
        <td>${(r.descricao||"")}</td>
        <td>${(r.obs||"")}</td>
        <td style="text-align:right">${rec>0?money(rec):""}</td>
        <td style="text-align:right">${dep>0?money(dep):""}</td>
        <td style="text-align:right">${money(r.saldo||0)}</td>
      </tr>`;
  }).join("");

  return `
  <html><head><meta charset="utf-8">
  <title>${titulo}</title>
  <style>
    body{font-family: Arial, sans-serif; margin:24px;}
    h1{font-size:18px; margin:0 0 12px;}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{border:1px solid #999; padding:6px;}
    th{background:#eee;}
  </style>
  </head><body>
    <h1>${titulo}</h1>
    <table>
      <thead>
        <tr>
          <th>DATA</th><th>DESCRIÇÃO</th><th>OBS</th>
          <th>RECEITA</th><th>DESPESA</th><th>SALDO</th>
        </tr>
      </thead>
      <tbody>${linhas || '<tr><td colspan="6">Sem lançamentos.</td></tr>'}</tbody>
    </table>
    <script>
      window.onload = ()=>{ window.print(); };
    </script>
  </body></html>`;
}

async function baixarPdf(){
  const ano = selAno.value;
  const mes = selMes.value;
  const {start, end} = ymRange(ano, mes);

  setStatus("Gerando PDF...");

  const { data, error } = await sb
    .from("vw_caixa_painel")
    .select("data,descricao,obs,receita,despesa,saldo")
    .gte("data", start)
    .lt("data", end)
    .order("data", { ascending:true })
    .order("id", { ascending:true });

  if(error){
    console.error(error);
    alert("Erro ao gerar PDF (veja console).");
    setStatus("ERRO ao gerar PDF.");
    return;
  }

  const doc = buildPdfHTML(data||[], ano, mes);

  try{
    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(doc);
    w.document.close();
    setStatus("PDF aberto. Use Imprimir > Salvar em PDF.");
  }catch(e){
    console.error(e);
    alert("Erro ao abrir o PDF (veja console).");
    setStatus("ERRO ao abrir PDF.");
  }
}

// ===== Eventos =====
btnCons.addEventListener("click", loadMonth);
btnPdf.addEventListener("click", baixarPdf);
btnSalvar.addEventListener("click", saveForm);
btnLimpar.addEventListener("click", clearForm);

// ===== Start =====
(async ()=>{
  initSelects();
  await initSupabase();
  clearForm();
  await loadMonth();
})();
</script>

</body>
</html>
