<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TESOURA - CONTROLE DE GOLS</title>

  <!-- MESMA BIBLIOTECA DO ARQUIVO JOGADORES -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0b1220;
      color: #ffffff;
    }

    h1 {
      text-align: center;
      color: #ff7f27;
      margin-top: 25px;
      margin-bottom: 10px;
      font-size: 26px;
    }

    .painel-central {
      max-width: 900px;
      margin: 0 auto 40px auto;
      background-color: #050b18;
      padding: 20px 30px 25px 30px;
      border-radius: 8px;
    }

    .bloco {
      background-color: #0b1220;
      padding: 12px 16px 16px 16px;
      margin-bottom: 14px;
      border-radius: 6px;
    }

    .bloco h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #ff7f27;
      font-size: 16px;
    }

    .linha-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    label {
      margin-right: 4px;
    }

    input, select, button {
      padding: 5px 8px;
      border-radius: 4px;
      border: none;
      font-size: 13px;
    }

    input[type="date"], input[type="number"], select {
      background-color: #101733;
      color: #ffffff;
    }

    button {
      background-color: #00b4ff;
      color: #000000;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.9;
    }

    .linha-tabelas {
      display: flex;
      gap: 18px;
      margin-top: 10px;
    }

    .tabela-card {
      flex: 1;
      background-color: #0b1220;
      padding: 10px;
      border-radius: 6px;
    }

    .tabela-card h3 {
      text-align: left;
      font-size: 15px;
      margin-bottom: 6px;
      color: #ff7f27;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #222a3f;
      padding: 4px 6px;
      text-align: center;
    }

    th {
      background-color: #ff7f27;
      color: #000000;
    }

    tr:nth-child(even) {
      background-color: #101733;
    }

    tr:nth-child(odd) {
      background-color: #050b18;
    }

    .btn-excluir {
      background-color: #ff4d4d;
      color: #000000;
      font-weight: bold;
      border-radius: 4px;
      padding: 1px 7px;
      cursor: pointer;
      border: none;
    }

    #status-gols {
      margin-top: 8px;
      font-size: 12px;
      color: #ffcc66;
    }
  
.btn-pdf{
  background: #ff7a00 !important;
  color: #000 !important;
}
.subtexto{
  margin-top: 6px;
  color: #cfcfcf;
  font-size: 12px;
}

</style>
</head>
<body>
  <h1>TESOURA - CONTROLE DE GOLS</h1>

  <div class="painel-central">
    <!-- Registrar gol -->
    <div class="bloco">
      <h3>Registrar gol</h3>
      <div class="linha-form">
        <label>ANO:</label>
        <select id="gols-ano"></select>

        <label>DATA:</label>
        <input type="date" id="gols-data" />

        <label>APELIDO:</label>
        <select id="gols-apelido">
          <option value="">-- selecione --</option>
        </select>

        <label>GOLS:</label>
        <input type="number" id="gols-quantidade" min="1" value="1" />

        <button id="gols-salvar-btn">SALVAR GOL</button>
        <button id="gols-pdf-btn" class="btn-pdf">BAIXAR PDF</button>
      </div>
      <div class="subtexto">Arquivo anual: <span id="gols-ano-label"></span></div>
      <div id="status-gols"></div>
    </div>

    <!-- Tabelas -->
    <div class="linha-tabelas">
      <!-- Gols registrados -->
      <div class="tabela-card">
        <h3>Gols registrados</h3>
        <table id="tabela-gols-registrados">
          <thead>
            <tr>
              <th>EXCLUIR</th>
              <th>DATA</th>
              <th>APELIDO</th>
              <th>GOLS</th>
            </tr>
          </thead>
          <tbody>
            <!-- preenchido pelo JS -->
          </tbody>
        </table>
      </div>

      <!-- Artilharia -->
      <div class="tabela-card">
        <h3>Artilharia</h3>
        <table id="tabela-artilharia">
          <thead>
            <tr>
              <th>#</th>
              <th>APELIDO</th>
              <th>TOTAL GOLS</th>
            </tr>
          </thead>
          <tbody>
            <!-- preenchido pelo JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
// ================================
// TESOURA - GOLS (ARQUIVO ANUAL)
// Regras:
// - Tudo é filtrado por ANO
// - "Gols registrados": lista de lançamentos do ano (pode EXCLUIR por linha)
// - "Artilharia": soma anual por jogador (somente visual)
// - "Baixar PDF": baixa exatamente o que está sendo visto no painel
// ================================

function $(sel){ return document.querySelector(sel); }

function getSupabaseClient(){
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  if (!window.supabase || !window.supabase.createClient){
    throw new Error("Supabase não carregou (cdn).");
  }
  return window.supabase.createClient(SB_URL, SB_KEY);
}

let sb;
let golsAno = [];

function setStatus(msg, isErr=false){
  const el = $("#status-gols");
  if(!el) return;
  el.textContent = msg || "";
  el.style.color = isErr ? "#ff5a5a" : "#5cff9a";
}

function hojeISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function popularAnos(){
  const sel = $("#gols-ano");
  if(!sel) return;
  const now = new Date().getFullYear();
  const start = 2024;
  const end = now + 5;

  sel.innerHTML = "";
  for(let y=end; y>=start; y--){
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = String(y);
    sel.appendChild(opt);
  }
  sel.value = String(now);
  $("#gols-ano-label").textContent = String(now);
}

function ajustarDataParaAno(){
  const ano = Number($("#gols-ano").value);
  const dataEl = $("#gols-data");
  if(!dataEl.value){
    dataEl.value = hojeISO();
  }
  // se a data estiver em outro ano, joga para 01/01 do ano selecionado
  const cur = dataEl.value;
  if(cur && Number(cur.slice(0,4)) !== ano){
    dataEl.value = `${ano}-01-01`;
  }
}

async function carregarJogadores(){
  const sel = $("#gols-apelido");
  if(!sel) return;

  sel.innerHTML = '<option value="">-- selecione --</option>';

  const { data, error } = await sb
    .from("jogadores")
    .select("apelido")
    .order("apelido", { ascending: true });

  if(error){
    console.error("Erro ao carregar jogadores:", error);
    setStatus("Erro ao carregar jogadores (ver console).", true);
    return;
  }

  const apelidos = (data || [])
    .map(r => (r.apelido || "").trim())
    .filter(Boolean);

  for(const apelido of apelidos){
    const opt = document.createElement("option");
    opt.value = apelido;
    opt.textContent = apelido;
    sel.appendChild(opt);
  }
}

function intervaloAno(ano){
  const start = `${ano}-01-01`;
  const end = `${ano}-12-31`;
  return { start, end };
}

async function carregarGolsDoAno(){
  const ano = Number($("#gols-ano").value);
  $("#gols-ano-label").textContent = String(ano);

  const { start, end } = intervaloAno(ano);

  const { data, error } = await sb
    .from("gols")
    .select("*")
    .gte("data", start)
    .lte("data", end)
    .order("data", { ascending: true })
    .order("id", { ascending: true });

  if(error){
    console.error("Erro ao carregar gols:", error);
    setStatus("Erro ao carregar gols (ver console).", true);
    golsAno = [];
  }else{
    golsAno = data || [];
    setStatus(`Arquivo anual ${ano} carregado. Registros: ${golsAno.length}`, false);
  }

  renderGolsRegistrados();
  renderArtilharia();
}

function formatBR(iso){
  if(!iso) return "";
  // iso: yyyy-mm-dd
  const [y,m,d] = iso.split("-");
  if(!y || !m || !d) return iso;
  return `${d}/${m}/${y}`;
}

function renderGolsRegistrados(){
  const tbody = $("#tabela-gols-registrados tbody");
  if(!tbody) return;

  tbody.innerHTML = "";

  for(const row of golsAno){
    const tr = document.createElement("tr");

    // EXCLUIR
    const tdX = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "btn-excluir";
    btn.textContent = "X";
    btn.addEventListener("click", () => excluirRegistro(row.id));
    tdX.appendChild(btn);

    const tdData = document.createElement("td");
    tdData.textContent = formatBR(row.data);

    const tdApelido = document.createElement("td");
    tdApelido.textContent = row.apelido || "";

    const tdGols = document.createElement("td");
    tdGols.textContent = String(row.gols ?? "");

    tr.appendChild(tdX);
    tr.appendChild(tdData);
    tr.appendChild(tdApelido);
    tr.appendChild(tdGols);

    tbody.appendChild(tr);
  }
}

function renderArtilharia(){
  const tbody = $("#tabela-artilharia tbody");
  if(!tbody) return;

  const mapa = {};
  for(const row of golsAno){
    const a = (row.apelido || "").trim();
    if(!a) continue;
    const g = Number(row.gols || 0);
    mapa[a] = (mapa[a] || 0) + g;
  }

  const ranking = Object.entries(mapa)
    .map(([apelido, total]) => ({ apelido, total }))
    .sort((a,b) => b.total - a.total || a.apelido.localeCompare(b.apelido));

  tbody.innerHTML = "";

  let pos = 1;
  for(const r of ranking){
    const tr = document.createElement("tr");

    const tdPos = document.createElement("td");
    tdPos.textContent = String(pos++);

    const tdApelido = document.createElement("td");
    tdApelido.textContent = r.apelido;

    const tdTotal = document.createElement("td");
    tdTotal.textContent = String(r.total);

    tr.appendChild(tdPos);
    tr.appendChild(tdApelido);
    tr.appendChild(tdTotal);

    tbody.appendChild(tr);
  }
}

async function salvarGol(){
  try{
    const ano = Number($("#gols-ano").value);
    const data = $("#gols-data").value;
    const apelido = $("#gols-apelido").value;
    const qtd = Number($("#gols-quantidade").value);

    if(!data){ setStatus("Selecione a DATA.", true); return; }
    if(Number(data.slice(0,4)) !== ano){
      setStatus("A DATA precisa estar no mesmo ANO selecionado.", true);
      return;
    }
    if(!apelido){ setStatus("Selecione o APELIDO.", true); return; }
    if(!qtd || qtd < 1){ setStatus("Informe a quantidade de GOLS.", true); return; }

    const { error } = await sb.from("gols").insert([{ data, apelido, gols: qtd }]);

    if(error){
      console.error("Erro ao salvar gol:", error);
      setStatus("Erro ao salvar (ver console).", true);
      return;
    }

    setStatus("Gol salvo com sucesso.", false);
    await carregarGolsDoAno();
  }catch(e){
    console.error(e);
    setStatus("Erro inesperado (ver console).", true);
  }
}

async function excluirRegistro(id){
  try{
    if(!id) return;
    const ok = confirm("Excluir este registro de gol?");
    if(!ok) return;

    const { error } = await sb.from("gols").delete().eq("id", id);
    if(error){
      console.error("Erro ao excluir:", error);
      setStatus("Erro ao excluir (ver console).", true);
      return;
    }
    setStatus("Registro excluído.", false);
    await carregarGolsDoAno();
  }catch(e){
    console.error(e);
    setStatus("Erro inesperado ao excluir (ver console).", true);
  }
}

function baixarPDF(){
  const ano = Number($("#gols-ano").value);

  const painel = document.querySelector(".container");
  if(!painel) return;

  // monta um HTML simples só com o conteúdo visível
  const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>TESOURA - GOLS - ${ano}</title>
  <style>
    @page { size: landscape; margin: 10mm; }
    body { font-family: Arial, sans-serif; color: #000; }
    h1 { font-size: 18px; margin: 0 0 8px 0; }
    .sub { font-size: 12px; margin: 0 0 12px 0; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border: 1px solid #333; padding: 6px; text-align: center; }
    th { background: #ff7a00; color: #000; }
    .wrap { display: flex; gap: 12px; }
    .card { width: 50%; }
  </style>
</head>
<body>
  <h1>TESOURA - CONTROLE DE GOLS</h1>
  <div class="sub">Arquivo anual: ${ano}</div>

  <div class="wrap">
    <div class="card">
      <h3>Gols registrados</h3>
      <table>
        <thead><tr><th>DATA</th><th>APELIDO</th><th>GOLS</th></tr></thead>
        <tbody>
          ${golsAno.map(r => `<tr><td>${formatBR(r.data)}</td><td>${(r.apelido||"")}</td><td>${(r.gols??"")}</td></tr>`).join("")}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Artilharia</h3>
      <table>
        <thead><tr><th>#</th><th>APELIDO</th><th>TOTAL GOLS</th></tr></thead>
        <tbody>
          ${(() => {
            const mapa = {};
            for(const row of golsAno){
              const a = (row.apelido || "").trim();
              if(!a) continue;
              const g = Number(row.gols || 0);
              mapa[a] = (mapa[a] || 0) + g;
            }
            const ranking = Object.entries(mapa)
              .map(([apelido, total]) => ({ apelido, total }))
              .sort((a,b) => b.total - a.total || a.apelido.localeCompare(b.apelido));
            let pos=1;
            return ranking.map(r => `<tr><td>${pos++}</td><td>${r.apelido}</td><td>${r.total}</td></tr>`).join("");
          })()}
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>`;

    // imprime sem pop-up (mais compatível no celular)
  const iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.right = "0";
  iframe.style.bottom = "0";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  iframe.srcdoc = html;
  document.body.appendChild(iframe);

  iframe.onload = () => {
    try{
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
    }catch(e){
      console.error("Erro ao imprimir PDF:", e);
      alert("Não foi possível abrir o PDF. Tente novamente em outro navegador.");
    }
    // remove depois (não atrapalha o uso)
    setTimeout(() => {
      try{ document.body.removeChild(iframe); }catch(e){}
    }, 2000);
  };
}

document.addEventListener("DOMContentLoaded", async () => {
  try{
    sb = getSupabaseClient();

    // UI
    popularAnos();
    const dataEl = $("#gols-data");
    if(dataEl && !dataEl.value) dataEl.value = hojeISO();
    ajustarDataParaAno();

    // eventos
    $("#gols-ano").addEventListener("change", async () => {
      ajustarDataParaAno();
      await carregarGolsDoAno();
    });

    $("#gols-salvar-btn").addEventListener("click", salvarGol);

    const btnPdf = $("#gols-pdf-btn");
    if(btnPdf) btnPdf.addEventListener("click", baixarPDF);

    // init
    await carregarJogadores();
    await carregarGolsDoAno();

  }catch(e){
    console.error(e);
    setStatus("Erro ao iniciar o painel (ver console).", true);
  }
});
</script>
</body>
</html>
