<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesoura - Jogadores</title>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#071225;
      --panel:#0c1b33;
      --panel2:#0b1730;
      --line:#203a5e;
      --text:#e9f1ff;
      --muted:#b7c6e6;
      --orange:#ff7a1a;
      --green:#22c55e;
      --red:#ef4444;
      --blue:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #050b17, var(--bg));
      color:var(--text);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(255,255,255,.06);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(6px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.4px;
    }
    .brand .logo{
      width:28px;height:28px;
      border-radius:9px;
      background:var(--orange);
      color:#0b1220;
      display:grid;
      place-items:center;
      font-weight:900;
    }
    .nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      text-decoration:none;
    }
    .tab.active{ background:rgba(255,122,26,.18); border-color:rgba(255,122,26,.45); }
    .rightActions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      padding:7px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-size:12px;
      font-weight:700;
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.3px;
      box-shadow: var(--shadow);
    }
    .btn.btn-orange{ background:var(--orange); color:#071225; }
    .btn.btn-green{ background:var(--green); color:#071225; }
    .btn.btn-red{ background:var(--red); color:#071225; }
    .btn.btn-blue{ background:var(--blue); color:#071225; }
    .container{
      max-width:1200px;
      margin:18px auto;
      padding:0 14px 60px;
    }
    h1{
      margin:14px 0 12px;
      font-size:26px;
      letter-spacing:.8px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-top:14px;
    }
    .title{
      color:var(--orange);
      font-weight:900;
      letter-spacing:.6px;
      margin:0 0 10px;
      font-size:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    .field label{
      display:block;
      font-size:11px;
      font-weight:900;
      color:var(--text);
      margin:0 0 6px;
    }
    .field input, .field select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:700;
    }
    .field input:disabled{
      opacity:.7;
      cursor:not-allowed;
    }
    .actions{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    #status{
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
    }
    thead th{
      background:rgba(255,122,26,.92);
      color:#071225;
      font-weight:900;
      font-size:12px;
      padding:10px 10px;
      text-align:left;
      border-right:1px solid rgba(0,0,0,.08);
    }
    tbody td{
      padding:9px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:12px;
      font-weight:700;
      color:var(--text);
    }
    tbody tr:hover td{ background:rgba(96,165,250,.07); }
    .smallHint{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      margin:6px 0 0;
    }

    /* Aniversariantes compacto */
    #birthdayPanel{
      max-height:160px;
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
    }

    /* A lista precisa aparecer sem depender de botão */
    #btnReload { display:none; }

    /* Área de impressão */
    #printArea{
      display:none;
      padding:18px;
      color:#000;
      font-family:Arial, sans-serif;
    }
    #printArea h1{
      margin:0 0 10px;
      font-size:18px;
      color:#000;
    }
    #printArea table{
      width:100%;
      border-collapse:collapse;
    }
    #printArea th, #printArea td{
      border:1px solid #333;
      padding:6px 8px;
      font-size:12px;
      color:#000;
    }
  </style>
</head>

<body>
  <div id="topoPainel"></div>

  <div class="topbar">
    <div class="brand">
      <div class="logo">T</div>
      <div>Tesoura — Controle do Futebol</div>
    </div>

    <div class="nav">
      <a class="tab active" href="#">JOGADORES</a>
      <a class="tab" href="tesoura_presenca_escala_R5.html">PRESENÇA / ESCALAÇÃO</a>
      <a class="tab" href="tesoura_controle_geral_teste.html">CONTROLE GERAL</a>
      <a class="tab" href="tesoura_mensalidade_R4.html">MENSALIDADE</a>
      <a class="tab" href="tesoura_caixa_teste.html">CAIXA</a>
      <a class="tab" href="tesoura_gols_teste.html">GOLS</a>
    </div>

    <div class="rightActions">
      <div class="pill" id="acessoLabel">Acesso da Diretoria (edita).</div>
      <button class="btn btn-orange" id="btnLogin">LOGIN</button>
      <button class="btn btn-blue" id="btnSair">SAIR</button>
    </div>
  </div>

  <div class="container">
    <h1>TESOURA - JOGADORES</h1>

    <div class="card">
      <div class="title">CADASTRAR / EDITAR JOGADOR</div>

      <div class="grid">
        <div class="field">
          <label>NÚMERO DA CAMISA:</label>
          <input id="inCamisa" type="number" placeholder="Ex: 10">
        </div>
        <div class="field">
          <label>NOME COMPLETO:</label>
          <input id="inNome" type="text" placeholder="Ex: JOÃO SILVA">
        </div>
        <div class="field">
          <label>APELIDO (ÚNICO):</label>
          <input id="inApelido" type="text" placeholder="Ex: JOÃO">
        </div>
        <div class="field">
          <label>DATA DE NASCIMENTO:</label>
          <input id="inDataNasc" type="date">
        </div>

        <div class="field">
          <label>CELULAR (WHATSAPP):</label>
          <input id="inCelular" type="text" placeholder="Ex: 21999999999">
        </div>
        <div class="field">
          <label>POSIÇÃO (Z/L/M/A):</label>
          <input id="inPosicao" type="text" placeholder="Z, L, M, A">
        </div>
        <div class="field">
          <label>HABILIDADE (1–5):</label>
          <input id="inHab" type="number" min="1" max="5">
        </div>
        <div class="field">
          <label>VELOCIDADE (1–2, N_3 *):</label>
          <input id="inVel" type="number" min="0" max="5">
        </div>

        <div class="field">
          <label>MOVIMENTAÇÃO (1–2, N_3 *):</label>
          <input id="inMov" type="number" min="0" max="5">
        </div>
        <div class="field">
          <label>PONTOS:</label>
          <input id="inPontos" type="number" disabled>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-green" id="btnSalvar">SALVAR JOGADOR</button>
        <button class="btn btn-orange" id="btnCancelar">CANCELAR EDIÇÃO</button>
      </div>

      <div id="status">Pronto.</div>
    </div>

    <div class="card">
      <div class="title">ANIVERSARIANTES DO MÊS</div>
      <div class="smallHint" id="birthdayHint">Carregando...</div>
      <div id="birthdayPanel">
        <table id="birthdayTable">
          <thead>
            <tr>
              <th>APELIDO</th>
              <th>DATA</th>
            </tr>
          </thead>
          <tbody id="birthdayBody">
            <tr><td colspan="2" style="text-align:center;color:#bbb">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="title">LISTA DE JOGADORES</div>
      <div class="smallHint">ZAGUEIRO = Z &nbsp;&nbsp; LATERAL = L &nbsp;&nbsp; MEIO = M &nbsp;&nbsp; ATAQUE = A</div>
      <div class="actions" style="margin-top:10px">
        <button class="btn btn-blue" id="btnReload">RECARREGAR LISTA</button>
        <button class="btn btn-blue" id="btnPdfAtual">BAIXAR PDF (ATUAL)</button>
      </div>
      <div class="smallHint" style="margin-top:8px">ORDEM ALFABÉTICA POR APELIDO. COLUNA IDADE É CALCULADA AUTOMÁTICA.</div>

      <div style="margin-top:10px; overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.06);">
        <table>
          <thead>
            <tr>
              <th>ORDEM</th>
              <th>ID</th>
              <th>CAMISA</th>
              <th>APELIDO</th>
              <th>NOME</th>
              <th>DATA NASC.</th>
              <th>IDADE</th>
              <th>CELULAR</th>
              <th>POSIÇÃO</th>
              <th>HAB</th>
              <th>VEL</th>
              <th>MOV</th>
              <th>PONTOS</th>
              <th>EDITAR</th>
              <th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbodyJogadores"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:14px; padding:14px;">
        <div class="title" style="margin-bottom:8px;">HISTÓRICO (ANO / MÊS)</div>
        <div class="actions" style="margin-top:6px;">
          <select id="histAno"></select>
          <select id="histMes"></select>
          <button class="btn btn-green" id="btnHistBuscar">BUSCAR</button>
          <button class="btn btn-orange" id="btnHistLimpar">LIMPAR</button>
        </div>
        <div class="smallHint" id="histMsg">Selecione ANO e MÊS e clique em BUSCAR para baixar o PDF do mês.</div>
      </div>

      <div class="smallHint" style="text-align:right;margin-top:10px">ARQUIVO: tesoura_jogadores_teste.html</div>
    </div>
  </div>

  <div id="printArea"></div>

  <script>
    // ===== SUPABASE FIXO (fonte única) =====
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    var supabase = window.__TESOURA_SUPABASE__;

    // ===== STATE =====
    const statusEl = document.getElementById("status");
    const tbody = document.getElementById("tbodyJogadores");

    const camisaInput = document.getElementById("inCamisa");
    const nomeInput = document.getElementById("inNome");
    const apelidoInput = document.getElementById("inApelido");
    const dataNascInput = document.getElementById("inDataNasc");
    const celularInput = document.getElementById("inCelular");
    const posicaoInput = document.getElementById("inPosicao");
    const habInput = document.getElementById("inHab");
    const velInput = document.getElementById("inVel");
    const movInput = document.getElementById("inMov");
    const pontosInput = document.getElementById("inPontos");

    const btnSalvar = document.getElementById("btnSalvar");
    const btnCancelar = document.getElementById("btnCancelar");

    let editId = null;
    let editApelidoOriginal = null;

    let JOGADORES_CACHE = [];

    function idadeFromISO(dateIso){
      try{
        if(!dateIso) return "";
        const d = new Date(dateIso);
        if(isNaN(d.getTime())) return "";
        const now = new Date();
        let age = now.getFullYear() - d.getFullYear();
        const m = now.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
        return age;
      }catch(e){
        return "";
      }
    }

      function renderAniversariantes(lista){
        try{
          const body = document.getElementById("birthdayBody");
          const hint = document.getElementById("birthdayHint");
          if(!body) return;

          const now = new Date();
          const mes = now.getMonth() + 1; // 1-12

          // aceita "YYYY-MM-DD" ou "DD/MM/AAAA"
          function parseMesDia(v){
            if(!v) return null;
            if(typeof v !== "string") return null;
            v = v.trim();
            // YYYY-MM-DD
            if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
              const mm = Number(v.slice(5,7));
              const dd = Number(v.slice(8,10));
              return {mm, dd};
            }
            // DD/MM/AAAA
            if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
              const dd = Number(v.slice(0,2));
              const mm = Number(v.slice(3,5));
              return {mm, dd};
            }
            return null;
          }

          const anivers = (Array.isArray(lista)?lista:[])
            .map(j=>{
              const md = parseMesDia(j.data_nasc || j.data_nascimento || "");
              if(!md) return null;
              return { apelido: String(j.apelido||"").toUpperCase(), mm: md.mm, dd: md.dd };
            })
            .filter(x=>x && x.mm === mes && x.apelido)
            .sort((a,b)=>a.dd-b.dd || a.apelido.localeCompare(b.apelido));

          if(anivers.length === 0){
            body.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#bbb">Nenhum aniversariante neste mês.</td></tr>`;
            if(hint) hint.textContent = "";
            return;
          }

          body.innerHTML = anivers.map(a=>{
            const dd = String(a.dd).padStart(2,"0");
            const mm = String(a.mm).padStart(2,"0");
            return `<tr><td>${a.apelido}</td><td>${dd}/${mm}</td></tr>`;
          }).join("");

          if(hint) hint.textContent = `Total: ${anivers.length}`;
        }catch(e){
          console.warn("Falha ao renderizar aniversariantes:", e);
        }
      }

    function clearForm(){
      editId = null;
      editApelidoOriginal = null;
      camisaInput.value = "";
      nomeInput.value = "";
      apelidoInput.value = "";
      dataNascInput.value = "";
      celularInput.value = "";
      posicaoInput.value = "";
      habInput.value = "";
      velInput.value = "";
      movInput.value = "";
      pontosInput.value = "";
      btnSalvar.textContent = "SALVAR JOGADOR";
      statusEl.textContent = "Pronto.";
    }

    function calcPontos(){
      const hab = habInput.value ? parseInt(habInput.value,10) : 0;
      const vel = velInput.value ? parseInt(velInput.value,10) : 0;
      const mov = movInput.value ? parseInt(movInput.value,10) : 0;
      const pontos = (hab||0) + (vel||0) + (mov||0);
      pontosInput.value = pontos ? String(pontos) : "";
    }

    habInput.addEventListener("input", calcPontos);
    velInput.addEventListener("input", calcPontos);
    movInput.addEventListener("input", calcPontos);

    async function carregarJogadores(){
      statusEl.textContent = "Carregando jogadores...";
      const { data, error } = await supabase.from("jogadores").select("*").order("apelido", { ascending:true });

      if(error){
        console.error(error);
        statusEl.textContent = "ERRO AO CARREGAR JOGADORES.";
        return;
      }

      JOGADORES_CACHE = Array.isArray(data) ? data : [];

      tbody.innerHTML = "";
      let ordem = 0;

      (data||[]).forEach(j=>{
        ordem++;

        const tr = document.createElement("tr");
        const idade = idadeFromISO(j.data_nasc);

        tr.innerHTML = `
          <td>${ordem}</td>
          <td>${j.id ?? ""}</td>
          <td>${j.camisa ?? ""}</td>
          <td>${(j.apelido ?? "").toUpperCase()}</td>
          <td>${(j.nome ?? "").toUpperCase()}</td>
          <td>${j.data_nasc ?? ""}</td>
          <td>${idade}</td>
          <td>${j.celular ?? ""}</td>
          <td>${(j.posicao ?? "").toUpperCase()}</td>
          <td>${j.hab ?? ""}</td>
          <td>${j.vel ?? ""}</td>
          <td>${j.mov ?? ""}</td>
          <td>${j.pontos ?? ""}</td>
        `;

        const tdEditar = document.createElement("td");
        const btnE = document.createElement("button");
        btnE.textContent = "EDITAR";
        btnE.className = "btn btn-blue";
        btnE.style.padding = "6px 10px";
        btnE.style.fontSize = "11px";
        btnE.addEventListener("click", async ()=>{
          editId = Number(j.id);
          // guarda apelido original (para permitir correção sem quebrar FK em mensalidades)
          editApelidoOriginal = String(j.apelido || "").trim().toUpperCase();
          // sobe para o topo do formulário automaticamente
          document.getElementById("topoPainel")?.scrollIntoView({ behavior: "smooth", block: "start" });

          camisaInput.value = j.camisa ?? "";
          nomeInput.value = j.nome ?? "";
          apelidoInput.value = j.apelido ?? "";
          dataNascInput.value = j.data_nasc ?? "";
          celularInput.value = j.celular ?? "";
          posicaoInput.value = (j.posicao ?? "").toUpperCase();
          habInput.value = j.hab ?? "";
          velInput.value = j.vel ?? "";
          movInput.value = j.mov ?? "";
          pontosInput.value = j.pontos ?? "";
          statusEl.textContent = "Editando jogador ID " + j.id;
          btnSalvar.textContent = "SALVAR ALTERAÇÃO";
        });
        tdEditar.appendChild(btnE);
        tr.appendChild(tdEditar);

        const tdExcluir = document.createElement("td");
        const btnX = document.createElement("button");
        btnX.textContent = "EXCLUIR";
        btnX.className = "btn btn-red";
        btnX.style.padding = "6px 10px";
        btnX.style.fontSize = "11px";
        btnX.addEventListener("click", async ()=>{
          if(!confirm("Excluir este jogador?")) return;
          await excluirJogador(j.id);
        });
        tdExcluir.appendChild(btnX);
        tr.appendChild(tdExcluir);

        tbody.appendChild(tr);
      });

      renderAniversariantes(data);
      statusEl.textContent = "TOTAL DE JOGADORES: " + (data||[]).length;
    }

    async function excluirJogador(id){
      statusEl.textContent = "Excluindo jogador...";
      const { error } = await supabase.from("jogadores").delete().eq("id", id);

      if(error){
        console.error(error);
        statusEl.textContent = "ERRO AO EXCLUIR JOGADOR: " + (error.message || JSON.stringify(error));
        return;
      }

      statusEl.textContent = "JOGADOR EXCLUÍDO COM SUCESSO.";
      await carregarJogadores();
    }

    async function salvarJogador(){
      let camisa = camisaInput.value ? parseInt(camisaInput.value,10) : null;
      let nome = nomeInput.value.trim().toUpperCase();
      let apelido = apelidoInput.value.trim().toUpperCase();
      let data_nasc = dataNascInput.value || null;
      let celular = celularInput.value.trim();
      let posicao = posicaoInput.value.trim().toUpperCase().slice(0,1);
      if(posicao === "D") posicao = "Z";
      if(posicao && !["Z","L","M","A"].includes(posicao)){
        statusEl.textContent = "POSIÇÃO inválida. Use: Z, L, M, A.";
        return;
      }
      let hab = habInput.value ? parseInt(habInput.value,10) : null;
      let vel = velInput.value ? parseInt(velInput.value,10) : null;
      let mov = movInput.value ? parseInt(movInput.value,10) : null;

      let pontos = null;
      if(hab !== null || vel !== null || mov !== null){
        pontos = (hab||0) + (vel||0) + (mov||0);
      }

      if(!apelido){
        statusEl.textContent = "APELIDO é obrigatório.";
        return;
      }

      const payload = {
        camisa,
        nome: nome || null,
        apelido,
        data_nasc,
        celular: celular || null,
        posicao: posicao || null,
        hab,
        vel,
        mov,
        pontos,
        ativo: true
      };

      statusEl.textContent = "Salvando jogador...";
      let error;

      // FIX: permitir corrigir APELIDO sem quebrar FK (mensalidades_apelido_fkey)
      const novoApelido = String(payload.apelido || "").trim();
      const apelidoAntigo = String(editApelidoOriginal || "").trim();

      if(editId !== null && apelidoAntigo && novoApelido && novoApelido !== apelidoAntigo){
        // 1) cria NOVO jogador com novo apelido
        const ins = await supabase.from("jogadores").insert(payload).select("id").single();
        if(ins.error){
          statusEl.textContent = "ERRO AO SALVAR JOGADOR: " + (ins.error.message || JSON.stringify(ins.error));
          return;
        }
        const newId = ins.data?.id;

        // 2) move mensalidades do apelido antigo para o novo
        const updMens = await supabase.from("mensalidades").update({ apelido: novoApelido }).eq("apelido", apelidoAntigo);
        if(updMens.error){
          // rollback: remove jogador novo
          await supabase.from("jogadores").delete().eq("id", newId);
          statusEl.textContent = "ERRO AO SALVAR JOGADOR: " + (updMens.error.message || JSON.stringify(updMens.error));
          return;
        }

        // 3) apaga jogador antigo (agora sem referências)
        const delOld = await supabase.from("jogadores").delete().eq("id", editId);
        if(delOld.error){
          statusEl.textContent = "ATENÇÃO: mensalidades migradas, mas falhou ao remover jogador antigo. " + (delOld.error.message || JSON.stringify(delOld.error));
          await carregarJogadores();
          clearForm();
          return;
        }

        statusEl.textContent = "JOGADOR ATUALIZADO (apelido corrigido) COM SUCESSO.";
        await carregarJogadores();
        clearForm();
        return;
      }

      if(editId !== null){
        const upd = await supabase.from("jogadores").update(payload).eq("id", editId);
        error = upd.error;
      }else{
        const ins = await supabase.from("jogadores").insert(payload);
        error = ins.error;
      }

      if(error){
        console.error(error);
        statusEl.textContent = "ERRO AO SALVAR JOGADOR: " + (error.message || JSON.stringify(error));
        return;
      }

      statusEl.textContent = "SALVO COM SUCESSO.";
      await carregarJogadores();
      clearForm();
    }

    btnSalvar.addEventListener("click", salvarJogador);
    btnCancelar.addEventListener("click", clearForm);

    // ===== PDF (ATUAL + HISTÓRICO) =====
    function ymRef(y,m){ return `${y}-${String(m).padStart(2,"0")}`; }
    function ymTitulo(y,m){ return `JOGADORES - LISTA (${String(m).padStart(2,"0")}/${y})`; }

    function jogadoresToTable(players){
      const list = Array.isArray(players) ? players : [];
      const rows = list.map((j,idx)=>{
        const idade = idadeFromISO(j.data_nasc);
        return `
          <tr>
            <td>${idx+1}</td>
            <td>${j.id ?? ""}</td>
            <td>${j.camisa ?? ""}</td>
            <td>${(j.apelido ?? "").toUpperCase()}</td>
            <td>${(j.nome ?? "").toUpperCase()}</td>
            <td>${j.data_nasc ?? ""}</td>
            <td>${idade}</td>
            <td>${j.celular ?? ""}</td>
            <td>${(j.posicao ?? "").toUpperCase()}</td>
            <td>${j.hab ?? ""}</td>
            <td>${j.vel ?? ""}</td>
            <td>${j.mov ?? ""}</td>
            <td>${j.pontos ?? ""}</td>
          </tr>`;
      }).join("");

      return `
        <table>
          <thead>
            <tr>
              <th>ORDEM</th><th>ID</th><th>CAMISA</th><th>APELIDO</th><th>NOME</th>
              <th>DATA NASC.</th><th>IDADE</th><th>CELULAR</th><th>POS</th>
              <th>HAB</th><th>VEL</th><th>MOV</th><th>PONTOS</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function printJogadores(list, titulo){
      const printArea = document.getElementById("printArea");
      const now = new Date();
      const dt = now.toLocaleString("pt-BR");
      printArea.innerHTML = `
        <h1>${titulo || "JOGADORES - LISTA"}</h1>
        <div style="margin-bottom:10px;font-size:12px;">Gerado em: ${dt}</div>
        ${jogadoresToTable(list)}
      `;
      const w = window.open("", "_blank");
      w.document.write("<html><head><title>"+(titulo||"Jogadores")+"</title></head><body>");
      w.document.write(printArea.innerHTML);
      w.document.write("</body></html>");
      w.document.close();
      w.focus();
      w.print();
    }

    document.getElementById("btnPdfAtual").addEventListener("click", ()=>{
      if(!Array.isArray(JOGADORES_CACHE) || JOGADORES_CACHE.length===0){
        alert("Lista vazia. Aguarde carregar.");
        return;
      }
      const now = new Date();
      const titulo = ymTitulo(now.getFullYear(), now.getMonth()+1);
      printJogadores(JOGADORES_CACHE, titulo);
    });

    // ===== SNAPSHOT + HISTÓRICO (Supabase) =====
    (function(){
      const TABLE_ARQUIVOS = "arquivos_app";

      function fillHistSelectors(){
        const selY = document.getElementById("histAno");
        const selM = document.getElementById("histMes");
        if(!selY || !selM) return;

        const now = new Date();
        const thisY = now.getFullYear();
        const minY = thisY - 1;

        selY.innerHTML = "";
        for(let y=thisY; y>=minY; y--){
          const o=document.createElement("option");
          o.value=String(y); o.textContent=String(y);
          selY.appendChild(o);
        }

        const meses = [
          ["01","JAN"],["02","FEV"],["03","MAR"],["04","ABR"],["05","MAI"],["06","JUN"],
          ["07","JUL"],["08","AGO"],["09","SET"],["10","OUT"],["11","NOV"],["12","DEZ"]
        ];
        selM.innerHTML="";
        meses.forEach(([v,t])=>{
          const o=document.createElement("option");
          o.value=v; o.textContent=`${v} - ${t}`;
          selM.appendChild(o);
        });

        selY.value = String(thisY);
        selM.value = String(now.getMonth()+1).padStart(2,"0");
      }

      function shouldAutoSnapshotNearDay1(){
        const d=new Date().getDate();
        return d>=1 && d<=3;
      }

  // Supabase (fonte única): já inicializado no topo do arquivo
  const sb = window.__TESOURA_SUPABASE__;
  if(!sb || !sb.from){ console.warn('Supabase não inicializado.'); }

      async function salvarSnapshotJogadores(motivo){
        try{
          if(!sb || !sb.from) return;
          if(!Array.isArray(JOGADORES_CACHE) || JOGADORES_CACHE.length===0) return;

          const now = new Date();
          const y = now.getFullYear();
          const m = now.getMonth()+1;
          const ref = ymRef(y,m);

          const payload = {
            painel: "jogadores",
            periodo: "mensal",
            referencia: ref,
            titulo: ymTitulo(y,m),
            tipo: "json",
            criado_em: now.toISOString(),
            conteudo: JSON.stringify(JOGADORES_CACHE),
            motivo: motivo || "auto"
          };

          await sb.from(TABLE_ARQUIVOS).insert([payload]);
          localStorage.setItem(`TESOURA_JOGADORES_SNAPSHOT_${ref}`, "1");
        }catch(e){
          console.warn("Snapshot jogadores falhou:", e);
        }
      }

      // salva snapshot quando salva/edita/exclui
      const __origSalvarJogador = salvarJogador;
      salvarJogador = async function(){
        const wasEditing = (editId !== null);
        await __origSalvarJogador();
        try{ await salvarSnapshotJogadores(wasEditing ? "editar" : "cadastrar"); }catch(e){}
      };

      const __origExcluirJogador = excluirJogador;
      excluirJogador = async function(id){
        await __origExcluirJogador(id);
        try{ await salvarSnapshotJogadores("excluir"); }catch(e){}
      };

      document.getElementById("btnHistBuscar")?.addEventListener("click", async ()=>{
        const msg = document.getElementById("histMsg");
        try{
          if(!sb || !sb.from){
            if(msg) msg.textContent = "Supabase não inicializado (volte para o login).";
            return;
          }
          const y = document.getElementById("histAno")?.value;
          const m = document.getElementById("histMes")?.value;
          if(!y || !m) return;

          const ref = `${y}-${m}`;
          if(msg) msg.textContent = "Buscando histórico...";

          const { data, error } = await sb
            .from(TABLE_ARQUIVOS)
            .select("conteudo,titulo,criado_em")
            .eq("painel","jogadores")
            .eq("referencia", ref)
            .order("criado_em", { ascending:false })
            .limit(1);

          if(error){
            if(msg) msg.textContent = "ERRO AO BUSCAR HISTÓRICO.";
            console.error(error);
            return;
          }
          if(!data || data.length===0){
            if(msg) msg.textContent = "Sem histórico para este mês.";
            return;
          }

          const item = data[0];
          const arr = JSON.parse(item.conteudo || "[]");
          printJogadores(arr, item.titulo || "JOGADORES - HISTÓRICO");
          if(msg) msg.textContent = "OK. PDF aberto.";
        }catch(e){
          console.error(e);
          const msg = document.getElementById("histMsg");
          if(msg) msg.textContent = "ERRO NO HISTÓRICO.";
        }
      });

      document.getElementById("btnHistLimpar")?.addEventListener("click", ()=>{
        const msg = document.getElementById("histMsg");
        if(msg) msg.textContent = "Selecione ANO e MÊS e clique em BUSCAR para baixar o PDF do mês.";
      });

      fillHistSelectors();

      // snapshot automático perto do dia 1 (uma vez por mês)
      (async ()=>{
        try{
          const now = new Date();
          const ref = ymRef(now.getFullYear(), now.getMonth()+1);
          const key = `TESOURA_JOGADORES_SNAPSHOT_${ref}`;
          if(shouldAutoSnapshotNearDay1() && !localStorage.getItem(key)){
            await salvarSnapshotJogadores("auto-dia1");
          }
        }catch(e){}
      })();

    })();

    // ===== INIT =====
    document.addEventListener("DOMContentLoaded", ()=>{
      carregarJogadores();
    });
  </script>
</body>
</html>
