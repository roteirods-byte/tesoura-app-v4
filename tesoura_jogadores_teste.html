<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tesoura - Jogadores</title>
  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --panel2:#0f172a;
      --line:#1f2937;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --orange:#f97316;
      --green:#2ecc71;
      --red:#ef4444;
      --btn:#111827;
      --btn2:#0b1120;
      --blue:#60a5fa;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--txt);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1, h2 { margin: 0 0 10px; font-weight: 800; letter-spacing: .5px; text-transform: uppercase; }
    h1 { font-size: 28px; }
    h2 { font-size: 18px; color: var(--orange); }
    .painel {
      background: linear-gradient(180deg, #0b1120 0%, #030712 100%);
      border: 1px solid #0f172a;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      margin-bottom: 14px;
    }
    label { font-size: 12px; color: var(--txt); font-weight: 700; }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #111827;
      outline: none;
      background: #0b1222;
      color: var(--txt);
      margin-top: 4px;
    }
    input::placeholder{ color: #556; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--txt);
      background: #111827;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .3px;
      text-transform: uppercase;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn-green { background: var(--green); color: #001a2e; }
    .btn-orange { background: var(--orange); color: #001a2e; }
    .btn-blue { background: var(--blue); color: #001a2e; }
    .btn-red { background: var(--red); color: #001a2e; }
    .btn-recarregar { background: var(--blue); color:#001a2e; padding:8px 10px; font-size: 12px; border-radius: 8px; font-weight:900; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      min-width: 980px;
    }
    th, td {
      border: 1px solid #0f172a;
      padding: 8px 10px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f97316;
      color: #0f172a;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) { background: #0b1120; }
    tr:nth-child(odd)  { background: #020617; }
    #status {
      font-size: 12px;
      margin-top: 4px;
      color: var(--muted);
    }
    .grid-form {
      display: grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap: 8px 12px;
    }
    @media (max-width: 900px) {
      .grid-form {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }

    .page-header{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  </style>
</head>
<body>
  <header class="page-header">
        <h1>TESOURA - JOGADORES</h1>
</header>

  <div class="container">
    <div class="painel">
      <h2>Cadastrar / Editar Jogador</h2>
      <div class="grid-form">
        <div>
          <label>NÚMERO DA CAMISA:</label><br />
          <input id="camisa" type="number" />
        </div>
        <div>
          <label>NOME COMPLETO:</label><br />
          <input id="nome" type="text" />
        </div>
        <div>
          <label>APELIDO (ÚNICO):</label><br />
          <input id="apelido" type="text" />
        </div>
        <div>
          <label>DATA DE NASCIMENTO:</label><br />
          <input id="data_nasc" type="date" />
        </div>

        <div>
          <label>CELULAR (WHATSAPP):</label><br />
          <input id="celular" type="text" />
        </div>
        <div>
          <label>POSIÇÃO (Z/L/M/A):</label><br />
          <input id="posicao" type="text" maxlength="1" />
        </div>
        <div>
          <label>HABILIDADE (1–5):</label><br />
          <input id="hab" type="number" min="1" max="5" />
        </div>
        <div>
          <label>VELOCIDADE (1–2, N_3_*):</label><br />
          <input id="vel" type="number" />
        </div>
        <div>
          <label>MOVIMENTAÇÃO (1–2, N_3_*):</label><br />
          <input id="mov" type="number" />
        </div>
        <div>
          <label>PONTOS:</label><br />
          <input id="pontos" type="number" disabled placeholder="HAB + VEL + MOV" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-green" id="btn-salvar">SALVAR JOGADOR</button>
        <button class="btn btn-orange" id="btn-cancelar">CANCELAR EDIÇÃO</button>
      </div>
      <p id="status"></p>
    </div>

    <div class="painel" style="overflow-x:auto;">
      <h2>Lista de Jogadores</h2>
      <button class="btn-recarregar" id="btn-recarregar">RECARREGAR LISTA</button>
      <p style="font-size:12px;">ORDEM ALFABÉTICA POR APELIDO. COLUNA IDADE É CALCULADA AUTOMÁTICA.</p>

      <table>
        <thead>
          <tr>
            <th>ORDEM</th>
            <th>ID</th>
            <th>CAMISA</th>
            <th>APELIDO</th>
            <th>NOME</th>
            <th>DATA NASC.</th>
            <th>IDADE</th>
            <th>CELULAR</th>
            <th>POSIÇÃO</th>
            <th>HAB</th>
            <th>VEL</th>
            <th>MOV</th>
            <th>PONTOS</th>
            <th>EDITAR</th>
            <th>EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tbody-jogadores"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    var supabase = window.__TESOURA_SUPABASE__;
    const camisaInput = document.getElementById("camisa");
    const nomeInput = document.getElementById("nome");
    const apelidoInput = document.getElementById("apelido");
    const dataNascInput = document.getElementById("data_nasc");
    const celularInput = document.getElementById("celular");
    const posicaoInput = document.getElementById("posicao");
    const habInput = document.getElementById("hab");
    const velInput = document.getElementById("vel");
    const movInput = document.getElementById("mov");
    const pontosInput = document.getElementById("pontos");

    const btnSalvar = document.getElementById("btn-salvar");
    const btnCancelar = document.getElementById("btn-cancelar");
    const btnRecarregar = document.getElementById("btn-recarregar");

    const tbody = document.getElementById("tbody-jogadores");
    const statusEl = document.getElementById("status");

    let editId = null;

    function el(id){ return document.getElementById(id); }

    function calcularIdade(dataISO) {
      if (!dataISO) return "";
      try {
        const nasc = new Date(dataISO);
        if (isNaN(nasc.getTime())) return "";
        const hoje = new Date();
        let idade = hoje.getFullYear() - nasc.getFullYear();
        const m = hoje.getMonth() - nasc.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
        if (idade < 0 || idade > 120) return "";
        return idade;
      } catch {
        return "";
      }
    }

    function limparFormulario() {
      editId = null;
      camisaInput.value = "";
      nomeInput.value = "";
      apelidoInput.value = "";
      dataNascInput.value = "";
      celularInput.value = "";
      posicaoInput.value = "";
      habInput.value = "";
      velInput.value = "";
      movInput.value = "";
      pontosInput.value = "";
      statusEl.textContent = "";
      btnSalvar.textContent = "SALVAR JOGADOR";
    }

    function atualizarPontos() {
      const hab = habInput.value ? parseInt(habInput.value, 10) : 0;
      const vel = velInput.value ? parseInt(velInput.value, 10) : 0;
      const mov = movInput.value ? parseInt(movInput.value, 10) : 0;
      const soma = (hab || 0) + (vel || 0) + (mov || 0);
      pontosInput.value = soma ? soma : "";
    }

    habInput.addEventListener("input", atualizarPontos);
    velInput.addEventListener("input", atualizarPontos);
    movInput.addEventListener("input", atualizarPontos);

    async function carregarJogadores() {
      statusEl.textContent = "Carregando jogadores...";
      tbody.innerHTML = "";
      const { data, error } = await supabase
        .from("jogadores")
        .select("id,camisa,apelido,nome,data_nasc,celular,posicao,hab,vel,mov,pontos,ativo")
        .order("apelido", { ascending: true });

      if (error) {
        console.error(error);
        statusEl.textContent = "ERRO AO CARREGAR JOGADORES.";
        return;
      }

      let ordem = 0;

      data.forEach(j => {
        ordem++;
        const tr = document.createElement("tr");

        function tdTexto(t) {
          const td = document.createElement("td");
          td.textContent = t ?? "";
          return td;
        }

        tr.appendChild(tdTexto(ordem));
        tr.appendChild(tdTexto(j.id));
        tr.appendChild(tdTexto(j.camisa ?? ""));
        tr.appendChild(tdTexto((j.apelido || "").toUpperCase()));
        tr.appendChild(tdTexto((j.nome || "").toUpperCase()));
        tr.appendChild(tdTexto(j.data_nasc || ""));

        const idade = calcularIdade(j.data_nasc);
        tr.appendChild(tdTexto(idade !== "" ? idade : ""));

        tr.appendChild(tdTexto(j.celular || ""));
        tr.appendChild(tdTexto((j.posicao || "").toUpperCase()));
        tr.appendChild(tdTexto(j.hab ?? ""));
        tr.appendChild(tdTexto(j.vel ?? ""));
        tr.appendChild(tdTexto(j.mov ?? ""));
        tr.appendChild(tdTexto(j.pontos ?? ""));

        const tdEditar = document.createElement("td");
        const btnE = document.createElement("button");
        btnE.textContent = "EDITAR";
        btnE.className = "btn btn-orange";
        btnE.style.padding = "6px 10px";
        btnE.style.fontSize = "11px";
        btnE.addEventListener("click", () => {
          editId = j.id;
          camisaInput.value = j.camisa ?? "";
          nomeInput.value = j.nome ?? "";
          apelidoInput.value = j.apelido ?? "";
          dataNascInput.value = j.data_nasc ?? "";
          celularInput.value = j.celular ?? "";
          posicaoInput.value = (j.posicao ?? "").toUpperCase();
          habInput.value = j.hab ?? "";
          velInput.value = j.vel ?? "";
          movInput.value = j.mov ?? "";
          pontosInput.value = j.pontos ?? "";
          statusEl.textContent = "Editando jogador ID " + j.id;
          btnSalvar.textContent = "SALVAR ALTERAÇÃO";
        });
        tdEditar.appendChild(btnE);
        tr.appendChild(tdEditar);

        const tdExcluir = document.createElement("td");
        const btnX = document.createElement("button");
        btnX.textContent = "EXCLUIR";
        btnX.className = "btn btn-red";
        btnX.style.padding = "6px 10px";
        btnX.style.fontSize = "11px";
        btnX.addEventListener("click", async () => {
          if (!confirm("Excluir este jogador?")) return;
          await excluirJogador(j.id);
        });
        tdExcluir.appendChild(btnX);
        tr.appendChild(tdExcluir);

        tbody.appendChild(tr);
      });

      statusEl.textContent = "TOTAL DE JOGADORES: " + data.length;
    }

    async function excluirJogador(id) {
      statusEl.textContent = "Excluindo jogador...";
      const { error } = await supabase.from("jogadores").delete().eq("id", id);

      if (error) {
        console.error(error);
        statusEl.textContent =
          "ERRO AO EXCLUIR JOGADOR: " + (error.message || JSON.stringify(error));
        return;
      }

      statusEl.textContent = "JOGADOR EXCLUÍDO COM SUCESSO.";
      carregarJogadores();
    }

    async function salvarJogador() {
      let camisa = camisaInput.value ? parseInt(camisaInput.value, 10) : null;
      let nome = nomeInput.value.trim().toUpperCase();
      let apelido = apelidoInput.value.trim().toUpperCase();
      let data_nasc = dataNascInput.value || null;
      let celular = celularInput.value.trim();
      let posicao = posicaoInput.value.trim().toUpperCase().slice(0,1);
      // compatibilidade: se digitar D, vira Z (Zagueiro)
      if(posicao === "D") posicao = "Z";
      if(posicao && !["Z","L","M","A"].includes(posicao)){
        statusEl.textContent = "POSIÇÃO inválida. Use: Z (Zagueiro), L (Lateral), M (Meio), A (Ataque).";
        return;
      }
      let hab = habInput.value ? parseInt(habInput.value, 10) : null;
      let vel = velInput.value ? parseInt(velInput.value, 10) : null;
      let mov = movInput.value ? parseInt(movInput.value, 10) : null;

      // calcular pontos automaticamente = HAB + VEL + MOV
      let pontos = null;
      if (hab !== null || vel !== null || mov !== null) {
        pontos = (hab || 0) + (vel || 0) + (mov || 0);
      }

      if (!apelido) {
        statusEl.textContent = "APELIDO é obrigatório.";
        return;
      }

      const payload = {
        camisa,
        nome: nome || null,
        apelido,
        data_nasc,
        celular: celular || null,
        posicao: posicao || null,
        hab,
        vel,
        mov,
        pontos,
        ativo: true
      };

      statusEl.textContent = "Salvando jogador...";
      let error;
      if (editId === null) {
        const resp = await supabase
          .from("jogadores")
          .insert(payload);
        error = resp.error;
      } else {
        const resp = await supabase
          .from("jogadores")
          .update(payload)
          .eq("id", editId);
        error = resp.error;
      }

      if (error) {
        console.error(error);
        statusEl.textContent = "ERRO AO SALVAR JOGADOR.";
        return;
      }

      statusEl.textContent = "JOGADOR SALVO COM SUCESSO.";
      limparFormulario();
      carregarJogadores();
    }

    function init() {
      carregarJogadores();
    }

    btnSalvar.addEventListener("click", salvarJogador);
    btnCancelar.addEventListener("click", limparFormulario);
    btnRecarregar.addEventListener("click", carregarJogadores);

    init();
  </script>
</body>
</html>
