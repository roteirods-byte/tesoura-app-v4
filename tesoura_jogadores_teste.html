<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TESOURA - JOGADORES</title>
  <link rel="stylesheet" href="app/css/ui.css">
  <script src="app/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{margin:0;background:#071023;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{padding:18px 18px 28px}
    .h1{font-size:34px;font-weight:900;letter-spacing:.5px;color:#ff7a18;margin:6px 0 16px}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;margin:14px 0}
    .grid2{display:grid;grid-template-columns: 1fr 1fr; gap:16px}
    .row2{display:grid;grid-template-columns: 220px 1fr; gap:16px; margin-top:10px}
    .row3{display:grid;grid-template-columns: 220px 220px 1fr; gap:16px; margin-top:10px}
    label{display:block;font-size:12px;color:#cfd6ff;margin:0 0 6px}
    input{width:100%;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:#fff;padding:0 12px;outline:none}
    input::placeholder{color:rgba(255,255,255,.35)}
    .btn{height:44px;border-radius:12px;border:0;padding:0 14px;font-weight:800;cursor:pointer}
    .btnGreen{background:#10d37d;color:#052014}
    .btnOrange{background:#ff7a18;color:#2b1304}
    .btnTiny{height:32px;border-radius:10px;border:0;padding:0 10px;font-weight:900;cursor:pointer}
    .tinyEdit{background:#ffb14a;color:#2b1304}
    .tinyDel{background:#ff3b3b;color:#2b0505}
    .meta{margin-top:8px;color:#cfd6ff;font-weight:800}
    .tableBox{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;min-width:980px;background:rgba(0,0,0,.15)}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:center;font-size:13px}
    th{background:rgba(255,122,24,.95);color:#211104;font-weight:900;position:sticky;top:0}
    .tdLeft{text-align:left}
    .topbar{display:flex;justify-content:flex-end;align-items:center;gap:10px}
    @media (max-width: 900px){
      .grid2,.row2,.row3{grid-template-columns:1fr}
      table{min-width:860px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="btn btnGreen" id="btnSalvarPainel">SALVAR PAINEL</button>
    </div>

    <div class="h1">TESOURA - JOGADORES</div>

    <div class="card">
      <div style="font-weight:900;color:#ff7a18;margin-bottom:10px">CADASTRAR / EDITAR JOGADOR</div>

      <div class="grid2">
        <div>
          <label>NÚMERO DA CAMISA:</label>
          <input id="camisa" placeholder="">
        </div>
        <div>
          <label>NOME COMPLETO:</label>
          <input id="nome" placeholder="">
        </div>
      </div>

      <div class="row2">
        <div>
          <label>APELIDO (ÚNICO):</label>
          <input id="apelido" placeholder="">
        </div>
        <div>
          <label>DATA DE NASCIMENTO:</label>
          <input id="nascimento" placeholder="dd/mm/aaaa">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>CELULAR (WHATSAPP):</label>
          <input id="celular" placeholder="">
        </div>
        <div>
          <label>POSIÇÃO (D/M/A):</label>
          <input id="posicao" placeholder="">
        </div>
        <div></div>
      </div>

      <div class="row3">
        <div>
          <label>HABILIDADE (1–5):</label>
          <input id="hab" placeholder="">
        </div>
        <div>
          <label>VELOCIDADE (1–2, N_3_*):</label>
          <input id="vel" placeholder="">
        </div>
        <div>
          <label>MOVIMENTAÇÃO (1–2, N_3_*):</label>
          <input id="mov" placeholder="">
        </div>
      </div>

      <div class="row2">
        <div>
          <label>PONTOS:</label>
          <input id="pontos" placeholder="" readonly>
        </div>
        <div></div>
      </div>

      <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
        <button class="btn btnGreen" id="btnSalvarJogador">SALVAR JOGADOR</button>
        <button class="btn btnOrange" id="btnCancelar">CANCELAR EDIÇÃO</button>
      </div>

      <div class="meta" id="totalJogadores">TOTAL DE JOGADORES: 0</div>
    </div>

    <div class="card">
      <div style="font-weight:900;color:#ff7a18;margin-bottom:10px">LISTA DE JOGADORES</div>
      <div style="color:#cfd6ff;font-size:12px;margin-bottom:10px">ORDEM ALFABÉTICA POR APELIDO. COLUNA IDADE É CALCULADA AUTOMÁTICA.</div>

      <div class="tableBox">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>CAMISA</th>
              <th>APELIDO</th>
              <th>NOME</th>
              <th>DATA NASC.</th>
              <th>IDADE</th>
              <th>CELULAR</th>
              <th>POSIÇÃO</th>
              <th>HAB</th>
              <th>VEL</th>
              <th>MOV</th>
              <th>PONTOS</th>
              <th>EDITAR</th>
              <th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbodyJogadores"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const CFG = window.TESOURA_CONFIG || {};
    const SB_URL = CFG.SUPABASE_URL || "";
    const SB_ANON = CFG.SUPABASE_ANON_KEY || "";
    const sb = supabase.createClient(SB_URL, SB_ANON);
    const el = (id)=>document.getElementById(id);

    function calcIdade(iso){
      if(!iso) return "";
      const a = new Date(iso);
      if(isNaN(a.getTime())) return "";
      const hoje = new Date();
      let idade = hoje.getFullYear() - a.getFullYear();
      const m = hoje.getMonth() - a.getMonth();
      if(m < 0 || (m === 0 && hoje.getDate() < a.getDate())) idade--;
      return idade;
    }
    function iso2br(iso){
      if(!iso) return "";
      const m = (iso||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return "";
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function br2iso(br){
      const t = (br||"").trim();
      const m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      return `${m[3]}-${m[2]}-${m[1]}`;
    }

    async function carregar(){
      const { data, error } = await sb.from("jogadores").select("*").order("apelido",{ascending:true});
      if(error){ console.error(error); return; }
      const tbody = el("tbodyJogadores");
      tbody.innerHTML = "";
      (data||[]).forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id||""}</td>
          <td>${(r.camisa||"").toString().toUpperCase()}</td>
          <td class="tdLeft">${(r.apelido||"").toUpperCase()}</td>
          <td class="tdLeft">${(r.nome||"").toUpperCase()}</td>
          <td>${iso2br(r.data_nasc||"")}</td>
          <td>${calcIdade(r.data_nasc||"")}</td>
          <td>${(r.celular||"")}</td>
          <td>${(r.posicao||"").toUpperCase()}</td>
          <td>${(r.hab||"")}</td>
          <td>${(r.vel||"")}</td>
          <td>${(r.mov||"")}</td>
          <td>${(r.pontos||"")}</td>
          <td><button class="btnTiny tinyEdit" data-id="${r.id}">EDITAR</button></td>
          <td><button class="btnTiny tinyDel" data-id="${r.id}">EXCLUIR</button></td>
        `;
        tbody.appendChild(tr);
      });
      el("totalJogadores").textContent = `TOTAL DE JOGADORES: ${(data||[]).length}`;
    }

    // ======= ATIVA SALVAR / EDITAR / EXCLUIR (JOGADORES) =======
    let editId = null;

    function limparForm(){
      editId = null;
      el("camisa").value = "";
      el("nome").value = "";
      el("apelido").value = "";
      el("nascimento").value = "";
      el("celular").value = "";
      el("posicao").value = "";
      el("hab").value = "";
      el("vel").value = "";
      el("mov").value = "";
      el("pontos").value = "";
    }

    function pontosAuto(){
      const hab = parseInt(el("hab").value || "0", 10) || 0;
      const vel = parseInt(el("vel").value || "0", 10) || 0;
      const mov = parseInt(el("mov").value || "0", 10) || 0;
      const p = hab + vel + mov;
      el("pontos").value = p ? String(p) : "";
      return p;
    }

    ["hab","vel","mov"].forEach(id=>{
      el(id).addEventListener("input", pontosAuto);
    });

    el("btnCancelar").addEventListener("click", ()=>{
      limparForm();
    });

    el("btnSalvarJogador").addEventListener("click", async ()=>{
      try{
        const apelido = (el("apelido").value || "").trim().toUpperCase();
        if(!apelido){ alert("INFORME O APELIDO (ÚNICO)."); return; }

        const nascBR = (el("nascimento").value || "").trim();
        const data_nasc = nascBR ? br2iso(nascBR) : null;
        if(nascBR && !data_nasc){ alert("DATA INVÁLIDA. Use dd/mm/aaaa"); return; }

        const payload = {
          camisa: el("camisa").value ? parseInt(el("camisa").value,10) : null,
          nome: (el("nome").value || "").trim().toUpperCase(),
          apelido,
          data_nasc,
          celular: (el("celular").value || "").trim(),
          posicao: (el("posicao").value || "").trim().toUpperCase().slice(0,1),
          hab: el("hab").value ? parseInt(el("hab").value,10) : null,
          vel: el("vel").value ? parseInt(el("vel").value,10) : null,
          mov: el("mov").value ? parseInt(el("mov").value,10) : null,
          pontos: pontosAuto()
        };

        let resp;
        if(editId === null){
          resp = await sb.from("jogadores").insert(payload);
        } else {
          resp = await sb.from("jogadores").update(payload).eq("id", editId);
        }

        if(resp.error){
          console.error(resp.error);
          alert("ERRO AO SALVAR: " + (resp.error.message||""));
          return;
        }

        alert("JOGADOR SALVO!");
        limparForm();
        await carregar();
      }catch(e){
        console.error(e);
        alert("ERRO NO PAINEL JOGADORES. Veja o Console.");
      }
    });

    el("tbodyJogadores").addEventListener("click", async (ev)=>{
      const btn = ev.target;
      if(!(btn instanceof HTMLElement)) return;

      const id = btn.getAttribute("data-id");
      if(!id) return;

      // EDITAR
      if(btn.classList.contains("tinyEdit")){
        const { data, error } = await sb.from("jogadores").select("*").eq("id", id).single();
        if(error){ console.error(error); alert("ERRO AO LER JOGADOR: " + (error.message||"")); return; }

        editId = data.id;
        el("camisa").value = data.camisa ?? "";
        el("nome").value = data.nome ?? "";
        el("apelido").value = data.apelido ?? "";
        el("nascimento").value = iso2br(data.data_nasc || "");
        el("celular").value = data.celular ?? "";
        el("posicao").value = data.posicao ?? "";
        el("hab").value = data.hab ?? "";
        el("vel").value = data.vel ?? "";
        el("mov").value = data.mov ?? "";
        el("pontos").value = data.pontos ?? "";
        window.scrollTo({top:0, behavior:"smooth"});
        return;
      }

      // EXCLUIR
      if(btn.classList.contains("tinyDel")){
        if(!confirm("CONFIRMAR EXCLUSÃO DO JOGADOR?")) return;

        const resp = await sb.from("jogadores").delete().eq("id", id);
        if(resp.error){
          console.error(resp.error);
          alert("ERRO AO EXCLUIR: " + (resp.error.message||""));
          return;
        }
        alert("JOGADOR EXCLUÍDO!");
        await carregar();
      }
    });

    // carrega tabela ao abrir
    carregar();
  </script>
</body>
</html>
