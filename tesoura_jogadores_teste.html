<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tesoura - Jogadores</title>
  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --panel2:#0f172a;
      --line:#1f2937;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --orange:#f97316;
      --green:#2ecc71;
      --red:#ef4444;
      --btn:#111827;
      --btn2:#0b1120;
      --blue:#60a5fa;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--txt);
    }
    .container { max-width: 1600px; width: calc(100vw - 32px); margin: 0 auto; padding: 16px; }
    h1, h2 { margin: 0 0 10px; font-weight: 800; letter-spacing: .5px; text-transform: uppercase; }
    h1 { font-size: 28px; }
    h2 { font-size: 18px; color: var(--orange); }
    .painel {
      background: linear-gradient(180deg, #0b1120 0%, #030712 100%);
      border: 1px solid #0f172a;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      margin-bottom: 14px;
    }
    label { font-size: 12px; color: var(--txt); font-weight: 700; }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #111827;
      outline: none;
      background: #0b1222;
      color: var(--txt);
      margin-top: 4px;
    }
    input::placeholder{ color: #556; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--txt);
      background: #111827;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .3px;
      text-transform: uppercase;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn-green { background: var(--green); color: #001a2e; }
    .btn-orange { background: var(--orange); color: #001a2e; }
    .btn-blue { background: var(--blue); color: #001a2e; }
    .btn-red { background: var(--red); color: #001a2e; }
    .btn-recarregar { background: var(--blue); color:#001a2e; padding:8px 10px; font-size: 12px; border-radius: 8px; font-weight:900; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      /* min-width removido para evitar rolagem horizontal */
    }
    th, td {
      border: 1px solid #0f172a;
      padding: 8px 10px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f97316;
      color: #0f172a;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) { background: #0b1120; }
    tr:nth-child(odd)  { background: #020617; }
    #status {
      font-size: 12px;
      margin-top: 4px;
      color: var(--muted);
    }
    .grid-form {
      display: grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap: 8px 12px;
    }
    @media (max-width: 900px) {
      .grid-form {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }

    .page-header{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  
/* ===== HISTÓRICO (JOGADORES) ===== */
.histBox{margin-top:14px;padding:12px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,var(--card),var(--card2));}
.histTitle{color:var(--orange);font-weight:800;margin-bottom:6px;letter-spacing:.5px}
@media print{
  html,body{overflow-x:hidden;}
  body{background:#fff !important;}
  body *{visibility:hidden !important;}
  #printArea, #printArea *{visibility:visible !important;}
  #printArea{
    display:block !important;
    position:fixed;left:0;top:0;width:100%;
    background:#fff;color:#000;padding:18px;
  }
  #printArea table{width:100%;border-collapse:collapse;font-size:12px}
  #printArea th,#printArea td{border:1px solid #ccc;padding:6px;text-align:left}
  #printArea h1{margin:0 0 10px 0;font-size:16px}
  #printArea .printMeta{margin:0 0 12px 0;font-size:11px;color:#333}
}


/* ===== PDF (PRINT) ===== */
#printArea{display:none;}
#printArea .printHeader{margin-bottom:12px;}
#printArea .printStamp{font-size:12px;color:#111;margin-bottom:6px;}
#printArea h1{margin:0 0 6px 0;font-size:18px;color:#111;}
@media print{
  body{background:#fff !important;}
  body *{visibility:hidden !important;}
  #printArea, #printArea *{visibility:visible !important;}
  #printArea{
    display:block !important;
    position:absolute; left:0; top:0;
    width:100%;
    background:#fff !important;
    color:#000 !important;
    padding:16px;
  }
  #printArea table{width:100%; border-collapse:collapse;}
  #printArea th, #printArea td{border:1px solid #999; padding:4px; font-size:10px; color:#000 !important;}
  #printArea th{background:#eee !important; font-weight:700;}
}


/* R1 FIX: lista automática, sem botão recarregar */
.btn-recarregar{display:none !important;}
/* R1 FIX: aniversariantes menor */
#birthdayPanel{max-height:none; overflow:visible;}

  /* Birthday table sizing */
  #birthdayTable{ table-layout:fixed; width:100%; }
  #birthdayTable th, #birthdayTable td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #birthdayTable .bd-col-apelido{ width:50%; }
  #birthdayTable .bd-col-data{ width:25%; }
  #birthdayTable .bd-col-idade{ width:25%; text-align:center; }
  #birthdayBody td.bd-idade{ text-align:center; }

/* R3 FIX: evitar rolagem horizontal na LISTA DE JOGADORES */
#jogadoresTable{ table-layout:fixed; width:100%; }
#jogadoresTable th, #jogadoresTable td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  /* Larguras (px) – ajustadas para NÃO ter barra horizontal */
  #jogadoresTable { width:100%; table-layout:fixed; }
  #jogadoresTable th, #jogadoresTable td { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  #jogadoresTable th:nth-child(1),  #jogadoresTable td:nth-child(1){width:40px;}   /* ORDEM */
  #jogadoresTable th:nth-child(2),  #jogadoresTable td:nth-child(2){width:45px;}   /* ID */
  #jogadoresTable th:nth-child(3),  #jogadoresTable td:nth-child(3){width:55px;}   /* CAMISA */
  #jogadoresTable th:nth-child(4),  #jogadoresTable td:nth-child(4){width:90px;}   /* APELIDO */
  #jogadoresTable th:nth-child(5),  #jogadoresTable td:nth-child(5){width:140px;}  /* NOME */
  #jogadoresTable th:nth-child(6),  #jogadoresTable td:nth-child(6){width:95px;}   /* DATA NASC. */
  #jogadoresTable th:nth-child(7),  #jogadoresTable td:nth-child(7){width:50px;}   /* IDADE */
  #jogadoresTable th:nth-child(8),  #jogadoresTable td:nth-child(8){width:110px;}  /* CELULAR */
  #jogadoresTable th:nth-child(9),  #jogadoresTable td:nth-child(9){width:50px;}   /* POSIÇÃO */
  #jogadoresTable th:nth-child(10), #jogadoresTable td:nth-child(10){width:40px;}  /* HAB */
  #jogadoresTable th:nth-child(11), #jogadoresTable td:nth-child(11){width:40px;}  /* VEL */
  #jogadoresTable th:nth-child(12), #jogadoresTable td:nth-child(12){width:40px;}  /* MOV */
  #jogadoresTable th:nth-child(13), #jogadoresTable td:nth-child(13){width:50px;}  /* PONTOS */
  #jogadoresTable th:nth-child(14), #jogadoresTable td:nth-child(14){width:100px;} /* AÇÕES */



  /* Lista: não quebrar linhas em DATA NASC e CELULAR */
  #tbody-jogadores td:nth-child(6), #tbody-jogadores th:nth-child(6){ min-width:110px; white-space:nowrap; }
  #tbody-jogadores td:nth-child(8), #tbody-jogadores th:nth-child(8){ min-width:130px; white-space:nowrap; }
  /* Nome: mais espaço */
  #tbody-jogadores td:nth-child(5), #tbody-jogadores th:nth-child(5){ min-width:180px; }


  .w-aco{width:100px;}

  .birthday-inline{ margin-top:10px; }
  .birthday-inline h2{ margin:0 0 6px 0; font-size:16px; }
  .birthday-inline .hint{ margin:0 0 6px 0; font-size:12px; }
  #birthdayTable th,#birthdayTable td{ padding:6px 8px; font-size:12px; }
  #birthdayTable th:nth-child(1),#birthdayTable td:nth-child(1){ width:60%; }
  #birthdayTable th:nth-child(2),#birthdayTable td:nth-child(2){ width:20%; text-align:center; }
  #birthdayTable th:nth-child(3),#birthdayTable td:nth-child(3){ width:20%; text-align:center; }
</style>
</head>
<body>
<div class="container">
    <div class="painel" id="editPanel">
      <h2>Cadastrar / Editar Jogador</h2>
      <div class="grid-form">
        <div>
          <label>NÚMERO DA CAMISA:</label><br />
          <input id="camisa" type="number" />
        </div>
        <div>
          <label>NOME COMPLETO:</label><br />
          <input id="nome" type="text" />
        </div>
        <div>
          <label>APELIDO (ÚNICO):</label><br />
          <input id="apelido" type="text" />
        </div>
        <div>
          <label>DATA DE NASCIMENTO:</label><br />
          <input id="data_nasc" type="date" />
        </div>

        <div>
          <label>CELULAR (WHATSAPP):</label><br />
          <input id="celular" type="text" />
        </div>
        <div>
          <label>POSIÇÃO (Z/L/M/A):</label><br />
          <input id="posicao" type="text" maxlength="1" />
        </div>
        <div>
          <label>HABILIDADE (1–5):</label><br />
          <input id="hab" type="number" min="1" max="5" />
        </div>
        <div>
          <label>VELOCIDADE (1–2, N_3_*):</label><br />
          <input id="vel" type="number" />
        </div>
        <div>
          <label>MOVIMENTAÇÃO (1–2, N_3_*):</label><br />
          <input id="mov" type="number" />
        </div>
        <div>
          <label>PONTOS:</label><br />
          <input id="pontos" type="number" disabled placeholder="HAB + VEL + MOV" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-green" id="btn-salvar">SALVAR JOGADOR</button>
        <button class="btn btn-orange" id="btn-cancelar">CANCELAR EDIÇÃO</button>
      </div>
      <p id="status"></p>
    </div>

    

    <div class="painel" style="overflow-x:hidden;">
      <h2>Lista de Jogadores</h2>
      <div style="color:#cfd6ff;font-weight:800;margin:6px 0 10px">
  ZAGUEIRO = Z &nbsp;&nbsp; LATERAL = L &nbsp;&nbsp; MEIO = M &nbsp;&nbsp; ATAQUE = A
</div>
<div class="painel birthday-inline" id="birthdayPanel">
  <h2>Aniversariantes do Mês</h2>
  <div id="birthdayHint" style="color:#cfd6ff;font-weight:800;margin:6px 0 10px">Carregando...</div>
  <div style="overflow-x:hidden;">
    <table id="birthdayTable" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th class="bd-col-apelido">APELIDO</th>
          <th class="bd-col-data">DATA</th>
          <th class="bd-col-idade">IDADE</th>
        </tr>
      </thead>
      <tbody id="birthdayBody">
        <tr><td colspan="3" style="padding:10px;border:1px solid rgba(255,255,255,.12);">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<button class="btn btn-blue" id="btnPdfAtual" type="button">BAIXAR PDF (ATUAL)</button>
      <p style="font-size:12px;">ORDEM ALFABÉTICA POR APELIDO. COLUNA IDADE É CALCULADA AUTOMÁTICA.</p>

      <table id="jogadoresTable">
        <thead>
          <tr>
            <th>ORDEM</th>
            <th>ID</th>
            <th>CAMISA</th>
            <th>APELIDO</th>
            <th>NOME</th>
            <th>DATA NASC.</th>
            <th>IDADE</th>
            <th>CELULAR</th>
            <th>POSIÇÃO</th>
            <th>HAB</th>
            <th>VEL</th>
            <th>MOV</th>
            <th>PONTOS</th>
            <th>AÇÕES</th>
          </tr>
        </thead>
        <tbody id="tbody-jogadores"></tbody>
      
          </table>

          <div class="histBox">
            <div class="histTitle">HISTÓRICO (ANO / MÊS)</div>
            <div class="row">
              <div class="field">
                <label>ANO</label>
                <select id="histAno"></select>
              </div>
              <div class="field">
                <label>MÊS</label>
                <select id="histMes"></select>
              </div>
              <div class="actions right">
                <button id="btnHistBuscar" class="btn btnGreen">BUSCAR</button>
                <button id="btnHistLimpar" class="btn btnOrange">LIMPAR</button>
              </div>
            </div>
            <div class="small" id="histMsg">Selecione ANO e MÊS e clique em BUSCAR para baixar o PDF do mês.</div>
          </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    var supabase = window.__TESOURA_SUPABASE__;
    const camisaInput = document.getElementById("camisa");
    const nomeInput = document.getElementById("nome");
    const apelidoInput = document.getElementById("apelido");
    const dataNascInput = document.getElementById("data_nasc");
    const celularInput = document.getElementById("celular");
    const posicaoInput = document.getElementById("posicao");
    const habInput = document.getElementById("hab");
    const velInput = document.getElementById("vel");
    const movInput = document.getElementById("mov");
    const pontosInput = document.getElementById("pontos");

    const btnSalvar = document.getElementById("btn-salvar");
    const btnCancelar = document.getElementById("btn-cancelar");
    const btnRecarregar = document.getElementById("btn-recarregar");

    const tbody = document.getElementById("tbody-jogadores");
    const statusEl = document.getElementById("status");

    let editId = null;
let editApelidoOriginal = null;

    let JOGADORES_CACHE = [];
function el(id){ return document.getElementById(id); }

    function calcularIdade(dataISO) {
      if (!dataISO) return "";
      try {
        const nasc = new Date(dataISO);
        if (isNaN(nasc.getTime())) return "";
        const hoje = new Date();
        let idade = hoje.getFullYear() - nasc.getFullYear();
        const m = hoje.getMonth() - nasc.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
        if (idade < 0 || idade > 120) return "";
        return idade;
      } catch {
        return "";
      }
    }

    function limparFormulario() {
      editId = null;
      editApelidoOriginal = null;
      camisaInput.value = "";
      nomeInput.value = "";
      apelidoInput.value = "";
      dataNascInput.value = "";
      celularInput.value = "";
      posicaoInput.value = "";
      habInput.value = "";
      velInput.value = "";
      movInput.value = "";
      pontosInput.value = "";
      statusEl.textContent = "";
      btnSalvar.textContent = "SALVAR JOGADOR";
    }

    function atualizarPontos() {
      const hab = habInput.value ? parseInt(habInput.value, 10) : 0;
      const vel = velInput.value ? parseInt(velInput.value, 10) : 0;
      const mov = movInput.value ? parseInt(movInput.value, 10) : 0;
      const soma = (hab || 0) + (vel || 0) + (mov || 0);
      pontosInput.value = soma ? soma : "";
    }

    habInput.addEventListener("input", atualizarPontos);
    velInput.addEventListener("input", atualizarPontos);
    movInput.addEventListener("input", atualizarPontos);

    
      function parseBirthDate(v){
        if(!v) return null;
        // ISO: YYYY-MM-DD
        if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
          const [y,m,d]=v.split("-").map(Number);
          return {y,m,d};
        }
        // BR: DD/MM/YYYY
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
          const [d,m,y]=v.split("/").map(Number);
          return {y,m,d};
        }
        return null;
      }

      function calcAge(y,m,d){
        const now = new Date();
        let age = now.getFullYear() - y;
        const mm = now.getMonth()+1;
        const dd = now.getDate();
        if(mm < m || (mm===m && dd < d)) age -= 1;
        return age;
      }

      function renderAniversariantes(lista){
        try{
          const tbody = document.getElementById("birthdayBody");
          const hint = document.getElementById("birthdayHint");
          if(!tbody) return;

          const now = new Date();
          const mes = now.getMonth()+1;

          const aniv = (Array.isArray(lista)? lista: []).map(j=>{
            const bd = parseBirthDate(j.data_nasc);
            if(!bd) return null;
            return { apelido: String(j.apelido||"").toUpperCase(), y:bd.y, m:bd.m, d:bd.d };
          }).filter(x=>x && x.apelido && x.m===mes)
            .sort((a,b)=> a.d - b.d);

          tbody.innerHTML = "";

          if(aniv.length === 0){
            tbody.innerHTML = `<tr><td colspan="3">Nenhum aniversariante neste mês.</td></tr>`;
            if(hint) hint.textContent = "";
            return;
          }

          const rows = aniv.map(a=>{
            const dd = String(a.d).padStart(2,"0");
            const mm = String(a.m).padStart(2,"0");
            const idade = calcAge(a.y,a.m,a.d);
            return `<tr>
              <td title="${a.apelido}">${a.apelido}</td>
              <td>${dd}/${mm}</td>
              <td class="bd-idade">${idade}</td>
            </tr>`;
          }).join("");

          tbody.innerHTML = rows;
          if(hint) hint.textContent = `Total: ${aniv.length}`;
        }catch(e){
          console.warn("renderAniversariantes falhou:", e);
        }
      }

      async function carregarJogadores() {
      statusEl.textContent = "Carregando jogadores...";
      tbody.innerHTML = "";
      const { data, error } = await supabase
        .from("jogadores")
        .select("id,camisa,apelido,nome,data_nasc,celular,posicao,hab,vel,mov,pontos,ativo")
        .order("apelido", { ascending: true });

      if (error) {
        console.error(error);
        statusEl.textContent = "ERRO AO CARREGAR JOGADORES.";
        return;
      }

      let ordem = 0;
      data.forEach(j => {
        ordem++;
        const tr = document.createElement("tr");

        function tdTexto(t) {
          const td = document.createElement("td");
          td.textContent = t ?? "";
          return td;
        }

       tr.appendChild(tdTexto(String(ordem)));
        tr.appendChild(tdTexto(j.id));
        tr.appendChild(tdTexto(j.camisa ?? ""));
        tr.appendChild(tdTexto((j.apelido || "").toUpperCase()));
        tr.appendChild(tdTexto((j.nome || "").toUpperCase()));
        tr.appendChild(tdTexto(j.data_nasc || ""));

        const idade = calcularIdade(j.data_nasc);
        tr.appendChild(tdTexto(idade !== "" ? idade : ""));

        tr.appendChild(tdTexto(j.celular || ""));
        tr.appendChild(tdTexto((j.posicao || "").toUpperCase()));
        tr.appendChild(tdTexto(j.hab ?? ""));
        tr.appendChild(tdTexto(j.vel ?? ""));
        tr.appendChild(tdTexto(j.mov ?? ""));
        tr.appendChild(tdTexto(j.pontos ?? ""));
          const tdAcoes = document.createElement("td");
          tdAcoes.className = "td-acoes";
          const btnE = document.createElement("button");
          btnE.textContent = "EDITAR";
          btnE.className = "btn";
          btnE.style.padding = "6px 10px";
          btnE.style.fontSize = "11px";
          btnE.addEventListener("click", () => {
            editId = j.id;
            editApelidoOriginal = (j.apelido || "").toUpperCase();
            camisaInput.value = j.camisa ?? "";
            nomeInput.value = j.nome ?? "";
            apelidoInput.value = (j.apelido ?? "").toUpperCase();
            dataNascInput.value = j.data_nasc ?? "";
            celularInput.value = j.celular ?? "";
            posicaoInput.value = (j.posicao ?? "").toUpperCase();
            habInput.value = j.hab ?? "";
            velInput.value = j.vel ?? "";
            movInput.value = j.mov ?? "";
            pontosInput.value = j.pontos ?? "";
            statusEl.textContent = "Editando jogador ID " + j.id;
            btnSalvar.textContent = "SALVAR ALTERAÇÃO";
            // rolar para o topo do formulário (sempre visível)
            document.getElementById("topoFormulario")?.scrollIntoView({behavior:"smooth", block:"start"});
          });

          const btnX = document.createElement("button");
          btnX.textContent = "EXCLUIR";
          btnX.className = "btn btn-red";
          btnX.style.padding = "6px 10px";
          btnX.style.fontSize = "11px";
          btnX.addEventListener("click", async () => {
            if (!confirm("Excluir este jogador?")) return;
            await excluirJogador(j.id);
          });

          const wrap = document.createElement("div");
          wrap.style.display = "flex";
          wrap.style.gap = "6px";
          wrap.style.justifyContent = "center";
          wrap.appendChild(btnE);
          wrap.appendChild(btnX);

          tdAcoes.appendChild(wrap);
          tr.appendChild(tdAcoes);
tbody.appendChild(tr);
      });

      renderAniversariantes(data);
      statusEl.textContent = "TOTAL DE JOGADORES: " + data.length;
    }

    async function excluirJogador(id) {
      statusEl.textContent = "Excluindo jogador...";
      const { error } = await supabase.from("jogadores").delete().eq("id", id);

      if (error) {
        console.error(error);
        statusEl.textContent =
          "ERRO AO EXCLUIR JOGADOR: " + (error.message || JSON.stringify(error));
        return;
      }

      statusEl.textContent = "JOGADOR EXCLUÍDO COM SUCESSO.";
      carregarJogadores();
    }

    async function salvarJogador() {
      let camisa = camisaInput.value ? parseInt(camisaInput.value, 10) : null;
      let nome = nomeInput.value.trim().toUpperCase();
      let apelido = apelidoInput.value.trim().toUpperCase();
      let data_nasc = dataNascInput.value || null;
      let celular = celularInput.value.trim();
      let posicao = posicaoInput.value.trim().toUpperCase().slice(0,1);
      // compatibilidade: se digitar D, vira Z (Zagueiro)
      if(posicao === "D") posicao = "Z";
      if(posicao && !["Z","L","M","A"].includes(posicao)){
        statusEl.textContent = "POSIÇÃO inválida. Use: Z (Zagueiro), L (Lateral), M (Meio), A (Ataque).";
        return;
      }
      let hab = habInput.value ? parseInt(habInput.value, 10) : null;
      let vel = velInput.value ? parseInt(velInput.value, 10) : null;
      let mov = movInput.value ? parseInt(movInput.value, 10) : null;

      // calcular pontos automaticamente = HAB + VEL + MOV
      let pontos = null;
      if (hab !== null || vel !== null || mov !== null) {
        pontos = (hab || 0) + (vel || 0) + (mov || 0);
      }

      if (!apelido) {
        statusEl.textContent = "APELIDO é obrigatório.";
        return;
      }

      const payload = {
        camisa,
        nome: nome || null,
        apelido,
        data_nasc,
        celular: celular || null,
        posicao: posicao || null,
        hab,
        vel,
        mov,
        pontos,
        ativo: true
      };

      statusEl.textContent = "Salvando jogador...";
      let error;

      // R1 FIX: permitir corrigir APELIDO sem quebrar FK (mensalidades_apelido_fkey)
      const novoApelido = String(payload.apelido || "").trim();
      const apelidoAntigo = String(editApelidoOriginal || "").trim();

      if (editId !== null && apelidoAntigo && novoApelido && novoApelido !== apelidoAntigo) {
        // 1) cria NOVO jogador com novo apelido
        const ins = await supabase.from("jogadores").insert(payload).select("id").single();
        if (ins.error) {
          error = ins.error;
        } else {
          const newId = ins.data.id;

          // 2) move mensalidades para o novo apelido
          const upMens = await supabase.from("mensalidades").update({ apelido: novoApelido }).eq("apelido", apelidoAntigo);
          if (upMens.error) {
            // desfaz: apaga jogador novo
            await supabase.from("jogadores").delete().eq("id", newId);
            error = upMens.error;
          } else {
              // 2B) tenta mover outras tabelas que guardam APELIDO (se existirem)
            // (se a tabela não existir, ignora e segue)
            const extraTables = ["gols", "presenca", "presencas", "presenca_escala", "escala", "escalacao"];
            for (const t of extraTables) {
              try{
                const r = await supabase.from(t).update({ apelido: novoApelido }).eq("apelido", apelidoAntigo);
                if (r && r.error) {
                  const msg = String(r.error.message || "").toLowerCase();
                  if (msg.includes("does not exist") || msg.includes("relation") || msg.includes("table")) {
                    // ignora tabela inexistente
                  } else {
                    // se deu outro erro, só mostra no console e segue
                    console.warn("Aviso ao atualizar tabela", t, r.error);
                  }
                }
              }catch(e){}
            }

          // 3) apaga jogador antigo
            const delOld = await supabase.from("jogadores").delete().eq("id", editId);
            if (delOld.error) {
              // desfaz: volta mensalidades e apaga novo
              await supabase.from("mensalidades").update({ apelido: apelidoAntigo }).eq("apelido", novoApelido);
              await supabase.from("jogadores").delete().eq("id", newId);
              error = delOld.error;
            }
          }
        }
      } else if (editId === null) {
        const resp = await supabase.from("jogadores").insert(payload);
        error = resp.error;
      } else {
        const resp = await supabase.from("jogadores").update(payload).eq("id", editId);
        error = resp.error;
      }

      if (error) {
        console.error(error);
        statusEl.textContent = "ERRO AO SALVAR JOGADOR: " + (error?.message || JSON.stringify(error) || "");
      console.error("ERRO AO SALVAR JOGADOR:", error);
        return;
      }

      statusEl.textContent = "JOGADOR SALVO COM SUCESSO.";
      limparFormulario();
      carregarJogadores();
    }

    function init() {
      
/* =========================
   PDF (ATUAL) - SEM NOVA PÁGINA (usa Impressão do navegador)
   ========================= */
function formatBRDateTime(d){
  const pad=(n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function pontosFrom(h,v,m){
  const a = Number(h||0), b = Number(v||0), c = Number(m||0);
  return (a+b+c);
}
function idadeFromISO(iso){
  if(!iso) return "";
  const d = new Date(String(iso).slice(0,10));
  if(isNaN(d.getTime())) return "";
  const now = new Date();
  let age = now.getFullYear() - d.getFullYear();
  const m = now.getMonth() - d.getMonth();
  if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
  return age;
}
function jogadoresToTable(players){
  const cols = ["ORDEM","ID","CAMISA","APELIDO","NOME","DATA NASC.","IDADE","CELULAR","POSIÇÃO","HAB","VEL","MOV","PONTOS"];
  let html = `<table><thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead><tbody>`;
  html += players.map((p,i)=>{
    const nasc = p.data_nascimento ? String(p.data_nascimento).slice(0,10) : "";
    const idade = idadeFromISO(p.data_nascimento);
    const pontos = pontosFrom(p.habilidade, p.velocidade, p.movimentacao);
    const row = [
      i+1,
      p.id ?? "",
      p.numero_camisa ?? "",
      (p.apelido||"").toUpperCase(),
      (p.nome_completo||"").toUpperCase(),
      nasc,
      idade,
      p.celular || "",
      p.posicao || "",
      p.habilidade ?? "",
      p.velocidade ?? "",
      p.movimentacao ?? "",
      pontos
    ];
    return `<tr>${row.map(v=>`<td>${String(v ?? "")}</td>`).join("")}</tr>`;
  }).join("");
  html += `</tbody></table>`;
  return html;
}

  function printJogadores(){
  const pa = document.getElementById("printArea");
  pa.innerHTML = `
    <h1>JOGADORES - LISTA ATUAL</h1>
    <div class="printMeta">${new Date().toLocaleString("pt-BR")}</div>
    ${jogadoresToTable(true)}
  `;
  pa.style.display = "block";

  const cleanup = () => {
    pa.innerHTML = "";
    pa.style.display = "none";
  };

  // Limpa depois do print (sem timeout que pode apagar antes)
  window.addEventListener("afterprint", cleanup, { once: true });

  // Espera 2 frames para o Chrome renderizar o printArea antes do print
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      try { window.print(); } catch(e){ console.warn(e); cleanup(); }
      // fallback: se o afterprint não disparar por algum motivo
      setTimeout(() => cleanup(), 4000);
    });
  });
}
    
/* =========================
   HISTÓRICO (ANO/MÊS) - SUPABASE (arquivos_app)
   ========================= */
const TABLE_ARQUIVOS = "arquivos_app";

function ymRef(y,m){ return `${y}-${String(m).padStart(2,"0")}`; }
function ymTitulo(y,m){ return `JOGADORES - LISTA (${String(m).padStart(2,"0")}/${y})`; }

function fillHistSelectors(){
  const selY = document.getElementById("histAno");
  const selM = document.getElementById("histMes");
  if(!selY || !selM) return;

  const now = new Date();
  const thisY = now.getFullYear();
  const minY = thisY - 1;

  selY.innerHTML = "";
  for(let y=thisY; y>=minY; y--){
    const o=document.createElement("option");
    o.value=String(y); o.textContent=String(y);
    selY.appendChild(o);
  }

  const meses = [
    ["01","JAN"],["02","FEV"],["03","MAR"],["04","ABR"],["05","MAI"],["06","JUN"],
    ["07","JUL"],["08","AGO"],["09","SET"],["10","OUT"],["11","NOV"],["12","DEZ"]
  ];
  selM.innerHTML="";
  meses.forEach(([v,t])=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=`${v} - ${t}`;
    selM.appendChild(o);
  });

  selY.value = String(thisY);
  selM.value = String(now.getMonth()+1).padStart(2,"0");
}

function shouldAutoSnapshotNearDay1(){
  const d=new Date().getDate();
  return d>=1 && d<=3;
}

// Supabase (fonte única): já inicializado no topo do arquivo
const supabase = window.__TESOURA_SUPABASE__;
      
async function salvarSnapshotJogadores(motivo){
  try{
    if(!supabase || !supabase.from) return;
    if(!Array.isArray(JOGADORES_CACHE) || JOGADORES_CACHE.length===0) return;

    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const ref = ymRef(y,m);

    const payload = {
      painel: "jogadores",
      periodo: "mensal",
      referencia: ref,
      titulo: ymTitulo(y,m),
      tipo: "json",
      criado_em: now.toISOString(),
      conteudo: JSON.stringify(JOGADORES_CACHE),
      motivo: motivo || "auto"
    };

    await supabase.from(TABLE_ARQUIVOS).insert([payload]);
    localStorage.setItem(`TESOURA_JOGADORES_SNAPSHOT_${ref}`, "1");
  }catch(e){
    console.warn("Snapshot jogadores falhou:", e);
  }
}

// salva snapshot quando salva/edita/exclui (sem quebrar o fluxo)
const __origSalvarJogador = salvarJogador;
salvarJogador = async function(){
  const wasEditing = (editId !== null);
  await __origSalvarJogador();
  try{ await salvarSnapshotJogadores(wasEditing ? "editar" : "cadastrar"); }catch(e){}
};

const __origExcluirJogador = excluirJogador;
excluirJogador = async function(id){
  await __origExcluirJogador(id);
  try{ await salvarSnapshotJogadores("excluir"); }catch(e){}
};

document.getElementById("btnHistBuscar")?.addEventListener("click", async ()=>{
  const msg = document.getElementById("histMsg");
  try{
    if(!supabase || !supabase.from){
      if(msg) msg.textContent = "Supabase não inicializado (volte para o login).";
      return;
    }
    const y = document.getElementById("histAno")?.value;
    const m = document.getElementById("histMes")?.value;
    if(!y || !m) return;

    const ref = `${y}-${m}`;
    if(msg) msg.textContent = "Buscando histórico...";

    const { data, error } = await supabase
      .from(TABLE_ARQUIVOS)
      .select("*")
      .eq("painel","jogadores")
      .eq("periodo","mensal")
      .eq("referencia", ref)
      .order("criado_em", { ascending: false })
      .limit(1);

    if(error) throw error;
    const item = (data && data[0]) ? data[0] : null;
    if(!item){
      if(msg) msg.textContent = "Nenhum arquivo encontrado para este mês.";
      return;
    }
    let arr = [];
    try{ arr = JSON.parse(item.conteudo || "[]"); }catch(e){ arr=[]; }
    if(!Array.isArray(arr) || arr.length===0){
      if(msg) msg.textContent = "Arquivo encontrado, mas vazio.";
      return;
    }
    if(msg) msg.textContent = `Arquivo: ${item.titulo || ""} (${item.criado_em || ""})`;
    printJogadores(arr, item.titulo || "JOGADORES - HISTÓRICO");
  }catch(e){
    console.error(e);
    if(msg) msg.textContent = "Erro ao buscar histórico.";
  }
});

document.getElementById("btnHistLimpar")?.addEventListener("click", ()=>{
  fillHistSelectors();
  const msg = document.getElementById("histMsg");
  if(msg) msg.textContent = "Selecione ANO e MÊS e clique em BUSCAR para baixar.";
});

// inicializa seletores e snapshot automático perto do dia 1º
fillHistSelectors();
(async ()=>{
  try{
    if(shouldAutoSnapshotNearDay1()){
      const now=new Date();
      const ref=ymRef(now.getFullYear(), now.getMonth()+1);
      const key=`TESOURA_JOGADORES_SNAPSHOT_${ref}`;
      if(!localStorage.getItem(key)){
        await salvarSnapshotJogadores("auto_dia1");
      }
    }
  }catch(e){}
})();


carregarJogadores();
    }

    btnSalvar.addEventListener("click", salvarJogador);
    btnCancelar.addEventListener("click", limparFormulario);
    btnRecarregar?.addEventListener("click", carregarJogadores);

    init();
  
/* ===== PDF (ATUAL) - sem nova página ===== */
(function(){
  const btn = document.getElementById("btnPdfAtual");
  if(!btn) return;
  btn.addEventListener("click", function(){
    try{
      const tbody = document.getElementById("tbody-jogadores");
      if(!tbody || tbody.children.length === 0){
        alert("Não foi possível gerar o PDF agora. Recarregue a lista e tente novamente.");
        return;
      }
      const table = tbody.closest("table");
      if(!table){
        alert("Não foi possível gerar o PDF agora. Recarregue a lista e tente novamente.");
        return;
      }
      const now = new Date();
      const stamp = now.toLocaleDateString("pt-BR") + " " + now.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
      const printArea = document.getElementById("printArea");
      printArea.innerHTML = `
        <div class="printHeader">
          <div class="printStamp">${stamp}</div>
          <h1>JOGADORES - LISTA ATUAL</h1>
        </div>
        ${table.outerHTML}
      `;
      window.print();
      // limpa depois do print
      setTimeout(()=>{ printArea.innerHTML = ""; }, 400);
    }catch(err){
      console.warn("PDF jogadores falhou:", err);
      alert("Não foi possível gerar o PDF agora. Recarregue a lista e tente novamente.");
    }
  });
})();


// R1 FIX: carrega lista automaticamente
window.addEventListener('DOMContentLoaded', () => { try{ carregarJogadores(); }catch(e){ console.error(e);} });
</script>

<div id="printArea"></div>
</body>
</html>
