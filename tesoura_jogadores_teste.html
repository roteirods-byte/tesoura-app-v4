<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tesoura - Jogadores</title>
  <!-- JOGADORES_REV_FILTRO_PDF_20260104 -->
  <style>
    :root{
      --bg:#020617;
      --panel:#0b1222;
      --panel2:#0f172a;
      --line:#1f2937;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --orange:#f97316;
      --green:#2ecc71;
      --red:#ef4444;
      --btn:#111827;
      --btn2:#0b1120;
      --blue:#60a5fa;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--txt);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1, h2 { margin: 0 0 10px; font-weight: 800; letter-spacing: .5px; text-transform: uppercase; }
    h1 { font-size: 28px; }
    h2 { font-size: 18px; color: var(--orange); }
    .painel {
      background: linear-gradient(180deg, #0b1120 0%, #030712 100%);
      border: 1px solid #0f172a;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      margin-bottom: 14px;
    }
    label { font-size: 12px; color: var(--txt); font-weight: 700; }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #111827;
      outline: none;
      background: #0b1222;
      color: var(--txt);
      margin-top: 4px;
    }
    input::placeholder{ color: #556; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--txt);
      background: #111827;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .3px;
      text-transform: uppercase;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn-green { background: var(--green); color: #001a2e; }
    .btn-orange { background: var(--orange); color: #001a2e; }
    .btn-blue { background: var(--blue); color: #001a2e; }
    .btn-red { background: var(--red); color: #001a2e; }
    .btn-recarregar { background: var(--blue); color:#001a2e; padding:8px 10px; font-size: 12px; border-radius: 8px; font-weight:900; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      min-width: 980px;
    }
    th, td {
      border: 1px solid #0f172a;
      padding: 8px 10px;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f97316;
      color: #0f172a;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) { background: #0b1120; }
    tr:nth-child(odd)  { background: #020617; }
    #status {
      font-size: 12px;
      margin-top: 4px;
      color: var(--muted);
    }
    .grid-form {
      display: grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap: 8px 12px;
    }
    @media (max-width: 900px) {
      .grid-form {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }

    .page-header{display:flex; align-items:center; justify-content:space-between; gap:12px;}

    /* ===== HISTÓRICO (ANO/MÊS) ===== */
    .hist-card{margin-top:12px; padding:12px; border:1px solid var(--line); border-radius:12px; background: linear-gradient(180deg, var(--panel), var(--panel2));}
    .hist-title{color:var(--orange); font-weight:900; letter-spacing:.5px; text-transform:uppercase; font-size:13px; margin:0 0 8px;}
    .hist-row{display:flex; flex-wrap:wrap; gap:10px 12px; align-items:flex-end;}
    .hist-field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    .hist-field label{font-size:12px; color:var(--muted);}
    .hist-field select{height:36px; border-radius:10px; border:1px solid var(--line); background:#071225; color:var(--txt); padding:0 10px;}
    .hist-actions{display:flex; gap:8px; margin-left:auto; flex-wrap:wrap;}
    .hist-table{width:100%; border-collapse:collapse; margin-top:10px;}
    .hist-table th,.hist-table td{border-bottom:1px solid var(--line); padding:10px 8px; font-size:13px; text-align:left;}
    .hist-table th{color:var(--orange); font-weight:900;}
    .hist-empty{color:var(--muted); font-size:13px; padding:10px 0;}

    /* ===== IMPRESSÃO ===== */
    @media print {
      body { background: #fff !important; color:#000 !important; }
      .container { max-width: none !important; padding: 0 !important; }
      .painel, .card { box-shadow:none !important; border:none !important; background:#fff !important; }
      .page-header, .controls, .hist-card, #status, .btn-recarregar { display:none !important; }
      table { border:1px solid #111 !important; }
      th, td { border-bottom:1px solid #333 !important; color:#000 !important; }
      th { color:#000 !important; }
    }
  
    /* ===== PRINT/PDF (sem nova aba) ===== */
    #printArea{ display:none; }
    body.printMode #printArea{ display:block; }

    @media print{
      /* imprime apenas o conteúdo do printArea */
      body.printMode *{ visibility:hidden !important; }
      body.printMode #printArea, body.printMode #printArea *{ visibility:visible !important; }

      body.printMode #printArea{
        position: fixed;
        left: 0; top: 0; right: 0; bottom: 0;
        padding: 18px;
        background: #ffffff !important;
        color: #000000 !important;
      }

      body.printMode .printMeta{ font-size: 11px; margin-bottom: 6px; color:#111; }
      body.printMode .printTitle{ font-size: 16px; font-weight: 800; margin: 0 0 6px 0; }
      body.printMode .printSub{ font-size: 12px; margin: 0 0 12px 0; color:#222; }

      body.printMode table{ width:100%; border-collapse: collapse; }
      body.printMode th, body.printMode td{ border: 1px solid #111; padding: 6px 8px; font-size: 12px; text-align: left; }
      body.printMode th{ background:#f2f2f2; }
    }

</style>
</head>
<body>
  <header class="page-header">
        <h1>TESOURA - JOGADORES</h1>
</header>

  <div class="container">
    <div class="painel">
      <h2>Cadastrar / Editar Jogador</h2>
      <div class="grid-form">
        <div>
          <label>NÚMERO DA CAMISA:</label><br />
          <input id="camisa" type="number" />
        </div>
        <div>
          <label>NOME COMPLETO:</label><br />
          <input id="nome" type="text" />
        </div>
        <div>
          <label>APELIDO (ÚNICO):</label><br />
          <input id="apelido" type="text" />
        </div>
        <div>
          <label>DATA DE NASCIMENTO:</label><br />
          <input id="data_nasc" type="date" />
        </div>

        <div>
          <label>CELULAR (WHATSAPP):</label><br />
          <input id="celular" type="text" />
        </div>
        <div>
          <label>POSIÇÃO (Z/L/M/A):</label><br />
          <input id="posicao" type="text" maxlength="1" />
        </div>
        <div>
          <label>HABILIDADE (1–5):</label><br />
          <input id="hab" type="number" min="1" max="5" />
        </div>
        <div>
          <label>VELOCIDADE (1–2, N_3_*):</label><br />
          <input id="vel" type="number" />
        </div>
        <div>
          <label>MOVIMENTAÇÃO (1–2, N_3_*):</label><br />
          <input id="mov" type="number" />
        </div>
        <div>
          <label>PONTOS:</label><br />
          <input id="pontos" type="number" disabled placeholder="HAB + VEL + MOV" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-green" id="btn-salvar">SALVAR JOGADOR</button>
        <button class="btn btn-orange" id="btn-cancelar">CANCELAR EDIÇÃO</button>
      </div>
      <p id="status"></p>
    </div>

    <div class="painel" style="overflow-x:auto;">
      <h2>Lista de Jogadores</h2>
      <div style="color:#cfd6ff;font-weight:800;margin:6px 0 10px">
  ZAGUEIRO = Z &nbsp;&nbsp; LATERAL = L &nbsp;&nbsp; MEIO = M &nbsp;&nbsp; ATAQUE = A
</div>
      <div class="row" style="margin:8px 0 10px;">
        <button class="btn-recarregar" id="btn-recarregar">RECARREGAR LISTA</button>
        <button class="btn btn-blue" id="btn-baixar-pdf">BAIXAR PDF (ATUAL)</button>
      </div>
      <p style="font-size:12px;">ORDEM ALFABÉTICA POR APELIDO. COLUNA IDADE É CALCULADA AUTOMÁTICA.</p>

      <table id="tblJogadores">
        <thead>
          <tr>
            <th>ORDEM</th>
            <th>ID</th>
            <th>CAMISA</th>
            <th>APELIDO</th>
            <th>NOME</th>
            <th>DATA NASC.</th>
            <th>IDADE</th>
            <th>CELULAR</th>
            <th>POSIÇÃO</th>
            <th>HAB</th>
            <th>VEL</th>
            <th>MOV</th>
            <th>PONTOS</th>
            <th>EDITAR</th>
            <th>EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tbody-jogadores"></tbody>
      </table>

      <!-- HISTÓRICO (ANO/MÊS) - não precisa visualizar, apenas escolher e baixar -->
      <div class="hist-card" id="histCard">
        <div class="hist-title">HISTÓRICO (ANO / MÊS)</div>
        <div class="hist-row">
          <div class="hist-field">
            <label>ANO</label>
            <select id="histAno"></select>
          </div>
          <div class="hist-field">
            <label>MÊS</label>
            <select id="histMes"></select>
          </div>
          <div class="hist-actions">
            <button class="btn btn-green" id="btnHistBuscar">BUSCAR</button>
            <button class="btn btn-orange" id="btnHistLimpar">LIMPAR</button>
          </div>
        </div>
        <div id="histResultado"></div>
        <div class="hint" style="margin-top:8px;">Obs: o histórico é salvo automaticamente quando você salva/edita/exclui jogadores. E também quando abrir o painel perto do dia 1º.</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ===== SUPABASE (mesmo padrão do CAIXA) ===== */
    const CFG = window.TESOURA_CONFIG || window.parent?.TESOURA_CONFIG || {};
    const SUPABASE_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || CFG.SUPABASE_ANON || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    var supabase = window.__TESOURA_SUPABASE__;
    const camisaInput = document.getElementById("camisa");
    const nomeInput = document.getElementById("nome");
    const apelidoInput = document.getElementById("apelido");
    const dataNascInput = document.getElementById("data_nasc");
    const celularInput = document.getElementById("celular");
    const posicaoInput = document.getElementById("posicao");
    const habInput = document.getElementById("hab");
    const velInput = document.getElementById("vel");
    const movInput = document.getElementById("mov");
    const pontosInput = document.getElementById("pontos");

    const btnSalvar = document.getElementById("btn-salvar");
    const btnCancelar = document.getElementById("btn-cancelar");
    const btnRecarregar = document.getElementById("btn-recarregar");
    const btnBaixarPdfAtual = document.getElementById("btn-baixar-pdf");

    /* histórico */
    const selAnoHist = document.getElementById("selAnoHist");
    const selMesHist = document.getElementById("selMesHist");
    const btnHistBuscar = document.getElementById("btnHistBuscar");
    const btnHistLimpar = document.getElementById("btnHistLimpar");
    const tbodyHist = document.getElementById("tbody-historico");

    const tbody = document.getElementById("tbody-jogadores");
    const statusEl = document.getElementById("status");

    let editId = null;

    function el(id){ return document.getElementById(id); }

    function pad2(n){ return String(n).padStart(2,'0'); }

    function getMesAtualRef(){
      const d = new Date();
      const ano = d.getFullYear();
      const mes = d.getMonth()+1;
      return { ano, mes, mes2: pad2(mes), dataRef: `${ano}-${pad2(mes)}-01`, ref: `${pad2(mes)}/${ano}` };
    }

    function formatAgora(){
      try{
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }catch(e){
        return '';
      }
    }

    function sanitizeTableHtml(html){
      try{
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const table = doc.querySelector('table');
        if(!table) return html;

        // remove coluna AÇÕES (se existir)
        const ths = Array.from(table.querySelectorAll('thead th'));
        const idxs = [];
        ths.forEach((th, i) => {
          const t = (th.textContent || '').trim().toUpperCase();
          if (t.includes('AÇÕES') || t.includes('ACOES') || (th.className||'').includes('col-actions')) idxs.push(i);
        });

        const removeAt = (idx) => {
          const headRow = table.querySelector('thead tr');
          if (headRow && headRow.children[idx]) headRow.children[idx].remove();
          table.querySelectorAll('tbody tr').forEach(tr => { if (tr.children[idx]) tr.children[idx].remove(); });
        };

        idxs.sort((a,b)=>b-a).forEach(removeAt);

        // remove botões remanescentes
        table.querySelectorAll('button').forEach(b=>b.remove());

        return table.outerHTML;
      }catch(e){
        return html;
      }
    }

    function imprimirNoPainel({ titulo, subtitulo, tableHtml }){
      const area = document.getElementById('printArea');
      if (!area) { alert('Erro: printArea não encontrado.'); return; }

      const safeTable = sanitizeTableHtml(tableHtml || '');
      area.innerHTML = `
        <div class="printMeta">${formatAgora()}</div>
        <div class="printTitle">${titulo || ''}</div>
        ${subtitulo ? `<div class="printSub">${subtitulo}</div>` : ``}
        ${safeTable}
      `;

      // modo impressão (sem abrir nova aba)
      document.body.classList.add('printMode');

      // dispara impressão/PDF
      setTimeout(()=>window.print(), 50);
    }

    // limpa após imprimir
    window.addEventListener('afterprint', () => {
      document.body.classList.remove('printMode');
      const area = document.getElementById('printArea');
      if (area) area.innerHTML = '';
    });


    async function arquivarJogadoresMesAtual({motivo}){
      try {
        const { ano, mes, mes2, dataRef, ref } = getMesAtualRef();
        // monta conteúdo do painel (exatamente como seria baixado)
        const titulo = `JOGADORES (${mes2}/${ano})`;
        const gerado = new Date();
        const tableHtml = document.getElementById('tblJogadores')?.outerHTML || '';

        // remove snapshot do mesmo mês (evita duplicidade)
        await supabase
          .from('arquivos_app')
          .delete()
          .eq('painel','jogadores')
          .eq('periodo','mensal')
          .eq('ano_ref', ano)
          .eq('mes_ref', mes)
          .eq('data_ref', dataRef);

        const payload = {
          painel: 'jogadores',
          periodo: 'mensal',
          data_ref: dataRef,
          mes_ref: mes,
          ano_ref: ano,
          referencia: ref,
          titulo,
          conteudo: {
            titulo,
            referencia: ref,
            motivo: motivo || 'auto',
            gerado_em: gerado.toISOString(),
            total: (window.__jogadoresCache__ || []).length,
            jogadores: window.__jogadoresCache__ || [],
            table_html: tableHtml,
          }
        };

        const { error } = await supabase.from('arquivos_app').insert(payload);
        if (error) console.warn('Aviso: não conseguiu arquivar jogadores.', error);
      } catch (e) {
        console.warn('Aviso: erro ao arquivar jogadores.', e);
      }
    }

    async function carregarHistoricoJogadores(){
      tbodyHist.innerHTML = '';
      const ano = parseInt(selAnoHist.value,10);
      const mes = parseInt(selMesHist.value,10);
      if (!ano || !mes) return;

      const { data, error } = await supabase
        .from('arquivos_app')
        .select('id, created_at, titulo, referencia, conteudo')
        .eq('painel','jogadores')
        .eq('periodo','mensal')
        .eq('ano_ref', ano)
        .eq('mes_ref', mes)
        .order('created_at', { ascending: false });

      if (error) {
        console.warn('Aviso: não conseguiu ler histórico de jogadores.', error);
        tbodyHist.innerHTML = `<tr><td colspan="3" style="color:#ff6b6b;">Erro ao carregar histórico.</td></tr>`;
        return;
      }

      const rows = (data || []);
      if (rows.length === 0) {
        tbodyHist.innerHTML = `<tr><td colspan="3">Nenhum arquivo salvo para este mês.</td></tr>`;
        return;
      }

      for (const r of rows) {
        const dt = r.created_at ? new Date(r.created_at) : null;
        const quando = dt ? `${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}` : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${quando}</td>
          <td>${r.titulo || 'JOGADORES'}</td>
          <td><button class="btn btn-blue" data-id="${r.id}">BAIXAR PDF</button></td>
        `;
        const btn = tr.querySelector('button');
        btn.addEventListener('click', async ()=>{
          const conteudo = r.conteudo || {};
          const tableHtml = conteudo.table_html || '';
          const titulo = conteudo.titulo || r.titulo || 'JOGADORES';
          const subtitulo = conteudo.referencia ? `Referência: ${conteudo.referencia}` : '';
          imprimirNoPainel({ titulo, subtitulo, tableHtml });
        });
        tbodyHist.appendChild(tr);
      }
    }

    function calcularIdade(dataISO) {
      if (!dataISO) return "";
      try {
        const nasc = new Date(dataISO);
        if (isNaN(nasc.getTime())) return "";
        const hoje = new Date();
        let idade = hoje.getFullYear() - nasc.getFullYear();
        const m = hoje.getMonth() - nasc.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
        if (idade < 0 || idade > 120) return "";
        return idade;
      } catch {
        return "";
      }
    }

    function limparFormulario() {
      editId = null;
      camisaInput.value = "";
      nomeInput.value = "";
      apelidoInput.value = "";
      dataNascInput.value = "";
      celularInput.value = "";
      posicaoInput.value = "";
      habInput.value = "";
      velInput.value = "";
      movInput.value = "";
      pontosInput.value = "";
      statusEl.textContent = "";
      btnSalvar.textContent = "SALVAR JOGADOR";
    }

    function atualizarPontos() {
      const hab = habInput.value ? parseInt(habInput.value, 10) : 0;
      const vel = velInput.value ? parseInt(velInput.value, 10) : 0;
      const mov = movInput.value ? parseInt(movInput.value, 10) : 0;
      const soma = (hab || 0) + (vel || 0) + (mov || 0);
      pontosInput.value = soma ? soma : "";
    }

    habInput.addEventListener("input", atualizarPontos);
    velInput.addEventListener("input", atualizarPontos);
    movInput.addEventListener("input", atualizarPontos);

    async function carregarJogadores() {
      statusEl.textContent = "Carregando jogadores...";
      tbody.innerHTML = "";
      const { data, error } = await supabase
        .from("jogadores")
        .select("id,camisa,apelido,nome,data_nasc,celular,posicao,hab,vel,mov,pontos,ativo")
        .order("apelido", { ascending: true });

      if (error) {
        console.error(error);
        statusEl.textContent = "ERRO AO CARREGAR JOGADORES.";
        return;
      }

      let ordem = 0;
      data.forEach(j => {
        ordem++;
        const tr = document.createElement("tr");

        function tdTexto(t) {
          const td = document.createElement("td");
          td.textContent = t ?? "";
          return td;
        }

       tr.appendChild(tdTexto(String(ordem)));
        tr.appendChild(tdTexto(j.id));
        tr.appendChild(tdTexto(j.camisa ?? ""));
        tr.appendChild(tdTexto((j.apelido || "").toUpperCase()));
        tr.appendChild(tdTexto((j.nome || "").toUpperCase()));
        tr.appendChild(tdTexto(j.data_nasc || ""));

        const idade = calcularIdade(j.data_nasc);
        tr.appendChild(tdTexto(idade !== "" ? idade : ""));

        tr.appendChild(tdTexto(j.celular || ""));
        tr.appendChild(tdTexto((j.posicao || "").toUpperCase()));
        tr.appendChild(tdTexto(j.hab ?? ""));
        tr.appendChild(tdTexto(j.vel ?? ""));
        tr.appendChild(tdTexto(j.mov ?? ""));
        tr.appendChild(tdTexto(j.pontos ?? ""));

        const tdEditar = document.createElement("td");
        const btnE = document.createElement("button");
        btnE.textContent = "EDITAR";
        btnE.className = "btn btn-orange";
        btnE.style.padding = "6px 10px";
        btnE.style.fontSize = "11px";
        btnE.addEventListener("click", () => {
          editId = j.id;
          camisaInput.value = j.camisa ?? "";
          nomeInput.value = j.nome ?? "";
          apelidoInput.value = j.apelido ?? "";
          dataNascInput.value = j.data_nasc ?? "";
          celularInput.value = j.celular ?? "";
          posicaoInput.value = (j.posicao ?? "").toUpperCase();
          habInput.value = j.hab ?? "";
          velInput.value = j.vel ?? "";
          movInput.value = j.mov ?? "";
          pontosInput.value = j.pontos ?? "";
          statusEl.textContent = "Editando jogador ID " + j.id;
          btnSalvar.textContent = "SALVAR ALTERAÇÃO";
        });
        tdEditar.appendChild(btnE);
        tr.appendChild(tdEditar);

        const tdExcluir = document.createElement("td");
        const btnX = document.createElement("button");
        btnX.textContent = "EXCLUIR";
        btnX.className = "btn btn-red";
        btnX.style.padding = "6px 10px";
        btnX.style.fontSize = "11px";
        btnX.addEventListener("click", async () => {
          if (!confirm("Excluir este jogador?")) return;
          await excluirJogador(j.id);
        });
        tdExcluir.appendChild(btnX);
        tr.appendChild(tdExcluir);

        tbody.appendChild(tr);
      });

      statusEl.textContent = "TOTAL DE JOGADORES: " + data.length;
    }

    async function excluirJogador(id) {
      statusEl.textContent = "Excluindo jogador...";
      const { error } = await supabase.from("jogadores").delete().eq("id", id);

      if (error) {
        console.error(error);
        statusEl.textContent =
          "ERRO AO EXCLUIR JOGADOR: " + (error.message || JSON.stringify(error));
        return;
      }

      statusEl.textContent = "JOGADOR EXCLUÍDO COM SUCESSO.";
      await carregarJogadores();
      await arquivarJogadoresMesAtual("edit/delete");
    }

    async function salvarJogador() {
      let camisa = camisaInput.value ? parseInt(camisaInput.value, 10) : null;
      let nome = nomeInput.value.trim().toUpperCase();
      let apelido = apelidoInput.value.trim().toUpperCase();
      let data_nasc = dataNascInput.value || null;
      let celular = celularInput.value.trim();
      let posicao = posicaoInput.value.trim().toUpperCase().slice(0,1);
      // compatibilidade: se digitar D, vira Z (Zagueiro)
      if(posicao === "D") posicao = "Z";
      if(posicao && !["Z","L","M","A"].includes(posicao)){
        statusEl.textContent = "POSIÇÃO inválida. Use: Z (Zagueiro), L (Lateral), M (Meio), A (Ataque).";
        return;
      }
      let hab = habInput.value ? parseInt(habInput.value, 10) : null;
      let vel = velInput.value ? parseInt(velInput.value, 10) : null;
      let mov = movInput.value ? parseInt(movInput.value, 10) : null;

      // calcular pontos automaticamente = HAB + VEL + MOV
      let pontos = null;
      if (hab !== null || vel !== null || mov !== null) {
        pontos = (hab || 0) + (vel || 0) + (mov || 0);
      }

      if (!apelido) {
        statusEl.textContent = "APELIDO é obrigatório.";
        return;
      }

      const payload = {
        camisa,
        nome: nome || null,
        apelido,
        data_nasc,
        celular: celular || null,
        posicao: posicao || null,
        hab,
        vel,
        mov,
        pontos,
        ativo: true
      };

      statusEl.textContent = "Salvando jogador...";
      let error;
      if (editId === null) {
        const resp = await supabase
          .from("jogadores")
          .insert(payload);
        error = resp.error;
      } else {
        const resp = await supabase
          .from("jogadores")
          .update(payload)
          .eq("id", editId);
        error = resp.error;
      }

      if (error) {
        console.error(error);
        statusEl.textContent = "ERRO AO SALVAR JOGADOR.";
        return;
      }

      statusEl.textContent = "JOGADOR SALVO COM SUCESSO.";
      limparFormulario();
      await carregarJogadores();
      await arquivarJogadoresMesAtual("edit/delete");
    }

    async function init() {
      await carregarJogadores();
      preencherFiltrosHistorico();
      await carregarHistorico();

      /* auto-snapshot perto do dia 01 (se abrir) */
      const hoje = new Date();
      if (hoje.getDate() <= 3) {
        await arquivarJogadoresMesAtual("auto-dia01");
      }
    }

    btnSalvar.addEventListener("click", salvarJogador);
    btnCancelar.addEventListener("click", limparFormulario);
    btnRecarregar.addEventListener("click", carregarJogadores);
    btnBaixarPdfAtual.addEventListener("click", () => {
      const html = document.getElementById("tblJogadores")?.outerHTML || "";
      imprimirNoPainel({ titulo: \"JOGADORES - LISTA ATUAL\", tableHtml: html });
    });

    btnHistBuscar.addEventListener("click", carregarHistorico);
    btnHistLimpar.addEventListener("click", () => {
      preencherFiltrosHistorico();
      carregarHistorico();
    });

    init();
  </script>

  <div id="printArea" aria-hidden="true"></div>
</body>
</html>
