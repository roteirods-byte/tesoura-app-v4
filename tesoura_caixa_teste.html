<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesoura - Caixa</title>
  <style>
    :root {
      --bg: #07101f;
      --panel: #0b1830;
      --panel2: #0d1f3c;
      --stroke: rgba(255,255,255,.12);
      --text: #e9eef7;
      --muted: rgba(233,238,247,.75);
      --orange: #ff8a2b;
      --cyan: #35d0ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 10%, rgba(60,120,255,.20), transparent 55%),
                  radial-gradient(900px 500px at 80% 30%, rgba(255,138,43,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
      padding: 16px;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(15,25,45,.85), rgba(6,11,22,.85));
      padding: 16px;
    }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; margin-bottom: 10px; }
    h1 { margin: 0; font-size: 26px; letter-spacing: .5px; }
    .subtitle { margin-top: 4px; color: var(--muted); font-size: 12px; line-height: 1.35; max-width: 720px; }
    .chip { align-self:flex-start; padding: 8px 10px; border-radius: 999px; border: 1px solid var(--stroke);
            background: rgba(0,0,0,.15); color: var(--text); font-size: 12px; white-space: nowrap; }

    .grid { display:grid; grid-template-columns: 1.5fr 1fr; gap: 14px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid var(--stroke); border-radius: 16px;
            background: linear-gradient(180deg, rgba(18,30,55,.78), rgba(10,18,34,.78));
            padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin: 0 0 10px 0; font-size: 14px; color: var(--orange); letter-spacing: .3px; text-transform: uppercase; }

    .row { display:grid; grid-template-columns: 120px 150px 1fr 1fr 140px; gap: 10px; align-items: end; }
    @media (max-width: 980px) { .row { grid-template-columns: 1fr 1fr; } }

    label { display:block; font-size: 11px; color: var(--muted); margin-bottom: 5px; }
    input, select {
      width: 100%; height: 36px; border-radius: 10px; border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04); color: var(--text); padding: 0 10px; outline: none;
    }
    input::placeholder { color: rgba(233,238,247,.45); }

    .btns { display:flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button { height: 36px; border-radius: 10px; border: 1px solid var(--stroke); cursor: pointer; padding: 0 14px;
             font-weight: 700; letter-spacing: .2px; }
    .btn-primary { background: var(--cyan); color: #00111a; border-color: rgba(53,208,255,.35); }
    .btn-secondary { background: rgba(255,255,255,.08); color: var(--text); }
    .btn-orange { background: var(--orange); color: #1a0b00; border-color: rgba(255,138,43,.40); width: 100%; }

    .status { margin-top: 8px; font-size: 12px; color: var(--muted); }
    .totals { display:flex; gap: 12px; flex-wrap: wrap; margin: 10px 0 0; font-size: 12px; color: var(--text); }
    .totals b { color: var(--text); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; overflow: hidden;
            border-radius: 14px; border: 1px solid var(--stroke); background: rgba(0,0,0,.10); }
    thead th { background: var(--orange); color: #1a0b00; font-size: 11px; text-transform: uppercase;
               padding: 10px 8px; border-right: 1px solid rgba(0,0,0,.18); white-space: nowrap; }
    thead th:last-child { border-right: none; }
    tbody td { padding: 9px 8px; border-top: 1px solid var(--stroke); font-size: 12px; color: var(--text); vertical-align: top; }
    tbody tr:hover td { background: rgba(255,255,255,.03); }
    .small { font-size: 11px; color: var(--muted); }
    .linkbtn { background: rgba(255,255,255,.08); color: var(--text); border: 1px solid var(--stroke);
               height: 28px; padding: 0 10px; border-radius: 10px; font-weight: 700; font-size: 11px; }
    .danger { background: rgba(255,0,0,.10); border-color: rgba(255,0,0,.25); }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Config (opcional). Se não existir, o CAIXA usa fallback. -->
  <script src="config.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>TESOURA - CAIXA</h1>
        <div class="subtitle">
          Arquivo mensal: dia 1 → dia 1 do próximo mês. A tela fica sempre no mês corrente.
          O filtro ao lado é apenas para baixar PDF de meses anteriores.
        </div>
      </div>
      <div class="chip" id="chipMes">Mês corrente: --</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Lançamentos (mês corrente)</h2>

        <div class="row">
          <div>
            <label>DATA (automática)</label>
            <input id="inData" type="text" disabled />
          </div>

          <div>
            <label>TIPO</label>
            <select id="inTipo">
              <option value="RECEITA">RECEITA</option>
              <option value="DESPESA">DESPESA</option>
            </select>
          </div>

          <div>
            <label>DESCRIÇÃO</label>
            <input id="inDesc" placeholder="Descrição" maxlength="120" />
          </div>

          <div>
            <label>OBS</label>
            <input id="inObs" placeholder="Opcional" maxlength="120" />
          </div>

          <div>
            <label>VALOR (R$)</label>
            <input id="inValor" inputmode="decimal" placeholder="0,00" />
          </div>
        </div>

        <div class="btns">
          <button class="btn-primary" id="btnSalvar">SALVAR</button>
          <button class="btn-secondary" id="btnLimpar">LIMPAR</button>
        </div>

        <div class="status" id="status">Carregando...</div>
        <div class="totals">
          <span><b>SALDO ANTERIOR:</b> <span id="tAnterior">R$ 0,00</span></span>
          <span><b>SALDO NO PERÍODO:</b> <span id="tPeriodo">R$ 0,00</span></span>
          <span><b>SALDO FINAL:</b> <span id="tFinal">R$ 0,00</span></span>
        </div>

        <table>
          <thead>
            <tr>
              <th>DATA</th>
              <th>DESCRIÇÃO</th>
              <th>OBS</th>
              <th>RECEITA (R$)</th>
              <th>DESPESA (R$)</th>
              <th>SALDO (R$)</th>
              <th>EDITAR</th>
              <th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" class="small">Carregando...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h2>PDF (arquivo mensal)</h2>
        <div class="row" style="grid-template-columns: 1fr 1fr;">
          <div>
            <label>ANO</label>
            <select id="pdfAno"></select>
          </div>
          <div>
            <label>MÊS</label>
            <select id="pdfMes"></select>
          </div>
        </div>

        <div class="btns">
          <button class="btn-orange" id="btnPdf">BAIXAR PDF</button>
        </div>

        <div class="status">
          Dica: o PDF abre no navegador. Depois clique em <b>Imprimir</b> e salve como PDF.
          <div class="small" style="margin-top:6px;">ARQUIVO: tesoura_caixa_teste.html</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG + SUPABASE ===== */
const CFG = window.TESOURA_CONFIG || {};
const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
const sb = window.supabase.createClient(SB_URL, SB_KEY);

// fonte para LISTAR (view já pronta com saldo e permissões)
const VIEW_NAME = "vw_caixa_painel";
// tabela real para INSERT/UPDATE/DELETE
const TABLE_NAME = "caixa";

/* ===== util ===== */
const fmtBRL = (n) => {
  const v = (Number(n) || 0);
  return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
};
const toISO = (d) => d.toISOString().slice(0,10);
const toBR = (iso) => {
  if(!iso) return "";
  const [y,m,dd] = iso.split("-");
  return `${dd}/${m}/${y}`;
};
const parseValor = (s) => {
  if(!s) return 0;
  return Number(String(s).replaceAll(".", "").replace(",", ".").trim()) || 0;
};

/* ===== estado ===== */
let editingId = null;

const inData = document.getElementById("inData");
const inTipo = document.getElementById("inTipo");
const inDesc = document.getElementById("inDesc");
const inObs = document.getElementById("inObs");
const inValor = document.getElementById("inValor");
const tbody = document.getElementById("tbody");
const statusEl = document.getElementById("status");

const tAnterior = document.getElementById("tAnterior");
const tPeriodo = document.getElementById("tPeriodo");
const tFinal = document.getElementById("tFinal");

const chipMes = document.getElementById("chipMes");

const pdfAno = document.getElementById("pdfAno");
const pdfMes = document.getElementById("pdfMes");

/* ===== datas do mês corrente ===== */
function monthRange(year, month1to12) {
  const start = new Date(year, month1to12 - 1, 1);
  const next = new Date(year, month1to12, 1);
  return { startISO: toISO(start), endISOExclusive: toISO(next), start, next };
}
function currentMonthRange() {
  const now = new Date();
  return monthRange(now.getFullYear(), now.getMonth() + 1);
}
function monthLabel(year, month1to12) {
  const nomes = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
  return `${String(month1to12).padStart(2,"0")} - ${nomes[month1to12-1]} / ${year}`;
}

/* ===== carregar mês (tela) ===== */
async function loadCurrentMonth() {
  try {
    statusEl.textContent = "Carregando...";
    const r = currentMonthRange();
    chipMes.textContent = "Mês corrente: " + monthLabel(r.start.getFullYear(), r.start.getMonth()+1);
    inData.value = toBR(toISO(new Date()));

    // saldo anterior = último saldo antes do início do mês
    const prev = await sb
      .from(VIEW_NAME)
      .select("saldo,data,id")
      .lt("data", r.startISO)
      .order("data", { ascending: false })
      .order("id", { ascending: false })
      .limit(1);

    const saldoAnterior = (prev.data && prev.data[0]) ? (Number(prev.data[0].saldo)||0) : 0;

    // lista do mês corrente
    const res = await sb
      .from(VIEW_NAME)
      .select("id,data,descricao,obs,receita,despesa,saldo,pode_editar,pode_excluir")
      .gte("data", r.startISO)
      .lt("data", r.endISOExclusive)
      .order("data", { ascending: true })
      .order("id", { ascending: true });

    if(res.error) throw res.error;

    renderRows(res.data || [], saldoAnterior);
    statusEl.textContent = "OK";
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ERRO ao buscar CAIXA. Abra o Console (F12).";
  }
}

function renderRows(rows, saldoAnterior) {
  const saldoFinal = (rows.length ? (Number(rows[rows.length-1].saldo)||0) : saldoAnterior);
  tAnterior.textContent = fmtBRL(saldoAnterior);
  tFinal.textContent = fmtBRL(saldoFinal);
  tPeriodo.textContent = fmtBRL(saldoFinal - saldoAnterior);

  if(!rows.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="small">Sem lançamentos no mês corrente.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const receita = Number(r.receita)||0;
    const despesa = Number(r.despesa)||0;
    const saldo = Number(r.saldo)||0;

    const canEdit = !!r.pode_editar;
    const canDel  = !!r.pode_excluir;

    return `
      <tr>
        <td>${toBR(r.data)}</td>
        <td>${(r.descricao||"")}</td>
        <td>${(r.obs||"")}</td>
        <td>${receita ? fmtBRL(receita) : ""}</td>
        <td>${despesa ? fmtBRL(despesa) : ""}</td>
        <td>${fmtBRL(saldo)}</td>
        <td>${canEdit ? `<button class="linkbtn" data-act="edit" data-id="${r.id}">EDITAR</button>` : ""}</td>
        <td>${canDel ? `<button class="linkbtn danger" data-act="del" data-id="${r.id}">EXCLUIR</button>` : ""}</td>
      </tr>
    `;
  }).join("");
}

/* ===== salvar / editar / excluir ===== */
function clearForm() {
  editingId = null;
  inTipo.value = "RECEITA";
  inDesc.value = "";
  inObs.value = "";
  inValor.value = "";
}

async function saveForm() {
  const desc = (inDesc.value || "").trim();
  const obs  = (inObs.value || "").trim();
  const tipo = inTipo.value;
  const valor = parseValor(inValor.value);

  if(!desc) { alert("Digite a DESCRIÇÃO."); return; }
  if(!valor || valor <= 0) { alert("Digite um VALOR maior que zero."); return; }

  const hojeISO = toISO(new Date());
  const payload = {
    data: hojeISO,
    descricao: desc,
    obs: obs || null,
    receita: (tipo === "RECEITA") ? valor : null,
    despesa: (tipo === "DESPESA") ? valor : null
  };

  try {
    statusEl.textContent = "Salvando...";
    if(editingId) {
      const upd = { descricao: payload.descricao, obs: payload.obs, receita: payload.receita, despesa: payload.despesa };
      const r = await sb.from(TABLE_NAME).update(upd).eq("id", editingId);
      if(r.error) throw r.error;
    } else {
      const r = await sb.from(TABLE_NAME).insert(payload);
      if(r.error) throw r.error;
    }
    clearForm();
    await loadCurrentMonth();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ERRO ao salvar. Abra o Console (F12).";
    alert("ERRO ao salvar. Veja o Console (F12).");
  }
}

async function startEdit(id) {
  try {
    const r = await sb.from(VIEW_NAME)
      .select("id,descricao,obs,receita,despesa,pode_editar")
      .eq("id", id)
      .limit(1);
    if(r.error) throw r.error;

    const row = (r.data && r.data[0]) ? r.data[0] : null;
    if(!row) return;

    if(!row.pode_editar) { alert("Este lançamento não pode ser editado."); return; }

    editingId = row.id;

    const receita = Number(row.receita)||0;
    const despesa = Number(row.despesa)||0;

    if(receita > 0) {
      inTipo.value = "RECEITA";
      inValor.value = String(receita).replace(".", ",");
    } else {
      inTipo.value = "DESPESA";
      inValor.value = String(despesa).replace(".", ",");
    }

    inDesc.value = row.descricao || "";
    inObs.value = row.obs || "";
    window.scrollTo({ top: 0, behavior: "smooth" });
  } catch (e) {
    console.error(e);
    alert("ERRO ao carregar edição. Veja o Console (F12).");
  }
}

async function deleteRow(id) {
  if(!confirm("Excluir este lançamento?")) return;
  try {
    statusEl.textContent = "Excluindo...";
    const r = await sb.from(TABLE_NAME).delete().eq("id", id);
    if(r.error) throw r.error;
    await loadCurrentMonth();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ERRO ao excluir. Abra o Console (F12).";
    alert("ERRO ao excluir. Veja o Console (F12).");
  }
}

/* ===== PDF ===== */
function fillPdfSelectors() {
  const now = new Date();
  const y = now.getFullYear();

  const anos = [];
  for(let i=0;i<6;i++) anos.push(y - i);
  pdfAno.innerHTML = anos.map(a => `<option value="${a}">${a}</option>`).join("");

  const meses = [
    ["01","JAN"],["02","FEV"],["03","MAR"],["04","ABR"],["05","MAI"],["06","JUN"],
    ["07","JUL"],["08","AGO"],["09","SET"],["10","OUT"],["11","NOV"],["12","DEZ"]
  ];
  pdfMes.innerHTML = meses.map(([v,l]) => `<option value="${v}">${v} - ${l}</option>`).join("");

  pdfAno.value = String(y);
  pdfMes.value = String(now.getMonth()+1).padStart(2,"0");
}

async function baixarPdf() {
  try {
    const year = Number(pdfAno.value);
    const month = Number(pdfMes.value);
    const r = monthRange(year, month);

    const res = await sb
      .from(VIEW_NAME)
      .select("data,descricao,obs,receita,despesa,saldo")
      .gte("data", r.startISO)
      .lt("data", r.endISOExclusive)
      .order("data", { ascending: true })
      .order("id", { ascending: true });

    if(res.error) throw res.error;
    const rows = res.data || [];

    const doc = `<!doctype html>
<html lang="pt-BR"><head><meta charset="utf-8">
<title>CAIXA - ${monthLabel(year, month)}</title>
<style>
  body { font-family: Arial, sans-serif; padding: 16px; }
  h1 { margin: 0 0 8px 0; }
  .small { color:#555; font-size: 12px; margin-bottom: 12px; }
  table { width:100%; border-collapse: collapse; }
  th, td { border: 1px solid #999; padding: 6px; font-size: 12px; }
  th { background: #eee; }
</style></head><body>
<h1>TESOURA - CAIXA</h1>
<div class="small">Arquivo mensal: ${monthLabel(year, month)}</div>
<table><thead><tr>
<th>DATA</th><th>DESCRIÇÃO</th><th>OBS</th><th>RECEITA</th><th>DESPESA</th><th>SALDO</th>
</tr></thead><tbody>
${rows.map(r => `
<tr>
<td>${toBR(r.data)}</td>
<td>${(r.descricao||"")}</td>
<td>${(r.obs||"")}</td>
<td>${(Number(r.receita)||0) ? fmtBRL(r.receita) : ""}</td>
<td>${(Number(r.despesa)||0) ? fmtBRL(r.despesa) : ""}</td>
<td>${fmtBRL(r.saldo)}</td>
</tr>`).join("")}
</tbody></table>
<script>window.print();</script>
</body></html>`;

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(doc);
    w.document.close();
  } catch (e) {
    console.error(e);
    alert("ERRO ao gerar PDF. Veja o Console (F12).");
  }
}

/* ===== events ===== */
document.getElementById("btnLimpar").addEventListener("click", () => {
  clearForm();
  statusEl.textContent = "OK";
});
document.getElementById("btnSalvar").addEventListener("click", saveForm);
document.getElementById("btnPdf").addEventListener("click", baixarPdf);

tbody.addEventListener("click", (ev) => {
  const btn = ev.target.closest("button");
  if(!btn) return;
  const id = Number(btn.getAttribute("data-id"));
  const act = btn.getAttribute("data-act");
  if(!id) return;
  if(act === "edit") startEdit(id);
  if(act === "del") deleteRow(id);
});

/* ===== start ===== */
fillPdfSelectors();
loadCurrentMonth();
</script>
</body>
</html>
