
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CAIXA (TESTE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#0b1220; color:#fff; }
    header{
      padding:14px 18px; border-bottom:2px solid #f97316;
      display:flex; align-items:center; justify-content:space-between;
      background:#07101f;
    }
    header h1{ margin:0; font-size:16px; letter-spacing:.5px; color:#f97316; text-transform:uppercase; font-weight:900; }
    .wrap{ max-width:1100px; margin:18px auto; padding:0 12px; }
    .painel{
      background:#020617; border:1px solid #0f172a; border-radius:12px;
      padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .painel h2{ margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-weight:900; text-transform:uppercase; font-size:12px; }
    select, input[type="text"], input[type="date"], input[type="time"], input[type="number"]{
      border-radius:10px; border:1px solid #0f172a; padding:10px 12px;
      font-weight:900; font-size:12px; background:#0b1220; color:#fff;
      outline:none;
    }
    input[type="number"]{ width:120px; }
    input[type="text"]{ width:260px; }
    .btn{
      border:0; border-radius:10px; padding:10px 12px; font-weight:900; text-transform:uppercase;
      font-size:12px; cursor:pointer;
    }
    .btn-azul{ background:#38bdf8; color:#031019; }
    .btn-laranja{ background:#f97316; color:#111827; }
    .btn-vermelho{ background:#ef4444; color:#111827; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .status{ margin-top:8px; font-size:12px; color:#9ca3af; }

    .table-wrap{ overflow:auto; border-radius:12px; border:1px solid #0f172a; }
    table{ border-collapse:collapse; font-size:12px; width:max-content; min-width:100%; }
    thead th{
      position:sticky; top:0; background:#f97316; color:#ffffff; z-index:2;
      border:1px solid rgba(255,255,255,.45); padding:8px 8px; text-align:center; white-space:nowrap;
      font-weight:900; text-transform:uppercase;
    }
    tbody td{
      border:1px solid rgba(255,255,255,.20); padding:6px 6px; text-align:center; white-space:nowrap;
      background:#020617; text-transform:uppercase;
      vertical-align:middle;
    }
    tbody tr:nth-child(even) td{ background:#061024; }

    .td-left{ text-align:left; padding-left:10px; }
    .money-pos{ color:#22c55e; font-weight:900; }
    .money-neg{ color:#ef4444; font-weight:900; }
    .saldo{ font-weight:900; }
    .fechamento td{
      background:#111827 !important;
      border-top:2px solid rgba(249,115,22,.95) !important;
      border-bottom:2px solid rgba(249,115,22,.95) !important;
    }
    .fechamento .td-left{ color:#f97316; font-weight:900; }

    /* PRINT / PDF */
    @page{ size: A4 landscape; margin: 10mm; }
    @media print{
      header, .no-print{ display:none !important; }
      body{ background:#fff; color:#000; }
      .wrap{ max-width:none; margin:0; padding:0; }
      .painel{ box-shadow:none; border:0; padding:0; }
      .table-wrap{ overflow:visible !important; border:0; }
      table{ width:100% !important; min-width:100% !important; }
      thead th{ position:static !important; }
      tbody td{ background:#fff !important; color:#000 !important; }
      .money-pos{ color:#000 !important; }
      .money-neg{ color:#000 !important; }
      .fechamento td{ background:#fff !important; }
    }
  </style>
</head>
<body>

<header>
  <h1>TESOURA - CAIXA</h1>
  <div style="font-size:12px;color:#9ca3af;">(auto-save)</div>
</header>

<div class="wrap">

  <div class="painel no-print">
    <h2>FILTRO</h2>
    <div class="row" style="justify-content:space-between; width:100%;">
      <div class="row">
        <div class="row" style="gap:8px;">
          <label>ANO:</label>
          <select id="selAno"></select>
        </div>

        <div class="row" style="gap:8px;">
          <label>MÊS:</label>
          <select id="selMes"></select>
        </div>

        <div class="row" style="gap:8px;">
          <label>PERÍODO:</label>
          <select id="selPeriodo">
            <option value="SEMANAL">SEMANAL</option>
            <option value="MENSAL">MENSAL</option>
            <option value="ANUAL">ANUAL</option>
          </select>
        </div>

        <div class="row" style="gap:8px;" id="wrapSemana">
          <label>SEMANA:</label>
          <select id="selSemana"></select>
        </div>

        <button id="btnConsultar" class="btn btn-azul">CONSULTAR</button>
      </div>

      <div class="row">
        <button id="btnNovo" class="btn btn-azul" title="Criar lançamento">NOVO</button>
        <button id="btnPdf" class="btn btn-laranja" title="Salvar em PDF">BAIXAR PDF</button>
      </div>
    </div>

    <div class="status" id="status">Carrega automaticamente.</div>
  </div>

  <div class="painel">
    <h2>LANÇAMENTOS</h2>
    <div class="table-wrap" id="wrapTabela">
      <table>
        <thead>
          <tr>
            <th>DATA</th>
            <th>HORA</th>
            <th>TIPO</th>
            <th>DESCRIÇÃO</th>
            <th>OBS</th>
            <th>RECEITA (R$)</th>
            <th>DESPESA (R$)</th>
            <th>SALDO (R$)</th>
            <th class="no-print">AÇÕES</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script src="app/core/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ===== SUPABASE (ÚNICO / SEM DUPLICAR VARIÁVEIS) =====
(function(){
  const CFG =
    (window.parent && window.parent.TESOURA_CONFIG) ? window.parent.TESOURA_CONFIG :
    (window.TESOURA_CONFIG || window.CAIXA_CFG || {});
  const SB_URL =
    CFG.SUPABASE_URL || CFG.SB_URL || window.SUPABASE_URL || window.SB_URL;
  const SB_KEY =
    CFG.SUPABASE_ANON_KEY || CFG.SUPABASE_KEY || CFG.SB_KEY ||
    window.SUPABASE_ANON_KEY || window.SUPABASE_KEY || window.SB_KEY;

  if(!SB_URL || !SB_KEY){
    console.error("CAIXA: Supabase config ausente", {SB_URL, hasKey: !!SB_KEY, CFG});
    const st = document.getElementById("status");
    if(st) st.textContent = "ERRO: Supabase não configurado.";
    return;
  }

  window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SB_URL, SB_KEY);
})();
const sb = window.__TESOURA_SUPABASE__;


const $ = (id)=>document.getElementById(id);

  const selAno = $("selAno");
  const selMes = $("selMes");
  const selPeriodo = $("selPeriodo");
  const wrapSemana = $("wrapSemana");
  const selSemana = $("selSemana");

  const btnConsultar = $("btnConsultar");
  const btnNovo = $("btnNovo");
  const btnPdf = $("btnPdf");

  const statusEl = $("status");
  const tbody = $("tbody");

  function pad2(n){ return String(n).padStart(2,"0"); }

  function hojeISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function horaHHMM(){
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function toBR(iso){
    if(!iso) return "";
    const s = String(iso).slice(0,10);
    const [y,m,d] = s.split("-");
    if(!y||!m||!d) return "";
    return `${d}/${m}/${y}`;
  }
  function money(v){
    const n = Number(v||0);
    return n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});
  }
  function isMensalidadeRow(row){
    const desc = String(row.descricao||"");
    const tipo = String(row.tipo||"");
    return desc.toUpperCase().startsWith("MENSALIDADE -") || tipo.toUpperCase()==="MENSALIDADE";
  }
  function isFechamentoRow(row){
    const tipo = String(row.tipo||"").toUpperCase();
    const desc = String(row.descricao||"").toUpperCase();
    return tipo==="FECHAMENTO" || desc.startsWith("FECHAMENTO SEMANAL");
  }

  // ==== DATAS (semana segunda->segunda)
  function getMonday00(d){
    const x = new Date(d.getTime());
    x.setHours(0,0,0,0);
    const day = x.getDay(); // 0 dom .. 1 seg
    const diff = (day===0 ? -6 : 1-day);
    x.setDate(x.getDate()+diff);
    return x;
  }
  function addDays(d,days){
    const x = new Date(d.getTime());
    x.setDate(x.getDate()+days);
    return x;
  }
  function isoDate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function labelSemana(start){
    const end = addDays(start,7);
    return `${toBR(isoDate(start))} → ${toBR(isoDate(end))}`;
  }

  // monta seletor de semanas (últimas 14)
  function buildSemanas(){
    selSemana.innerHTML = "";
    const now = new Date();
    const monday = getMonday00(now);
    for(let i=0;i<14;i++){
      const start = addDays(monday, -7*i);
      const opt = document.createElement("option");
      opt.value = isoDate(start);
      opt.textContent = labelSemana(start);
      if(i===0) opt.selected = true;
      selSemana.appendChild(opt);
    }
  }

  // anos/meses
  (function initSelectors(){
    const now = new Date();
    const anoAtual = now.getFullYear();
    for(let a=anoAtual-1; a<=anoAtual+1; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if(a===anoAtual) opt.selected = true;
      selAno.appendChild(opt);
    }
    for(let m=1;m<=12;m++){
      const opt = document.createElement("option");
      opt.value = pad2(m);
      opt.textContent = `${pad2(m)} - ${["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"][m-1]}`;
      if(m===now.getMonth()+1) opt.selected = true;
      selMes.appendChild(opt);
    }
    buildSemanas();
    toggleSemana();
  })();

  function toggleSemana(){
    const v = selPeriodo.value;
    wrapSemana.style.display = (v==="SEMANAL") ? "flex" : "none";
  }
  selPeriodo.addEventListener("change", toggleSemana);

  // ==== FECHAMENTO SEMANAL: cria linha toda segunda (se não existir)
  async function garantirFechamentos(){
    // cria fechamentos das últimas 26 semanas até a segunda atual
    const now = new Date();
    const monday = getMonday00(now);
    const startRange = addDays(monday, -7*26);

    // pega fechamentos já existentes no range
    const { data: rows, error } = await sb
      .from("caixa")
      .select("id, data, hora, tipo, descricao")
      .eq("tipo","FECHAMENTO")
      .gte("data", isoDate(startRange))
      .lte("data", isoDate(monday));

    if(error){
      console.warn("Aviso: não consegui listar fechamentos.", error);
      return;
    }

    const set = new Set();
    (rows||[]).forEach(r=>{
      const d = String(r.data||"").slice(0,10);
      const h = String(r.hora||"");
      set.add(`${d}::${h}`);
    });

    // monta todas as segundas no range
    let cur = new Date(startRange.getTime());
    cur = getMonday00(cur);

    const inserts = [];
    while(cur <= monday){
      const dIso = isoDate(cur);
      const key = `${dIso}::00:00`;
      if(!set.has(key)){
        inserts.push({
          data: dIso,
          hora: "00:00",
          tipo: "FECHAMENTO",
          descricao: `FECHAMENTO SEMANAL (${toBR(dIso)})`,
          obs: "",
          valor: 0
        });
      }
      cur = addDays(cur, 7);
    }

    if(inserts.length){
      const ins = await sb.from("caixa").insert(inserts);
      if(ins.error){
        console.warn("Aviso: falhou inserir fechamentos.", ins.error);
      }
    }
  }

  function getRangeSelecionado(){
    const ano = Number(selAno.value);
    const mes = Number(selMes.value);
    const periodo = selPeriodo.value;

    if(periodo==="SEMANAL"){
      const startIso = selSemana.value; // segunda
      const start = new Date(startIso+"T00:00:00");
      const end = addDays(start, 7);
      return { startIso: isoDate(start), endIso: isoDate(end), label: `SEMANA ${toBR(isoDate(start))} → ${toBR(isoDate(end))}` };
    }

    if(periodo==="MENSAL"){
      const startIso = `${ano}-${pad2(mes)}-01`;
      const last = new Date(ano, mes, 0).getDate();
      const endIso = `${ano}-${pad2(mes)}-${pad2(last)}`;
      // endExclusive = +1 dia
      const endEx = new Date(endIso+"T00:00:00"); endEx.setDate(endEx.getDate()+1);
      return { startIso, endIso: isoDate(endEx), label: `MÊS ${pad2(mes)}/${ano}` };
    }

    // ANUAL
    const startIso = `${ano}-01-01`;
    const endEx = `${ano+1}-01-01`; // exclusivo
    return { startIso, endIso: endEx, label: `ANO ${ano}` };
  }

  async function somarSaldoAnterior(startIso){
    // soma tudo antes do startIso (data < startIso) + também (data=startIso e hora<00:00) que é nada
    const { data, error } = await sb
      .from("caixa")
      .select("valor, data, hora")
      .lt("data", startIso);

    if(error){
      console.warn("Aviso: não consegui calcular saldo anterior.", error);
      return 0;
    }
    let sum = 0;
    (data||[]).forEach(r=>{
      sum += Number(r.valor||0);
    });
    return sum;
  }

  function rowToValor(row){
    // DB: guarda "valor" (positivo receita / negativo despesa)
    return Number(row.valor||0);
  }

  let saving = new Map(); // debounce por id

  async function salvarRow(id, patch){
    if(!id) return;

    // debounce simples
    if(saving.has(id)) clearTimeout(saving.get(id));
    const t = setTimeout(async ()=>{
      statusEl.textContent = "SALVANDO...";
      const { error } = await sb.from("caixa").update(patch).eq("id", id);
      if(error){
        console.error(error);
        alert("ERRO ao salvar: " + (error.message || "ver console"));
        statusEl.textContent = "ERRO ao salvar.";
      }else{
        statusEl.textContent = "SALVO.";
      }
    }, 250);
    saving.set(id, t);
  }

  async function excluirRow(id){
    if(!id) return;
    if(!confirm("EXCLUIR este lançamento?")) return;
    statusEl.textContent = "EXCLUINDO...";
    const { error } = await sb.from("caixa").delete().eq("id", id);
    if(error){
      console.error(error);
      alert("ERRO ao excluir: " + (error.message || "ver console"));
      statusEl.textContent = "ERRO ao excluir.";
      return;
    }
    await carregar();
  }

  function render(rows, saldoInicial){
    tbody.innerHTML = "";

    let saldo = Number(saldoInicial||0);

    rows.forEach(row=>{
      const tr = document.createElement("tr");
      if(isFechamentoRow(row)) tr.classList.add("fechamento");

      const d = String(row.data||"").slice(0,10);
      const h = String(row.hora||"");
      const tipo = String(row.tipo||"RECEITA").toUpperCase();
      const descricao = String(row.descricao||"");
      const obs = String(row.obs||"");

      const valor = rowToValor(row);
      const receita = (valor>0) ? valor : 0;
      const despesa = (valor<0) ? Math.abs(valor) : 0;

      saldo += valor;

      // DATA
      tr.appendChild(tdInputDate(row, d));
      // HORA
      tr.appendChild(tdInputTime(row, h));
      // TIPO
      tr.appendChild(tdSelectTipo(row, tipo));
      // DESCRIÇÃO
      tr.appendChild(tdInputText(row, "descricao", descricao, true));
      // OBS
      tr.appendChild(tdInputText(row, "obs", obs, true));
      // RECEITA
      tr.appendChild(tdValor(row, "RECEITA", receita));
      // DESPESA
      tr.appendChild(tdValor(row, "DESPESA", despesa));
      // SALDO
      const tdSaldo = document.createElement("td");
      tdSaldo.className = "saldo";
      tdSaldo.textContent = "R$ " + money(saldo);
      tr.appendChild(tdSaldo);

      // AÇÕES
      const tdA = document.createElement("td");
      tdA.className = "no-print";

      const bloqueado = isMensalidadeRow(row) || isFechamentoRow(row);

      const bDel = document.createElement("button");
      bDel.className = "btn btn-vermelho";
      bDel.textContent = "EXCLUIR";
      bDel.disabled = bloqueado;
      bDel.addEventListener("click", ()=>excluirRow(row.id));
      tdA.appendChild(bDel);

      tr.appendChild(tdA);

      tbody.appendChild(tr);
    });
  }

  function tdInputDate(row, iso){
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.type = "date";
    input.value = iso || "";
    input.addEventListener("change", ()=>{
      salvarRow(row.id, { data: input.value });
    });
    td.appendChild(input);
    return td;
  }

  function tdInputTime(row, hhmm){
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.type = "time";
    input.value = hhmm || "00:00";
    input.step = 60;
    input.addEventListener("change", ()=>{
      salvarRow(row.id, { hora: input.value });
    });
    td.appendChild(input);
    return td;
  }

  function tdSelectTipo(row, tipo){
    const td = document.createElement("td");
    const sel = document.createElement("select");

    ["RECEITA","DESPESA","MENSALIDADE","FECHAMENTO"].forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });

    sel.value = tipo || "RECEITA";
    sel.addEventListener("change", ()=>{
      const v = sel.value;
      // se trocar tipo, ajusta valor (mantém magnitude)
      const cur = Number(row.valor||0);
      let novo = cur;
      if(v==="RECEITA") novo = Math.abs(cur||0);
      if(v==="DESPESA") novo = -Math.abs(cur||0);
      if(v==="FECHAMENTO") novo = 0;
      salvarRow(row.id, { tipo: v, valor: novo });
      carregar(); // re-render rápido (saldo/cores)
    });

    // bloqueia edição do tipo se for mensalidade/fechamento
    if(isMensalidadeRow(row) || isFechamentoRow(row)){
      sel.disabled = true;
    }

    td.appendChild(sel);
    return td;
  }

  function tdInputText(row, field, val, upper){
    const td = document.createElement("td");
    td.className = "td-left";
    const input = document.createElement("input");
    input.type = "text";
    input.value = val || "";
    input.style.width = (field==="descricao") ? "320px" : "240px";
    if(upper) input.style.textTransform = "uppercase";

    const bloqueado = isMensalidadeRow(row) || isFechamentoRow(row);
    input.disabled = bloqueado;

    input.addEventListener("change", ()=>{
      const patch = {};
      patch[field] = input.value;
      salvarRow(row.id, patch);
    });
    td.appendChild(input);
    return td;
  }

  function tdValor(row, modo, v){
    const td = document.createElement("td");

    const input = document.createElement("input");
    input.type = "number";
    input.step = "0.01";
    input.min = "0";
    input.value = (v>0) ? String(v) : "";

    const bloqueado = isMensalidadeRow(row) || isFechamentoRow(row);
    input.disabled = bloqueado;

    input.addEventListener("change", ()=>{
      const n = Number(input.value||0);
      let novoValor = Number(row.valor||0);

      if(modo==="RECEITA"){
        novoValor = Math.abs(n);
        salvarRow(row.id, { tipo: "RECEITA", valor: novoValor });
      }else{
        novoValor = -Math.abs(n);
        salvarRow(row.id, { tipo: "DESPESA", valor: novoValor });
      }
      carregar();
    });

    // cor
    if(modo==="RECEITA") td.className = "money-pos";
    if(modo==="DESPESA") td.className = "money-neg";

    td.appendChild(input);
    return td;
  }

  async function criarNovo(){
    statusEl.textContent = "CRIANDO...";
    const payload = {
      data: hojeISO(),
      hora: horaHHMM(),
      tipo: "RECEITA",
      descricao: "",
      obs: "",
      valor: 0
    };
    const { data, error } = await sb.from("caixa").insert([payload]).select("*").single();
    if(error){
      console.error(error);
      alert("ERRO ao criar: " + (error.message || "ver console"));
      statusEl.textContent = "ERRO ao criar.";
      return;
    }
    await carregar();
    statusEl.textContent = "CRIADO.";
  }

  async function carregar(){
    try{
      statusEl.textContent = "CARREGANDO...";

      // garante fechamentos antes de listar
      await garantirFechamentos();

      const range = getRangeSelecionado();

      // saldo anterior (acumulado)
      const saldoAnterior = await somarSaldoAnterior(range.startIso);

      // lista do período (endIso é exclusivo para semanal/mensal/anual)
      const { data: rows, error } = await sb
        .from("caixa")
        .select("id, data, hora, tipo, descricao, obs, valor")
        .gte("data", range.startIso)
        .lt("data", range.endIso)
        .order("data", { ascending:true })
        .order("hora", { ascending:true });

      if(error){
        console.error(error);
        statusEl.textContent = "ERRO ao buscar CAIXA (ver console).";
        return;
      }

      // se o período estiver vazio, ainda mostra saldo anterior no status
      render(rows || [], saldoAnterior);

      statusEl.textContent = `OK: ${range.label} | Registros: ${(rows||[]).length} | Saldo anterior: R$ ${money(saldoAnterior)}`;
    }catch(e){
      console.error(e);
      statusEl.textContent = "ERRO (ver console).";
    }
  }

  btnConsultar.addEventListener("click", carregar);
  btnNovo.addEventListener("click", criarNovo);
  btnPdf.addEventListener("click", ()=>window.print());

  // auto-load
  window.addEventListener("DOMContentLoaded", ()=> setTimeout(()=>{ if(window.__TESOURA_SUPABASE__) carregar(); }, 50));
</script>
</body>
</html>
 
