<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CAIXA (TESTE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    header{padding:14px 18px;border-bottom:2px solid #f97316;display:flex;align-items:center;justify-content:space-between;background:#07101f}
    header h1{margin:0;font-size:16px;letter-spacing:.5px;color:#f97316;text-transform:uppercase;font-weight:900}
    .wrap{max-width:1400px;margin:18px auto;padding:0 12px}
    .painel{background:#020617;border:1px solid #0f172a;border-radius:12px;padding:12px;margin-bottom:14px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .painel h2{margin:0 0 10px;color:#f97316;font-size:14px;letter-spacing:.5px;text-transform:uppercase;font-weight:900}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:900;text-transform:uppercase;color:#cbd5e1}
    select,input{border-radius:10px;border:1px solid #0f172a;padding:10px 12px;font-weight:900;text-transform:uppercase;font-size:12px;background:#0b1220;color:#fff;outline:none}
    input[type="text"]{text-transform:none;font-weight:800}
    input[type="number"]{text-transform:none;font-weight:900;width:140px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:900;text-transform:uppercase;font-size:12px;cursor:pointer}
    .btn-azul{background:#38bdf8;color:#031019}
    .btn-laranja{background:#f97316;color:#111827}
    .btn-vermelho{background:#ef4444;color:#111827}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .status{margin-top:8px;font-size:12px;color:#9ca3af}

    .table-wrap{overflow:visible;max-height:none;border-radius:12px;border:1px solid #0f172a}
    table{border-collapse:collapse;font-size:12px;width:100%;table-layout:fixed}
    thead th{
      position:sticky;top:0;background:#f97316;color:#fff;z-index:2;
      border:1px solid rgba(255,255,255,.45);padding:8px 8px;text-align:center;white-space:nowrap;
      font-weight:900;text-transform:uppercase
    }
    tbody td{
      border:1px solid rgba(255,255,255,.20);padding:6px 8px;text-align:center;white-space:nowrap;
      background:#020617
    }
    tbody tr:nth-child(even) td{background:#061024}
    td.left{text-align:left}
    .money{font-weight:900}
    .pos{color:#22c55e}
    .neg{color:#ef4444}
    .saldo{font-weight:900}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:900;font-size:11px}
    .pill-rec{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.35)}
    .pill-desp{background:rgba(239,68,68,.12);color:#ef4444;border:1px solid rgba(239,68,68,.35)}
    .readonly{opacity:.65}

    /* larguras (sem rolagem) */
    th.col-data, td.col-data{width:110px}
    th.col-tipo, td.col-tipo{width:120px}
    th.col-desc, td.col-desc{width:360px}
    th.col-obs,  td.col-obs{width:180px}
    th.col-rec,  td.col-rec{width:130px}
    th.col-desp, td.col-desp{width:130px}
    th.col-saldo,td.col-saldo{width:140px}
    th.col-acoes,td.col-acoes{width:120px}

    td.col-desc, td.col-obs{white-space:normal}
    td.col-desc input, td.col-obs input{width:100% !important; box-sizing:border-box}

    /* impressão/PDF */
    @media print{
      header,#painelFiltro,.no-print{display:none !important}
      body{background:#fff;color:#000}
      .wrap{max-width:none;margin:0;padding:0}
      .painel{box-shadow:none;border:0}
      thead th{position:static !important}
    }
  </style>
</head>
<body>
<header>
  <h1>TESOURA - CAIXA</h1>
  <div style="font-size:12px;color:#9ca3af;">(auto-save)</div>
</header>

<div class="wrap">
  <div class="painel" id="painelFiltro">
    <h2>FILTRO</h2>

    <div class="row" style="justify-content:space-between;width:100%;">
      <div class="row">
        <div class="row">
          <label>ANO:</label>
          <select id="selAno"></select>
        </div>

        <div class="row">
          <label>MÊS:</label>
          <select id="selMes"></select>
        </div>

        <div class="row">
          <label>PERÍODO:</label>
          <select id="selPeriodo">
            <option value="SEMANAL">SEMANAL</option>
            <option value="MENSAL">MENSAL</option>
            <option value="ANUAL">ANUAL</option>
          </select>
        </div>

        <div class="row" id="wrapSemana">
          <label>SEMANA:</label>
          <select id="selSemana"></select>
        </div>
      </div>

      <div class="row">
        <button id="btnConsultar" class="btn btn-azul no-print">CONSULTAR</button>
        <button id="btnPdf" class="btn btn-laranja no-print" title="Salvar em PDF">BAIXAR PDF</button>
      </div>
    </div>

    <div class="status" id="status">Carregando…</div>

    <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap;">
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO ANTERIOR:</b> <span id="saldoAnterior">R$ 0,00</span></div>
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO NO PERÍODO:</b> <span id="saldoPeriodo">R$ 0,00</span></div>
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO FINAL:</b> <span id="saldoFinal">R$ 0,00</span></div>
    </div>
  </div>

  <div class="painel">
    <h2>LANÇAMENTOS</h2>

    <!-- linha de lançamento (sem botão NOVO) -->
    <div class="row no-print" style="margin-bottom:10px;gap:8px;">
      <input id="inData" type="date" />
      <input id="inHora" type="time" />
      <select id="inTipo">
        <option value="RECEITA">RECEITA</option>
        <option value="DESPESA">DESPESA</option>
      </select>
      <input id="inDesc" type="text" placeholder="DESCRIÇÃO" style="width:260px;" />
      <input id="inObs" type="text" placeholder="OBS" style="width:180px;" />
      <input id="inValor" type="number" step="0.01" placeholder="VALOR (R$)" />
      <button id="btnAdd" class="btn btn-azul">SALVAR</button>
    </div>

    <div class="table-wrap" id="wrapTabela">
      <table>
        <thead>
          <tr>
            <th class="col-data">DATA</th>
            <th class="col-tipo">TIPO</th>
            <th class="col-desc">DESCRIÇÃO</th>
            <th class="col-obs">OBS</th>
            <th class="col-rec">RECEITA (R$)</th>
            <th class="col-desp">DESPESA (R$)</th>
            <th class="col-saldo">SALDO (R$)</th>
            <th class="no-print col-acoes">AÇÕES</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="status" id="status2"></div>
  </div>
</div>

<script src="app/core/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ===== SUPABASE =====
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  // ===== UI =====
  const selAno = document.getElementById("selAno");
  const selMes = document.getElementById("selMes");
  const selPeriodo = document.getElementById("selPeriodo");
  const wrapSemana = document.getElementById("wrapSemana");
  const selSemana = document.getElementById("selSemana");
  const btnConsultar = document.getElementById("btnConsultar");
  const btnPdf = document.getElementById("btnPdf");

  const statusEl = document.getElementById("status");
  const status2 = document.getElementById("status2");
  const tbody = document.getElementById("tbody");

  const saldoAnteriorEl = document.getElementById("saldoAnterior");
  const saldoPeriodoEl  = document.getElementById("saldoPeriodo");
  const saldoFinalEl    = document.getElementById("saldoFinal");

  const inData = document.getElementById("inData");
  const inHora = document.getElementById("inHora");
  const inTipo = document.getElementById("inTipo");
  const inDesc = document.getElementById("inDesc");
  const inObs  = document.getElementById("inObs");
  const inValor= document.getElementById("inValor");
  const btnAdd = document.getElementById("btnAdd");

  // ===== HELPERS =====
  const pad2 = n => String(n).padStart(2,"0");
  const money = (v) => {
    const n = Number(v || 0);
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  };
  const isoDate = (d) => {
    if (!d) return "";
    if (typeof d === "string") return d.slice(0,10);
    const x = new Date(d);
    return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
  };
  const isoTime = (d) => {
    if (!d) return "";
    if (typeof d === "string" && d.includes(":")) return d.slice(0,5);
    const x = new Date(d);
    return `${pad2(x.getHours())}:${pad2(x.getMinutes())}`;
  };

  function startOfWeekMonday(dateObj){
    const d = new Date(dateObj.getTime());
    d.setHours(0,0,0,0);
    const day = d.getDay(); // 0 dom
    const diff = (day === 0) ? -6 : (1 - day);
    d.setDate(d.getDate() + diff);
    return d;
  }
  function addDays(d, n){ const x = new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
  function lastDayOfMonth(y,m){ return new Date(y, m, 0).getDate(); } // m = 1..12

  // ===== SCHEMA FLEXÍVEL (para não quebrar com coluna diferente) =====
  function pickCol(obj, candidates){
    for (const c of candidates){
      if (obj && Object.prototype.hasOwnProperty.call(obj, c)) return c;
    }
    return null;
  }

  function getSignedValue(row){
    // 1) se existir "valor" (padrão): + receita / - despesa
    if (row && row.valor !== undefined && row.valor !== null && row.valor !== "") return Number(row.valor);

    // 2) se existir receita/despesa separado
    const rec = Number(row && (row.receita ?? row.entrada ?? 0)) || 0;
    const desp= Number(row && (row.despesa ?? row.saida ?? 0)) || 0;
    // despesa pode estar positiva no banco -> vira negativa aqui
    return rec - Math.abs(desp);
  }

  function isMensalidade(row){
    const origem = String(row?.origem || row?.source || "").toUpperCase();
    const desc = String(row?.descricao || row?.descrição || row?.desc || "").toUpperCase();
    return origem.includes("MENSAL") || desc.startsWith("MENSALIDADE -");
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function getMensalidadePagoCount(ano, mes){
    // retorna quantidade de pagamentos "pago=true" no mês (ou null se não conseguir consultar)
    try{
      const { count, error } = await sb
        .from("mensalidades")
        .select("apelido", { count:"exact", head:true })
        .eq("ano", ano)
        .eq("mes", mes)
        .eq("pago", true);
      if (error) return null;
      return Number(count || 0);
    }catch(e){
      return null;
    }
  }

  function rowYearMonth(row, cols){
    const dataCol = cols?.dateCol || pickCol(row, ["data","data_lancamento","data_mov","dia"]);
    const createdCol = cols?.createdCol || pickCol(row, ["created_at","criado_em","createdAt"]);
    const dt = dataCol ? row?.[dataCol] : (createdCol ? row?.[createdCol] : null);
    const iso = isoDate(dt);
    if (!iso) return { y:null, m:null };
    return { y:Number(iso.slice(0,4)), m:Number(iso.slice(5,7)) };
  }

  function buildPrintHTML(){
    const ano = Number(selAno.value);
    const mes = Number(selMes.value);
    const periodo = String(selPeriodo.value);
    const faixa = (periodo==="SEMANAL") ? (selSemana.options[selSemana.selectedIndex]?.textContent || "") :
                 (periodo==="MENSAL") ? `${pad2(mes)}/${ano}` : `${ano}`;

    const rows = window.__printRows || [];
    const saldoAnteriorTxt = saldoAnteriorEl.textContent || "R$ 0,00";
    const saldoPeriodoTxt  = saldoPeriodoEl.textContent || "R$ 0,00";
    const saldoFinalTxt    = saldoFinalEl.textContent || "R$ 0,00";

    const trs = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.data)}</td>
        <td>${escapeHtml(r.tipo)}</td>
        <td style="text-align:left;">${escapeHtml(r.descricao)}</td>
        <td style="text-align:left;">${escapeHtml(r.obs)}</td>
        <td style="text-align:right;">${escapeHtml(r.receita)}</td>
        <td style="text-align:right;">${escapeHtml(r.despesa)}</td>
        <td style="text-align:right;">${escapeHtml(r.saldo)}</td>
      </tr>
    `).join("");

    return `<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>TESOURA - CAIXA</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  @page{ size:A4 landscape; margin:10mm; }
  body{font-family:Arial,sans-serif;color:#000;margin:0}
  h1{font-size:14px;margin:0 0 6px 0}
  .meta{font-size:11px;margin-bottom:8px}
  table{width:100%;border-collapse:collapse;font-size:10px;table-layout:fixed}
  th,td{border:1px solid #000;padding:4px;vertical-align:top;word-wrap:break-word}
  th{background:#f2f2f2}
</style>
</head>
<body>
  <h1>TESOURA - CAIXA</h1>
  <div class="meta"><b>Filtro:</b> ${escapeHtml(faixa)} &nbsp;&nbsp; <b>Saldo anterior:</b> ${escapeHtml(saldoAnteriorTxt)} &nbsp;&nbsp; <b>Saldo no período:</b> ${escapeHtml(saldoPeriodoTxt)} &nbsp;&nbsp; <b>Saldo final:</b> ${escapeHtml(saldoFinalTxt)}</div>
  <table>
    <thead>
      <tr>
        <th style="width:80px;">DATA</th>
        <th style="width:70px;">TIPO</th>
        <th style="width:260px;">DESCRIÇÃO</th>
        <th style="width:160px;">OBS</th>
        <th style="width:90px;">RECEITA (R$)</th>
        <th style="width:90px;">DESPESA (R$)</th>
        <th style="width:90px;">SALDO (R$)</th>
      </tr>
    </thead>
    <tbody>${trs}</tbody>
  </table>
<script>
window.onload=()=>{window.print(); setTimeout(()=>window.close(), 350);};
<\/script>
</body>
</html>`;
  }

  function baixarPDF(){
    const html = buildPrintHTML();
    const w = window.open("", "_blank");
    if (!w){ alert("Seu navegador bloqueou o pop-up do PDF."); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // ===== filtros =====
  function buildAnoOptions(){
    const now = new Date();
    const y = now.getFullYear();
    selAno.innerHTML = "";
    for (let a = y-1; a <= y+1; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if (a === y) opt.selected = true;
      selAno.appendChild(opt);
    }
  }

  function buildMesOptions(){
    const meses = ["01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN","07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"];
    selMes.innerHTML = "";
    meses.forEach((m, idx)=>{
      const opt = document.createElement("option");
      opt.value = idx+1;
      opt.textContent = m;
      selMes.appendChild(opt);
    });
  }

  function buildSemanaOptions(){
    selSemana.innerHTML = "";
    // semanas do ano selecionado (segunda->segunda)
    const ano = Number(selAno.value) || (new Date()).getFullYear();
    const start = startOfWeekMonday(new Date(ano,0,1));
    const end = new Date(ano,11,31);
    let cur = new Date(start.getTime());
    while (cur <= end){
      const ini = new Date(cur.getTime());
      const fim = addDays(ini, 7);
      const label = `${ini.toLocaleDateString("pt-BR")} → ${addDays(fim,-1).toLocaleDateString("pt-BR")}`;
      const opt = document.createElement("option");
      opt.value = `${isoDate(ini)}|${isoDate(fim)}`;
      opt.textContent = label;
      selSemana.appendChild(opt);
      cur = fim;
    }
  }

  function updateUIByPeriodo(){
    const p = String(selPeriodo.value);
    wrapSemana.style.display = (p==="SEMANAL") ? "" : "none";
  }

  function getRange(){
    const ano = Number(selAno.value);
    const mes = Number(selMes.value);
    const p = String(selPeriodo.value);

    if (p === "ANUAL"){
      return { ini: `${ano}-01-01`, fim: `${ano+1}-01-01` };
    }
    if (p === "MENSAL"){
      const ini = `${ano}-${pad2(mes)}-01`;
      const ld = lastDayOfMonth(ano, mes);
      const fim = `${ano}-${pad2(mes)}-${pad2(ld)}`;
      const fimPlus = isoDate(addDays(new Date(fim+"T00:00:00"), 1));
      return { ini, fim: fimPlus };
    }
    // semanal
    const v = String(selSemana.value || "");
    const parts = v.split("|");
    const ini = parts[0] || `${ano}-${pad2(mes)}-01`;
    const fim = parts[1] || isoDate(addDays(new Date(ini+"T00:00:00"),7));
    return { ini, fim };
  }

  // ===== CRUD =====
  async function fetchAllWithin(ini, fim){
    // usa select('*') para não quebrar com nomes de coluna diferentes
    // tenta filtrar por coluna "data" se existir; senão usa created_at
    const { data: sample, error: errSample } = await sb.from("caixa").select("*").limit(1);
    if (errSample) throw errSample;

    const dateCol = pickCol(sample?.[0], ["data","data_lancamento","data_mov","dia"]);
    const createdCol = pickCol(sample?.[0], ["created_at","criado_em","createdAt"]);

    let q = sb.from("caixa").select("*");
    if (dateCol){
      q = q.gte(dateCol, ini).lt(dateCol, fim);
      q = q.order(dateCol, {ascending:true});
    } else if (createdCol){
      q = q.gte(createdCol, ini).lt(createdCol, fim);
      q = q.order(createdCol, {ascending:true});
    } else {
      q = q.order("id", {ascending:true});
    }

    const { data, error } = await q;
    if (error) throw error;
    return { rows: data || [], dateCol, createdCol };
  }

  async function sumBefore(ini){
    // saldo anterior: soma de tudo antes do início (limitado ao próprio ano para não ficar pesado)
    const ano = String(ini).slice(0,4);
    const iniAno = `${ano}-01-01`;

    const { data: sample } = await sb.from("caixa").select("*").limit(1);
    const dateCol = pickCol(sample?.[0], ["data","data_lancamento","data_mov","dia"]);
    const createdCol = pickCol(sample?.[0], ["created_at","criado_em","createdAt"]);

    let q = sb.from("caixa").select("*");
    if (dateCol){
      q = q.gte(dateCol, iniAno).lt(dateCol, ini);
      q = q.order(dateCol, {ascending:true});
    } else if (createdCol){
      q = q.gte(createdCol, iniAno).lt(createdCol, ini);
      q = q.order(createdCol, {ascending:true});
    } else {
      q = q.limit(0);
    }

    const { data, error } = await q;
    if (error) throw error;

    let total = 0;
    (data || []).forEach(r => total += getSignedValue(r));
    return total;
  }

  function render(rows, cols){
    tbody.innerHTML = "";

    // detect colunas comuns (sem travar)
    const idCol   = pickCol(rows?.[0], ["id","uuid","ID"]);
    const dataCol = cols.dateCol || pickCol(rows?.[0], ["data","data_lancamento","data_mov","dia"]);
    const horaCol = pickCol(rows?.[0], ["hora","horario","time","hora_lancamento"]);
    const createdCol = cols.createdCol || pickCol(rows?.[0], ["created_at","criado_em","createdAt"]);
    const tipoCol = pickCol(rows?.[0], ["tipo","categoria","kind"]);
    const descCol = pickCol(rows?.[0], ["descricao","descrição","descricao_texto","desc"]);
    const obsCol  = pickCol(rows?.[0], ["obs","observacao","observação","nota","notas"]);
    const origemCol = pickCol(rows?.[0], ["origem","source"]);
    const valorCol = pickCol(rows?.[0], ["valor","value","signed","valor_mov"]);
    const receitaCol = pickCol(rows?.[0], ["receita","entrada"]);
    const despesaCol = pickCol(rows?.[0], ["despesa","saida"]);

    let saldo = window.__saldoAnterior || 0;
    let saldoPeriodo = 0;

    window.__printRows = [];

    rows.forEach((r) => {
      const tr = document.createElement("tr");

      const dt = dataCol ? r[dataCol] : (createdCol ? r[createdCol] : null);
      const hr = horaCol ? r[horaCol] : (createdCol ? r[createdCol] : null);

      const signed = getSignedValue(r);
      saldo += signed;
      saldoPeriodo += signed;

      const tipo = String((tipoCol ? r[tipoCol] : "") || "").toUpperCase();
      const isRec = (tipo === "RECEITA") || (signed >= 0);
      const isDesp = (tipo === "DESPESA") || (signed < 0);

      const receita = isRec ? Math.abs(signed) : 0;
      const despesa = isDesp ? Math.abs(signed) : 0;

      const mensal = isMensalidade(r);

      // DATA
      const tdData = document.createElement("td");
      tdData.className = "col-data";
      tdData.textContent = isoDate(dt) ? new Date(isoDate(dt)+"T00:00:00").toLocaleDateString("pt-BR") : "";
      tr.appendChild(tdData);

      // TIPO (editável)
      const tdTipo = document.createElement("td");
      tdTipo.className = "col-tipo";
      const sel = document.createElement("select");
      sel.innerHTML = `<option value="RECEITA">RECEITA</option><option value="DESPESA">DESPESA</option>`;
      sel.value = (tipo === "DESPESA") ? "DESPESA" : "RECEITA";
      if (mensal) { sel.disabled = true; sel.classList.add("readonly"); }
      tdTipo.appendChild(sel);
      tr.appendChild(tdTipo);

      // DESCRIÇÃO (editável)
      const tdDesc = document.createElement("td");
      tdDesc.className = "left col-desc";
      const inD = document.createElement("input");
      inD.type = "text";
      inD.value = String((descCol ? r[descCol] : "") || "");
      inD.style.width = "100%";
      if (mensal) { inD.disabled = true; inD.classList.add("readonly"); }
      tdDesc.appendChild(inD);
      tr.appendChild(tdDesc);

      // OBS (editável)
      const tdObs = document.createElement("td");
      tdObs.className = "left col-obs";
      const inO = document.createElement("input");
      inO.type = "text";
      inO.value = String((obsCol ? r[obsCol] : "") || "");
      inO.style.width = "100%";
      if (mensal) { inO.disabled = true; inO.classList.add("readonly"); }
      tdObs.appendChild(inO);
      tr.appendChild(tdObs);

      // RECEITA
      const tdR = document.createElement("td");
      tdR.className = "col-rec";
      tdR.innerHTML = receita ? `<span class="money pos">${money(receita)}</span>` : "";
      tr.appendChild(tdR);

      // DESPESA
      const tdE = document.createElement("td");
      tdE.className = "col-desp";
      tdE.innerHTML = despesa ? `<span class="money neg">${money(despesa)}</span>` : "";
      tr.appendChild(tdE);

      // SALDO
      const tdS = document.createElement("td");
      tdS.className = "col-saldo";
      tdS.innerHTML = `<span class="saldo">${money(saldo)}</span>`;
      tr.appendChild(tdS);

      // AÇÕES
      const tdA = document.createElement("td");
      tdA.className = "no-print col-acoes";
      const btnDel = document.createElement("button");
      btnDel.className = "btn btn-vermelho";
      btnDel.textContent = "EXCLUIR";
      if (mensal || !idCol) btnDel.disabled = true;

      tdA.appendChild(btnDel);
      tr.appendChild(tdA);

      // autosave (on change / blur) — não salva mensalidade aqui
      async function autosave(){
        if (mensal || !idCol) return;
        const id = r[idCol];
        const novoTipo = sel.value;
        const novoDesc = inD.value || "";
        const novoObs  = inO.value || "";

        // valor é derivado do tipo + valor antigo (mantém magnitude)
        const mag = Math.abs(getSignedValue(r) || 0);
        const novoSigned = (novoTipo === "DESPESA") ? -mag : mag;

        // atualiza usando os nomes reais das colunas (evita erro 400)
        const payload = {};
        payload[(tipoCol || "tipo")] = novoTipo;
        payload[(descCol || "descricao")] = novoDesc;
        payload[(obsCol  || "obs")] = novoObs;

        if (valorCol) {
          payload[valorCol] = novoSigned;
        } else {
          // tenta padrão
          payload["valor"] = novoSigned;
        }

        // se existir colunas separadas, preenche também
        if (receitaCol) payload[receitaCol] = (novoTipo==="RECEITA") ? mag : 0;
        if (despesaCol) payload[despesaCol] = (novoTipo==="DESPESA") ? mag : 0;

        // tenta salvar; se falhar, cai no modo "tentativas" (compatibilidade)
        let ok = false, lastErr = null;

        {
          const { error } = await sb.from("caixa").update(payload).eq(idCol, id);
          if (!error) ok = true;
          else lastErr = error;
        }

        if (!ok){
          const payloads = [
            { tipo: novoTipo, descricao: novoDesc, obs: novoObs, valor: novoSigned },
            { tipo: novoTipo, descricao: novoDesc, obs: novoObs,
              receita: (novoTipo==="RECEITA") ? mag : 0,
              despesa: (novoTipo==="DESPESA") ? mag : 0
            }
          ];
          for (const p of payloads){
            const { error } = await sb.from("caixa").update(p).eq(idCol, id);
            if (!error){ ok=true; break; }
            lastErr = error;
          }
        }
        if (!ok){
          console.warn("Autosave falhou:", lastErr);
          status2.textContent = "Aviso: não consegui salvar uma edição (ver console).";
        } else {
          status2.textContent = "Salvo.";
          setTimeout(()=>{ if(status2.textContent==="Salvo.") status2.textContent=""; }, 800);
        }
      }

      sel.addEventListener("change", autosave);
      inD.addEventListener("blur", autosave);
      inO.addEventListener("blur", autosave);

      btnDel.addEventListener("click", async ()=>{
        if (mensal || !idCol) return;
        if (!confirm("Excluir este lançamento?")) return;
        const id = r[idCol];
        const { error } = await sb.from("caixa").delete().eq(idCol, id);
        if (error){
          alert("ERRO ao excluir (ver console).");
          console.error(error);
          return;
        }
        carregar();
      });

      // linha para PDF (sem inputs)
      window.__printRows.push({
        data: tdData.textContent,
        tipo: sel.value,
        descricao: inD.value,
        obs: inO.value,
        receita: receita ? money(receita) : "",
        despesa: despesa ? money(despesa) : "",
        saldo: money(saldo)
      });

      tbody.appendChild(tr);
    });

    saldoPeriodoEl.textContent = money(saldoPeriodo);
    saldoFinalEl.textContent = money(saldo);
  }

  async function addLancamento(){
    try{
      btnAdd.disabled = true;
      status2.textContent = "";

      const data = inData.value;
      const hora = inHora.value;
      const tipo = String(inTipo.value || "RECEITA").toUpperCase();
      const desc = String(inDesc.value || "").trim();
      const obs  = String(inObs.value || "").trim();
      const val  = Number(inValor.value || 0);

      // BLOQUEIO: se Mensalidade do mês estiver zerada, não permitir lançar "MENSALIDADE" no Caixa
      const anoSel = Number(selAno.value);
      const mesSel = Number(selMes.value);
      const descUp = String(desc || "").toUpperCase();
      if (descUp.includes("MENSALIDADE")){
        const pagoCount = (window.__mensalidadePagoCount != null) ? Number(window.__mensalidadePagoCount) : await getMensalidadePagoCount(anoSel, mesSel);
        if (pagoCount === 0){
          alert("Mensalidade do mês está zerada. Não é permitido lançar MENSALIDADE no Caixa.");
          return;
        }
      }

      if (!data || !hora || !desc || !val){
        alert("Preencha: DATA, HORA, DESCRIÇÃO e VALOR.");
        return;
      }

      const signed = (tipo === "DESPESA") ? -Math.abs(val) : Math.abs(val);

      // tenta inserir com várias possibilidades de nomes de coluna
      const payloads = [
        { data, hora, tipo, descricao: desc, obs, valor: signed },
        { data, horario: hora, tipo, descricao: desc, obs, valor: signed },
        { data_lancamento: data, hora, tipo, descricao: desc, obs, valor: signed },
        { data, hora, tipo, descricao: desc, obs, receita: (tipo==="RECEITA")?Math.abs(val):0, despesa: (tipo==="DESPESA")?Math.abs(val):0 },
        { data_lancamento: data, hora, tipo, descricao: desc, obs, receita: (tipo==="RECEITA")?Math.abs(val):0, despesa: (tipo==="DESPESA")?Math.abs(val):0 }
      ];

      let ok=false, lastErr=null;
      for (const p of payloads){
        const { error } = await sb.from("caixa").insert(p);
        if (!error){ ok=true; break; }
        lastErr = error;
      }

      if (!ok){
        alert("ERRO ao criar (ver console).");
        console.error(lastErr);
        return;
      }

      // limpa inputs
      inDesc.value = "";
      inObs.value = "";
      inValor.value = "";

      carregar();
    } finally {
      btnAdd.disabled = false;
    }
  }

  async function carregar(){
    try{
      statusEl.textContent = "CARREGANDO...";
      status2.textContent = "";
      tbody.innerHTML = "";

      updateUIByPeriodo();
      const {ini, fim} = getRange();

      // saldo anterior
      let saldoAnt = 0;
      try{
        saldoAnt = await sumBefore(ini);
      }catch(e){
        console.warn("Aviso: não consegui calcular saldo anterior.", e);
        saldoAnt = 0;
      }
      window.__saldoAnterior = saldoAnt;
      saldoAnteriorEl.textContent = money(saldoAnt);

      const data = await fetchAllWithin(ini, fim);
      let rows = data.rows || [];

      // REGRA: se Mensalidade do mês está zerada, não mostrar lançamentos automáticos "MENSALIDADE" no Caixa
      const ano = Number(selAno.value);
      const mes = Number(selMes.value);
      const pagoCount = await getMensalidadePagoCount(ano, mes);
      window.__mensalidadePagoCount = pagoCount;

      if (pagoCount === 0){
        rows = rows.filter(r => !isMensalidade(r));
      }

      render(rows, data);

      statusEl.textContent = `LISTA CARREGADA. Registros: ${rows.length}` + (pagoCount === 0 ? " (Mensalidade do mês zerada: lançamentos MENSALIDADE ocultos)" : "");
    }catch(e){
      console.error(e);
      statusEl.textContent = "ERRO ao buscar CAIXA (ver console).";
      alert("ERRO ao buscar CAIXA (ver console).");
    }
  }

  // ===== eventos =====
  btnPdf.addEventListener("click", baixarPDF);
  btnConsultar.addEventListener("click", carregar);
  btnAdd.addEventListener("click", addLancamento);

  selPeriodo.addEventListener("change", ()=>{ updateUIByPeriodo(); });
  selAno.addEventListener("change", ()=>{ /* anual/mensal dependem do ano */ });
  selMes.addEventListener("change", ()=>{ /* mensal depende do mês */ });

  // init
  (function init(){
    buildAnoOptions();
    buildMesOptions();
    buildSemanaOptions();
    updateUIByPeriodo();

    // default inputs
    const now = new Date();
    inData.value = isoDate(now);
    inHora.value = isoTime(now);

    // mês atual
    selMes.value = String(now.getMonth()+1);

    carregar();
  })();
</script>
</body>
</html>
