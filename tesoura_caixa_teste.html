<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tesoura - Caixa</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#050a14;
      --panel:#0b1220;
      --panel2:#0a1020;
      --line:#18233a;
      --text:#e7eefc;
      --muted:#9fb2d7;
      --orange:#ff8a2a;
      --blue:#12b5ea;
      --green:#18d37b;
      --red:#ff3b3b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1400px;margin:0 auto;padding:18px}
    .card{background:linear-gradient(180deg,rgba(18,24,45,.92),rgba(10,16,32,.92));border:1px solid var(--line);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.35)}
    .title{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:2px solid rgba(255,138,42,.55)}
    .title h1{margin:0;font-size:18px;letter-spacing:.4px;color:var(--orange)}
    .title small{color:var(--muted)}
    .section{padding:16px 18px}
    .section h2{margin:0 0 10px 0;color:var(--orange);font-size:14px;letter-spacing:.4px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    select,input{height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:#0a1020;color:#fff;padding:0 10px;outline:none}
    input::placeholder{color:#5f6f93}
    .btn{height:36px;border-radius:10px;border:0;padding:0 14px;font-weight:800;cursor:pointer}
    .btn.blue{background:var(--blue);color:#00111a}
    .btn.orange{background:var(--orange);color:#1a0a00}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:#fff}
    .meta{margin-top:8px;color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.14);color:#dbe7ff;background:rgba(0,0,0,.18)}
    .badge.lock{border-color:rgba(255,138,42,.55);color:#ffd9b5}
    .table-wrap{margin-top:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);overflow:hidden}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{background:var(--orange);color:#fff;font-size:12px;padding:10px;border-right:1px solid rgba(0,0,0,.18)}
    thead th:last-child{border-right:0}
    tbody td{padding:10px;border-top:1px solid rgba(255,255,255,.08);vertical-align:middle;font-size:12px;color:#e9f1ff}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}

    .col-date{width:110px}
    .col-desc{width:320px}
    .col-obs{width:180px}
    .col-money{width:130px;text-align:right}
    .col-act{width:110px;text-align:center}

    td.col-desc, td.col-obs{white-space:normal;text-align:left;}
    .money.pos{color:var(--green);font-weight:900}
    .money.neg{color:var(--red);font-weight:900}

    .btnSmall{height:30px;border-radius:10px;border:0;padding:0 12px;font-weight:900;cursor:pointer;font-size:12px}
    .btnEdit{background:var(--green);color:#02140b}
    .btnDel{background:var(--red);color:#1a0000}
    .btnDisabled{opacity:.55;cursor:not-allowed}

    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:0;border-radius:0;background:#fff}
      .title .right-actions{display:none !important}
      .no-print{display:none !important}
      .table-wrap{border:0}
      table{table-layout:auto;width:100%}
    }
    @page{size:A4 landscape;margin:10mm}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <div>
          <h1>TESOURA - CAIXA</h1>
          <small>Arquivo mensal: dia 1 → dia 1 do próximo mês. Tela fica no mês corrente.</small>
        </div>
        <div class="right-actions no-print">
          <span class="badge" id="badgeMes">Mês corrente</span>
        </div>
      </div>

      <div class="section no-print">
        <h2>LANÇAMENTOS (mês corrente)</h2>
        <div class="row">
          <div class="field">
            <label>DATA (automática):</label>
            <input id="inData" type="date" style="width:170px" readonly />
          </div>
          <div class="field">
            <label>TIPO:</label>
            <select id="inTipo" style="width:150px">
              <option value="RECEITA">RECEITA</option>
              <option value="DESPESA">DESPESA</option>
            </select>
          </div>
          <div class="field" style="flex:1;min-width:260px">
            <label>DESCRIÇÃO:</label>
            <input id="inDesc" placeholder="Descrição" />
          </div>
          <div class="field" style="min-width:220px">
            <label>OBS:</label>
            <input id="inObs" placeholder="Opcional" />
          </div>
          <div class="field" style="width:160px">
            <label>VALOR (R$):</label>
            <input id="inValor" placeholder="0,00" inputmode="decimal" />
          </div>

          <button class="btn blue" id="btnSalvar">SALVAR</button>
          <button class="btn ghost" id="btnCancelar" style="display:none">CANCELAR</button>
          <button class="btn ghost" id="btnLimpar">LIMPAR</button>
        </div>

        <div class="meta" id="status">Carregando...</div>
      </div>

      <div class="section no-print">
        <h2>PDF (arquivo mensal)</h2>
        <div class="row">
          <div class="field">
            <label>ANO:</label>
            <select id="selAnoPdf"></select>
          </div>
          <div class="field">
            <label>MÊS:</label>
            <select id="selMesPdf"></select>
          </div>
          <button class="btn orange" id="btnPdf">BAIXAR PDF</button>
          <div class="meta">Obs: o PDF abre no navegador. Depois clique em imprimir e salve como PDF.</div>
        </div>
      </div>

      <div class="section">
        <h2 id="h2Tabela">LANÇAMENTOS</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="col-date">DATA</th>
                <th class="col-desc">DESCRIÇÃO</th>
                <th class="col-obs">OBS</th>
                <th class="col-money">RECEITA (R$)</th>
                <th class="col-money">DESPESA (R$)</th>
                <th class="col-money">SALDO (R$)</th>
                <th class="col-act">EDITAR</th>
                <th class="col-act">EXCLUIR</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== SUPABASE ===== */
const CFG = window.TESOURA_CONFIG || {};
const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || CFG.SUPABASE_ANON || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
const sb = window.supabase.createClient(SB_URL, SB_KEY);

/* ===== elementos ===== */
const inData = document.getElementById("inData");
const inTipo = document.getElementById("inTipo");
const inDesc = document.getElementById("inDesc");
const inObs = document.getElementById("inObs");
const inValor = document.getElementById("inValor");
const btnSalvar = document.getElementById("btnSalvar");
const btnCancelar = document.getElementById("btnCancelar");
const btnLimpar = document.getElementById("btnLimpar");
const btnPdf = document.getElementById("btnPdf");

const selAnoPdf = document.getElementById("selAnoPdf");
const selMesPdf = document.getElementById("selMesPdf");

const tbody = document.getElementById("tbody");
const statusEl = document.getElementById("status");
const badgeMes = document.getElementById("badgeMes");
const h2Tabela = document.getElementById("h2Tabela");

/* ===== util ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function isoDate(d){ return d.toISOString().slice(0,10); }
function money(n){
  const v = Number(n||0);
  return v.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function parseMoneyBR(v){
  const s = String(v||"").trim().replaceAll(".","").replace(",",".");
  const num = Number(s);
  return isFinite(num) ? num : NaN;
}
function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }
function monthNamePT(m){
  const nomes = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
  return nomes[(m-1)] || "";
}
function rangeMonth(y,m){
  const ini = `${y}-${pad2(m)}-01`;
  const next = (m===12) ? { y:y+1, m:1 } : { y:y, m:m+1 };
  const fim = `${next.y}-${pad2(next.m)}-01`;
  return { ini, fim };
}
function isMensalidadeRow(r){
  const obs = String(r.obs||"").toUpperCase();
  const desc = String(r.descricao||"").toUpperCase();
  const origem = String(r.origem||"").toUpperCase();
  if (origem === "MENSALIDADE") return true;
  if (r.mensalidade_id != null) return true;
  if (obs.includes("MENSALIDADE")) return true;
  if (desc.startsWith("MENSALIDADE")) return true;
  return false;
}

/* ===== estado ===== */
let editingId = null;
let currentMode = "CURRENT"; // CURRENT ou PDF

/* ===== colunas (compat) ===== */
async function detectCols(){
  const { data, error } = await sb.from("caixa").select("*").limit(1);
  if (error) throw error;
  const row = (data && data.length) ? data[0] : null;
  const keys = row ? Object.keys(row) : [];

  function pick(cands){
    const low = keys.map(k=>k.toLowerCase());
    for (const c of cands){
      const i = low.indexOf(String(c).toLowerCase());
      if (i>=0) return keys[i];
    }
    return null;
  }

  return {
    idCol: pick(["id"]),
    dataCol: pick(["data"]),
    dataLancCol: pick(["data_lancamento"]),
    tipoCol: pick(["tipo"]),
    descCol: pick(["descricao","descrição","desc"]),
    obsCol: pick(["obs"]),
    valorCol: pick(["valor"]),
    origemCol: pick(["origem"]),
    mensalidadeIdCol: pick(["mensalidade_id"]),
  };
}

function normalizeRow(r, cols){
  const dt = (cols.dataCol && r[cols.dataCol]) ? String(r[cols.dataCol]).slice(0,10)
           : (cols.dataLancCol && r[cols.dataLancCol]) ? String(r[cols.dataLancCol]).slice(0,10)
           : "";

  const tipo = cols.tipoCol ? String(r[cols.tipoCol]||"") : "";
  const descricao = cols.descCol ? String(r[cols.descCol]||"") : "";
  const obs = cols.obsCol ? String(r[cols.obsCol]||"") : "";
  const origem = cols.origemCol ? String(r[cols.origemCol]||"") : "";
  const mensalidade_id = cols.mensalidadeIdCol ? r[cols.mensalidadeIdCol] : null;

  let val = cols.valorCol ? Number(r[cols.valorCol]||0) : 0;
  if (!isFinite(val)) val = 0;

  // padroniza: RECEITA positiva, DESPESA negativa
  const up = String(tipo||"").toUpperCase();
  if (up === "DESPESA" && val > 0) val = -Math.abs(val);
  if (up === "RECEITA" && val < 0) val = Math.abs(val);

  const receita = val > 0 ? val : 0;
  const despesa = val < 0 ? Math.abs(val) : 0;

  const locked = isMensalidadeRow({ obs, descricao, origem, mensalidade_id });

  return {
    id: cols.idCol ? r[cols.idCol] : r.id,
    data: dt,
    tipo: up,
    descricao,
    obs,
    origem,
    mensalidade_id,
    valor_signed: val,
    receita,
    despesa,
    locked
  };
}

/* ===== render ===== */
function render(rows){
  tbody.innerHTML = "";
  let saldo = 0;

  rows.forEach((r)=>{
    saldo += (Number(r.receita||0) - Number(r.despesa||0));

    const tr = document.createElement("tr");

    const tdD = document.createElement("td");
    tdD.textContent = r.data ? r.data.split("-").reverse().join("/") : "";
    tr.appendChild(tdD);

    const tdDesc = document.createElement("td");
    tdDesc.className = "col-desc";
    tdDesc.textContent = r.descricao || "";
    tr.appendChild(tdDesc);

    const tdObs = document.createElement("td");
    tdObs.className = "col-obs";
    tdObs.textContent = r.obs || "";
    tr.appendChild(tdObs);

    const tdR = document.createElement("td");
    tdR.className = "col-money";
    tdR.innerHTML = r.receita ? `<span class="money pos">${money(r.receita)}</span>` : "";
    tr.appendChild(tdR);

    const tdE = document.createElement("td");
    tdE.className = "col-money";
    tdE.innerHTML = r.despesa ? `<span class="money neg">${money(r.despesa)}</span>` : "";
    tr.appendChild(tdE);

    const tdS = document.createElement("td");
    tdS.className = "col-money";
    tdS.innerHTML = saldo >= 0
      ? `<span class="money pos">${money(saldo)}</span>`
      : `<span class="money neg">${money(saldo)}</span>`;
    tr.appendChild(tdS);

    const tdEdit = document.createElement("td");
    tdEdit.className = "col-act";
    const tdDel = document.createElement("td");
    tdDel.className = "col-act";

    if (r.locked){
      tdEdit.innerHTML = `<span class="badge lock">AUTO</span>`;
      tdDel.innerHTML = `<span class="badge lock">AUTO</span>`;
    } else {
      const bE = document.createElement("button");
      bE.className = "btnSmall btnEdit";
      bE.textContent = "EDITAR";
      bE.addEventListener("click", ()=>startEdit(r));
      tdEdit.appendChild(bE);

      const bD = document.createElement("button");
      bD.className = "btnSmall btnDel";
      bD.textContent = "EXCLUIR";
      bD.addEventListener("click", ()=>doDelete(r));
      tdDel.appendChild(bD);
    }

    tr.appendChild(tdEdit);
    tr.appendChild(tdDel);

    tbody.appendChild(tr);
  });
}

/* ===== carregar mês corrente ===== */
async function loadCurrentMonth(){
  try{
    currentMode = "CURRENT";
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const { ini, fim } = rangeMonth(y,m);

    badgeMes.textContent = `Mês corrente: ${monthNamePT(m)}/${y}`;
    h2Tabela.textContent = `LANÇAMENTOS (mês corrente: ${monthNamePT(m)}/${y})`;

    setStatus("Carregando mês corrente...");
    const rows = await fetchCaixaRange(ini, fim);
    setStatus(`LISTA CARREGADA. Registros: ${rows.length}`);
    render(rows);
  }catch(e){
    console.error(e);
    setStatus("ERRO ao buscar CAIXA (ver console).");
    alert("ERRO ao buscar CAIXA (ver console).");
  }
}

async function fetchCaixaRange(ini, fim){
  const cols = await detectCols();

  // preferir filtro por "data" (date)
  let q = sb.from("caixa").select("*");
  if (cols.dataCol){
    q = q.gte(cols.dataCol, ini).lt(cols.dataCol, fim).order(cols.dataCol, {ascending:true}).order(cols.idCol || "id", {ascending:true});
  } else if (cols.dataLancCol){
    // fallback por timestamp
    q = q.gte(cols.dataLancCol, ini).lt(cols.dataLancCol, fim).order(cols.dataLancCol, {ascending:true}).order(cols.idCol || "id", {ascending:true});
  } else {
    q = q.order(cols.idCol || "id", {ascending:true});
  }

  const { data, error } = await q;
  if (error) throw error;

  const rows = (data||[]).map(r => normalizeRow(r, cols));

  // ordena por data (string ISO), depois id
  rows.sort((a,b)=>{
    const da = a.data || "0000-00-00";
    const db = b.data || "0000-00-00";
    if (da < db) return -1;
    if (da > db) return 1;
    return Number(a.id||0) - Number(b.id||0);
  });

  return rows;
}

/* ===== criar/editar/excluir ===== */
function resetForm(){
  editingId = null;
  btnCancelar.style.display = "none";
  btnSalvar.textContent = "SALVAR";
  inTipo.value = "RECEITA";
  inDesc.value = "";
  inObs.value = "";
  inValor.value = "";
}

function startEdit(r){
  if (!r || r.locked) return;
  editingId = r.id;

  // data fica automática (não edita data no caixa)
  inTipo.value = (r.valor_signed < 0) ? "DESPESA" : "RECEITA";
  inDesc.value = r.descricao || "";
  inObs.value = r.obs || "";
  inValor.value = money(Math.abs(Number(r.valor_signed||0)));

  btnCancelar.style.display = "inline-block";
  btnSalvar.textContent = "ATUALIZAR";
}

async function addOrUpdate(){
  try{
    const tipo = String(inTipo.value||"").toUpperCase();
    const desc = String(inDesc.value||"").trim();
    const obs = String(inObs.value||"").trim();
    const val = parseMoneyBR(inValor.value);

    if (!desc){ alert("Preencha a DESCRIÇÃO."); return; }
    if (!isFinite(val) || val <= 0){ alert("Preencha um VALOR válido."); return; }

    // data automática (hoje)
    const dataHoje = String(inData.value||"").slice(0,10);
    if (!dataHoje){ alert("Data inválida."); return; }

    // bloqueio mensalidade manual
    if (String(obs).toUpperCase().includes("MENSALIDADE")){
      alert("Mensalidade é automática (não criar/editar no Caixa).");
      return;
    }

    const signed = (tipo === "DESPESA") ? -Math.abs(val) : Math.abs(val);

    const payload = {
      data: dataHoje,
      tipo,
      descricao: desc,
      obs,
      valor: signed
    };

    if (!editingId){
      const { error } = await sb.from("caixa").insert(payload);
      if (error) throw error;
      resetForm();
      await loadCurrentMonth();
      return;
    }

    // update
    const cols = await detectCols();
    const idCol = cols.idCol || "id";
    const { error } = await sb.from("caixa").update(payload).eq(idCol, editingId);
    if (error) throw error;

    resetForm();
    await loadCurrentMonth();
  }catch(e){
    console.error(e);
    alert("ERRO ao salvar (ver console).");
  }
}

async function doDelete(r){
  try{
    if (!r || r.locked) return;
    if (!confirm("Excluir este lançamento?")) return;

    const cols = await detectCols();
    const idCol = cols.idCol || "id";
    const { error } = await sb.from("caixa").delete().eq(idCol, r.id);
    if (error) throw error;

    await loadCurrentMonth();
  }catch(e){
    console.error(e);
    alert("ERRO ao excluir (ver console).");
  }
}

/* ===== PDF mensal: imprime mês escolhido e volta pro mês corrente ===== */
async function baixarPdfMensal(){
  try{
    const y = Number(selAnoPdf.value);
    const m = Number(selMesPdf.value);
    const { ini, fim } = rangeMonth(y,m);

    currentMode = "PDF";
    h2Tabela.textContent = `ARQUIVO MENSAL (PDF): ${monthNamePT(m)}/${y}`;

    setStatus("Carregando mês para PDF...");
    const rows = await fetchCaixaRange(ini, fim);
    setStatus(`PDF pronto. Registros: ${rows.length}`);
    render(rows);

    window.print();

    // volta pro mês corrente (evita “ficar preso” em mês antigo)
    await loadCurrentMonth();
  }catch(e){
    console.error(e);
    alert("ERRO ao gerar PDF (ver console).");
    await loadCurrentMonth();
  }
}

/* ===== montar selects PDF ===== */
function buildAnoMesPdf(){
  const now = new Date();
  const y = now.getFullYear();
  selAnoPdf.innerHTML = "";
  [y-1,y,y+1].forEach(yy=>{
    const opt = document.createElement("option");
    opt.value = String(yy);
    opt.textContent = String(yy);
    selAnoPdf.appendChild(opt);
  });
  selAnoPdf.value = String(y);

  selMesPdf.innerHTML = "";
  for (let m=1;m<=12;m++){
    const opt = document.createElement("option");
    opt.value = String(m);
    opt.textContent = `${pad2(m)} - ${monthNamePT(m)}`;
    selMesPdf.appendChild(opt);
  }
  selMesPdf.value = String(now.getMonth()+1);
}

/* ===== init ===== */
(function init(){
  const now = new Date();
  inData.value = isoDate(now);

  buildAnoMesPdf();
  resetForm();
  loadCurrentMonth();
})();

/* ===== eventos ===== */
btnSalvar.addEventListener("click", addOrUpdate);
btnCancelar.addEventListener("click", ()=>{ resetForm(); });
btnLimpar.addEventListener("click", ()=>{ resetForm(); });

btnPdf.addEventListener("click", baixarPdfMensal);
</script>
</body>
</html>
