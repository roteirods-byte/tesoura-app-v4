<!-- CAIXA_BUILD_TESTE 20260110_1905 -->
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TESOURA - CAIXA</title>

  <style>
    :root{
      --bg:#070c18;
      --bg2:#0b1630;
      --card:#0b1a33;
      --line:#1a2c52;
      --text:#eaf0ff;
      --muted:rgba(255,255,255,.70);
      --orange:#ff8a1c;
      --green:#17d46a;
      --red:#ff4050;
      --blue:#3aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg) 0%, #060a14 100%);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 28px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-radius:14px;
      background:linear-gradient(180deg,var(--bg2) 0%, #081327 100%);
      border:1px solid var(--line);
      box-shadow:0 10px 40px rgba(0,0,0,.45);
      margin-bottom:14px;
    }
    .title{
      display:flex;align-items:baseline;gap:10px;flex-wrap:wrap
    }
    .title .h1{font-weight:900;letter-spacing:.6px;color:var(--orange);font-size:18px}
    .title .sub{font-size:12px;color:var(--muted)}
    .badge{
      font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background:#081a34;color:var(--muted)
    }

    .card{
      background:linear-gradient(180deg,var(--card) 0%, #08162d 100%);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 10px 40px rgba(0,0,0,.45);
      padding:14px;
      margin-bottom:14px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;color:var(--orange);font-weight:800;letter-spacing:.4px}
    select,input{
      height:38px;min-width:160px;
      border-radius:10px;border:1px solid var(--line);
      background:#071327;color:var(--text);
      padding:0 10px;outline:none;
    }
    input[type="date"]{min-width:170px}
    .btn{
      height:38px;border-radius:10px;border:0;
      font-weight:900;letter-spacing:.4px;
      padding:0 14px;cursor:pointer;
    }
    .btn.blue{background:var(--blue);color:#071327}
    .btn.orange{background:var(--orange);color:#071327}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status strong{color:var(--text)}

    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    thead th{
      text-align:left;font-size:12px;color:#071327;
      background:var(--orange);
      padding:10px;border-bottom:1px solid #e27200;
      letter-spacing:.4px;
    }
    tbody td{
      padding:10px;border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;color:var(--text);
      vertical-align:middle;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .col-money{white-space:nowrap;font-variant-numeric:tabular-nums}
    .money.pos{color:var(--green);font-weight:900}
    .money.neg{color:var(--red);font-weight:900}
    .btnSmall{
      height:30px;border-radius:9px;border:0;cursor:pointer;
      font-weight:900;font-size:12px;padding:0 10px;
    }
    .btnEdit{background:#2ec7ff;color:#06101f}
    .btnDel{background:#ff4050;color:#06101f}
    .badge.lock{
      display:inline-block;padding:5px 10px;border-radius:999px;
      background:rgba(23,212,106,.12);
      border:1px solid rgba(23,212,106,.35);
      color:var(--green);font-weight:900;font-size:12px;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
  </style>

  <!-- tenta reaproveitar config do projeto (se existir) -->
  <script src="app/core/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="h1">TESOURA - CAIXA</div>
        <div class="sub">Filtro por <b>ANO</b> e <b>MÊS</b> (sem semana)</div>
      </div>
      <div class="badge" id="envBadge">online</div>
    </div>

    <div class="card">
      <div class="row">
        <div class="field">
          <div class="label">ANO</div>
          <select id="selAno"></select>
        </div>

        <div class="field">
          <div class="label">MÊS</div>
          <select id="selMes"></select>
        </div>

        <button class="btn blue" id="btnConsultar" type="button">CONSULTAR</button>
        <button class="btn ghost" id="btnLimpar" type="button">LIMPAR</button>
      </div>

      <div class="status">STATUS: <strong id="status">pronto</strong></div>
      <div class="hint">Mensalidades pagas aparecem como <b>AUTO</b> e não podem ser editadas/excluídas no Caixa.</div>
    </div>

    <div class="card">
      <div class="grid2">
        <div class="field">
          <div class="label">DATA</div>
          <input id="inData" type="date"/>
        </div>

        <div class="field">
          <div class="label">TIPO</div>
          <select id="inTipo">
            <option value="RECEITA">RECEITA</option>
            <option value="DESPESA">DESPESA</option>
          </select>
        </div>

        <div class="field">
          <div class="label">DESCRIÇÃO</div>
          <input id="inDesc" placeholder="Ex: CHURRASCO"/>
        </div>

        <div class="field">
          <div class="label">OBS</div>
          <input id="inObs" placeholder="Opcional"/>
        </div>

        <div class="field">
          <div class="label">VALOR (R$)</div>
          <input id="inValor" inputmode="decimal" placeholder="Ex: 25,00"/>
        </div>

        <div class="field">
          <div class="label">AÇÕES</div>
          <div class="row">
            <button class="btn orange" id="btnSalvar" type="button">SALVAR</button>
            <button class="btn ghost" id="btnCancelar" type="button" style="display:none">CANCELAR</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="label" style="margin:0">LANÇAMENTOS</div>
        <div class="badge">Saldo anterior: <span id="saldoAnterior">R$ 0,00</span></div>
      </div>

      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:110px">DATA</th>
              <th>DESCRIÇÃO</th>
              <th>OBS</th>
              <th style="width:140px">RECEITA</th>
              <th style="width:140px">DESPESA</th>
              <th style="width:140px">SALDO</th>
              <th style="width:110px">EDITAR</th>
              <th style="width:110px">EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* =======================
   FIX DEFINITIVO:
   - NÃO EXISTE semana no Caixa
   - buildSemanas SEMPRE existe (stub)
   - updateUIByPeriodo SEMPRE existe (stub)
   - NÃO trava se algo faltar
======================= */

function buildSemanas(){ return; }
function updateUIByPeriodo(){ return; }

(function(){
  const $ = (id)=>document.getElementById(id);
  const statusEl = $("status");
  const tbody = $("tbody");
  const selAno = $("selAno");
  const selMes = $("selMes");
  const btnConsultar = $("btnConsultar");
  const btnLimpar = $("btnLimpar");
  const btnSalvar = $("btnSalvar");
  const btnCancelar = $("btnCancelar");
  const inData = $("inData");
  const inTipo = $("inTipo");
  const inDesc = $("inDesc");
  const inObs = $("inObs");
  const inValor = $("inValor");
  const sAnterior = $("saldoAnterior");

  function setStatus(msg){
    if(statusEl) statusEl.textContent = msg || "";
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoDate(d){
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  function money(v){
    try{
      return (Number(v||0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }catch(e){ return "R$ 0,00"; }
  }
  function parseMoneyBR(s){
    s = String(s||"").trim();
    if(!s) return NaN;
    s = s.replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"");
    return Number(s);
  }
  function isMensalidadeRow(r){
    const obs = String((r && r.obs) || "").toUpperCase();
    const desc = String((r && r.descricao) || "").toUpperCase();
    return obs.includes("MENSALIDADE") || desc.includes("MENSALIDADE");
  }

  // tenta pegar um client supabase pronto (sb) ou cria um
  function getSupabaseClient(){
    if (window.sb && typeof window.sb.from === "function") return window.sb;

    const supabaseGlobal = window.supabase;
    if(!supabaseGlobal || typeof supabaseGlobal.createClient !== "function") return null;

    // tenta achar URL/KEY em vários formatos comuns
    const cfg = window.TESOURA_CONFIG || window.CONFIG || {};
    const url = cfg.SUPABASE_URL || cfg.supabaseUrl || window.SUPABASE_URL || window.supabaseUrl;
    const key = cfg.SUPABASE_ANON_KEY || cfg.supabaseAnonKey || window.SUPABASE_ANON_KEY || window.supabaseAnonKey;

    if(!url || !key) return null;

    try{
      return supabaseGlobal.createClient(url, key);
    }catch(e){
      return null;
    }
  }

  const sb = getSupabaseClient();
  $("envBadge").textContent = sb ? "supabase ok" : "supabase ausente";

  let editingId = null;
  let idCol = "id";
  let dateCol = "data";
  let descCol = "descricao";
  let obsCol  = "obs";
  let tipoCol = "tipo";
  let valorCol = "valor";
  let receitaCol = "receita";
  let despesaCol = "despesa";

  function buildAno(){
    selAno.innerHTML = "";
    const now = new Date();
    const y = now.getFullYear();
    const years = [y-1,y,y+1,y+2];
    years.forEach(yy=>{
      const o=document.createElement("option");
      o.value=String(yy);
      o.textContent=String(yy);
      selAno.appendChild(o);
    });
  }
  function buildMes(){
    selMes.innerHTML = "";
    for(let m=1;m<=12;m++){
      const o=document.createElement("option");
      o.value=String(m);
      o.textContent=pad2(m);
      selMes.appendChild(o);
    }
  }

  function getRange(){
    const ano = Number(selAno.value||0);
    const mes = Number(selMes.value||0);
    const ini = new Date(ano, mes-1, 1);
    const fim = new Date(ano, mes, 1);
    return { ini: isoDate(ini), fim: isoDate(fim) };
  }

  async function detectColsOneRow(){
    // tenta descobrir nomes reais das colunas
    try{
      const r = await sb.from("caixa").select("*").limit(1);
      const row = (r.data && r.data[0]) ? r.data[0] : null;
      if(!row) return;

      const keys = Object.keys(row);

      function pick(cands, fallback){
        for (const c of cands){
          if(keys.includes(c)) return c;
        }
        return fallback;
      }

      idCol = pick(["id","caixa_id","uuid"], "id");
      dateCol = pick(["data","data_lancamento","dia","dt"], "data");
      descCol = pick(["descricao","desc","titulo"], "descricao");
      obsCol  = pick(["obs","observacao","observações","observacao_texto"], "obs");
      tipoCol = pick(["tipo"], "tipo");
      valorCol = pick(["valor"], "valor");
      receitaCol = pick(["receita"], "receita");
      despesaCol = pick(["despesa"], "despesa");
    }catch(e){}
  }

  async function fetchCaixaManual(ini, fim){
    let q = sb.from("caixa").select("*");
    // aplica range pela melhor coluna de data
    if(dateCol) q = q.gte(dateCol, ini).lt(dateCol, fim);

    const { data, error } = await q;
    if (error) throw error;

    const rows = (data||[]).map(r=>{
      const d = (r[dateCol] ?? r.data ?? r.data_lancamento ?? r.dia ?? "");
      const descricao = (r[descCol] ?? r.descricao ?? r.desc ?? "") || "";
      const obs = (r[obsCol] ?? r.obs ?? r.observacao ?? "") || "";
      const tipo = (r[tipoCol] ?? r.tipo ?? "") || "";

      const receita = r[receitaCol];
      const despesa = r[despesaCol];
      const valor = r[valorCol];

      let signed = 0;
      if (typeof receita === "number" || typeof despesa === "number"){
        signed = Number(receita||0) - Number(despesa||0);
      } else {
        signed = Number(valor||0);
      }

      const isR = (String(tipo).toUpperCase()==="RECEITA") || signed > 0;
      const isD = (String(tipo).toUpperCase()==="DESPESA") || signed < 0;

      return {
        _src:"CAIXA",
        id: r[idCol] ?? r.id ?? null,
        data: String(d||"").slice(0,10),
        descricao: String(descricao||""),
        obs: String(obs||""),
        receita: isR ? Math.abs(signed) : 0,
        despesa: isD ? Math.abs(signed) : 0,
        locked: isMensalidadeRow({obs,descricao})
      };
    }).filter(x=>x.data);

    return rows;
  }

  async function fetchMensalidadesPago(ini, fim){
    // se tabela não existir, não trava
    const { data, error } = await sb
      .from("mensalidades")
      .select("*")
      .eq("pago", true)
      .gte("data_pagamento", ini)
      .lt("data_pagamento", fim);

    if (error) throw error;

    return (data||[]).map(r=>{
      const dt = String(r.data_pagamento||"").slice(0,10);
      const ano = r.ano;
      const mes = r.mes;
      const mm = pad2(mes);
      const marker = `MENSALIDADE (${mm}/${ano})`;
      return {
        _src:"MENSALIDADE",
        id: `MENSALIDADE:${String(r.apelido||"").toUpperCase()}:${ano}-${mm}`,
        data: dt,
        descricao: String(r.apelido||"").toUpperCase(),
        obs: marker,
        receita: Math.abs(Number(r.valor||0)) || 0,
        despesa: 0,
        locked: true
      };
    }).filter(x=>x.data);
  }

  function render(rows){
    tbody.innerHTML = "";
    let saldo = 0;

    rows.forEach((r)=>{
      saldo += (Number(r.receita||0) - Number(r.despesa||0));
      const tr=document.createElement("tr");

      const tdD=document.createElement("td");
      tdD.textContent = r.data ? r.data.split("-").reverse().join("/") : "";
      tr.appendChild(tdD);

      const tdDesc=document.createElement("td");
      tdDesc.textContent = r.descricao || "";
      tr.appendChild(tdDesc);

      const tdObs=document.createElement("td");
      tdObs.textContent = r.obs || "";
      tr.appendChild(tdObs);

      const tdR=document.createElement("td");
      tdR.className="col-money";
      tdR.innerHTML = r.receita ? `<span class="money pos">${money(r.receita)}</span>` : "";
      tr.appendChild(tdR);

      const tdE=document.createElement("td");
      tdE.className="col-money";
      tdE.innerHTML = r.despesa ? `<span class="money neg">${money(r.despesa)}</span>` : "";
      tr.appendChild(tdE);

      const tdS=document.createElement("td");
      tdS.className="col-money";
      tdS.innerHTML = saldo >= 0
        ? `<span class="money pos">${money(saldo)}</span>`
        : `<span class="money neg">${money(saldo)}</span>`;
      tr.appendChild(tdS);

      const tdEdit=document.createElement("td");
      const tdDel=document.createElement("td");

      if(r.locked){
        const b=document.createElement("span");
        b.className="badge lock";
        b.textContent="AUTO";
        tdEdit.appendChild(b);
      } else {
        const btE=document.createElement("button");
        btE.className="btnSmall btnEdit";
        btE.textContent="EDITAR";
        btE.addEventListener("click", ()=>startEdit(r));
        tdEdit.appendChild(btE);

        const btD=document.createElement("button");
        btD.className="btnSmall btnDel";
        btD.textContent="EXCLUIR";
        btD.addEventListener("click", ()=>doDelete(r));
        tdDel.appendChild(btD);
      }

      tr.appendChild(tdEdit);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    });
  }

  async function carregar(){
    if(!sb){
      setStatus("ERRO: Supabase ausente (config não carregou).");
      return;
    }
    try{
      setStatus("Carregando...");
      const {ini,fim} = getRange();

      const manual = await fetchCaixaManual(ini,fim);
      let rows = manual;

      let mens = [];
      try{ mens = await fetchMensalidadesPago(ini,fim); }catch(e){ mens=[]; }

      rows = rows.filter(r => !isMensalidadeRow(r));
      rows = rows.concat(mens);

      rows.sort((a,b)=>{
        const da=a.data||"0000-00-00";
        const db=b.data||"0000-00-00";
        if(da<db) return -1;
        if(da>db) return 1;
        if(a._src===b._src) return 0;
        return a._src==="CAIXA" ? -1 : 1;
      });

      setStatus(`LISTA CARREGADA. Registros: ${rows.length}`);
      sAnterior.textContent = "R$ 0,00";
      render(rows);
    }catch(e){
      console.error(e);
      setStatus("ERRO ao buscar CAIXA (ver console).");
      alert("ERRO ao buscar CAIXA (ver console).");
    }
  }

  function resetForm(){
    editingId=null;
    btnCancelar.style.display="none";
    btnSalvar.textContent="SALVAR";
    inDesc.value="";
    inObs.value="";
    inValor.value="";
    inTipo.value="RECEITA";
  }

  function startEdit(r){
    if(!r || r.locked) return;
    editingId = r.id;
    inData.value = (r.data||"");
    const signed = (Number(r.receita||0) - Number(r.despesa||0));
    inTipo.value = (signed>=0) ? "RECEITA" : "DESPESA";
    inDesc.value = r.descricao || "";
    inObs.value = r.obs || "";
    inValor.value = String(Math.abs(signed)).replace(".",",");
    btnCancelar.style.display="inline-block";
    btnSalvar.textContent="ATUALIZAR";
  }

  async function addOrUpdate(){
    if(!sb){ setStatus("ERRO: Supabase ausente."); return; }

    const data = String(inData.value||"").slice(0,10);
    const tipo = String(inTipo.value||"").toUpperCase();
    const desc = String(inDesc.value||"").trim();
    const obs  = String(inObs.value||"").trim();
    const val  = parseMoneyBR(inValor.value);

    if(!data){ alert("Preencha a DATA."); return; }
    if(!desc){ alert("Preencha a DESCRIÇÃO."); return; }
    if(!isFinite(val) || val<=0){ alert("Preencha um VALOR válido."); return; }
    if(String(obs).toUpperCase().includes("MENSALIDADE")){
      alert("Mensalidade é automática (não edita no Caixa).");
      return;
    }

    const payload = {};
    payload[dateCol] = data;
    payload[descCol] = desc;
    payload[obsCol]  = obs;
    payload[tipoCol] = tipo;

    // grava como receita/despesa (se colunas existirem)
    if(receitaCol && despesaCol){
      payload[receitaCol] = (tipo==="RECEITA") ? val : 0;
      payload[despesaCol] = (tipo==="DESPESA") ? val : 0;
    } else {
      payload[valorCol] = (tipo==="RECEITA") ? val : -val;
    }

    try{
      setStatus(editingId ? "Atualizando..." : "Salvando...");

      if(editingId){
        const { error } = await sb.from("caixa").update(payload).eq(idCol, editingId);
        if(error) throw error;
      } else {
        const { error } = await sb.from("caixa").insert(payload);
        if(error) throw error;
      }

      resetForm();
      await carregar();
      setStatus("OK.");
    }catch(e){
      console.error(e);
      setStatus("ERRO ao salvar (ver console).");
      alert("ERRO ao salvar (ver console).");
    }
  }

  async function doDelete(r){
    if(!sb) return;
    if(!r || r.locked) return;
    if(!confirm("Excluir este lançamento?")) return;

    try{
      setStatus("Excluindo...");
      const { error } = await sb.from("caixa").delete().eq(idCol, r.id);
      if(error) throw error;
      await carregar();
      setStatus("OK.");
    }catch(e){
      console.error(e);
      setStatus("ERRO ao excluir (ver console).");
      alert("ERRO ao excluir (ver console).");
    }
  }

  // eventos (sem buildSemanas)
  btnConsultar.addEventListener("click", carregar);
  btnSalvar.addEventListener("click", addOrUpdate);
  btnCancelar.addEventListener("click", ()=>{ resetForm(); });
  btnLimpar.addEventListener("click", ()=>{
    const now=new Date();
    selAno.value=String(now.getFullYear());
    selMes.value=String(now.getMonth()+1);
    carregar();
  });

  // init
  (async function init(){
    try{
      buildAno();
      buildMes();
      const now=new Date();
      selAno.value=String(now.getFullYear());
      selMes.value=String(now.getMonth()+1);
      inData.value=isoDate(now);
      resetForm();

      if(sb){
        await detectColsOneRow();
        await carregar();
      } else {
        setStatus("ERRO: Supabase ausente (config não carregou).");
      }
    }catch(e){
      console.error(e);
      setStatus("ERRO ao iniciar (ver console).");
    }
  })();

})();
</script>
</body>
</html>
