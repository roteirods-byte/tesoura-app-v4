<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tesoura - Caixa</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#050a14;
      --panel:#0b1220;
      --panel2:#0a1020;
      --line:#18233a;
      --text:#e7eefc;
      --muted:#9fb2d7;
      --orange:#ff8a2a;
      --blue:#12b5ea;
      --green:#18d37b;
      --red:#ff3b3b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    \.wrap{max-width:1400px;margin:0 auto;padding:18px}
    .card{background:linear-gradient(180deg,rgba(18,24,45,.92),rgba(10,16,32,.92));border:1px solid var(--line);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.35)}
    .title{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:2px solid rgba(255,138,42,.55)}
    .title h1{margin:0;font-size:18px;letter-spacing:.4px;color:var(--orange)}
    .title small{color:var(--muted)}
    .section{padding:16px 18px}
    .section h2{margin:0 0 10px 0;color:var(--orange);font-size:14px;letter-spacing:.4px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    select,input{height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:#0a1020;color:#fff;padding:0 10px;outline:none}
    input::placeholder{color:#5f6f93}
    .btn{height:36px;border-radius:10px;border:0;padding:0 14px;font-weight:700;cursor:pointer}
    .btn.blue{background:var(--blue);color:#00111a}
    .btn.orange{background:var(--orange);color:#1a0a00}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:#fff}
    .meta{margin-top:8px;color:var(--muted);font-size:12px}
    .stats{display:flex;gap:14px;flex-wrap:wrap;color:var(--text);font-size:12px;margin-top:8px}
    .stats b{color:#fff}
    .table-wrap{margin-top:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);overflow:hidden}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{background:var(--orange);color:#fff;font-size:12px;padding:10px;border-right:1px solid rgba(0,0,0,.18)}
    thead th:last-child{border-right:0}
    tbody td{padding:10px;border-top:1px solid rgba(255,255,255,.08);vertical-align:middle;font-size:12px;color:#e9f1ff}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    .col-date{width:110px}
    .col-desc{width:280px}
    .col-obs{width:140px}
    .col-money{width:120px;text-align:right}
    .col-actions{width:260px;text-align:center}

    td.col-desc, td.col-obs{white-space:normal;}
    td.col-desc{text-align:left;}
    td.col-obs{text-align:left;}
    .money.pos{color:var(--green);font-weight:800}
    .money.neg{color:var(--red);font-weight:800}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.14);color:#dbe7ff;background:rgba(0,0,0,.18)}
    .badge.lock{border-color:rgba(255,138,42,.55);color:#ffd9b5}
    .actions{display:flex;gap:10px;justify-content:center;align-items:center}
    .btnSmall{height:30px;border-radius:10px;border:0;padding:0 12px;font-weight:800;cursor:pointer;font-size:12px}
    .btnEdit{background:var(--green);color:#02140b}
    .btnDel{background:var(--red);color:#1a0000}
    .btnDisabled{opacity:.55;cursor:not-allowed}
    .readonly{opacity:.75}
    .line{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    /* impressão */
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:0;border-radius:0;background:#fff}
      .title,.section h2,.row,.meta,.stats,.actions,.btn{display:none !important}
      .table-wrap{border:0}
      table{table-layout:auto;width:100%}
      thead th{position:static}
    }
    @page{size:A4 landscape;margin:10mm}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>TESOURA - CAIXA</h1>
        <small>(auto-save)</small>
      </div>

      <div class="section">
        <h2>FILTRO</h2>
        <div class="row">
          <div class="field">
            <label>ANO:</label>
            <select id="selAno"></select>
          </div>
          <div class="field">
            <label>MÊS:</label>
            <select id="selMes"></select>
          </div>
          <div class="field">
            <label>PERÍODO:</label>
            <select id="selPeriodo">
              <option value="SEMANAL">SEMANAL</option>
              <option value="MENSAL">MENSAL</option>
              <option value="ANUAL">ANUAL</option>
            </select>
          </div>
          <div class="field">
            <label>SEMANA:</label>
            <select id="selSemana"></select>
          </div>

          <div style="flex:1"></div>

          <button class="btn blue" id="btnConsultar">CONSULTAR</button>
          <button class="btn orange" id="btnPdf">BAIXAR PDF</button>
        </div>

        <div class="meta" id="status">Carregando...</div>
        <div class="stats">
          <div><b>SALDO ANTERIOR:</b> <span id="sAnterior">R$ 0,00</span></div>
          <div><b>SALDO NO PERÍODO:</b> <span id="sPeriodo">R$ 0,00</span></div>
          <div><b>SALDO FINAL:</b> <span id="sFinal">R$ 0,00</span></div>
        </div>
      </div>

      <div class="section">
        <h2>LANÇAMENTOS</h2>
        <div class="row">
          <input id="inData" type="date" style="width:160px"/>
          <select id="inTipo" style="width:140px">
            <option value="RECEITA">RECEITA</option>
            <option value="DESPESA">DESPESA</option>
          </select>
          <input id="inDesc" placeholder="DESCRIÇÃO" style="flex:1;min-width:220px"/>
          <input id="inObs" placeholder="OBS" style="width:220px"/>
          <input id="inValor" placeholder="VALOR (R$)" inputmode="decimal" style="width:160px"/>
          <button class="btn blue" id="btnSalvar">SALVAR</button>
          <button class="btn ghost" id="btnCancelar" style="display:none">CANCELAR</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="col-date">DATA</th>
                <th class="col-desc">DESCRIÇÃO</th>
                <th class="col-obs">OBS</th>
                <th class="col-money">RECEITA (R$)</th>
                <th class="col-money">DESPESA (R$)</th>
                <th class="col-money">SALDO (R$)</th>
                <th class="col-actions">AÇÕES</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== SUPABASE ===== */
const CFG = window.TESOURA_CONFIG || {};
const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || CFG.SUPABASE_ANON || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
const sb = window.supabase.createClient(SB_URL, SB_KEY);

/* ===== elementos ===== */
const selAno = document.getElementById("selAno");
const selMes = document.getElementById("selMes");
const selPeriodo = document.getElementById("selPeriodo");
const selSemana = document.getElementById("selSemana");
const btnConsultar = document.getElementById("btnConsultar");
const btnPdf = document.getElementById("btnPdf");

const inData = document.getElementById("inData");
const inTipo = document.getElementById("inTipo");
const inDesc = document.getElementById("inDesc");
const inObs = document.getElementById("inObs");
const inValor = document.getElementById("inValor");
const btnSalvar = document.getElementById("btnSalvar");
const btnCancelar = document.getElementById("btnCancelar");

const tbody = document.getElementById("tbody");
const statusEl = document.getElementById("status");

const sAnterior = document.getElementById("sAnterior");
const sPeriodo = document.getElementById("sPeriodo");
const sFinal = document.getElementById("sFinal");

/* ===== util ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function isoDate(d){ return d.toISOString().slice(0,10); }
function parseMoneyBR(v){
  const s = String(v||"").trim().replaceAll(".","").replace(",",".");
  const num = Number(s);
  return isFinite(num) ? num : NaN;
}
function money(n){
  const v = Number(n||0);
  return v.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function pickCol(row, candidates){
  if(!row) return null;
  const keys = Object.keys(row);
  const low = keys.map(k=>k.toLowerCase());
  for(const c of candidates){
    const i = low.indexOf(String(c).toLowerCase());
    if(i>=0) return keys[i];
  }
  return null;
}
function isMensalidadeRow(r){
  const obs = String(r.obs||"").toUpperCase();
  const desc = String(r.descricao||r.desc||"").toUpperCase();
  if (obs.includes("MENSALIDADE")) return true;
  if (desc.startsWith("MENSALIDADE")) return true;
  if (String(r._src||"") === "MENSALIDADE") return true;
  return false;
}
function weekStartMonday(d){
  const x = new Date(d);
  const day = (x.getDay()+6)%7; // 0=Mon
  x.setDate(x.getDate()-day);
  x.setHours(0,0,0,0);
  return x;
}
function weekEndExclusive(d){
  const s = weekStartMonday(d);
  const e = new Date(s);
  e.setDate(e.getDate()+7);
  return e;
}
function buildWeeksForYear(year){
  // gera semanas do ano (segunda->segunda)
  const weeks = [];
  let d = new Date(year,0,1);
  d = weekStartMonday(d);
  // até início do ano seguinte + 1 semana
  const end = new Date(year+1,0,15);
  while(d < end){
    const s = new Date(d);
    const e = weekEndExclusive(s);
    const label = `${pad2(s.getDate())}/${pad2(s.getMonth()+1)}/${s.getFullYear()} → ${pad2(new Date(e-1).getDate())}/${pad2(new Date(e-1).getMonth()+1)}/${new Date(e-1).getFullYear()}`;
    weeks.push({ ini: isoDate(s), fim: isoDate(e), label });
    d = e;
  }
  return weeks;
}
let WEEKS = [];

/* ===== estado ===== */
let editingId = null;
let editingPayloadBase = null; // guarda colunas detectadas
let lastLoadedRows = []; // já com mensalidades mescladas

/* ===== UI builders ===== */
function buildAno(){
  selAno.innerHTML = "";
  const nowY = new Date().getFullYear();
  const anos = [nowY-1, nowY, nowY+1];
  anos.forEach(y=>{
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = String(y);
    selAno.appendChild(opt);
  });
}
function buildMes(){
  selMes.innerHTML = "";
  const meses = [
    ["01","JAN"],["02","FEV"],["03","MAR"],["04","ABR"],["05","MAI"],["06","JUN"],
    ["07","JUL"],["08","AGO"],["09","SET"],["10","OUT"],["11","NOV"],["12","DEZ"]
  ];
  meses.forEach(([v,n])=>{
    const opt = document.createElement("option");
    opt.value = String(Number(v));
    opt.textContent = `${v} - ${n}`;
    selMes.appendChild(opt);
  });
}
function buildSemanas(){
  const year = Number(selAno.value);
  WEEKS = buildWeeksForYear(year);
  selSemana.innerHTML = "";
  WEEKS.forEach((w, idx)=>{
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = w.label;
    selSemana.appendChild(opt);
  });
  // semana atual
  const now = new Date();
  const idxNow = WEEKS.findIndex(w => isoDate(now) >= w.ini && isoDate(now) < w.fim);
  selSemana.value = String(Math.max(0, idxNow));
}
function updateUIByPeriodo(){
  const p = selPeriodo.value;
  selSemana.disabled = (p !== "SEMANAL");
  selMes.disabled = (p === "ANUAL");
}
function setStatus(msg){ statusEl.textContent = msg; }

/* ===== datas do filtro ===== */
function getRange(){
  const p = selPeriodo.value;
  const year = Number(selAno.value);
  const month = Number(selMes.value); // 1-12
  if (p === "ANUAL"){
    const ini = `${year}-01-01`;
    const fim = `${year+1}-01-01`;
    return { ini, fim };
  }
  if (p === "MENSAL"){
    const ini = `${year}-${pad2(month)}-01`;
    const next = (month===12) ? { y:year+1, m:1 } : { y:year, m:month+1 };
    const fim = `${next.y}-${pad2(next.m)}-01`;
    return { ini, fim };
  }
  // semanal
  const idx = Number(selSemana.value || 0);
  const w = WEEKS[idx] || WEEKS[0];
  return { ini: w.ini, fim: w.fim };
}

/* ===== SUPABASE: CAIXA (manual) ===== */
async function detectCols(){
  // Colunas oficiais da tabela public.caixa (base do projeto)
  // (evita depender de ter linhas para "descobrir" nomes)
  return {
    idCol: "id",
    dateCol: "data",
    tipoCol: "tipo",
    descricaoCol: "descricao",
    obsCol: "obs",
    valorCol: "valor",
    saldoCol: "saldo",
    mesRefCol: "referencia",
    origemCol: "origem",
    mensalidadeIdCol: "mensalidade_id",
    dataLancCol: "data_lancamento",
    apelidoCol: "apelido"
  };
}

async function fetchCaixaManual(ini, fim){
  // Lista do painel vem da VIEW (já traz receita/despesa/saldo e permissões de edição/exclusão)
  const VIEW = "vw_caixa_painel";

  const { data, error } = await sb
    .from(VIEW)
    .select("id,data,descricao,obs,receita,despesa,saldo,pode_editar,pode_excluir")
    .gte("data", ini)
    .lt("data", fim)
    .order("data", { ascending: true })
    .order("id", { ascending: true });

  if(error) throw error;

  const rows = (data || []).map(r => {
    const receita = (r.receita != null) ? Number(r.receita) : null;
    const despesa = (r.despesa != null) ? Number(r.despesa) : null;

    const podeEditar = (r.pode_editar !== false);
    const podeExcluir = (r.pode_excluir !== false);
    const locked = (!podeEditar && !podeExcluir); // mensalidade: travado

    return {
      id: r.id,
      data: r.data,
      descricao: r.descricao || "",
      obs: r.obs || "",
      receita: receita,
      despesa: despesa,
      saldo: (r.saldo != null) ? Number(r.saldo) : null,
      canEdit: podeEditar,
      canDelete: podeExcluir,
      locked
    };
  });

  // Mantemos "cols" para as rotinas de salvar/editar/excluir (tabela base)
  const cols = await detectCols();

  return { rows, cols };
}


/* ===== SUPABASE: MENSALIDADES (auto) ===== */
async function fetchMensalidadesPago(ini, fim){
  // busca pagamentos dentro do intervalo
  // coluna data_pagamento é usada no painel mensalidade
  const { data, error } = await sb
    .from("mensalidades")
    .select("*")
    .eq("pago", true)
    .gte("data_pagamento", ini)
    .lt("data_pagamento", fim);

  if (error) throw error;

  return (data||[]).map(r=>{
    const dt = String(r.data_pagamento||"").slice(0,10);
    const ano = r.ano;
    const mes = r.mes;
    const mm = pad2(mes);
    const marker = `MENSALIDADE (${mm}/${ano})`;
    return {
      _src:"MENSALIDADE",
      id: `MENSALIDADE:${String(r.apelido||"").toUpperCase()}:${ano}-${mm}`,
      data: dt,
      descricao: String(r.apelido||"").toUpperCase(),
      obs: marker,
      receita: Math.abs(Number(r.valor||0)) || 0,
      despesa: 0,
      locked: true,
      _mens: r
    };
  }).filter(x => x.data); // só com data válida
}

/* ===== render ===== */
function render(rows){
  tbody.innerHTML = "";
  let saldo = 0;

  rows.forEach((r, idx)=>{
    saldo += (Number(r.receita||0) - Number(r.despesa||0));
    const tr = document.createElement("tr");

    const tdD = document.createElement("td");
    tdD.textContent = r.data ? r.data.split("-").reverse().join("/") : "";
    tr.appendChild(tdD);

    const tdDesc = document.createElement("td");
    tdDesc.textContent = r.descricao || "";
    tr.appendChild(tdDesc);

    const tdObs = document.createElement("td");
    tdObs.textContent = r.obs || "";
    tr.appendChild(tdObs);

    const tdR = document.createElement("td");
    tdR.className = "col-money";
    tdR.innerHTML = r.receita ? `<span class="money pos">${money(r.receita)}</span>` : "";
    tr.appendChild(tdR);

    const tdE = document.createElement("td");
    tdE.className = "col-money";
    tdE.innerHTML = r.despesa ? `<span class="money neg">${money(r.despesa)}</span>` : "";
    tr.appendChild(tdE);

    const tdS = document.createElement("td");
    tdS.className = "col-money";
    tdS.innerHTML = saldo >= 0
      ? `<span class="money pos">${money(saldo)}</span>`
      : `<span class="money neg">${money(saldo)}</span>`;
    tr.appendChild(tdS);

    const tdA = document.createElement("td");
    tdA.className = "col-actions";
    const box = document.createElement("div");
    box.className = "actions";

    if (!r.canEdit && !r.canDelete){
      const badge = document.createElement("span");
      badge.className = "badge lock";
      badge.textContent = "AUTO";
      box.appendChild(badge);
    } else {
      if (r.canEdit){
        const eb = mkBtn("EDITAR", "mini edit");
        eb.onclick = ()=> startEdit(r);
        box.appendChild(eb);
      }
      if (r.canDelete){
        const db = mkBtn("EXCLUIR", "mini del");
        db.onclick = ()=> doDelete(r);
        box.appendChild(db);
      }
    }
    tdA.appendChild(box);
    tr.appendChild(tdA);

    tbody.appendChild(tr);
  });

  // saldos
  sPeriodo.textContent = `R$ ${money(rows.reduce((acc,r)=>acc + (Number(r.receita||0)-Number(r.despesa||0)),0))}`;
  sFinal.textContent = `R$ ${money(saldo)}`;
}

/* ===== carregar ===== */
async function carregar(){
  try{
    setStatus("Carregando...");
    const { ini, fim } = getRange();

    const manual = await fetchCaixaManual(ini, fim);
    let rows = manual.rows;

    // OBS: agora a lista vem pronta da VIEW vw_caixa_painel (inclui mensalidades e permissões)

    // ordena por data (e por origem)
    rows.sort((a,b)=>{
      const da = a.data || "0000-00-00";
      const db = b.data || "0000-00-00";
      if (da < db) return -1;
      if (da > db) return 1;
      // manual antes de auto no mesmo dia
      if (a._src === b._src) return 0;
      return a._src === "CAIXA" ? -1 : 1;
    });

    lastLoadedRows = rows;
    setStatus(`LISTA CARREGADA. Registros: ${rows.length}`);

    // saldo anterior: calculo simples = 0 (mantém como estava)
    sAnterior.textContent = "R$ 0,00";
    render(rows);
  }catch(e){
    console.error(e);
    setStatus("ERRO ao buscar CAIXA (ver console).");
    alert("ERRO ao buscar CAIXA (ver console).");
  }
}

/* ===== criar/editar/excluir manual ===== */
function resetForm(){
  editingId = null;
  editingPayloadBase = null;
  btnCancelar.style.display = "none";
  btnSalvar.textContent = "SALVAR";
  inDesc.value = "";
  inObs.value = "";
  inValor.value = "";
}

function startEdit(r){
  // só manual
  if (!r || r.locked) return;
  editingId = r.id;

  // preenche form
  inData.value = (r.data || "");
  const signed = (Number(r.receita||0) - Number(r.despesa||0));
  inTipo.value = (signed >= 0) ? "RECEITA" : "DESPESA";
  inDesc.value = r.descricao || "";
  inObs.value = r.obs || "";
  inValor.value = money(Math.abs(signed));

  btnCancelar.style.display = "inline-block";
  btnSalvar.textContent = "ATUALIZAR";
}

async function addOrUpdate(){
  const data = String(inData.value||"").slice(0,10);
  const tipo = String(inTipo.value||"").toUpperCase();
  const desc = String(inDesc.value||"").trim();
  const obs = String(inObs.value||"").trim();
  const val = parseMoneyBR(inValor.value);

  if (!data){ alert("Preencha a DATA."); return; }
  if (!desc){ alert("Preencha a DESCRIÇÃO."); return; }
  if (!isFinite(val) || val <= 0){ alert("Preencha um VALOR válido."); return; }

  // mensalidade é só automática
  if (String(obs).toUpperCase().includes("MENSALIDADE")){
    alert("Mensalidade é automática (não edita no Caixa).");
    return;
  }

  const signed = (tipo==="DESPESA") ? -Math.abs(val) : Math.abs(val);

  // tenta payloads diferentes para compatibilidade de colunas
  const payloads = [
    { data, tipo, descricao: desc, obs, valor: signed },
    { data_lancamento: data, tipo, descricao: desc, obs, valor: signed },
    { data, tipo, desc, obs, valor: signed },
    { data, tipo, descricao: desc, obs, receita: (tipo==="RECEITA")?Math.abs(val):0, despesa: (tipo==="DESPESA")?Math.abs(val):0 },
    { data_lancamento: data, tipo, descricao: desc, obs, receita: (tipo==="RECEITA")?Math.abs(val):0, despesa: (tipo==="DESPESA")?Math.abs(val):0 }
  ];

  if (!editingId){
    let ok=false, lastErr=null;
    for (const p of payloads){
      const { error } = await sb.from("caixa").insert(p);
      if (!error){ ok=true; break; }
      lastErr = error;
    }
    if (!ok){
      console.error(lastErr);
      alert("ERRO ao criar (ver console).");
      return;
    }
    resetForm();
    carregar();
    return;
  }

  // update
  // descobre coluna id (se existir)
  const cols = await detectCols();
  const idCol = cols.idCol || "id";
  let ok=false, lastErr=null;

  for (const p of payloads){
    const q = sb.from("caixa").update(p).eq(idCol, editingId);
    const { error } = await q;
    if (!error){ ok=true; break; }
    lastErr = error;
  }
  if (!ok){
    console.error(lastErr);
    alert("ERRO ao editar (ver console).");
    return;
  }
  resetForm();
  carregar();
}

async function doDelete(r){
  if (!r || r.locked) return;
  if (!confirm("Excluir este lançamento?")) return;
  const cols = await detectCols();
  const idCol = cols.idCol || "id";
  const { error } = await sb.from("caixa").delete().eq(idCol, r.id);
  if (error){
    console.error(error);
    alert("ERRO ao excluir (ver console).");
    return;
  }
  carregar();
}

/* ===== eventos ===== */
btnPdf.addEventListener("click", ()=>window.print());
btnConsultar.addEventListener("click", carregar);
btnSalvar.addEventListener("click", addOrUpdate);
btnCancelar.addEventListener("click", ()=>{ resetForm(); });

selPeriodo.addEventListener("change", ()=>{ updateUIByPeriodo(); });
selAno.addEventListener("change", ()=>{ buildSemanas(); updateUIByPeriodo(); });
selMes.addEventListener("change", ()=>{ /* mês muda só o range */ });

/* ===== init ===== */
(function init(){
  buildAno();
  buildMes();

  const now = new Date();
  selAno.value = String(now.getFullYear());
  selMes.value = String(now.getMonth()+1);
  buildSemanas();
  updateUIByPeriodo();

  inData.value = isoDate(now);
  resetForm();

  carregar();
})();
</script>
</body>
</html>
