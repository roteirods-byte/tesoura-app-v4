<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tesoura - Caixa</title>

  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#0b1220; color:#fff; }
    header{
      padding:14px 18px; border-bottom:2px solid #f97316;
      display:flex; align-items:center; justify-content:space-between;
      background:#07101f;
    }
    header h1{ margin:0; font-size:16px; letter-spacing:.5px; color:#f97316; text-transform:uppercase; font-weight:900; }
    .wrap{ max-width:1100px; margin:18px auto; padding:0 12px; }
    .painel{
      background:#020617; border:1px solid #0f172a; border-radius:12px;
      padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .painel h2{ margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ font-weight:900; text-transform:uppercase; font-size:12px; }
    select, input[type="text"], input[type="date"], input[type="time"], input[type="number"]{
      border-radius:10px; border:1px solid #0f172a; padding:10px 12px;
      font-weight:900; font-size:12px; background:#0b1220; color:#fff;
      outline:none;
    }
    input[type="number"]{ width:120px; }
    input[type="text"]{ width:260px; }
    .btn{
      border:0; border-radius:10px; padding:10px 12px; font-weight:900; text-transform:uppercase;
      font-size:12px; cursor:pointer;
    }
    .btn-azul{ background:#38bdf8; color:#031019; }
    .btn-laranja{ background:#f97316; color:#111827; }
    .btn-vermelho{ background:#ef4444; color:#111827; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .status{ margin-top:8px; font-size:12px; color:#9ca3af; }

    .table-wrap{ overflow:auto; border-radius:12px; border:1px solid #0f172a; }
    table{ border-collapse:collapse; font-size:12px; width:max-content; min-width:100%; }
    thead th{
      position:sticky; top:0; background:#f97316; color:#ffffff; z-index:2;
      border:1px solid rgba(255,255,255,.45); padding:8px 8px; text-align:center; white-space:nowrap;
      font-weight:900; text-transform:uppercase;
    }
    tbody td{
      border:1px solid rgba(255,255,255,.20); padding:6px 6px; text-align:center; white-space:nowrap;
      background:#020617; text-transform:uppercase;
      vertical-align:middle;
    }
    tbody tr:nth-child(even) td{ background:#061024; }

    .td-left{ text-align:left; padding-left:10px; }
    .money-pos{ color:#22c55e; font-weight:900; }
    .money-neg{ color:#ef4444; font-weight:900; }
    .saldo{ font-weight:900; }
    .fechamento td{
      background:#111827 !important;
      border-top:2px solid rgba(249,115,22,.95) !important;
      border-bottom:2px solid rgba(249,115,22,.95) !important;
    }
    .fechamento .td-left{ color:#f97316; font-weight:900; }

    /* PRINT / PDF */
    @page{ size: A4 landscape; margin: 10mm; }
    @media print{
      header, .no-print{ display:none !important; }
      body{ background:#fff; color:#000; }
      .wrap{ max-width:none; margin:0; padding:0; }
      .painel{ box-shadow:none; border:0; padding:0; }
      .table-wrap{ overflow:visible !important; border:0; }
      table{ width:100% !important; min-width:100% !important; }
      thead th{ position:static !important; }
      tbody td{ background:#fff !important; color:#000 !important; }
      .money-pos{ color:#000 !important; }
      .money-neg{ color:#000 !important; }
      .fechamento td{ background:#fff !important; }
    }
  
/* ===== extras (CAIXA corrigido) ===== */
.topbar{display:flex;align-items:center;justify-content:space-between;margin:14px 0 18px 0}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;border-radius:10px;background:#ff8c00;display:flex;align-items:center;justify-content:center;font-weight:800;color:#111}
.title{font-weight:800}
.subtitle{opacity:.8;font-size:12px}
.top-actions{display:flex;align-items:center;gap:10px}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;background:#0b1626;border:1px solid rgba(255,255,255,.08);color:#fff;font-size:12px;font-weight:700}
.pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:#0b1626;border:1px solid rgba(255,255,255,.08);color:#fff;font-size:12px}
.note{opacity:.85;font-size:12px}
.form-grid{display:grid;grid-template-columns: 160px 120px 160px 1fr 1fr 160px; gap:10px}
.field label{display:block;font-size:12px;opacity:.8;margin:0 0 6px 2px}
.field input,.field select{width:100%}
.actions{display:flex;gap:10px;align-items:center}
.status{font-size:12px;opacity:.85}
.status.err{color:#ff6b6b;opacity:1}
.warn{background:#25130f;border:1px solid rgba(255,107,107,.35);color:#ffd1d1;padding:10px;border-radius:12px;font-size:12px}
.table-wrap{overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th{position:sticky;top:0;background:rgba(255,140,0,.9);color:#111;padding:10px;font-size:12px;text-align:left}
.table td{padding:9px 10px;border-top:1px solid rgba(255,255,255,.06);font-size:12px}
.btn{cursor:pointer}
.btn-secondary{background:#283548}
.btn-primary{background:#2da8ff}
.btn-success{background:#16c172}
.btn-danger{background:#e74c3c}
.btn-mini{padding:6px 8px;font-size:11px;border-radius:10px}
.inp{width:100%;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1626;color:#fff}
@media(max-width:1100px){
  .form-grid{grid-template-columns: 1fr 1fr;}
}

</style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <div class="title">Tesoura — Controle do Futebol</div>
          <div class="subtitle">CAIXA</div>
        </div>
      </div>

      <div class="top-actions">
        <span id="roleBadge" class="badge">—</span>
        <button id="btnRefresh" class="btn btn-secondary">ATUALIZAR</button>
      </div>
    </div>

    <div class="painel">
      <div class="painel-title">CAIXA</div>
      <div class="note">
        Tela fixa no <b>mês corrente</b>. O filtro abaixo é <b>apenas</b> para <b>BAIXAR PDF</b> de meses anteriores.
      </div>

      <div class="row" style="margin-top:12px">
        <div class="pill">Mês corrente: <b id="mesCorrenteLbl">—</b></div>
        <div class="pill">Visualizando: <b id="visualizandoLbl">—</b></div>
        <div class="pill">Total: <b id="totaisLbl">—</b></div>
      </div>
    </div>

    <div class="painel">
      <div class="painel-title">LANÇAMENTOS (mês corrente)</div>

      <div id="modoAviso" class="warn" style="display:none;margin-bottom:10px"></div>

      <div class="form-grid">
        <div class="field">
          <label>DATA</label>
          <input id="fData" type="date" />
        </div>

        <div class="field">
          <label>HORA</label>
          <input id="fHora" type="time" />
        </div>

        <div class="field">
          <label>TIPO</label>
          <select id="fTipo">
            <option value="RECEITA">RECEITA</option>
            <option value="DESPESA">DESPESA</option>
          </select>
        </div>

        <div class="field" style="grid-column: 1 / span 2;">
          <label>DESCRIÇÃO</label>
          <input id="fDesc" type="text" placeholder="Descrição" />
        </div>

        <div class="field" style="grid-column: 3 / span 2;">
          <label>OBS</label>
          <input id="fObs" type="text" placeholder="Opcional" />
        </div>

        <div class="field">
          <label>VALOR (R$)</label>
          <input id="fValor" type="number" step="0.01" min="0" placeholder="0,00" />
        </div>

        <div class="actions" style="grid-column: 1 / -1;">
          <button id="btnSalvar" class="btn btn-success">SALVAR</button>
          <button id="btnLimpar" class="btn btn-danger">LIMPAR</button>
          <span id="status" class="status"></span>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:14px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:110px">DATA</th>
              <th style="width:90px">HORA</th>
              <th style="width:90px">TIPO</th>
              <th>DESCRIÇÃO</th>
              <th>OBS</th>
              <th style="width:120px;text-align:right">RECEITA (R$)</th>
              <th style="width:120px;text-align:right">DESPESA (R$)</th>
              <th style="width:120px;text-align:right">SALDO (R$)</th>
              <th style="width:140px;text-align:center">AÇÕES</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    </div>

    <div class="painel">
      <div class="painel-title">PDF (ARQUIVO MENSAL)</div>

      <div class="form-grid" style="grid-template-columns: 160px 220px 1fr;">
        <div class="field">
          <label>ANO (PDF)</label>
          <select id="pdfAno"></select>
        </div>
        <div class="field">
          <label>MÊS (PDF)</label>
          <select id="pdfMes"></select>
        </div>
        <div class="actions" style="align-items:end">
          <button id="btnPdf" class="btn btn-primary">BAIXAR PDF</button>
          <span id="statusPdf" class="status"></span>
        </div>
      </div>

      <div class="note" style="margin-top:10px">
        Dica: o PDF abre no navegador. Depois clique em <b>Imprimir</b> e salve como PDF.
      </div>
    </div>
  </div>

<script>
(() => {
  if (window.__TESOURA_CAIXA_INIT__) return;
  window.__TESOURA_CAIXA_INIT__ = true;

  // ===== CONFIG / SUPABASE (mesmo padrão do Mensalidade) =====
  const CFG = (window.parent && window.parent.TESOURA_CONFIG) || window.TESOURA_CONFIG || {};

  const SB_URL = (CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co");
  const SB_KEY = (CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg");

  let sb = null;
  try {
    if(!SB_URL || !SB_KEY) throw new Error("CAIXA: Supabase não configurado (SB_URL/SB_KEY)");
    sb = window.supabase.createClient(SB_URL, SB_KEY);
  } catch(e) {
    console.error(e);
    showStatus("CAIXA: Supabase não configurado (ver Console).", true);
  }

  // ===== PERMISSÃO =====
  const role = (window.parent && window.parent.TESOURA_ROLE) || window.TESOURA_ROLE || "jogador";
  document.getElementById("roleBadge").textContent = (role || "—").toUpperCase();
  const podeEditar = (String(role).toLowerCase() === "diretoria");

  if(!podeEditar) {
    // jogador (visual): trava edição
    document.getElementById("btnSalvar").disabled = true;
    document.getElementById("btnLimpar").disabled = true;
    document.getElementById("fData").disabled = true;
    document.getElementById("fHora").disabled = true;
    document.getElementById("fTipo").disabled = true;
    document.getElementById("fDesc").disabled = true;
    document.getElementById("fObs").disabled = true;
    document.getElementById("fValor").disabled = true;
    document.getElementById("modoAviso").style.display = "";
    document.getElementById("modoAviso").textContent = "Modo JOGADOR (VISUAL): sem edição no CAIXA.";
  }

  // ===== HELPERS =====
  const $ = (id) => document.getElementById(id);

  function pad2(n) { return String(n).padStart(2, "0"); }

  function hojeISO() {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function agoraHora() {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function money(n) {
    const v = Number(n || 0);
    return v.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function monthLabel(y, m0) {
    const nomes = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    return `${nomes[m0]}/${y}`;
  }

  function getRangeMesCorrente() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth()+1, 1);
    return { start, end };
  }

  function toISODate(d) {
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function showStatus(msg, isErr=false) {
    $("status").textContent = msg || "";
    $("status").className = "status " + (isErr ? "err" : "");
  }

  function showStatusPdf(msg, isErr=false) {
    $("statusPdf").textContent = msg || "";
    $("statusPdf").className = "status " + (isErr ? "err" : "");
  }

  // ===== LOAD + RENDER =====
  async function saldoAntesDe(dataISO) {
    if(!sb) return 0;
    const { data, error } = await sb.from("caixa")
      .select("tipo,valor,data,hora")
      .lt("data", dataISO)
      .order("data", { ascending: true })
      .order("hora", { ascending: true });
    if(error) throw error;

    let saldo = 0;
    for(const r of (data || [])) {
      const val = Number(r.valor || 0);
      saldo += (String(r.tipo || "").toUpperCase() === "DESPESA") ? -val : val;
    }
    return saldo;
  }

  async function carregarMesCorrente() {
    if(!sb) return;
    showStatus("Carregando...");
    const { start, end } = getRangeMesCorrente();
    const startISO = toISODate(start);
    const endISO = toISODate(end);

    $("mesCorrenteLbl").textContent = monthLabel(start.getFullYear(), start.getMonth());
    $("visualizandoLbl").textContent = `${startISO} → ${endISO} (exclusive)`;

    const saldoAnterior = await saldoAntesDe(startISO);

    const { data, error } = await sb.from("caixa")
      .select("id,data,hora,tipo,descricao,obs,valor,created_at")
      .gte("data", startISO)
      .lt("data", endISO)
      .order("data", { ascending: true })
      .order("hora", { ascending: true })
      .order("created_at", { ascending: true });

    if(error) throw error;

    renderTabela(data || [], saldoAnterior);
    showStatus("");
  }

  function renderTabela(rows, saldoAnterior) {
    const tb = $("tb");
    tb.innerHTML = "";

    let saldo = Number(saldoAnterior || 0);
    let totRec = 0, totDesp = 0;

    // linha "Saldo anterior"
    const tr0 = document.createElement("tr");
    tr0.innerHTML = `
      <td colspan="7" style="opacity:.85"><b>Saldo anterior</b></td>
      <td style="text-align:right"><b>${money(saldo)}</b></td>
      <td style="text-align:center;opacity:.6">—</td>
    `;
    tb.appendChild(tr0);

    for(const r of rows) {
      const tipo = String(r.tipo || "").toUpperCase();
      const valor = Number(r.valor || 0);

      if(tipo === "DESPESA") {
        saldo -= valor;
        totDesp += valor;
      } else {
        saldo += valor;
        totRec += valor;
      }

      const tr = document.createElement("tr");
      tr.dataset.id = r.id;

      const receita = (tipo === "RECEITA") ? money(valor) : "";
      const despesa = (tipo === "DESPESA") ? money(valor) : "";

      tr.innerHTML = `
        <td>${r.data || ""}</td>
        <td>${(r.hora || "").slice(0,5)}</td>
        <td>${tipo}</td>
        <td>${escapeHtml(r.descricao || "")}</td>
        <td>${escapeHtml(r.obs || "")}</td>
        <td style="text-align:right">${receita}</td>
        <td style="text-align:right">${despesa}</td>
        <td style="text-align:right"><b>${money(saldo)}</b></td>
        <td style="text-align:center">${podeEditar ? `
          <button class="btn btn-mini" data-act="edit">EDITAR</button>
          <button class="btn btn-mini btn-danger" data-act="del">EXCLUIR</button>
        ` : `<span style="opacity:.6">—</span>`}</td>
      `;
      tb.appendChild(tr);
    }

    $("totaisLbl").textContent = `Receitas: R$ ${money(totRec)} • Despesas: R$ ${money(totDesp)} • Saldo: R$ ${money(saldo)}`;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ===== CRUD =====
  async function criar() {
    if(!sb) return;
    if(!podeEditar) return;

    const data = $("fData").value || hojeISO();
    const hora = ($("fHora").value || agoraHora()).slice(0,5);
    const tipo = $("fTipo").value;
    const desc = ($("fDesc").value || "").trim();
    const obs = ($("fObs").value || "").trim();
    const valor = Number(String($("fValor").value || "0").replace(",", "."));

    if(!desc) return showStatus("Informe a DESCRIÇÃO.", true);
    if(!valor || valor <= 0) return showStatus("Informe um VALOR maior que zero.", true);

    showStatus("Salvando...");
    const payload = {
      data, hora, tipo,
      descricao: desc,
      obs: obs || null,
      valor
    };

    const { error } = await sb.from("caixa").insert(payload);
    if(error) {
      console.error(error);
      return showStatus("Erro ao salvar (ver Console).", true);
    }

    limpar();
    await carregarMesCorrente();
    showStatus("Salvo.");
    setTimeout(()=>showStatus(""), 1200);
  }

  function limpar() {
    $("fData").value = hojeISO();
    $("fHora").value = agoraHora();
    $("fTipo").value = "RECEITA";
    $("fDesc").value = "";
    $("fObs").value = "";
    $("fValor").value = "";
  }

  async function excluir(id) {
    if(!sb) return;
    if(!podeEditar) return;
    if(!id) return;
    if(!confirm("Excluir este lançamento?")) return;

    showStatus("Excluindo...");
    const { error } = await sb.from("caixa").delete().eq("id", id);
    if(error) {
      console.error(error);
      return showStatus("Erro ao excluir (ver Console).", true);
    }
    await carregarMesCorrente();
    showStatus("Excluído.");
    setTimeout(()=>showStatus(""), 1200);
  }

  function entrarModoEdicao(tr) {
    if(!podeEditar) return;
    const id = tr.dataset.id;
    const tds = tr.querySelectorAll("td");
    const data = tds[0].textContent.trim();
    const hora = tds[1].textContent.trim();
    const tipo = tds[2].textContent.trim();
    const desc = tds[3].textContent.trim();
    const obs = tds[4].textContent.trim();
    const valor = (tipo === "DESPESA") ? tds[6].textContent.trim() : tds[5].textContent.trim();

    tr.innerHTML = `
      <td><input class="inp" type="date" value="${data}"></td>
      <td><input class="inp" type="time" value="${hora}"></td>
      <td>
        <select class="inp">
          <option value="RECEITA" ${tipo==="RECEITA"?"selected":""}>RECEITA</option>
          <option value="DESPESA" ${tipo==="DESPESA"?"selected":""}>DESPESA</option>
        </select>
      </td>
      <td><input class="inp" type="text" value="${escapeAttr(desc)}"></td>
      <td><input class="inp" type="text" value="${escapeAttr(obs)}"></td>
      <td style="text-align:right"><span style="opacity:.5">—</span></td>
      <td style="text-align:right"><span style="opacity:.5">—</span></td>
      <td style="text-align:right"><span style="opacity:.5">—</span></td>
      <td style="text-align:center">
        <button class="btn btn-mini" data-act="save">SALVAR</button>
        <button class="btn btn-mini btn-secondary" data-act="cancel">CANCELAR</button>
      </td>
    `;

    // guarda valor em um input invisível (colocando no OBS)
    const inpObs = tr.querySelectorAll(".inp")[4];
    inpObs.dataset.valor = String(valor).replace(".", "").replace(",", ".") || "0";
  }

  function escapeAttr(s) {
    return String(s).replaceAll('"', "&quot;");
  }

  async function salvarEdicao(tr) {
    if(!sb) return;
    const id = tr.dataset.id;
    const inputs = tr.querySelectorAll(".inp");
    const data = inputs[0].value;
    const hora = (inputs[1].value || "00:00").slice(0,5);
    const tipo = inputs[2].value;
    const desc = (inputs[3].value || "").trim();
    const obs = (inputs[4].value || "").trim();

    // valor: tenta pegar do dataset; se estiver vazio, pede
    let valor = Number(inputs[4].dataset.valor || 0);
    if(!valor || valor<=0) {
      const v = prompt("Valor (R$):", "");
      valor = Number(String(v||"0").replace(",", "."));
    }
    if(!desc) return showStatus("Descrição vazia.", true);
    if(!valor || valor<=0) return showStatus("Valor inválido.", true);

    showStatus("Salvando edição...");
    const { error } = await sb.from("caixa").update({
      data, hora, tipo,
      descricao: desc,
      obs: obs || null,
      valor
    }).eq("id", id);

    if(error) {
      console.error(error);
      return showStatus("Erro ao editar (ver Console).", true);
    }

    await carregarMesCorrente();
    showStatus("Editado.");
    setTimeout(()=>showStatus(""), 1200);
  }

  // ===== PDF =====
  function fillPdfSelectors() {
    const anoSel = $("pdfAno");
    const mesSel = $("pdfMes");

    const now = new Date();
    const anoAtual = now.getFullYear();

    for(let a = anoAtual - 2; a <= anoAtual + 1; a++) {
      const op = document.createElement("option");
      op.value = String(a);
      op.textContent = String(a);
      if(a === anoAtual) op.selected = true;
      anoSel.appendChild(op);
    }

    const nomes = ["01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN","07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"];
    for(let i=0;i<12;i++) {
      const op = document.createElement("option");
      op.value = String(i+1);
      op.textContent = nomes[i];
      if(i === now.getMonth()) op.selected = true;
      mesSel.appendChild(op);
    }
  }

  async function baixarPdf() {
    if(!sb) return;
    showStatusPdf("Gerando...");

    const ano = Number($("pdfAno").value);
    const mes = Number($("pdfMes").value) - 1;

    const start = new Date(ano, mes, 1);
    const end = new Date(ano, mes+1, 1);

    const startISO = toISODate(start);
    const endISO = toISODate(end);

    try {
      const saldoAnterior = await saldoAntesDe(startISO);

      const { data, error } = await sb.from("caixa")
        .select("data,hora,tipo,descricao,obs,valor,created_at")
        .gte("data", startISO)
        .lt("data", endISO)
        .order("data", { ascending: true })
        .order("hora", { ascending: true })
        .order("created_at", { ascending: true });

      if(error) throw error;

      const html = buildPdfHtml(monthLabel(ano, mes), startISO, endISO, data||[], saldoAnterior);
      const w = window.open("", "_blank");
      if(!w) {
        showStatusPdf("Pop-up bloqueado. Libere pop-ups e tente de novo.", true);
        return;
      }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(()=>w.print(), 400);

      showStatusPdf("PDF aberto.");
      setTimeout(()=>showStatusPdf(""), 1500);
    } catch(e) {
      console.error(e);
      showStatusPdf("Erro ao gerar PDF (ver Console).", true);
    }
  }

  function buildPdfHtml(titulo, startISO, endISO, rows, saldoAnterior) {
    let saldo = Number(saldoAnterior||0);
    let totRec=0, totDesp=0;

    let trs = `
      <tr class="sa">
        <td colspan="6"><b>Saldo anterior</b></td>
        <td style="text-align:right"><b>R$ ${money(saldo)}</b></td>
      </tr>
    `;

    for(const r of rows) {
      const tipo = String(r.tipo||"").toUpperCase();
      const valor = Number(r.valor||0);
      if(tipo === "DESPESA") { saldo -= valor; totDesp += valor; } else { saldo += valor; totRec += valor; }

      trs += `
        <tr>
          <td>${r.data||""}</td>
          <td>${(r.hora||"").slice(0,5)}</td>
          <td>${tipo}</td>
          <td>${escapeHtml(r.descricao||"")}</td>
          <td>${escapeHtml(r.obs||"")}</td>
          <td style="text-align:right">${tipo==="RECEITA" ? money(valor) : ""}</td>
          <td style="text-align:right">${tipo==="DESPESA" ? money(valor) : ""}</td>
          <td style="text-align:right"><b>${money(saldo)}</b></td>
        </tr>
      `;
    }

    const resumo = `Receitas: R$ ${money(totRec)} • Despesas: R$ ${money(totDesp)} • Saldo: R$ ${money(saldo)}`;

    return `<!doctype html>
<html><head><meta charset="utf-8"/>
<title>CAIXA - ${titulo}</title>
<style>
  body{font-family:Arial, sans-serif; padding:18px;}
  h1{font-size:18px;margin:0 0 6px 0;}
  .sub{font-size:12px;margin:0 0 14px 0;color:#333;}
  table{width:100%;border-collapse:collapse;font-size:12px;}
  th,td{border:1px solid #ddd;padding:6px;vertical-align:top;}
  th{background:#f1f1f1;text-align:left;}
  .sa td{background:#fafafa;}
  .res{margin-top:10px;font-size:12px;}
</style>
</head><body>
  <h1>TESOURA - CAIXA (PDF)</h1>
  <div class="sub"><b>${titulo}</b> • Período: ${startISO} → ${endISO} (exclusive)</div>
  <table>
    <thead>
      <tr>
        <th style="width:90px">DATA</th>
        <th style="width:70px">HORA</th>
        <th style="width:70px">TIPO</th>
        <th>DESCRIÇÃO</th>
        <th>OBS</th>
        <th style="width:90px;text-align:right">RECEITA</th>
        <th style="width:90px;text-align:right">DESPESA</th>
        <th style="width:90px;text-align:right">SALDO</th>
      </tr>
    </thead>
    <tbody>
      ${trs}
    </tbody>
  </table>
  <div class="res"><b>${resumo}</b></div>
</body></html>`;
  }

  // ===== EVENTS =====
  $("btnSalvar").addEventListener("click", (e) => { e.preventDefault(); criar(); });
  $("btnLimpar").addEventListener("click", (e) => { e.preventDefault(); limpar(); showStatus(""); });
  $("btnRefresh").addEventListener("click", (e) => { e.preventDefault(); carregarMesCorrente().catch(err => { console.error(err); showStatus("Erro ao carregar (ver Console).", true); }); });
  $("btnPdf").addEventListener("click", (e) => { e.preventDefault(); baixarPdf(); });

  $("tb").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;
    const tr = btn.closest("tr");
    if(!tr || !tr.dataset.id) return;

    const act = btn.dataset.act;
    if(act === "del") return excluir(tr.dataset.id).catch(err => { console.error(err); showStatus("Erro (ver Console).", true); });
    if(act === "edit") return entrarModoEdicao(tr);
    if(act === "cancel") return carregarMesCorrente().catch(err => { console.error(err); showStatus("Erro (ver Console).", true); });
    if(act === "save") return salvarEdicao(tr).catch(err => { console.error(err); showStatus("Erro (ver Console).", true); });
  });

  // ===== INIT =====
  fillPdfSelectors();
  limpar();
  if(sb) {
    carregarMesCorrente().catch(err => {
      console.error(err);
      showStatus("Erro ao carregar (ver Console).", true);
    });
  }
})();
</script>

</body>
</html>
