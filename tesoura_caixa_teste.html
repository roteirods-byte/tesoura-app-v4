<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CAIXA (TESTE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    header{padding:14px 18px;border-bottom:2px solid #f97316;display:flex;align-items:center;justify-content:space-between;background:#07101f}
    header h1{margin:0;font-size:16px;letter-spacing:.5px;color:#f97316;text-transform:uppercase;font-weight:900}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    .painel{background:#020617;border:1px solid #0f172a;border-radius:12px;padding:12px;margin-bottom:14px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .painel h2{margin:0 0 10px;color:#f97316;font-size:14px;letter-spacing:.5px;text-transform:uppercase;font-weight:900}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:900;text-transform:uppercase;color:#cbd5e1}
    select,input{border-radius:10px;border:1px solid #0f172a;padding:10px 12px;font-weight:900;text-transform:uppercase;font-size:12px;background:#0b1220;color:#fff;outline:none}
    input[type="text"]{text-transform:none;font-weight:800}
    input[type="number"]{text-transform:none;font-weight:900;width:140px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:900;text-transform:uppercase;font-size:12px;cursor:pointer}
    .btn-azul{background:#38bdf8;color:#031019}
    .btn-laranja{background:#f97316;color:#111827}
    .btn-vermelho{background:#ef4444;color:#111827}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .status{margin-top:8px;font-size:12px;color:#9ca3af}

    .table-wrap{overflow:visible;}
    table{border-collapse:collapse;font-size:12px;width:max-content;min-width:1100px}
    thead th{
      position:sticky;top:0;background:#f97316;color:#fff;z-index:2;
      border:1px solid rgba(255,255,255,.45);padding:8px 8px;text-align:center;white-space:nowrap;
      font-weight:900;text-transform:uppercase
    }
    tbody td{
      border:1px solid rgba(255,255,255,.20);padding:6px 8px;text-align:center;white-space:nowrap;
      background:#020617
    }
    tbody tr:nth-child(even) td{background:#061024}
    td.left{text-align:left}
    .money{font-weight:900}
    .pos{color:#22c55e}
    .neg{color:#ef4444}
    .saldo{font-weight:900}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:900;font-size:11px}
    .pill-rec{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.35)}
    .pill-desp{background:rgba(239,68,68,.12);color:#ef4444;border:1px solid rgba(239,68,68,.35)}
    .readonly{opacity:.65}

    /* impressão/PDF */
    
    /* Ajustes de colunas (sem mudar o layout geral) */
    table{width:100%;table-layout:fixed}
    th.c-data, td:nth-child(1){width:110px}
    th.c-desc, td:nth-child(2){width:220px}
    th.c-obs,  td:nth-child(3){width:130px}
    th.c-rec,  td:nth-child(4){width:130px}
    th.c-desp, td:nth-child(5){width:130px}
    th.c-saldo,td:nth-child(6){width:130px}
    th.c-acoes,td:nth-child(7){width:230px}
    td{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

@media print{
      @page{size:A4 landscape; margin:10mm}
      .table-wrap{overflow:visible !important}

      header,#painelFiltro,.no-print{display:none !important}
      body{background:#fff;color:#000}
      .wrap{max-width:none;margin:0;padding:0}
      .painel{box-shadow:none;border:0}
      thead th{position:static !important}
    }
  </style>
</head>
<body>
<header>
  <h1>TESOURA - CAIXA</h1>
  <div style="font-size:12px;color:#9ca3af;">(auto-save)</div>
</header>

<div class="wrap">
  <div class="painel" id="painelFiltro">
    <h2>FILTRO</h2>

    <div class="row" style="justify-content:space-between;width:100%;">
      <div class="row">
        <div class="row">
          <label>ANO:</label>
          <select id="selAno"></select>
        </div>

        <div class="row">
          <label>MÊS:</label>
          <select id="selMes"></select>
        </div>

        <div class="row">
          <label>PERÍODO:</label>
          <select id="selPeriodo">
            <option value="SEMANAL">SEMANAL</option>
            <option value="MENSAL">MENSAL</option>
            <option value="ANUAL">ANUAL</option>
          </select>
        </div>

        <div class="row" id="wrapSemana">
          <label>SEMANA:</label>
          <select id="selSemana"></select>
        </div>
      </div>

      <div class="row">
        <button id="btnConsultar" class="btn btn-azul no-print">CONSULTAR</button>
        <button id="btnPdf" class="btn btn-laranja no-print" title="Salvar em PDF">BAIXAR PDF</button>
      </div>
    </div>

    <div class="status" id="status">Carregando…</div>

    <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap;">
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO ANTERIOR:</b> <span id="saldoAnterior">R$ 0,00</span></div>
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO NO PERÍODO:</b> <span id="saldoPeriodo">R$ 0,00</span></div>
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO FINAL:</b> <span id="saldoFinal">R$ 0,00</span></div>
    </div>
  </div>

  <div class="painel">
    <h2>LANÇAMENTOS</h2>

    <!-- linha de lançamento (sem botão NOVO) -->
    <div class="row no-print" style="margin-bottom:10px;gap:8px;">
      <input id="inData" type="date" />
      <!-- Hora removida -->
      <select id="inTipo">
        <option value="RECEITA">RECEITA</option>
        <option value="DESPESA">DESPESA</option>
      </select>
      <input id="inDesc" type="text" placeholder="DESCRIÇÃO" style="width:260px;" />
      <input id="inObs" type="text" placeholder="OBS" style="width:260px;" />
      <input id="inValor" type="number" step="0.01" placeholder="VALOR (R$)" />
      <button id="btnAdd" class="btn btn-azul">SALVAR</button>
    </div>

    <div class="table-wrap" id="wrapTabela">
      <table>
        <thead>
            <tr>
              <th class="c-data">DATA</th>
              <th class="c-desc">DESCRIÇÃO</th>
              <th class="c-obs">OBS</th>
              <th class="c-rec">RECEITA (R$)</th>
              <th class="c-desp">DESPESA (R$)</th>
              <th class="c-saldo">SALDO (R$)</th>
              <th class="c-acoes no-print">AÇÕES</th>
            </tr>
          </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="status" id="status2"></div>
  </div>
</div>

<script src="app/core/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ===== SUPABASE =====
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  // ===== UI =====
  const selAno = document.getElementById("selAno");
  const selMes = document.getElementById("selMes");
  const selPeriodo = document.getElementById("selPeriodo");
  const wrapSemana = document.getElementById("wrapSemana");
  const selSemana = document.getElementById("selSemana");
  const btnConsultar = document.getElementById("btnConsultar");
  const btnPdf = document.getElementById("btnPdf");

  const statusEl = document.getElementById("status");
  const status2 = document.getElementById("status2");
  const tbody = document.getElementById("tbody");

  const saldoAnteriorEl = document.getElementById("saldoAnterior");
  const saldoPeriodoEl  = document.getElementById("saldoPeriodo");
  const saldoFinalEl    = document.getElementById("saldoFinal");

  const inData = document.getElementById("inData");
  const inHora = null; // Hora removida
  const inTipo = document.getElementById("inTipo");
  const inDesc = document.getElementById("inDesc");
  const inObs  = document.getElementById("inObs");
  const inValor= document.getElementById("inValor");
  const btnAdd = document.getElementById("btnAdd");

  // ===== HELPERS =====
  const pad2 = n => String(n).padStart(2,"0");
  const money = (v) => {
    const n = Number(v || 0);
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  };
  const isoDate = (d) => {
    if (!d) return "";
    if (typeof d === "string") return d.slice(0,10);
    const x = new Date(d);
    return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
  };
  const isoTime = (d) => {
    if (!d) return "";
    if (typeof d === "string" && d.includes(":")) return d.slice(0,5);
    const x = new Date(d);
    return `${pad2(x.getHours())}:${pad2(x.getMinutes())}`;
  };

  function startOfWeekMonday(dateObj){
    const d = new Date(dateObj.getTime());
    d.setHours(0,0,0,0);
    const day = d.getDay(); // 0 dom
    const diff = (day === 0) ? -6 : (1 - day);
    d.setDate(d.getDate() + diff);
    return d;
  }
  function addDays(d, n){ const x = new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
  function lastDayOfMonth(y,m){ return new Date(y, m, 0).getDate(); } // m = 1..12

  // ===== SCHEMA FLEXÍVEL (para não quebrar com coluna diferente) =====
  function pickCol(obj, candidates){
    for (const c of candidates){
      if (obj && Object.prototype.hasOwnProperty.call(obj, c)) return c;
    }
    return null;
  }

  function getSignedValue(row){
    // 1) se existir "valor" (padrão): + receita / - despesa
    if (row && row.valor !== undefined && row.valor !== null && row.valor !== "") return Number(row.valor);

    // 2) se existir receita/despesa separado
    const rec = Number(row && (row.receita ?? row.entrada ?? 0)) || 0;
    const desp= Number(row && (row.despesa ?? row.saida ?? 0)) || 0;
    // despesa pode estar positiva no banco -> vira negativa aqui
    return rec - Math.abs(desp);
  }

  function isMensalidade(row){
    const d = String(row?.descricao || "").toUpperCase();
    const o = String(row?.origem || "").toUpperCase();
    return d.startsWith("MENSALIDADE -") || o === "MENSALIDADE";
  }

  // ===== PERÍODOS =====
  function buildMesOptions(){
    const meses = [
      "01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN",
      "07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"
    ];
    selMes.innerHTML = "";
    meses.forEach((t,i)=>{
      const opt = document.createElement("option");
      opt.value = String(i+1);
      opt.textContent = t;
      selMes.appendChild(opt);
    });
  }

  function buildAnoOptions(){
    const hoje = new Date();
    const a = hoje.getFullYear();
    selAno.innerHTML = "";
    for (let y=a-1;y<=a+1;y++){
      const opt=document.createElement("option");
      opt.value=String(y);
      opt.textContent=String(y);
      if (y===a) opt.selected=true;
      selAno.appendChild(opt);
    }
  }

  function buildSemanaOptions(){
    // últimas 10 semanas (segunda a segunda)
    selSemana.innerHTML = "";
    const hoje = new Date();
    const base = startOfWeekMonday(hoje);
    for (let i=0;i<10;i++){
      const ini = addDays(base, -7*i);
      const fim = addDays(ini, 7);
      const opt = document.createElement("option");
      opt.value = `${isoDate(ini)}|${isoDate(fim)}`;
      opt.textContent = `${ini.toLocaleDateString("pt-BR")} → ${fim.toLocaleDateString("pt-BR")}`;
      if (i===0) opt.selected = true;
      selSemana.appendChild(opt);
    }
  }

  function getRange(){
    const ano = Number(selAno.value);
    const mes = Number(selMes.value);
    const periodo = String(selPeriodo.value);

    if (periodo === "ANUAL"){
      return {ini:`${ano}-01-01`, fim:`${ano}-12-31`};
    }
    if (periodo === "MENSAL"){
      const last = lastDayOfMonth(ano, mes);
      return {ini:`${ano}-${pad2(mes)}-01`, fim:`${ano}-${pad2(mes)}-${pad2(last)}`};
    }
    // SEMANAL
    const v = String(selSemana.value || "");
    const [ini,fim] = v.split("|");
    return {ini, fim}; // fim é segunda da próxima semana
  }

  function updateUIByPeriodo(){
    const p = String(selPeriodo.value);
    wrapSemana.style.display = (p==="SEMANAL") ? "" : "none";
  }

  // ===== CRUD =====
  async function fetchAllWithin(ini, fim){
    // Esquema esperado: coluna "data" (YYYY-MM-DD)
    let q = sb.from("caixa").select("*").gte("data", ini).lte("data", fim).order("data", {ascending:true});
    let { data, error } = await q;
    if (!error){
      return { rows: (data||[]), dateCol: "data", createdCol: null };
    }

    // Fallback: por created_at (timestamp)
    q = sb.from("caixa").select("*").gte("created_at", ini + "T00:00:00").lte("created_at", fim + "T23:59:59").order("created_at", {ascending:true});
    ({ data, error } = await q);
    if (!error){
      return { rows: (data||[]), dateCol: null, createdCol: "created_at" };
    }

    console.warn("Aviso: não consegui ler caixa.", error);
    return { rows: [], dateCol: null, createdCol: null };
  }

  (dateCol, createdCol, ini){
    // soma lançamentos ANTES do início do período (para saldo anterior)
    const targetDate = ini;

    // tenta por data
    let q = sb.from("caixa").select("*").lt("data", targetDate);
    let { data, error } = await q;
    if (!error){
      let total = 0;
      (data || []).forEach(r => total += getSignedValue(r));
      return total;
    }

    // fallback created_at
    q = sb.from("caixa").select("*").lt("created_at", targetDate + "T00:00:00");
    ({ data, error } = await q);
    if (!error){
      let total = 0;
      (data || []).forEach(r => total += getSignedValue(r));
      return total;
    }

    return 0;
  }

    // fallback created_at
    q = sb.from("caixa").select("*").lt("created_at", targetDate + "T00:00:00");
    ({ data, error } = await q);
    if (!error){
      let total = 0;
      (data || []).forEach(r => total += getSignedValue(r));
      return total;
    }

    return 0;
  }


  

  async function sumBefore(ini){
    // soma lançamentos ANTES do início do período (para saldo anterior)
    const targetDate = ini;

    // tenta por "data"
    let q = sb.from("caixa").select("*").lt("data", targetDate);
    let { data, error } = await q;
    if (!error){
      let total = 0;
      (data || []).forEach(r => total += getSignedValue(r));
      return total;
    }

    // fallback "created_at"
    q = sb.from("caixa").select("*").lt("created_at", targetDate + "T00:00:00");
    ({ data, error } = await q);
    if (!error){
      let total = 0;
      (data || []).forEach(r => total += getSignedValue(r));
      return total;
    }

    return 0;
  }

