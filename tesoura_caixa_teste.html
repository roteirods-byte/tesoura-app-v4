<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CAIXA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    header{padding:14px 18px;border-bottom:2px solid #f97316;display:flex;align-items:center;justify-content:space-between;background:#07101f}
    header h1{margin:0;font-size:16px;letter-spacing:.5px;color:#f97316;text-transform:uppercase;font-weight:900}
    .wrap{max-width:1400px;margin:18px auto;padding:0 12px}
    .painel{background:#020617;border:1px solid #0f172a;border-radius:12px;padding:12px;margin-bottom:14px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .painel h2{margin:0 0 10px;color:#f97316;font-size:14px;letter-spacing:.5px;text-transform:uppercase;font-weight:900}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:900;text-transform:uppercase;color:#cbd5e1}
    select,input{border-radius:10px;border:1px solid #0f172a;padding:10px 12px;font-weight:900;text-transform:uppercase;font-size:12px;background:#0b1220;color:#fff;outline:none}
    input[type="text"]{text-transform:none;font-weight:800}
    input[type="number"]{text-transform:none;font-weight:900;width:140px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:900;text-transform:uppercase;font-size:12px;cursor:pointer}
    .btn-azul{background:#38bdf8;color:#031019}
    .btn-laranja{background:#f97316;color:#111827}
    .btn-vermelho{background:#ef4444;color:#111827}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .status{margin-top:8px;font-size:12px;color:#9ca3af}

    /* SEM BARRA DE ROLAGEM INTERNA */
    .table-wrap{overflow:visible;max-height:none;border-radius:12px;border:1px solid #0f172a}

    table{border-collapse:collapse;font-size:12px;width:100%;table-layout:fixed}
    thead th{
      position:sticky;top:0;background:#f97316;color:#fff;z-index:2;
      border:1px solid rgba(255,255,255,.45);padding:8px 8px;text-align:center;white-space:nowrap;
      font-weight:900;text-transform:uppercase
    }
    tbody td{
      border:1px solid rgba(255,255,255,.20);padding:6px 8px;text-align:center;white-space:nowrap;
      background:#020617
    }
    tbody tr:nth-child(even) td{background:#061024}
    td.left{text-align:left}
    .money{font-weight:900}
    .pos{color:#22c55e}
    .neg{color:#ef4444}
    .saldo{font-weight:900}

    /* Larguras (sem coluna TIPO) */
    th.col-data, td.col-data{width:110px}
    th.col-desc, td.col-desc{width:420px}
    th.col-obs,  td.col-obs{width:170px}
    th.col-rec,  td.col-rec{width:130px}
    th.col-desp, td.col-desp{width:130px}
    th.col-saldo,td.col-saldo{width:140px}
    th.col-acoes,td.col-acoes{width:120px}

    td.col-desc, td.col-obs{white-space:normal}
    td.col-desc input, td.col-obs input{width:100% !important; box-sizing:border-box}

    @media print{
      header,#painelFiltro,.no-print{display:none !important}
      body{background:#fff;color:#000}
      .wrap{max-width:none;margin:0;padding:0}
      .painel{box-shadow:none;border:0}
      thead th{position:static !important}
    }
  </style>
</head>
<body>
<header>
  <h1>TESOURA - CAIXA</h1>
  <div style="font-size:12px;color:#9ca3af;">(auto-save)</div>
</header>

<div class="wrap">
  <div class="painel" id="painelFiltro">
    <h2>FILTRO</h2>

    <div class="row" style="justify-content:space-between;width:100%;">
      <div class="row">
        <div class="row">
          <label>ANO:</label>
          <select id="selAno"></select>
        </div>

        <div class="row">
          <label>MÊS:</label>
          <select id="selMes"></select>
        </div>

        <div class="row">
          <label>PERÍODO:</label>
          <select id="selPeriodo">
            <option value="SEMANAL">SEMANAL</option>
            <option value="MENSAL">MENSAL</option>
            <option value="ANUAL">ANUAL</option>
          </select>
        </div>

        <div class="row" id="wrapSemana">
          <label>SEMANA:</label>
          <select id="selSemana"></select>
        </div>
      </div>

      <div class="row">
        <button id="btnConsultar" class="btn btn-azul no-print">CONSULTAR</button>
        <button id="btnPdf" class="btn btn-laranja no-print">BAIXAR PDF</button>
      </div>
    </div>

    <div class="status" id="status">Carregando…</div>

    <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap;">
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO ANTERIOR:</b> <span id="saldoAnterior">R$ 0,00</span></div>
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO NO PERÍODO:</b> <span id="saldoPeriodo">R$ 0,00</span></div>
      <div style="font-size:12px;color:#cbd5e1;"><b>SALDO FINAL:</b> <span id="saldoFinal">R$ 0,00</span></div>
    </div>
  </div>

  <div class="painel">
    <h2>LANÇAMENTOS</h2>

    <div class="row no-print" style="margin-bottom:10px;gap:8px;">
      <input id="inData" type="date" />
      <select id="inTipo">
        <option value="RECEITA">RECEITA</option>
        <option value="DESPESA">DESPESA</option>
      </select>
      <input id="inDesc" type="text" placeholder="DESCRIÇÃO" style="width:320px;" />
      <input id="inObs" type="text" placeholder="OBS" style="width:170px;" />
      <input id="inValor" type="number" step="0.01" placeholder="VALOR (R$)" />
      <button id="btnAdd" class="btn btn-azul">SALVAR</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="col-data">DATA</th>
            <th class="col-desc">DESCRIÇÃO</th>
            <th class="col-obs">OBS</th>
            <th class="col-rec">RECEITA (R$)</th>
            <th class="col-desp">DESPESA (R$)</th>
            <th class="col-saldo">SALDO (R$)</th>
            <th class="no-print col-acoes">AÇÕES</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="status" id="status2"></div>
  </div>
</div>

<script src="app/core/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
(function(){
  // ========= SAFE START =========
  const statusEl = document.getElementById("status");
  const status2  = document.getElementById("status2");

  function failUI(msg, err){
    statusEl.textContent = msg;
    status2.textContent = msg;
    if (err) console.error(err);
  }

  // DOM refs
  const selAno = document.getElementById("selAno");
  const selMes = document.getElementById("selMes");
  const selPeriodo = document.getElementById("selPeriodo");
  const wrapSemana = document.getElementById("wrapSemana");
  const selSemana = document.getElementById("selSemana");
  const btnConsultar = document.getElementById("btnConsultar");
  const btnPdf = document.getElementById("btnPdf");

  const tbody = document.getElementById("tbody");
  const saldoAnteriorEl = document.getElementById("saldoAnterior");
  const saldoPeriodoEl  = document.getElementById("saldoPeriodo");
  const saldoFinalEl    = document.getElementById("saldoFinal");

  const inData = document.getElementById("inData");
  const inTipo = document.getElementById("inTipo");
  const inDesc = document.getElementById("inDesc");
  const inObs  = document.getElementById("inObs");
  const inValor= document.getElementById("inValor");
  const btnAdd = document.getElementById("btnAdd");

  // helpers
  const pad2 = n => String(n).padStart(2,"0");
  const money = (v) => Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  function toBR(iso){
    if (!iso) return "";
    const s = String(iso).slice(0,10);
    const y=s.slice(0,4), m=s.slice(5,7), d=s.slice(8,10);
    return (y && m && d) ? `${d}/${m}/${y}` : s;
  }

  function startOfWeekMonday(dateObj){
    const d = new Date(dateObj.getTime());
    d.setHours(0,0,0,0);
    const day = d.getDay();
    const diff = (day === 0) ? -6 : (1 - day);
    d.setDate(d.getDate() + diff);
    return d;
  }
  function addDays(d, n){ const x = new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
  function lastDayOfMonth(y,m){ return new Date(y, m, 0).getDate(); }

  // regra: ocultar “mensalidade / R$70”
  function isMensalidadeRow(r){
    const desc = String(r?.descricao || "").toUpperCase();
    const obs  = String(r?.obs || "").toUpperCase();
    const v = Number(r?.valor || 0);
    if (Math.abs(v) === 70) return true;
    if (desc.includes("MENSALIDADE")) return true;
    if (obs.includes("MENSALIDADE")) return true;
    return false;
  }

  // filtros
  function buildAnoOptions(){
    const now = new Date();
    const y = now.getFullYear();
    selAno.innerHTML = "";
    for (let a = y-1; a <= y+1; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if (a === y) opt.selected = true;
      selAno.appendChild(opt);
    }
  }
  function buildMesOptions(){
    const meses = ["01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN","07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"];
    selMes.innerHTML = "";
    meses.forEach((m, idx)=>{
      const opt = document.createElement("option");
      opt.value = idx+1;
      opt.textContent = m;
      selMes.appendChild(opt);
    });
  }
  function buildSemanaOptions(){
    selSemana.innerHTML = "";
    const ano = Number(selAno.value) || (new Date()).getFullYear();
    const start = startOfWeekMonday(new Date(ano,0,1));
    const end = new Date(ano,11,31);
    let cur = new Date(start.getTime());
    while (cur <= end){
      const ini = new Date(cur.getTime());
      const fim = addDays(ini, 7);
      const label = `${ini.toLocaleDateString("pt-BR")} → ${addDays(fim,-1).toLocaleDateString("pt-BR")}`;
      const opt = document.createElement("option");
      opt.value = `${ini.toISOString().slice(0,10)}|${fim.toISOString().slice(0,10)}`;
      opt.textContent = label;
      selSemana.appendChild(opt);
      cur = fim;
    }
  }
  function updateUIByPeriodo(){
    wrapSemana.style.display = (String(selPeriodo.value)==="SEMANAL") ? "" : "none";
  }
  function getRange(){
    const ano = Number(selAno.value);
    const mes = Number(selMes.value);
    const p = String(selPeriodo.value);

    if (p === "ANUAL") return { ini: `${ano}-01-01`, fim: `${ano+1}-01-01` };

    if (p === "MENSAL"){
      const ini = `${ano}-${pad2(mes)}-01`;
      const ld = lastDayOfMonth(ano, mes);
      const fim = `${ano}-${pad2(mes)}-${pad2(ld)}`;
      const fimPlus = addDays(new Date(fim+"T00:00:00"), 1).toISOString().slice(0,10);
      return { ini, fim: fimPlus };
    }

    const v = String(selSemana.value || "");
    const parts = v.split("|");
    const ini = parts[0] || `${ano}-${pad2(mes)}-01`;
    const fim = parts[1] || addDays(new Date(ini+"T00:00:00"),7).toISOString().slice(0,10);
    return { ini, fim };
  }

  // PDF (simples: imprime tela)
  function baixarPDF(){ window.print(); }

  // ===== Supabase client (com proteção) =====
  const SUPABASE_URL = (window.TESOURA_CONFIG && TESOURA_CONFIG.SUPABASE_URL) ? TESOURA_CONFIG.SUPABASE_URL : "https://xuplzpispukvtggjasxx.supabase.co";
  const SUPABASE_ANON_KEY = (window.TESOURA_CONFIG && TESOURA_CONFIG.SUPABASE_ANON_KEY) ? TESOURA_CONFIG.SUPABASE_ANON_KEY : "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";

  let supa = null;
  try{
    if (!window.supabase || !window.supabase.createClient) throw new Error("Supabase JS não carregou (CDN).");
    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }catch(e){
    supa = null;
    failUI("ERRO: Supabase não carregou. Atualize (Ctrl+F5).", e);
  }

  // ===== DB =====
  async function fetchWithin(ini, fim){
    const { data, error } = await supa.from("caixa").select("*").gte("data", ini).lt("data", fim).order("data", {ascending:true});
    if (error) throw error;
    return data || [];
  }
  async function sumBefore(ini){
    const ano = String(ini).slice(0,4);
    const iniAno = `${ano}-01-01`;
    const { data, error } = await supa.from("caixa").select("*").gte("data", iniAno).lt("data", ini).order("data", {ascending:true});
    if (error) throw error;

    let total = 0;
    (data || []).forEach(r=>{
      const tipo = String(r.tipo || "").toUpperCase();
      const v = Number(r.valor || 0);
      total += (tipo === "DESPESA") ? -Math.abs(v) : Math.abs(v);
    });
    return total;
  }

  function render(rows){
    tbody.innerHTML = "";
    let saldo = window.__saldoAnterior || 0;
    let saldoPeriodo = 0;

    rows.forEach((r)=>{
      const tr = document.createElement("tr");

      const tipo = String(r.tipo || "").toUpperCase();
      const v = Number(r.valor || 0);
      const signed = (tipo === "DESPESA") ? -Math.abs(v) : Math.abs(v);

      const receita = (tipo === "RECEITA") ? Math.abs(v) : 0;
      const despesa = (tipo === "DESPESA") ? Math.abs(v) : 0;

      saldo += signed;
      saldoPeriodo += signed;

      const tdData = document.createElement("td");
      tdData.className = "col-data";
      tdData.textContent = toBR(r.data);

      const tdDesc = document.createElement("td");
      tdDesc.className = "left col-desc";
      const inD = document.createElement("input");
      inD.type = "text";
      inD.value = String(r.descricao || "");
      tdDesc.appendChild(inD);

      const tdObs = document.createElement("td");
      tdObs.className = "left col-obs";
      const inO = document.createElement("input");
      inO.type = "text";
      inO.value = String(r.obs || "");
      tdObs.appendChild(inO);

      const tdR = document.createElement("td");
      tdR.className = "col-rec";
      tdR.innerHTML = receita ? `<span class="money pos">${money(receita)}</span>` : "";

      const tdE = document.createElement("td");
      tdE.className = "col-desp";
      tdE.innerHTML = despesa ? `<span class="money neg">${money(despesa)}</span>` : "";

      const tdS = document.createElement("td");
      tdS.className = "col-saldo";
      tdS.innerHTML = `<span class="saldo">${money(saldo)}</span>`;

      const tdA = document.createElement("td");
      tdA.className = "no-print col-acoes";

      const btnEditar = document.createElement("button");
      btnEditar.className = "btn btn-azul";
      btnEditar.textContent = "EDITAR";

      const btnExcluir = document.createElement("button");
      btnExcluir.className = "btn btn-vermelho";
      btnExcluir.textContent = "EXCLUIR";
      btnExcluir.style.marginLeft = "6px";

      btnEditar.addEventListener("click", async ()=>{
        try{
          btnEditar.disabled = true;
          status2.textContent = "";

          const novaDesc = (inD.value || "").toUpperCase();
          const novaObs  = (inO.value || "").toUpperCase();

          const { error } = await supa.from("caixa").update({ descricao: novaDesc, obs: novaObs }).eq("id", r.id);
          if (error) throw error;

          status2.textContent = "Editado.";
          setTimeout(()=>{ if(status2.textContent==="Editado.") status2.textContent=""; }, 800);
        }catch(e){
          failUI("ERRO ao editar (ver console).", e);
          alert("ERRO ao editar (ver console).");
        }finally{
          btnEditar.disabled = false;
        }
      });

      btnExcluir.addEventListener("click", async ()=>{
        if (!confirm("Excluir este lançamento?")) return;
        try{
          const { error } = await supa.from("caixa").delete().eq("id", r.id);
          if (error) throw error;
          carregar();
        }catch(e){
          failUI("ERRO ao excluir (ver console).", e);
          alert("ERRO ao excluir (ver console).");
        }
      });

      tdA.appendChild(btnEditar);
      tdA.appendChild(btnExcluir);

      tr.appendChild(tdData);
      tr.appendChild(tdDesc);
      tr.appendChild(tdObs);
      tr.appendChild(tdR);
      tr.appendChild(tdE);
      tr.appendChild(tdS);
      tr.appendChild(tdA);

      tbody.appendChild(tr);
    });

    saldoPeriodoEl.textContent = money(saldoPeriodo);
    saldoFinalEl.textContent = money(saldo);
  }

  async function addLancamento(){
    if (!supa){
      alert("Supabase não carregou. Faça Ctrl+F5.");
      return;
    }
    try{
      btnAdd.disabled = true;
      status2.textContent = "";

      const data = inData.value;
      const tipo = String(inTipo.value || "RECEITA").toUpperCase();
      const desc = String(inDesc.value || "").trim();
      const obs  = String(inObs.value || "").trim();
      const valor = Number(inValor.value || 0);

      if (!data || !desc || !valor){
        alert("Preencha: DATA, DESCRIÇÃO e VALOR.");
        return;
      }

      // bloqueio mensalidade/70 (não existe)
      const descUp = desc.toUpperCase();
      if (descUp.includes("MENSALIDADE") || Math.abs(valor) === 70){
        alert("Mensalidade / R$ 70 não existe aqui. Lançamento bloqueado.");
        return;
      }

      const payload = {
        data,
        tipo,
        descricao: desc.toUpperCase(),
        valor: Math.abs(valor),
        obs: obs.toUpperCase()
      };

      const { error } = await supa.from("caixa").insert(payload);
      if (error) throw error;

      inDesc.value = "";
      inObs.value = "";
      inValor.value = "";
      carregar();
    }catch(e){
      failUI("ERRO ao criar (ver console).", e);
      alert("ERRO ao criar (ver console).");
    }finally{
      btnAdd.disabled = false;
    }
  }

  async function carregar(){
    if (!supa){
      statusEl.textContent = "ERRO: Supabase não carregou. Ctrl+F5.";
      return;
    }
    try{
      statusEl.textContent = "Carregando...";
      status2.textContent = "";
      tbody.innerHTML = "";

      updateUIByPeriodo();
      const {ini, fim} = getRange();

      let saldoAnt = 0;
      try{ saldoAnt = await sumBefore(ini); }catch(e){ saldoAnt = 0; console.warn(e); }
      window.__saldoAnterior = saldoAnt;
      saldoAnteriorEl.textContent = money(saldoAnt);

      let rows = await fetchWithin(ini, fim);
      rows = rows.filter(r => !isMensalidadeRow(r)); // remove “mensalidade/70”

      render(rows);

      statusEl.textContent = `LISTA CARREGADA. Registros: ${rows.length}` + (rows.length===0 ? " (painel vazio)" : "");
    }catch(e){
      failUI("ERRO ao buscar CAIXA (ver console).", e);
      alert("ERRO ao buscar CAIXA (ver console).");
    }
  }

  // ===== INIT (garantido) =====
  function init(){
    try{
      buildAnoOptions();
      buildMesOptions();
      buildSemanaOptions();
      updateUIByPeriodo();

      const now = new Date();
      inData.value = now.toISOString().slice(0,10);
      selMes.value = String(now.getMonth()+1);

      btnPdf.addEventListener("click", baixarPDF);
      btnConsultar.addEventListener("click", carregar);
      btnAdd.addEventListener("click", addLancamento);

      selPeriodo.addEventListener("change", ()=>{ updateUIByPeriodo(); });
      selAno.addEventListener("change", ()=>{ buildSemanaOptions(); });

      statusEl.textContent = "Pronto.";
      carregar();
    }catch(e){
      failUI("ERRO no painel (ver console).", e);
      alert("ERRO no painel (ver console).");
    }
  }

  window.addEventListener("load", init);
})();
</script>
</body>
</html>
