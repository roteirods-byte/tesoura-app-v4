<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesoura - CAIXA</title>

  <!-- Anti-cache leve (não mexe em service-worker) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#061a3a;
      --card:#081f45;
      --line:#123a70;
      --text:#ffffff;
      --muted:#b9c7e6;
      --orange:#ff8a2a;
      --green:#34d399;
      --red:#fb7185;
      --blueBtn:#2b76ff;
      --blueBtn2:#1f5fe0;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    body{
      margin:0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin: 10px 0 14px;
    }
    .title h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.5px;
      color: var(--orange);
    }
    .subtitle{
      margin: 3px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 12px;
      align-items:end;
      justify-content:space-between;
    }

    .left, .right{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:end;
    }

    label{
      display:block;
      font-size: 11px;
      color: var(--muted);
      margin: 0 0 6px;
      letter-spacing:.4px;
    }

    select, input{
      background: var(--card);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      min-width: 140px;
    }

    button{
      cursor:pointer;
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight:700;
      font-size: 13px;
      color: #fff;
      background: var(--blueBtn);
      box-shadow: 0 8px 18px rgba(43,118,255,.25);
      transition: .15s;
    }
    button:hover{ background: var(--blueBtn2); transform: translateY(-1px); }
    button:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
    }

    .warn{
      background: rgba(251,113,133,.10);
      border: 1px solid rgba(251,113,133,.25);
      padding: 10px 12px;
      border-radius: 14px;
      color: #ffd1d9;
      font-size: 13px;
      margin-top: 10px;
      line-height: 1.35;
    }
    .ok{
      background: rgba(52,211,153,.10);
      border: 1px solid rgba(52,211,153,.25);
      padding: 10px 12px;
      border-radius: 14px;
      color: #d7fff1;
      font-size: 13px;
      margin-top: 10px;
      line-height: 1.35;
    }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 14px;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      padding: 12px;
      color: var(--orange);
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.10);
      letter-spacing:.3px;
    }
    tbody td{
      padding: 11px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 14px;
      color: #fff;
      vertical-align: top;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.03);
    }

    .mono{ font-family: var(--mono); font-size: 13px; color: #e7efff; }
    .muted{ color: var(--muted); font-size: 12px; }
    .pos{ color: var(--green); font-weight: 800; }
    .neg{ color: var(--red); font-weight: 800; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn-mini{
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
      background: rgba(255,255,255,.08);
      box-shadow:none;
      border: 1px solid rgba(255,255,255,.10);
    }
    .btn-mini:hover{ background: rgba(255,255,255,.12); transform:none; }
    .btn-mini.danger{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.12); }
    .btn-mini.danger:hover{ background: rgba(251,113,133,.18); }

    .footerline{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 14px;
      justify-content: space-between;
      align-items:center;
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }
  </style>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>CAIXA</h1>
        <div class="subtitle">Tela fixa no mês corrente (dia 1 → dia 1 do próximo mês). Filtro abaixo só serve para BAIXAR PDF.</div>
      </div>
      <div class="pill" id="pillPeriod">Carregando…</div>
    </div>

    <div class="grid">
      <!-- Filtro PDF (não muda a tela) -->
      <div class="card">
        <div class="row">
          <div class="left">
            <div>
              <label>ANO (PDF)</label>
              <select id="pdfYear"></select>
            </div>

            <div>
              <label>MÊS (PDF)</label>
              <select id="pdfMonth"></select>
            </div>

            <div>
              <button id="btnPdf">BAIXAR PDF</button>
            </div>
          </div>

          <div class="right">
            <div class="pill" id="pillStatus">Inicializando…</div>
          </div>
        </div>

        <div id="msgArea"></div>
      </div>

      <!-- Tabela do mês corrente -->
      <div class="card">
        <div class="row" style="align-items:center;">
          <div class="left">
            <div class="pill" id="pillNow">Mês corrente: …</div>
            <div class="pill" id="pillCount">0 lançamentos</div>
          </div>
          <div class="right">
            <button id="btnReload" class="btn-mini">ATUALIZAR</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:120px;">DATA</th>
              <th>DESCRIÇÃO</th>
              <th style="width:120px;">TIPO</th>
              <th style="width:140px;">VALOR</th>
              <th style="width:140px;">SALDO</th>
              <th style="width:140px;">AÇÕES</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted">Carregando…</td></tr>
          </tbody>
        </table>

        <div class="footerline">
          <div id="totals" class="mono">Receitas: R$ 0,00 • Despesas: R$ 0,00 • Saldo: R$ 0,00</div>
          <div class="muted" id="lastUpdate">—</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    /******************************************************************
     * CONFIG (mantém compatível com o resto do app, sem mexer nos outros painéis)
     ******************************************************************/
    const TABLE_CAIXA = "caixa";

    // Tentativas de coluna de data (a query vai tentar nesta ordem)
    const DATE_COL_TRIES = ["data", "created_at", "data_hora", "timestamp"];

    // Campos comuns (se existirem)
    const COL_DESCR_TRIES = ["descricao", "descrição", "descricao_texto", "texto", "obs", "observacao"];
    const COL_TIPO_TRIES  = ["tipo", "categoria"];
    const COL_VALOR_TRIES = ["valor", "amount", "quantia"];

    // Regra de bloqueio de mensalidade: tenta detectar por campos OU texto
    const MENSALIDADE_TEXT_PREFIX = "MENSALIDADE - ";

    /******************************************************************
     * HELPERS
     ******************************************************************/
    const el = (id) => document.getElementById(id);

    function pad2(n){ return String(n).padStart(2, "0"); }

    function brl(v){
      const num = Number(v || 0);
      return num.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function fmtDateBR(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      if (isNaN(dt.getTime())) return "-";
      return `${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}/${dt.getFullYear()}`;
    }

    function monthNamePT(mIndex){
      const names = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      return names[mIndex] || "-";
    }

    // Mês corrente (dia 1 → dia 1 do próximo)
    function getCurrentMonthRange(){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
      const end   = new Date(now.getFullYear(), now.getMonth()+1, 1, 0, 0, 0, 0);
      return { now, start, end };
    }

    function getMonthRange(year, monthIndex){
      const start = new Date(year, monthIndex, 1, 0, 0, 0, 0);
      const end   = new Date(year, monthIndex+1, 1, 0, 0, 0, 0);
      return { start, end };
    }

    function setMsg(type, text){
      const area = el("msgArea");
      if(!text){
        area.innerHTML = "";
        return;
      }
      const cls = (type === "ok") ? "ok" : "warn";
      area.innerHTML = `<div class="${cls}">${text}</div>`;
    }

    function findFirstKey(obj, keys){
      for(const k of keys){
        if(obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return k;
      }
      return null;
    }

    function guessLocked(row){
      // 1) campos típicos
      if (row && (row.mensalidade_id || row.mensalidadeId || row.id_mensalidade)) return true;
      if (row && (row.locked === true || row.bloqueado === true)) return true;
      // 2) origem/tipo_registro
      const origemKey = findFirstKey(row, ["origem","source","fonte","tipo_registro"]);
      if (origemKey && String(row[origemKey]).toUpperCase().includes("MENSAL")) return true;
      // 3) texto padrão
      const descrKey = findFirstKey(row, COL_DESCR_TRIES);
      if (descrKey && String(row[descrKey]).toUpperCase().startsWith(MENSALIDADE_TEXT_PREFIX)) return true;
      return false;
    }

    function getSupabaseCreds(){
      // 1) globais diretos
      if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
        return { url: window.SUPABASE_URL, key: window.SUPABASE_ANON_KEY };
      }
      // 2) globais alternativos
      if (window.__SUPABASE_URL__ && window.__SUPABASE_ANON_KEY__) {
        return { url: window.__SUPABASE_URL__, key: window.__SUPABASE_ANON_KEY__ };
      }
      // 3) localStorage
      try{
        const url = localStorage.getItem("SUPABASE_URL");
        const key = localStorage.getItem("SUPABASE_ANON_KEY");
        if (url && key) return { url, key };
      }catch(e){}
      return null;
    }

    function isoLocal(d){
      // ISO sem depender de timezone externo (usa horário local)
      // Para filtro por timestamp no Supabase, ISO padrão funciona bem.
      return new Date(d).toISOString();
    }

    /******************************************************************
     * SUPABASE INIT
     ******************************************************************/
    let supabase = null;

    function initSupabase(){
      const creds = getSupabaseCreds();
      if(!creds){
        el("pillStatus").textContent = "Supabase não encontrado";
        setMsg("warn",
          "Não achei as credenciais do Supabase neste painel. " +
          "Se os outros painéis funcionam, me envie o início do arquivo do painel JOGADORES (onde cria o Supabase) que eu adapto aqui sem você editar nada."
        );
        return false;
      }
      supabase = window.supabase.createClient(creds.url, creds.key);
      el("pillStatus").textContent = "Conectado";
      return true;
    }

    /******************************************************************
     * DATA LOADING (mês corrente fixo)
     ******************************************************************/
    async function fetchCaixaByRange(startDate, endDate){
      if(!supabase) throw new Error("Supabase não inicializado.");

      // tenta query com diferentes colunas de data, para não depender do que foi usado no passado
      let lastErr = null;

      for(const dateCol of DATE_COL_TRIES){
        try{
          const { data, error } = await supabase
            .from(TABLE_CAIXA)
            .select("*")
            .gte(dateCol, isoLocal(startDate))
            .lt(dateCol, isoLocal(endDate))
            .order(dateCol, { ascending: true }); // asc para calcular saldo correto

          if(error) throw error;

          // marca qual coluna foi usada (útil para debug)
          return { rows: Array.isArray(data) ? data : [], usedDateCol: dateCol };
        }catch(err){
          lastErr = err;
        }
      }

      throw lastErr || new Error("Não foi possível consultar o CAIXA.");
    }

    function calcAndRender(rows, usedDateCol){
      // Descobre campos por amostra
      const sample = rows[0] || {};
      const descrKey = findFirstKey(sample, COL_DESCR_TRIES) || "descricao";
      const tipoKey  = findFirstKey(sample, COL_TIPO_TRIES)  || "tipo";
      const valorKey = findFirstKey(sample, COL_VALOR_TRIES) || "valor";

      // Calcula saldo acumulado (em ordem ascendente)
      let saldo = 0;
      let totalReceita = 0;
      let totalDespesa = 0;

      const computed = rows.map(r => {
        const tipoRaw = (r[tipoKey] ?? "").toString().trim();
        const tipoUp  = tipoRaw.toUpperCase();

        let valor = Number(r[valorKey] ?? 0);

        // Normalização simples:
        // - Se for "DESPESA" e vier positivo, transforma em negativo na conta
        // - Se for "RECEITA" e vier negativo, transforma em positivo na conta
        let delta = valor;
        if (tipoUp.includes("DESP") && delta > 0) delta = -delta;
        if (tipoUp.includes("RECE") && delta < 0) delta = Math.abs(delta);

        saldo += delta;

        if (delta >= 0) totalReceita += delta;
        else totalDespesa += Math.abs(delta);

        return {
          raw: r,
          date: r[usedDateCol] || r.data || r.created_at,
          descr: r[descrKey] ?? "",
          tipo: tipoRaw || "-",
          delta,
          saldo
        };
      });

      // Para exibir “últimos movimentos”, mostramos desc, mas mantendo saldo calculado certo
      const toShow = computed.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));

      // Render
      const tbody = el("tbody");
      if(!toShow.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Sem lançamentos neste mês.</td></tr>`;
      }else{
        tbody.innerHTML = toShow.map(item => {
          const locked = guessLocked(item.raw);
          const deltaClass = item.delta >= 0 ? "pos" : "neg";
          const tipoUp = String(item.tipo).toUpperCase();
          const tipoLabel = tipoUp.includes("DESP") ? "DESPESA" : (tipoUp.includes("RECE") ? "RECEITA" : item.tipo);

          return `
            <tr>
              <td class="mono">${fmtDateBR(item.date)}</td>
              <td>${String(item.descr || "").replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>
              <td class="mono">${tipoLabel}</td>
              <td class="${deltaClass} mono">${brl(item.delta)}</td>
              <td class="mono">${brl(item.saldo)}</td>
              <td>
                <div class="actions">
                  ${locked
                    ? `<span class="muted">Bloqueado</span>`
                    : `<button class="btn-mini danger" data-del="${item.raw.id ?? ""}">Excluir</button>`
                  }
                </div>
              </td>
            </tr>
          `;
        }).join("");

        // bind excluir (somente manual)
        tbody.querySelectorAll("button[data-del]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-del");
            if(!id) return;
            const ok = confirm("Excluir este lançamento do CAIXA?");
            if(!ok) return;

            try{
              el("pillStatus").textContent = "Excluindo…";
              const { error } = await supabase.from(TABLE_CAIXA).delete().eq("id", id);
              if(error) throw error;
              el("pillStatus").textContent = "Conectado";
              await loadCurrentMonth(); // recarrega mês corrente
            }catch(e){
              el("pillStatus").textContent = "Erro";
              setMsg("warn", "Falha ao excluir. Se este lançamento veio do Mensalidade, ele é bloqueado. Detalhe: " + (e?.message || e));
            }
          });
        });
      }

      el("pillCount").textContent = `${toShow.length} lançamentos`;
      el("totals").textContent = `Receitas: ${brl(totalReceita)} • Despesas: ${brl(totalDespesa)} • Saldo: ${brl(totalReceita - totalDespesa)}`;
      el("lastUpdate").textContent = `Atualizado: ${new Date().toLocaleString("pt-BR")}`;
    }

    async function loadCurrentMonth(){
      setMsg("", "");
      const { now, start, end } = getCurrentMonthRange();

      el("pillPeriod").textContent = `Mês corrente: ${monthNamePT(now.getMonth())}/${now.getFullYear()}`;
      el("pillNow").textContent = `Visualizando: ${monthNamePT(now.getMonth())}/${now.getFullYear()} (1 → 1)`;

      el("tbody").innerHTML = `<tr><td colspan="6" class="muted">Carregando…</td></tr>`;

      try{
        el("pillStatus").textContent = "Carregando…";
        const res = await fetchCaixaByRange(start, end);
        el("pillStatus").textContent = "Conectado";
        calcAndRender(res.rows, res.usedDateCol);
      }catch(e){
        el("pillStatus").textContent = "Erro";
        el("tbody").innerHTML = `<tr><td colspan="6" class="muted">Erro ao carregar.</td></tr>`;
        setMsg("warn",
          "Não consegui carregar os lançamentos do CAIXA. " +
          "Me envie um print do console (F12 → Console) e o nome das colunas da tabela CAIXA no Supabase. " +
          "Detalhe: " + (e?.message || e)
        );
      }
    }

    /******************************************************************
     * PDF (ano/mês selecionado) — NÃO MUDA A TELA
     ******************************************************************/
    function fillPdfSelectors(){
      const y = el("pdfYear");
      const m = el("pdfMonth");

      const now = new Date();
      const curYear = now.getFullYear();
      const curMonth = now.getMonth();

      // anos: curYear-3 até curYear+1
      y.innerHTML = "";
      for(let year = curYear - 3; year <= curYear + 1; year++){
        const opt = document.createElement("option");
        opt.value = String(year);
        opt.textContent = String(year);
        if(year === curYear) opt.selected = true;
        y.appendChild(opt);
      }

      m.innerHTML = "";
      for(let i=0;i<12;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = monthNamePT(i);
        if(i === curMonth) opt.selected = true;
        m.appendChild(opt);
      }
    }

    async function buildPdfData(year, monthIndex){
      const { start, end } = getMonthRange(year, monthIndex);
      const res = await fetchCaixaByRange(start, end);
      return { start, end, usedDateCol: res.usedDateCol, rows: res.rows };
    }

    function openPrintWindow({ year, monthIndex, rows, usedDateCol }){
      // calcula saldo igual a tela
      // (reusa parte da lógica de cálculo)
      const sample = rows[0] || {};
      const descrKey = findFirstKey(sample, COL_DESCR_TRIES) || "descricao";
      const tipoKey  = findFirstKey(sample, COL_TIPO_TRIES)  || "tipo";
      const valorKey = findFirstKey(sample, COL_VALOR_TRIES) || "valor";

      let saldo = 0;
      let totalReceita = 0;
      let totalDespesa = 0;

      const computedAsc = rows.slice().sort((a,b)=> new Date(a[usedDateCol]) - new Date(b[usedDateCol])).map(r=>{
        const tipoRaw = (r[tipoKey] ?? "").toString().trim();
        const tipoUp  = tipoRaw.toUpperCase();
        let valor = Number(r[valorKey] ?? 0);

        let delta = valor;
        if (tipoUp.includes("DESP") && delta > 0) delta = -delta;
        if (tipoUp.includes("RECE") && delta < 0) delta = Math.abs(delta);

        saldo += delta;

        if (delta >= 0) totalReceita += delta;
        else totalDespesa += Math.abs(delta);

        return {
          date: r[usedDateCol],
          descr: r[descrKey] ?? "",
          tipo: tipoUp.includes("DESP") ? "DESPESA" : (tipoUp.includes("RECE") ? "RECEITA" : (tipoRaw || "-")),
          delta,
          saldo
        };
      });

      const rowsHtml = computedAsc.map(it=>{
        const deltaStyle = it.delta >= 0 ? "color:#0f9d58;font-weight:700;" : "color:#d93025;font-weight:700;";
        return `
          <tr>
            <td>${fmtDateBR(it.date)}</td>
            <td>${String(it.descr||"").replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>
            <td>${it.tipo}</td>
            <td style="${deltaStyle}">${brl(it.delta)}</td>
            <td>${brl(it.saldo)}</td>
          </tr>
        `;
      }).join("");

      const html = `
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CAIXA - ${monthNamePT(monthIndex)}/${year}</title>
  <style>
    body{ font-family: Arial, sans-serif; margin:24px; color:#111; }
    h1{ margin:0 0 6px; font-size:18px; }
    .sub{ color:#444; margin:0 0 14px; font-size:12px; }
    table{ width:100%; border-collapse: collapse; font-size:12px; }
    th, td{ border:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
    th{ background:#f4f4f4; }
    .tot{ margin-top:12px; font-size:12px; }
    @media print{ button{ display:none; } }
  </style>
</head>
<body>
  <h1>CAIXA - ${monthNamePT(monthIndex)}/${year}</h1>
  <p class="sub">Período do arquivo: dia 1 até dia 1 do mês seguinte.</p>

  <table>
    <thead>
      <tr>
        <th style="width:110px;">DATA</th>
        <th>DESCRIÇÃO</th>
        <th style="width:90px;">TIPO</th>
        <th style="width:110px;">VALOR</th>
        <th style="width:110px;">SALDO</th>
      </tr>
    </thead>
    <tbody>
      ${rowsHtml || `<tr><td colspan="5">Sem lançamentos.</td></tr>`}
    </tbody>
  </table>

  <div class="tot">
    <b>Receitas:</b> ${brl(totalReceita)} &nbsp;&nbsp;
    <b>Despesas:</b> ${brl(totalDespesa)} &nbsp;&nbsp;
    <b>Saldo:</b> ${brl(totalReceita - totalDespesa)}
  </div>

  <script>
    // abre o diálogo de impressão (usuário salva como PDF)
    window.onload = () => setTimeout(() => window.print(), 350);
  </script>
</body>
</html>
      `;

      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    async function handlePdf(){
      setMsg("", "");
      const year = Number(el("pdfYear").value);
      const monthIndex = Number(el("pdfMonth").value);

      try{
        el("btnPdf").disabled = true;
        el("pillStatus").textContent = "Preparando PDF…";

        const data = await buildPdfData(year, monthIndex);

        el("pillStatus").textContent = "Conectado";
        el("btnPdf").disabled = false;

        // IMPORTANTE: não mexe na tela — só abre janela do PDF
        openPrintWindow({ year, monthIndex, rows: data.rows, usedDateCol: data.usedDateCol });

        setMsg("ok", `PDF pronto: ${monthNamePT(monthIndex)}/${year}. (A tela continua no mês corrente.)`);
      }catch(e){
        el("btnPdf").disabled = false;
        el("pillStatus").textContent = "Erro";
        setMsg("warn", "Falha ao preparar PDF. Detalhe: " + (e?.message || e));
      }
    }

    /******************************************************************
     * START
     ******************************************************************/
    (function start(){
      fillPdfSelectors();

      const ok = initSupabase();
      if(ok){
        loadCurrentMonth();
      }

      el("btnPdf").addEventListener("click", handlePdf);
      el("btnReload").addEventListener("click", loadCurrentMonth);
    })();
  </script>
</body>
</html>
