<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CONTROLE GERAL (TESTE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #fff; }
    header {
      padding: 14px 18px; border-bottom: 2px solid #f97316;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#07101f;
    }
    header h1 { margin: 0; font-size: 16px; letter-spacing: .5px; color:#f97316; text-transform:uppercase; font-weight:900; }

    .btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      background: #f97316;
      color: #111827;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .btn:active { transform: translateY(1px); }

    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .painel { background:#020617; border:1px solid #0f172a; border-radius:12px; padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .painel h2 { margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select { border-radius:10px; border:1px solid #0f172a; padding:10px 12px; font-weight:900; text-transform:uppercase; font-size:12px; background:#0b1220; color:#fff; min-width:140px; }
    .status { margin-top: 8px; font-size: 12px; color: #9ca3af; }

    /* wrapper do scroll horizontal */
    #wrapTabela{
      overflow: auto;
      padding-bottom: 8px; /* ajuda a “barra de correr” ficar completa */
      border-radius: 12px;
    }

    table { border-collapse: collapse; font-size: 12px; width: max-content; min-width: 100%; }
    thead th {
      position: sticky; top: 0; background:#f97316; color:#ffffff; z-index:2;
      border:1px solid rgba(255,255,255,.45); padding:6px 8px; text-align:center; white-space:nowrap; font-weight:900; text-transform:uppercase;
    }
    tbody td {
      border:1px solid rgba(255,255,255,.20); padding:5px 6px; text-align:center; white-space:nowrap; background:#020617; text-transform:uppercase;
    }
    tbody tr:nth-child(even) td { background:#061024; }

    .col-atleta { min-width:140px; text-align:left; padding-left:10px; font-weight:900; }
    .col-faltas { min-width:85px; font-weight:900; }

    .sticky-atleta { position: sticky; left: 0; z-index:3; background:#020617; }
    .sticky-faltas { position: sticky; left: 140px; z-index:3; background:#020617; }
    thead .sticky-atleta, thead .sticky-faltas { z-index:5; background:#f97316; color:#ffffff; }

    /* ✅ 2 linhas verticais na coluna TOTAL FALTAS */
    .faltas-divisoria {
      border-left: 3px solid rgba(255,255,255,.65) !important;
      border-right: 3px solid rgba(255,255,255,.65) !important;
    }

    .pverde { color:#22c55e; font-weight:900; }
    .pvermelho { color:#ef4444; font-weight:900; }

    /* ===== PDF (print) ===== */
    @media print {
      body { background:#fff; color:#000; }
      header, .painel#painelFiltro { display:none !important; }
      .wrap { max-width: none; margin: 0; padding: 0; }
      .painel { box-shadow:none; border:0; background:#fff; padding:0; margin:0; }
      #wrapTabela{ overflow: visible !important; }
      table { width: 100% !important; min-width: 100% !important; }
      thead th { position: static !important; }
      .sticky-atleta, .sticky-faltas { position: static !important; }
    }
  </style>
</head>
<body>

<header>
  <h1>TESOURA - CONTROLE GERAL</h1>
  <div style="display:flex;align-items:center;gap:10px;">
    <button id="btnPdf" class="btn" title="Salvar em PDF">BAIXAR PDF</button>
    <div style="font-size:12px;color:#9ca3af;">(somente visualização)</div>
  </div>
</header>

<div class="wrap">
  <div class="painel" id="painelFiltro">
    <h2>FILTRO</h2>
    <div class="row">
      <div style="display:flex;align-items:center;gap:8px;">
        <label style="font-weight:900;text-transform:uppercase;">ANO:</label>
        <select id="selAno"></select>
      </div>
    </div>

    <p style="margin:10px 0 0;font-size:12px;color:#cbd5e1;">
      OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) |
      <span class="pverde">P (verde)</span> pagou |
      <span class="pvermelho">P (vermelho)</span> não pagou.
    </p>
    <div class="status" id="status">A lista carrega automaticamente.</div>
  </div>

  <div class="painel" id="wrapTabela">
    <h2>JOGADORES X DOMINGOS</h2>
    <table id="tblControle">
      <thead id="theadControle"></thead>
      <tbody id="tbodyControle"></tbody>
    </table>
  </div>
</div>

<script src="app/js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // trava para não inicializar 2x no iframe
  if (window.__TESOURA_INIT_CONTROLE_GERAL__) {
    console.log("CONTROLE GERAL já inicializado");
  } else {
    window.__TESOURA_INIT_CONTROLE_GERAL__ = true;

    const CFG = window.TESOURA_CONFIG || {};
    const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
    const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    const sb = window.supabase.createClient(SB_URL, SB_KEY);

    const selAno = document.getElementById("selAno");
    const statusEl = document.getElementById("status");
    const theadControle = document.getElementById("theadControle");
    const tbodyControle = document.getElementById("tbodyControle");
    const btnPdf = document.getElementById("btnPdf");

    btnPdf.addEventListener("click", ()=> window.print());

    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    for (let a = anoAtual - 1; a <= anoAtual + 1; a++) {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if (a === anoAtual) opt.selected = true;
      selAno.appendChild(opt);
    }

    const nomesMes = {
      1:"JANEIRO",2:"FEVEREIRO",3:"MARÇO",4:"ABRIL",5:"MAIO",6:"JUNHO",
      7:"JULHO",8:"AGOSTO",9:"SETEMBRO",10:"OUTUBRO",11:"NOVEMBRO",12:"DEZEMBRO"
    };

    const norm = (s)=> String(s || "").trim().toUpperCase();

    function getDomingosMes(ano, mes) {
      const domingos = [];
      const dt = new Date(ano, mes - 1, 1);
      while (dt.getMonth() === mes - 1) {
        if (dt.getDay() === 0) {
          const anoStr = dt.getFullYear();
          const mesStr = String(dt.getMonth() + 1).padStart(2, "0");
          const diaStr = String(dt.getDate()).padStart(2, "0");
          domingos.push({ iso: `${anoStr}-${mesStr}-${diaStr}`, rotulo: `${diaStr}/${mesStr}` });
        }
        dt.setDate(dt.getDate() + 1);
      }
      return domingos;
    }

    function buildMesesOrdem(anoSelecionado) {
      const agora = new Date();
      const anoAgora = agora.getFullYear();
      const mesAgora = agora.getMonth() + 1;

      const meses = [];
      // se estamos em jan/fev e selecionou o ano atual: inclui nov/dez do ano anterior
      if (anoSelecionado === anoAgora && mesAgora <= 2) {
        meses.push({ ano: anoAgora - 1, mes: 11 });
        meses.push({ ano: anoAgora - 1, mes: 12 });
      }
      for (let m = 1; m <= 12; m++) meses.push({ ano: anoSelecionado, mes: m });
      return meses;
    }

    // ✅ rola automaticamente para mostrar: mês atual + 2 anteriores (ex.: em JAN mostra NOV/DEZ/JAN)
    function scrollUltimos3Meses() {
      const wrap = document.getElementById("wrapTabela");
      if (!wrap) return;

      const agora = new Date();
      let start = new Date(agora.getFullYear(), agora.getMonth(), 1);
      start.setMonth(start.getMonth() - 2); // 2 meses atrás
      const alvoAno = start.getFullYear();
      const alvoMes = start.getMonth() + 1;

      const doms = getDomingosMes(alvoAno, alvoMes);
      if (!doms.length) return;

      const th = wrap.querySelector(`th[data-iso="${doms[0].iso}"]`);
      if (!th) return;

      // faz depois de renderizar tudo (mais confiável)
      requestAnimationFrame(()=>{
        requestAnimationFrame(()=>{
          wrap.scrollLeft = Math.max(0, th.offsetLeft - 10);
        });
      });
    }

    async function carregarLista() {
      try {
        statusEl.textContent = "CARREGANDO...";
        theadControle.innerHTML = "";
        tbodyControle.innerHTML = "";

        const ano = Number(selAno.value);
        const mesesOrdem = buildMesesOrdem(ano);
        const domingosMes = mesesOrdem.map(mm => getDomingosMes(mm.ano, mm.mes));

        const trMeses = document.createElement("tr");
        const trDias = document.createElement("tr");

        const thAtletaSpan = document.createElement("th");
        thAtletaSpan.textContent = "ATLETA";
        thAtletaSpan.rowSpan = 2;
        thAtletaSpan.className = "col-atleta sticky-atleta";
        trMeses.appendChild(thAtletaSpan);

        const thFaltasTop = document.createElement("th");
        thFaltasTop.textContent = "TOTAL";
        thFaltasTop.className = "col-faltas sticky-faltas faltas-divisoria";
        trMeses.appendChild(thFaltasTop);

        const thFaltasBottom = document.createElement("th");
        thFaltasBottom.textContent = "FALTAS";
        thFaltasBottom.className = "col-faltas sticky-faltas faltas-divisoria";
        trDias.appendChild(thFaltasBottom);

        mesesOrdem.forEach((mm, idx) => {
          const listaDom = domingosMes[idx] || [];
          const thMes = document.createElement("th");
          thMes.colSpan = Math.max(1, listaDom.length);
          const nomeMes = nomesMes[mm.mes] || `MÊS ${mm.mes}`;
          thMes.textContent = `MÊS ${String(mm.mes).padStart(2,"0")} - ${nomeMes} - ${mm.ano}`;
          trMeses.appendChild(thMes);

          listaDom.forEach(d => {
            const thDia = document.createElement("th");
            thDia.textContent = d.rotulo;
            thDia.dataset.iso = d.iso;
            trDias.appendChild(thDia);
          });
        });

        theadControle.appendChild(trMeses);
        theadControle.appendChild(trDias);

        const { data: jogadores, error: errJog } = await sb
          .from("jogadores")
          .select("apelido")
          .order("apelido", { ascending: true });

        if (errJog) { statusEl.textContent = "ERRO AO BUSCAR JOGADORES."; return; }

        const firstMM = mesesOrdem[0];
        const iniIso = `${firstMM.ano}-${String(firstMM.mes).padStart(2, "0")}-01`;
        const fimIso = `${ano}-12-31`;

        const { data: pres, error: errPres } = await sb
          .from("presencas")
          .select("data_jogo, apelido, presenca, faltoso")
          .gte("data_jogo", iniIso)
          .lte("data_jogo", fimIso);

        if (errPres) { statusEl.textContent = "ERRO AO BUSCAR PRESENÇAS."; return; }

        const mapaPres = {};
        (pres || []).forEach(p => {
          mapaPres[`${norm(p.apelido)}::${String(p.data_jogo).slice(0,10)}`] = p;
        });

        const { data: esc, error: errEsc } = await sb
          .from("escalacao")
          .select("data_jogo, apelido, tempo")
          .gte("data_jogo", iniIso)
          .lte("data_jogo", fimIso);

        if (errEsc) { statusEl.textContent = "ERRO AO BUSCAR ESCALAÇÃO."; return; }

        const mapaEsc = {};
        (esc || []).forEach(e => {
          const key = `${norm(e.apelido)}::${String(e.data_jogo).slice(0,10)}`;
          if (!mapaEsc[key]) mapaEsc[key] = new Set();
          if (e.tempo !== null && e.tempo !== undefined && e.tempo !== "") mapaEsc[key].add(String(e.tempo));
        });

        (jogadores || []).forEach(j => {
          const apelido = norm(j.apelido);
          const tr = document.createElement("tr");

          const tdAtleta = document.createElement("td");
          tdAtleta.textContent = apelido;
          tdAtleta.className = "col-atleta sticky-atleta";
          tr.appendChild(tdAtleta);

          const tdFaltas = document.createElement("td");
          tdFaltas.textContent = "0";
          tdFaltas.className = "col-faltas sticky-faltas faltas-divisoria";
          tr.appendChild(tdFaltas);

          let totalFaltas = 0;

          mesesOrdem.forEach((mm, idx) => {
            const listaDom = domingosMes[idx] || [];
            listaDom.forEach(d => {
              const td = document.createElement("td");
              const key = `${apelido}::${d.iso}`;
              const presDia = mapaPres[key];
              let valor = "";

              if (presDia) {
                const presencaVal = presDia.presenca === true || presDia.presenca === "true" || presDia.presenca === 1 || presDia.presenca === "1";
                const faltosoVal = presDia.faltoso === true || presDia.faltoso === "true" || presDia.faltoso === 1 || presDia.faltoso === "1";

                if (presencaVal) {
                  const setTempos = mapaEsc[key] || new Set();
                  const t1 = setTempos.has("1");
                  const t2 = setTempos.has("2");
                  if (t1 && t2) valor = "1-2";
                  else if (t2) valor = "2";
                  else if (t1) valor = "1";
                  else valor = "C";
                } else if (faltosoVal) {
                  valor = "F";
                  totalFaltas += 1;
                }
              }

              td.textContent = valor;
              tr.appendChild(td);
            });
          });

          tdFaltas.textContent = String(totalFaltas);
          tbodyControle.appendChild(tr);
        });

        statusEl.textContent = "LISTA CARREGADA.";
        scrollUltimos3Meses();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "ERRO (ver Console).";
      }
    }

    selAno.addEventListener("change", carregarLista);
    window.addEventListener("load", carregarLista);
  }
</script>
</body>
</html>
