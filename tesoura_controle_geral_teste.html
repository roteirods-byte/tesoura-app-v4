<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CONTROLE GERAL (TESTE)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#fff; }
    header { padding:14px 18px; border-bottom:2px solid #f97316; display:flex; align-items:center; justify-content:space-between; background:#07101f; }
    header h1 { margin:0; font-size:16px; letter-spacing:.5px; color:#f97316; text-transform:uppercase; font-weight:900; }
    .wrap { max-width:1100px; margin:18px auto; padding:0 12px; }
    .painel { background:#020617; border:1px solid #0f172a; border-radius:12px; padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .painel h2 { margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select {
      border-radius:10px; border:1px solid #0f172a; padding:10px 12px;
      font-weight:900; text-transform:uppercase; font-size:12px; background:#0b1220; color:#fff; min-width:140px;
    }

    .btn {
      border:0; border-radius:10px; padding:10px 12px; font-weight:900; text-transform:uppercase;
      font-size:12px; cursor:pointer;
    }
    .btn-pdf { background:#f97316; color:#111827; }
    .btn-pdf:hover { filter:brightness(1.05); }

    .status { margin-top:8px; font-size:12px; color:#9ca3af; }

    /* SCROLL REAL */
    #wrapTabela { overflow:auto; }
    table { border-collapse:collapse; font-size:12px; width:max-content; min-width:max-content; }
    thead th{
      position:sticky; top:0; background:#f97316; color:#ffffff; z-index:2;
      border:1px solid rgba(255,255,255,.45); padding:6px 8px; text-align:center; white-space:nowrap;
      font-weight:900; text-transform:uppercase;
    }
    tbody td{
      border:1px solid rgba(255,255,255,.20); padding:5px 6px; text-align:center; white-space:nowrap;
      background:#020617; text-transform:uppercase;
    }
    tbody tr:nth-child(even) td{ background:#061024; }

    .col-atleta { min-width:160px; text-align:left; padding-left:10px; font-weight:900; }
    .col-faltas { min-width:95px; font-weight:900; }

    /* STICKY colunas fixas */
    .sticky-atleta { position:sticky; left:0; z-index:3; background:#020617; }
    .sticky-faltas { position:sticky; left:160px; z-index:3; background:#020617; }

    thead .sticky-atleta, thead .sticky-faltas { z-index:5; background:#f97316; color:#ffffff; }

    /* 2 LINHAS VERTICAIS na coluna TOTAL FALTAS */
    .sticky-faltas, .col-faltas {
      border-left:3px solid rgba(249,115,22,0.95) !important;
      border-right:3px solid rgba(249,115,22,0.95) !important;
    }

    /* Pagamento */
    .pverde { color:#22c55e; font-weight:900; }
    .pvermelho { color:#ef4444; font-weight:900; }

    @media print{
      header, #painelFiltro { display:none !important; }
      body { background:#fff; color:#000; }
      .wrap { max-width:none; margin:0; padding:0; }
      .painel { box-shadow:none; border:0; }
      thead th { position:static !important; }
      .sticky-atleta, .sticky-faltas { position:static !important; }
    }
  
/* PRINT FULL (REV_PDF_2026_01_03) */
@page { size: A4 landscape; margin: 8mm; }
@media print{
  /* não cortar em container com scroll */
  #wrapTabela{ overflow: visible !important; }
  .painel{ overflow: visible !important; }

  /* pegar a largura toda (chrome) */
  body{ zoom: 0.72; }

  /* ajuda a não “prender” larguras */
  table{ width: 100% !important; min-width: 0 !important; }
  thead th, tbody td{ font-size: 10px !important; padding: 4px 5px !important; }

  /* desligar sticky no print */
  thead th{ position: static !important; }
  .sticky-atleta, .sticky-faltas{ position: static !important; }
}

</style>
</head>
<body>

<header>
  <h1>TESOURA - CONTROLE GERAL</h1>
  <div style="font-size:12px;color:#9ca3af;">(somente visualização)</div>
</header>

<div class="wrap">
  <div class="painel" id="painelFiltro">
    <h2>FILTRO</h2>
    <div class="row" style="justify-content:space-between; width:100%;">
      <div style="display:flex;align-items:center;gap:10px; flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="font-weight:900;text-transform:uppercase;">ANO:</label>
          <select id="selAno"></select>
        </div>
        <button id="btnPdf" class="btn btn-pdf" title="Salvar em PDF">BAIXAR PDF</button>
      </div>
    </div>

    <p style="margin:10px 0 0;font-size:12px;color:#cbd5e1;">
      OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) |
      P (branco) pendente | <span class="pverde">P (verde)</span> pagou |
      <span class="pvermelho">P (vermelho)</span> não pagou.
    </p>
    <div class="status" id="status">A lista carrega automaticamente.</div>
  </div>

  <div class="painel" id="wrapTabela">
    <h2>JOGADORES X DOMINGOS (3 MESES)</h2>
    <table id="tblControle">
      <thead id="theadControle"></thead>
      <tbody id="tbodyControle"></tbody>
    </table>
  </div>
</div>

<script src="app/core/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const selAno = document.getElementById("selAno");
  const statusEl = document.getElementById("status");
  const theadControle = document.getElementById("theadControle");
  const tbodyControle = document.getElementById("tbodyControle");
  const btnPdf = document.getElementById("btnPdf");

  const hoje = new Date();
  const anoAtual = hoje.getFullYear();

  // anos no seletor
  for (let a = anoAtual - 1; a <= anoAtual + 1; a++) {
    const opt = document.createElement("option");
    opt.value = a;
    opt.textContent = a;
    if (a === anoAtual) opt.selected = true;
    selAno.appendChild(opt);
  }

  const nomesMes = {
    1:"JANEIRO",2:"FEVEREIRO",3:"MARÇO",4:"ABRIL",5:"MAIO",6:"JUNHO",
    7:"JULHO",8:"AGOSTO",9:"SETEMBRO",10:"OUTUBRO",11:"NOVEMBRO",12:"DEZEMBRO"
  };

  function pad2(n){ return String(n).padStart(2,"0"); }

  function lastDayOfMonth(ano, mes){
    return new Date(ano, mes, 0).getDate();
  }

  function getDomingosMes(ano, mes) {
    const domingos = [];
    const dt = new Date(ano, mes - 1, 1);
    while (dt.getMonth() === mes - 1) {
      if (dt.getDay() === 0) {
        domingos.push({ iso: `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`, rotulo: `${pad2(dt.getDate())}/${pad2(dt.getMonth()+1)}` });
      }
      dt.setDate(dt.getDate() + 1);
    }
    return domingos;
  }

  function addDias(dateObj, dias){
    const d = new Date(dateObj.getTime());
    d.setDate(d.getDate()+dias);
    return d;
  }

  // 2º domingo do mês
  function getSegundoDomingo(ano, mes){
    const dt = new Date(ano, mes-1, 1);
    let count = 0;
    while (dt.getMonth() === mes-1){
      if (dt.getDay() === 0){
        count++;
        if (count === 2) return new Date(dt.getTime());
      }
      dt.setDate(dt.getDate()+1);
    }
    return null;
  }

  function get3Meses(anoSelecionado){
    const now = new Date();
    const anoNow = now.getFullYear();
    const mesNow = now.getMonth()+1;

    let baseAno = anoSelecionado;
    let baseMes = 12;

    if (anoSelecionado === anoNow) baseMes = mesNow;
    else if (anoSelecionado > anoNow) baseMes = 1;

    const meses = [];
    // pega base-2, base-1, base
    let a = baseAno;
    let m = baseMes;

    // volta 2 meses
    for (let i=0;i<2;i++){
      m -= 1;
      if (m <= 0){ a -= 1; m = 12; }
    }
    // agora a/m é base-2
    for (let k=0;k<3;k++){
      meses.push({ano:a, mes:m});
      m += 1;
      if (m >= 13){ a += 1; m = 1; }
    }
    return meses;
  }

  // INÍCIO OFICIAL DO APP (não mostrar P em meses anteriores)
  const APP_START_ANO = 2026;
  const APP_START_MES = 1;

  function getPStatus(ano, mes, pagoBool){
    // meses antes do início do app: vazio
    if (ano < APP_START_ANO || (ano === APP_START_ANO && mes < APP_START_MES)) {
      return { text: "", className: "" };
    }

    // mês futuro: vazio
    const hoje0 = new Date();
    hoje0.setHours(0,0,0,0);
    const mesIni = new Date(ano, mes - 1, 1);
    mesIni.setHours(0,0,0,0);
    if (hoje0 < mesIni) {
      return { text: "", className: "" };
    }

    // pagou: P verde
    if (pagoBool) {
      return { text: "P", className: "pverde" };
    }

    // não pagou: antes do vencimento = P branco; depois = P vermelho
    const segDom = getSegundoDomingo(ano, mes);
    if (!segDom) {
      return { text: "P", className: "" };
    }
    const viraVermelho = addDias(segDom, 1); // segunda após 2º domingo
    viraVermelho.setHours(0,0,0,0);

    if (hoje0 >= viraVermelho) {
      return { text: "P", className: "pvermelho" };
    }
    return { text: "P", className: "" }; // branco (pendente)
  }


  function normIsoDate(v){
    if (!v) return "";
    const s = String(v);
    return s.length >= 10 ? s.slice(0,10) : s;
  }

  async function carregarLista(){
    try{
      statusEl.textContent = "CARREGANDO...";
      theadControle.innerHTML = "";
      tbodyControle.innerHTML = "";

      const anoSel = Number(selAno.value);
      const meses3 = get3Meses(anoSel);

      // domingos por mês
      const domingosMes = meses3.map(mm => getDomingosMes(mm.ano, mm.mes));

      // range de busca (do primeiro dia do 1º mês ao último dia do 3º mês)
      const iniIso = `${meses3[0].ano}-${pad2(meses3[0].mes)}-01`;
      const fimIso = `${meses3[2].ano}-${pad2(meses3[2].mes)}-${pad2(lastDayOfMonth(meses3[2].ano, meses3[2].mes))}`;

      // HEADER (2 linhas)
      const trMeses = document.createElement("tr");
      const trDias  = document.createElement("tr");

      const thAtleta = document.createElement("th");
      thAtleta.textContent = "ATLETA";
      thAtleta.rowSpan = 2;
      thAtleta.className = "col-atleta sticky-atleta";
      trMeses.appendChild(thAtleta);

      const thFaltasTop = document.createElement("th");
      thFaltasTop.textContent = "TOTAL";
      thFaltasTop.className = "col-faltas sticky-faltas";
      trMeses.appendChild(thFaltasTop);

      const thFaltasBot = document.createElement("th");
      thFaltasBot.textContent = "FALTAS";
      thFaltasBot.className = "col-faltas sticky-faltas";
      trDias.appendChild(thFaltasBot);

      meses3.forEach((mm, idx)=>{
        const listaDom = domingosMes[idx] || [];
        // +1 coluna extra do "P" (pagamento do mês)
        const thMes = document.createElement("th");
        thMes.colSpan = (listaDom.length + 1);
        thMes.textContent = `MÊS ${pad2(mm.mes)} - ${nomesMes[mm.mes]} - ${mm.ano}`;
        trMeses.appendChild(thMes);

        // coluna P
        const thP = document.createElement("th");
        thP.textContent = "P";
        thP.dataset.pano = String(mm.ano);
        thP.dataset.pmes = String(mm.mes);
        trDias.appendChild(thP);

        // domingos
        listaDom.forEach(d=>{
          const thDia = document.createElement("th");
          thDia.textContent = d.rotulo;
          thDia.dataset.iso = d.iso;
          trDias.appendChild(thDia);
        });
      });

      theadControle.appendChild(trMeses);
      theadControle.appendChild(trDias);

      // DADOS
      const { data: jogadores, error: errJog } = await sb
        .from("jogadores")
        .select("apelido")
        .order("apelido", { ascending:true });

      if (errJog){
        console.error(errJog);
        statusEl.textContent = "ERRO AO BUSCAR JOGADORES.";
        return;
      }

      const { data: pres, error: errPres } = await sb
        .from("presencas")
        .select("data_jogo, apelido, presenca, faltoso")
        .gte("data_jogo", iniIso)
        .lte("data_jogo", fimIso);

      if (errPres){
        console.error(errPres);
        statusEl.textContent = "ERRO AO BUSCAR PRESENÇAS.";
        return;
      }

      const mapaPres = {};
      (pres || []).forEach(p=>{
        const d = normIsoDate(p.data_jogo);
        mapaPres[`${p.apelido}::${d}`] = p;
      });

      const { data: esc, error: errEsc } = await sb
        .from("escalacao")
        .select("data_jogo, apelido, tempo")
        .gte("data_jogo", iniIso)
        .lte("data_jogo", fimIso);

      if (errEsc){
        console.error(errEsc);
        statusEl.textContent = "ERRO AO BUSCAR ESCALAÇÃO.";
        return;
      }

      const mapaEsc = {};
      (esc || []).forEach(e=>{
        const d = normIsoDate(e.data_jogo);
        const key = `${e.apelido}::${d}`;
        if (!mapaEsc[key]) mapaEsc[key] = new Set();
        if (e.tempo !== null && e.tempo !== undefined && e.tempo !== "") mapaEsc[key].add(String(e.tempo));
      });

      // mensalidades (para P)
      let mensalidades = [];
      try{
        const minAno = Math.min(meses3[0].ano, meses3[2].ano);
        const maxAno = Math.max(meses3[0].ano, meses3[2].ano);

        const { data: men, error: errMen } = await sb
          .from("mensalidades")
          .select("apelido, ano, mes, pago")
          .gte("ano", minAno)
          .lte("ano", maxAno);

        if (errMen) throw errMen;
        mensalidades = men || [];
      }catch(e){
        console.warn("Aviso: não consegui ler mensalidades.", e);
        mensalidades = [];
      }

      const mapaMen = {};
      mensalidades.forEach(m=>{
        const a = Number(m.ano);
        const me = Number(m.mes);
        const key = `${m.apelido}::${a}-${pad2(me)}`;
        mapaMen[key] = m;
      });

      // MONTAR TABELA
      (jogadores || []).forEach(j=>{
        const apelido = j.apelido;
        const tr = document.createElement("tr");

        const tdAtleta = document.createElement("td");
        tdAtleta.textContent = (apelido || "").toUpperCase();
        tdAtleta.className = "col-atleta sticky-atleta";
        tr.appendChild(tdAtleta);

        const tdFaltas = document.createElement("td");
        tdFaltas.textContent = "0";
        tdFaltas.className = "col-faltas sticky-faltas";
        tr.appendChild(tdFaltas);

        let totalFaltas = 0;

        meses3.forEach((mm, idx)=>{
          // coluna P do mês
          const tdP = document.createElement("td");
          const menKey = `${apelido}::${mm.ano}-${pad2(mm.mes)}`;
          const menRow = mapaMen[menKey];
          const pago = menRow ? !!menRow.pago : false;
          const st = getPStatus(mm.ano, mm.mes, pago);
          tdP.textContent = st.text;
          tdP.className = st.className;
          tr.appendChild(tdP);

          // domingos do mês
          const listaDom = domingosMes[idx] || [];
          listaDom.forEach(d=>{
            const td = document.createElement("td");
            const key = `${apelido}::${d.iso}`;
            const presDia = mapaPres[key];

            let valor = "";
            if (presDia){
              if (presDia.presenca){
                const setTempos = mapaEsc[key] || new Set();
                const t1 = setTempos.has("1");
                const t2 = setTempos.has("2");
                if (t1 && t2) valor = "1-2";
                else if (t2) valor = "2";
                else if (t1) valor = "1";
                else valor = "C";
              } else if (presDia.faltoso){
                valor = "F";
                totalFaltas += 1;
              }
            }

            td.textContent = valor;
            tr.appendChild(td);
          });
        });

        tdFaltas.textContent = String(totalFaltas);
        tbodyControle.appendChild(tr);
      });

      statusEl.textContent = `LISTA CARREGADA. Jogadores: ${(jogadores||[]).length} | Presenças: ${(pres||[]).length} | Escalação: ${(esc||[]).length} | Mensalidades: ${(mensalidades||[]).length}`;
    }catch(e){
      console.error(e);
      statusEl.textContent = "ERRO (ver console).";
    }
  }

  // PDF: abre impressão (você salva como PDF)
  btnPdf.addEventListener("click", ()=>{
    // garante que já carregou antes de imprimir
    window.print();
  });

  selAno.addEventListener("change", carregarLista);
  window.addEventListener("load", carregarLista);
</script>
</body>
</html>
