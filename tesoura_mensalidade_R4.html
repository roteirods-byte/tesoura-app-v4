<!doctype html>
<html lang="pt-BR_allow">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - MENSALIDADE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#fff; }
    header { padding:14px 18px; border-bottom:2px solid #f97316; display:flex; align-items:center; justify-content:space-between; background:#07101f; gap:12px; }
    header h1 { margin:0; font-size:16px; letter-spacing:.5px; color:#f97316; text-transform:uppercase; font-weight:900; }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .painel { background:#020617; border:1px solid #0f172a; border-radius:12px; padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .painel h2 { margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-weight:900; text-transform:uppercase; font-size:12px; color:#fff; }
    select, input[type="date"] {
      border-radius:10px; border:1px solid #0f172a; padding:10px 12px;
      font-weight:900; text-transform:uppercase; font-size:12px;
      background:#0b1220; color:#fff;
    }
    select { min-width:140px; }
    .status { margin-top:8px; font-size:12px; color:#9ca3af; }
    .btn {
      border:0; border-radius:10px; padding:10px 14px; font-weight:900;
      text-transform:uppercase; cursor:pointer; font-size:12px;
      background:#0ea5e9; color:#001018;
    }
    .btn:active { transform: translateY(1px); }
    .btn-pdf { background:#f97316; color:#220b00; }
    .btn-del { background:#ef4444; color:#1b0000; }
    .btn-edt { background:#22c55e; color:#001b08; }
    .hint { font-size:12px; color:#cbd5e1; margin:10px 0 0; line-height:1.35; }
    .totalbox { margin-top:10px; font-size:12px; color:#e5e7eb; font-weight:900; text-transform:uppercase; }
    table { width:100%; border-collapse:collapse; margin-top:10px; background:#020617; font-size:12px; }
    thead th {
      position: sticky; top: 0; z-index: 2;
      background:#f97316; color:#fff;
      border:1px solid rgba(255,255,255,.45);
      padding:8px 8px; text-align:center; white-space:nowrap;
      font-weight:900; text-transform:uppercase;
    }
    tbody td {
      border:1px solid rgba(255,255,255,.20);
      padding:6px 6px; text-align:center; white-space:nowrap;
      background:#020617; text-transform:uppercase;
    }
    tbody tr:nth-child(even) td { background:#061024; }
    .col-atleta { text-align:left; font-weight:900; padding-left:10px; }
    .col-valor { font-weight:900; }
    .pverde { color:#22c55e; font-weight:900; }
    .pvermelho { color:#ef4444; font-weight:900; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(2,6,23,.95); border: 1px solid rgba(255,255,255,.15);
      padding: 10px 12px; border-radius: 10px; font-size: 12px; color:#fff;
      display:none; z-index: 9999; box-shadow:0 10px 26px rgba(0,0,0,.35);
    }
    .wrap-table { overflow:auto; max-height: 70vh; border-radius:10px; }
    .chk { width:18px; height:18px; cursor:pointer; }

    /* PRINT FULL (REV_PDF_MENS_2026_01_03) */
    @page { size: A4 portrait; margin: 10mm; }
    @media print{
      .wrap, .painel, .panel, .table-wrap, #wrapTabela, #wrapLista, #lista, #listaJogadores{
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }
      table{ width: 100% !important; }
      tr{ page-break-inside: avoid; }
      .no-print, button{ display:none !important; }
    }
  </style>

<style>
#tesouraFileBadge{
  position:fixed; right:10px; bottom:10px; z-index:99999;
  font: 11px/1.2 Arial, sans-serif;
  background: rgba(0,0,0,.55);
  color:#fff; padding:6px 8px; border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
}
</style>

</head>
<body>

<header>
  <h1>TESOURA - MENSALIDADE</h1>
  <button id="btnPdf" class="btn btn-pdf" title="Salvar em PDF">BAIXAR PDF</button>
</header>

<div class="wrap">
  <div class="painel">
    <h2>FILTRO</h2>

    <div class="row">
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="selAno">ANO:</label>
        <select id="selAno"></select>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <label for="selMes">MÊS:</label>
        <select id="selMes"></select>
      </div>

      <button id="btnConsultar" class="btn">CONSULTAR</button>
    </div>

    <div class="hint">
      Regras: valor <b>R$ 70</b> até o <b>2º domingo</b> do mês. Depois: <b>R$ 80</b>.<br/>
      STATUS é o <b>P</b>: fica <span class="pverde">verde</span> quando pagar, e fica <span class="pvermelho">vermelho</span> na <b>segunda-feira após o 2º domingo</b> se não pagar.<br/>
      Ao marcar/desmarcar, salva automaticamente. No botão <b>EDITAR</b> você pode digitar um valor diferente (ex.: 60, 90, etc).
    </div>

    <div class="totalbox" id="totalPagoMes">TOTAL PAGO NO MÊS: R$ 0 (0)</div>
    <div class="status" id="status">A lista carrega automaticamente.</div>
  </div>

  <div class="painel">
    <h2>LISTA DE JOGADORES</h2>
    <div class="wrap-table" id="wrapTabela">
      <table>
        <thead>
          <tr>
            <th style="min-width:170px;text-align:left;padding-left:10px;">ATLETA</th>
            <th style="min-width:110px;">VALOR</th>
            <th style="min-width:90px;">PAGO?</th>
            <th style="min-width:160px;">DATA PAGAMENTO</th>
            <th style="min-width:90px;">STATUS</th>
            <th style="min-width:110px;">EDITAR</th>
            <th style="min-width:110px;">EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>if (!window.supabase && typeof supabase !== "undefined") window.supabase = supabase;</script>
  
<script>
  const CFG = window.TESOURA_CONFIG || (window.parent && window.parent.TESOURA_CONFIG) || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  // === Mensalidade -> Caixa (espelho automático) ===
  function pad2(n){ return String(n).padStart(2,"0"); }
  function caixaMarker(apelido, ano, mes){
    return `MENSALIDADE|${apelido}|${pad2(mes)}|${ano}`;
  }

  async function syncCaixaMensalidade({ apelido, ano, mes, pago, data_pagamento, valor }){
    try{
      // 1) remove qualquer duplicado anterior (por marker)
      const marker = caixaMarker(apelido, ano, mes);
      const { error: delErr } = await sb.from("caixa").delete().eq("obs", marker);
      // se der erro (coluna diferente), só ignora para não travar
if (!pago) return; // desmarcou ou excluiu: só remove

      // 2) insere novamente (descricao = apelido; receita positiva)
      const v = Math.abs(Number(valor || 0)) || 0;
      if (!v) return;

      const base = {
        data: data_pagamento || null,
        // "hora" pode não existir no Supabase (dependendo do schema)
        hora: "00:00",
        tipo: "RECEITA",
        descricao: apelido,
        obs: marker,
        valor: v,
        receita: v,
        despesa: 0
      };

      const candidates = [
        // valor único
        { data: base.data, hora: base.hora, tipo: base.tipo, descricao: base.descricao, obs: base.obs, valor: base.valor },
        // receita/despesa
        { data: base.data, hora: base.hora, tipo: base.tipo, descricao: base.descricao, obs: base.obs, receita: base.receita, despesa: base.despesa },
        // sem hora/tipo
        { data: base.data, descricao: base.descricao, obs: base.obs, valor: base.valor },
        { data: base.data, descricao: base.descricao, obs: base.obs, receita: base.receita, despesa: base.despesa },
      ];

      for (const payload of candidates){
        const { error } = await sb.from("caixa").insert(payload);
        if (!error) return;
      }
    }catch(err){
      console.warn("Aviso: sync Caixa falhou.", err);
    }
  }


  const selAno = document.getElementById("selAno");
  const selMes = document.getElementById("selMes");
  const btnConsultar = document.getElementById("btnConsultar");
  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const toastEl = document.getElementById("toast");
  const btnPdf = document.getElementById("btnPdf");
  const totalPagoMesEl = document.getElementById("totalPagoMes");

  const hoje = new Date();
  const anoAtual = hoje.getFullYear();
  const mesAtual = hoje.getMonth() + 1;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoToday(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display="none", 1600);
  }

  function getSecondSunday(year, month){
    const d = new Date(year, month-1, 1);
    let sundays = 0;
    while(d.getMonth() === month-1){
      if(d.getDay() === 0){
        sundays++;
        if(sundays === 2) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }
      d.setDate(d.getDate()+1);
    }
    return null;
  }

  function isoSecondSunday(year, month){
    const s = getSecondSunday(year, month);
    if(!s) return `${year}-${pad2(month)}-01`;
    return `${s.getFullYear()}-${pad2(s.getMonth()+1)}-${pad2(s.getDate())}`;
  }

  function mondayAfterSecondSunday(year, month){
    const s = getSecondSunday(year, month);
    if(!s) return null;
    const m = new Date(s.getFullYear(), s.getMonth(), s.getDate());
    m.setDate(m.getDate() + 1);
    m.setHours(0,0,0,0);
    return m;
  }

  function suggestedValueNow(year, month){
    const dueMonday = mondayAfterSecondSunday(year, month);
    if(!dueMonday) return 70;
    return (new Date() >= dueMonday) ? 80 : 70;
  }

  function valueByPaymentDate(year, month, isoPayDate){
    if(!isoPayDate) return suggestedValueNow(year, month);
    const s = getSecondSunday(year, month);
    if(!s) return 70;
    const pay = new Date(isoPayDate + "T00:00:00");
    const limite = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 23,59,59,999);
    return (pay <= limite) ? 70 : 80;
  }

  function statusP(pago, year, month){
    if(pago) return { text: "P", cls: "pverde" };
    const dueMonday = mondayAfterSecondSunday(year, month);
    if(!dueMonday) return { text:"", cls:"" };
    return (new Date() >= dueMonday) ? { text:"P", cls:"pvermelho" } : { text:"", cls:"" };
  }

  function fillFiltro(){
    for(let a = anoAtual - 1; a <= anoAtual + 1; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if(a === anoAtual) opt.selected = true;
      selAno.appendChild(opt);
    }
    const meses = ["01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN","07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"];
    meses.forEach((txt, idx)=>{
      const m = idx+1;
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = txt;
      if(m === mesAtual) opt.selected = true;
      selMes.appendChild(opt);
    });
  }

  async function getExisting(apel, year, month){
    const { data, error } = await sb
      .from("mensalidades")
      .select("*")
      .eq("apelido", apel)
      .eq("ano", year)
      .eq("mes", month)
      .limit(1);
    if(error) return { ok:false, error };
    return { ok:true, row: (data && data.length ? data[0] : null) };
  }

  async function salvarRegistro(apel, year, month, pago, data_pagamento, valor, data_vencimento){
    const ex = await getExisting(apel, year, month);
    if(!ex.ok){
      alert("ERRO ao salvar (consulta): " + (ex.error.message || "sem detalhe"));
      return false;
    }

    const payload = {
      apelido: apel,
      ano: year,
      mes: month,
      pago: !!pago,
      data_pagamento: data_pagamento || null,
      // REGRA: se NÃO PAGO, valor fica NULL no banco
      valor: (pago ? (valor == null ? null : Number(valor)) : null),
      data_vencimento: data_vencimento
    };

    if(ex.row){
      const { error } = await sb
        .from("mensalidades")
        .update(payload)
        .eq("apelido", apel)
        .eq("ano", year)
        .eq("mes", month);
      if(error){
        alert("ERRO ao salvar (atualizar): " + (error.message || "sem detalhe"));
        return false;
      }
      await syncCaixaMensalidade({ apelido: apel, ano: year, mes: month, pago:false, data_pagamento:null, valor:0 });
    return true;
  } else {
      const { error } = await sb
        .from("mensalidades")
        .insert([payload]);
      if(error){
        alert("ERRO ao salvar (inserir): " + (error.message || "sem detalhe"));
        return false;
      }
      return true;
    }
  }

  async function excluirRegistro(apel, year, month){
    const { error } = await sb
      .from("mensalidades")
      .delete()
      .eq("apelido", apel)
      .eq("ano", year)
      .eq("mes", month);
    if(error){
      alert("ERRO ao excluir: " + (error.message || "sem detalhe"));
      return false;
    }
    return true;
  }

  async function load(){
    const year = Number(selAno.value);
    const month = Number(selMes.value);

    try{
      statusEl.textContent = "CARREGANDO...";
      tbody.innerHTML = "";
      totalPagoMesEl.textContent = "TOTAL PAGO NO MÊS: R$ 0 (0)";

      const { data: jogadores, error: errJog } = await sb
        .from("jogadores")
        .select("apelido")
        .order("apelido", { ascending:true });
      if(errJog){ statusEl.textContent = "ERRO AO BUSCAR JOGADORES."; return; }

      const { data: mens, error: errMen } = await sb
        .from("mensalidades")
        .select("*")
        .eq("ano", year)
        .eq("mes", month);
      if(errMen){ statusEl.textContent = "ERRO AO BUSCAR MENSALIDADES."; return; }

      const mapa = {};
      (mens || []).forEach(r => { mapa[(r.apelido||"").toUpperCase()] = r; });

      let totalPago = 0;
      let qtdPago = 0;

      const vencIso = isoSecondSunday(year, month);

      (jogadores || []).forEach(j => {
        const apelido = (j.apelido || "").toUpperCase();
        const r = mapa[apelido];

        const pago = !!(r && (r.pago === true || r.pago === 1));
        const dataPag = (r && r.data_pagamento) ? String(r.data_pagamento).slice(0,10) : "";

        let valorExibido = suggestedValueNow(year, month);
        if(pago){
          if(r && r.valor != null && r.valor !== "") valorExibido = Number(r.valor);
          else valorExibido = valueByPaymentDate(year, month, dataPag);

          totalPago += Number(valorExibido || 0);
          qtdPago += 1;
        }

        const st = statusP(pago, year, month);

        const tr = document.createElement("tr");

        const tdA = document.createElement("td");
        tdA.className = "col-atleta";
        tdA.textContent = apelido;
        tr.appendChild(tdA);

        const tdV = document.createElement("td");
        tdV.className = "col-valor";
        tdV.textContent = `R$ ${Number(valorExibido).toFixed(0)}`;
        tr.appendChild(tdV);

        const tdP = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chk";
        chk.checked = pago;
        tdP.appendChild(chk);
        tr.appendChild(tdP);

        const tdD = document.createElement("td");
        const inpDate = document.createElement("input");
        inpDate.type = "date";
        inpDate.value = dataPag;
        inpDate.disabled = !chk.checked;
        tdD.appendChild(inpDate);
        tr.appendChild(tdD);

        const tdS = document.createElement("td");
        tdS.textContent = st.text;
        tdS.className = st.cls;
        tr.appendChild(tdS);

        const tdE = document.createElement("td");
        const btnEdt = document.createElement("button");
        btnEdt.className = "btn btn-edt";
        btnEdt.textContent = "EDITAR";
        tdE.appendChild(btnEdt);
        tr.appendChild(tdE);

        const tdX = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.className = "btn btn-del";
        btnDel.textContent = "EXCLUIR";
        tdX.appendChild(btnDel);
        tr.appendChild(tdX);

        async function salvarAgora(){
          const year2 = Number(selAno.value);
          const month2 = Number(selMes.value);
          const vencIso2 = isoSecondSunday(year2, month2);

          const pagoAgora = chk.checked;

          if(pagoAgora && !inpDate.value){
            inpDate.value = isoToday();
          }
          inpDate.disabled = !pagoAgora;

          // se já existe valor customizado no banco, mantém; senão calcula 70/80
          let valorCalc = suggestedValueNow(year2, month2);
          if(pagoAgora){
            if(r && r.valor != null && r.valor !== "") valorCalc = Number(r.valor);
            else valorCalc = valueByPaymentDate(year2, month2, inpDate.value);
          } else {
            inpDate.value = "";
          }

          tdV.textContent = `R$ ${Number(valorCalc).toFixed(0)}`;

          const stNow = statusP(pagoAgora, year2, month2);
          tdS.textContent = stNow.text;
          tdS.className = stNow.cls;

          const ok = await salvarRegistro(
            apelido,
            year2,
            month2,
            pagoAgora,
            (pagoAgora ? inpDate.value : null),
            (pagoAgora ? valorCalc : null),
            vencIso2
          );

          if(ok){
            toast(pagoAgora ? `SALVO (PAGO): ${apelido}` : `SALVO (NÃO PAGO): ${apelido}`);
            load();
          }
        }

        chk.addEventListener("change", salvarAgora);
        inpDate.addEventListener("change", salvarAgora);

        // EDITAR: permite digitar qualquer valor
        btnEdt.addEventListener("click", async ()=>{
          const year2 = Number(selAno.value);
          const month2 = Number(selMes.value);
          const vencIso2 = isoSecondSunday(year2, month2);

          // ao editar: garante que está como PAGO
          if(!chk.checked){
            chk.checked = true;
            if(!inpDate.value) inpDate.value = isoToday();
            inpDate.disabled = false;
          }

          const valorAtual = (r && r.valor != null && r.valor !== "") ? Number(r.valor) : Number(tdV.textContent.replace(/[^\d.,-]/g,"").replace(",",".") || 70);
          const resp = prompt(`Digite o valor da mensalidade de ${apelido} (${pad2(month2)}/${year2})`, String(isFinite(valorAtual) ? valorAtual : 70));
          if(resp === null) return;

          const v = Number(String(resp).trim().replace(",", "."));
          if(!isFinite(v) || v <= 0){
            alert("Valor inválido.");
            return;
          }

          tdV.textContent = `R$ ${Number(v).toFixed(0)}`;
          const stNow = statusP(true, year2, month2);
          tdS.textContent = stNow.text;
          tdS.className = stNow.cls;

          const ok = await salvarRegistro(
            apelido,
            year2,
            month2,
            true,
            (inpDate.value || isoToday()),
            v,
            vencIso2
          );

          if(ok){
            toast(`SALVO (VALOR): ${apelido} = R$ ${Number(v).toFixed(0)}`);
            load();
          }
        });

        btnDel.addEventListener("click", async ()=>{
          const year2 = Number(selAno.value);
          const month2 = Number(selMes.value);
          if(!confirm(`Excluir mensalidade de ${apelido} (${pad2(month2)}/${year2})?`)) return;

          const ok = await excluirRegistro(apelido, year2, month2);
          if(ok){
            toast("EXCLUIDO.");
            chk.checked = false;
            inpDate.value = "";
            inpDate.disabled = true;
            load();
          }
        });

        tbody.appendChild(tr);
      });

      totalPagoMesEl.textContent = `TOTAL PAGO NO MÊS: R$ ${Number(totalPago).toFixed(0)} (${qtdPago})`;
      statusEl.textContent = `LISTA CARREGADA. (${pad2(month)}/${year})`;
    }catch(e){
      console.error(e);
      statusEl.textContent = "ERRO (ver Console).";
    }
  }

  btnPdf.addEventListener("click", () => window.print());

  fillFiltro();
  btnConsultar.addEventListener("click", load);
  window.addEventListener("load", load);
</script>

<div id="tesouraFileBadge">ARQUIVO: tesoura_mensalidade_R4.html</div>
</body>
</html>
