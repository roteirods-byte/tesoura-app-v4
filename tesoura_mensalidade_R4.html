<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - MENSALIDADE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#fff; }
    header { padding:14px 18px; border-bottom:2px solid #f97316; display:flex; align-items:center; justify-content:space-between; background:#07101f; gap:12px; }
    header h1 { margin:0; font-size:16px; letter-spacing:.5px; color:#f97316; text-transform:uppercase; font-weight:900; }

    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .painel { background:#020617; border:1px solid #0f172a; border-radius:12px; padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .painel h2 { margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-weight:900; text-transform:uppercase; font-size:12px; color:#fff; }
    select, input[type="date"] {
      border-radius:10px; border:1px solid #0f172a; padding:10px 12px;
      font-weight:900; text-transform:uppercase; font-size:12px;
      background:#0b1220; color:#fff;
    }
    select { min-width:140px; }
    .status { margin-top:8px; font-size:12px; color:#9ca3af; }

    .btn {
      border:0; border-radius:10px; padding:10px 14px; font-weight:900;
      text-transform:uppercase; cursor:pointer; font-size:12px;
      background:#0ea5e9; color:#001018;
    }
    .btn:active { transform: translateY(1px); }
    .btn-pdf { background:#f97316; color:#220b00; }
    .hint { font-size:12px; color:#cbd5e1; margin:10px 0 0; line-height:1.35; }

    table { width:100%; border-collapse:collapse; margin-top:10px; background:#020617; font-size:12px; }
    thead th {
      position: sticky; top: 0; z-index: 2;
      background:#f97316; color:#fff;
      border:1px solid rgba(255,255,255,.45);
      padding:8px 8px; text-align:center; white-space:nowrap;
      font-weight:900; text-transform:uppercase;
    }
    tbody td {
      border:1px solid rgba(255,255,255,.20);
      padding:6px 6px; text-align:center; white-space:nowrap;
      background:#020617; text-transform:uppercase;
    }
    tbody tr:nth-child(even) td { background:#061024; }

    .col-atleta { text-align:left; font-weight:900; padding-left:10px; }
    .col-valor { font-weight:900; }
    .pverde { color:#22c55e; font-weight:900; }
    .pvermelho { color:#ef4444; font-weight:900; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(2,6,23,.95); border: 1px solid rgba(255,255,255,.15);
      padding: 10px 12px; border-radius: 10px; font-size: 12px; color:#fff;
      display:none; z-index: 9999; box-shadow:0 10px 26px rgba(0,0,0,.35);
    }
    .wrap-table { overflow:auto; max-height: 70vh; border-radius:10px; }
    .chk { width:18px; height:18px; cursor:pointer; }
  </style>
</head>
<body>

<header>
  <h1>TESOURA - MENSALIDADE</h1>
  <button id="btnPdf" class="btn btn-pdf" title="Salvar em PDF">BAIXAR PDF</button>
</header>

<div class="wrap">
  <div class="painel">
    <h2>FILTRO</h2>

    <div class="row">
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="selAno">ANO:</label>
        <select id="selAno"></select>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <label for="selMes">MÊS:</label>
        <select id="selMes"></select>
      </div>

      <button id="btnConsultar" class="btn">CONSULTAR</button>
    </div>

    <div class="hint">
      Regras: valor <b>R$ 70</b> até o <b>2º domingo</b> do mês. Depois: <b>R$ 80</b>.<br/>
      A coluna <b>STATUS</b> é o <b>P</b>: fica <span class="pverde">verde</span> quando marcar pago, e fica <span class="pvermelho">vermelho</span> somente na <b>segunda-feira após o 2º domingo</b> se não pagar.<br/>
      <b>Sem botão recarregar:</b> ao editar, o app salva automaticamente.
    </div>

    <div class="status" id="status">A lista carrega automaticamente.</div>
  </div>

  <div class="painel">
    <h2>LISTA DE JOGADORES</h2>
    <div class="wrap-table" id="wrapTabela">
      <table>
        <thead>
          <tr>
            <th style="min-width:170px;text-align:left;padding-left:10px;">ATLETA</th>
            <th style="min-width:110px;">VALOR</th>
            <th style="min-width:90px;">PAGO?</th>
            <th style="min-width:160px;">DATA PAGAMENTO</th>
            <th style="min-width:90px;">STATUS</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="app/js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const selAno = document.getElementById("selAno");
  const selMes = document.getElementById("selMes");
  const btnConsultar = document.getElementById("btnConsultar");
  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const toastEl = document.getElementById("toast");
  const btnPdf = document.getElementById("btnPdf");

  const hoje = new Date();
  const anoAtual = hoje.getFullYear();
  const mesAtual = hoje.getMonth() + 1;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoFromYMD(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
  function brFromIso(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${d}/${m}/${y}`;
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display="none", 1800);
  }

  function getSecondSunday(year, month){
    // month: 1-12
    const d = new Date(year, month-1, 1);
    let sundays = 0;
    while(d.getMonth() === month-1){
      if(d.getDay() === 0){
        sundays++;
        if(sundays === 2) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }
      d.setDate(d.getDate()+1);
    }
    return null;
  }

  function mondayAfterSecondSunday(year, month){
    const second = getSecondSunday(year, month);
    if(!second) return null;
    const m = new Date(second.getFullYear(), second.getMonth(), second.getDate());
    m.setDate(m.getDate() + 1); // segunda
    m.setHours(0,0,0,0);
    return m;
  }

  function suggestedValueForMonth(year, month){
    // valor exibido no painel (70 até vencer, depois 80)
    const dueMonday = mondayAfterSecondSunday(year, month);
    if(!dueMonday) return 70;
    const now = new Date();
    return (now >= dueMonday) ? 80 : 70;
  }

  function valueByPaymentDate(year, month, isoPayDate){
    // valor real do pagamento (70 até o 2º domingo, depois 80)
    if(!isoPayDate) return null;
    const second = getSecondSunday(year, month);
    if(!second) return 70;
    const pay = new Date(isoPayDate + "T00:00:00");
    const s = new Date(second.getFullYear(), second.getMonth(), second.getDate(), 23,59,59,999);
    return (pay <= s) ? 70 : 80;
  }

  function statusP(pago, year, month){
    if(pago) return { text: "P", cls: "pverde" };

    const dueMonday = mondayAfterSecondSunday(year, month);
    if(!dueMonday) return { text:"", cls:"" };

    const now = new Date();
    if(now >= dueMonday) return { text:"P", cls:"pvermelho" };

    return { text:"", cls:"" };
  }

  function fillFiltro(){
    // ANO (igual padrão)
    for(let a = anoAtual - 1; a <= anoAtual + 1; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if(a === anoAtual) opt.selected = true;
      selAno.appendChild(opt);
    }
    // MÊS (1..12)
    const meses = [
      "01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN",
      "07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"
    ];
    meses.forEach((txt, idx)=>{
      const m = idx+1;
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = txt;
      if(m === mesAtual) opt.selected = true;
      selMes.appendChild(opt);
    });
  }

  async function load(){
    const year = Number(selAno.value);
    const month = Number(selMes.value);

    try{
      statusEl.textContent = "CARREGANDO...";
      tbody.innerHTML = "";

      // jogadores
      const { data: jogadores, error: errJog } = await sb
        .from("jogadores")
        .select("apelido")
        .order("apelido", { ascending:true });
      if(errJog){ statusEl.textContent = "ERRO AO BUSCAR JOGADORES."; return; }

      // mensalidades do mês/ano
      const { data: mens, error: errMen } = await sb
        .from("mensalidades")
        .select("apelido, ano, mes, pago, data_pagamento, valor")
        .eq("ano", year)
        .eq("mes", month);
      if(errMen){ statusEl.textContent = "ERRO AO BUSCAR MENSALIDADES."; return; }

      const mapa = {};
      (mens || []).forEach(r => { mapa[(r.apelido||"").toUpperCase()] = r; });

      const sug = suggestedValueForMonth(year, month);

      (jogadores || []).forEach(j => {
        const apelido = (j.apelido || "").toUpperCase();
        const r = mapa[apelido];

        const pago = !!(r && (r.pago === true || r.pago === 1));
        const dataPag = (r && r.data_pagamento) ? String(r.data_pagamento).slice(0,10) : "";

        // valor exibido:
        // - se pagou: usa valor do registro (se tiver) senão calcula pela data do pagamento
        // - se não pagou: mostra sugestão do mês (70/80), mas NÃO cadastra até marcar pago
        let valorExibido = sug;
        if(pago){
          if(r && r.valor != null && r.valor !== "") valorExibido = Number(r.valor);
          else valorExibido = valueByPaymentDate(year, month, dataPag) ?? sug;
        }

        const st = statusP(pago, year, month);

        const tr = document.createElement("tr");

        const tdA = document.createElement("td");
        tdA.className = "col-atleta";
        tdA.textContent = apelido;
        tr.appendChild(tdA);

        const tdV = document.createElement("td");
        tdV.className = "col-valor";
        tdV.textContent = `R$ ${Number(valorExibido).toFixed(0)}`;
        tr.appendChild(tdV);

        const tdP = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chk";
        chk.checked = pago;
        tdP.appendChild(chk);
        tr.appendChild(tdP);

        const tdD = document.createElement("td");
        const inpDate = document.createElement("input");
        inpDate.type = "date";
        inpDate.value = dataPag;
        // só libera data se pago estiver marcado
        inpDate.disabled = !chk.checked;
        tdD.appendChild(inpDate);
        tr.appendChild(tdD);

        const tdS = document.createElement("td");
        tdS.textContent = st.text;
        tdS.className = st.cls;
        tr.appendChild(tdS);

        async function salvarAutomatico(){
          const year = Number(selAno.value);
          const month = Number(selMes.value);
          const apel = apelido;

          const pagoAgora = chk.checked;
          const dtPay = inpDate.value || "";

          // Atualiza UI imediata
          inpDate.disabled = !pagoAgora;
          const stNow = statusP(pagoAgora, year, month);
          tdS.textContent = stNow.text;
          tdS.className = stNow.cls;

          // VALOR ao pagar
          let valor = null;
          if(pagoAgora){
            const v = valueByPaymentDate(year, month, dtPay) ?? suggestedValueForMonth(year, month);
            valor = v;
            tdV.textContent = `R$ ${Number(v).toFixed(0)}`;
          } else {
            // não pago: só sugestão na tela
            const v = suggestedValueForMonth(year, month);
            tdV.textContent = `R$ ${Number(v).toFixed(0)}`;
          }

          try{
            // regra: só cadastra depois de editar pagamento
            // - Se NÃO pago: remove registro do mês/ano (se existir) e não insere nada.
            // - Se PAGO: salva registro com valor e data.
            if(!pagoAgora){
              await sb.from("mensalidades").delete().eq("apelido", apel).eq("ano", year).eq("mes", month);
              toast(`SALVO: ${apel} (sem pagamento)`);
              return;
            }

            if(!dtPay){
              toast("ERRO: informe a DATA do pagamento.");
              return;
            }

            // garante 1 registro (deleta e insere)
            await sb.from("mensalidades").delete().eq("apelido", apel).eq("ano", year).eq("mes", month);

            const row = {
              apelido: apel,
              ano: year,
              mes: month,
              pago: true,
              data_pagamento: dtPay,
              valor: valor
            };

            const { error: errIns } = await sb.from("mensalidades").insert([row]);
            if(errIns){
              console.error(errIns);
              toast("ERRO ao salvar.");
              return;
            }

            toast(`SALVO: ${apel} (pago)`);
          }catch(e){
            console.error(e);
            toast("ERRO ao salvar.");
          }
        }

        chk.addEventListener("change", async () => {
          // se marcou pago e não tem data, coloca hoje automaticamente (pode editar)
          if(chk.checked && !inpDate.value){
            const now = new Date();
            inpDate.value = isoFromYMD(now.getFullYear(), now.getMonth()+1, now.getDate());
          }
          await salvarAutomatico();
        });

        inpDate.addEventListener("change", salvarAutomatico);

        tbody.appendChild(tr);
      });

      statusEl.textContent = `LISTA CARREGADA. (${pad2(month)}/${year})`;
    }catch(e){
      console.error(e);
      statusEl.textContent = "ERRO (ver Console).";
    }
  }

  // PDF
  btnPdf.addEventListener("click", () => {
    // imprime a página (usuário escolhe "Salvar em PDF")
    window.print();
  });

  // init
  fillFiltro();

  btnConsultar.addEventListener("click", load);
  window.addEventListener("load", load);
</script>

</body>
</html>
