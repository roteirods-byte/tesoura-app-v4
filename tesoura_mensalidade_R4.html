<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - MENSALIDADE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#fff; }
    header { padding:14px 18px; border-bottom:2px solid #f97316; display:flex; align-items:center; justify-content:space-between; background:#07101f; gap:12px; }
    header h1 { margin:0; font-size:16px; letter-spacing:.5px; color:#f97316; text-transform:uppercase; font-weight:900; }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .painel { background:#020617; border:1px solid #0f172a; border-radius:12px; padding:12px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .painel h2 { margin:0 0 10px; color:#f97316; font-size:14px; letter-spacing:.5px; text-transform:uppercase; font-weight:900; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-weight:900; text-transform:uppercase; font-size:12px; color:#fff; }
    select, input[type="date"] {
      border-radius:10px; border:1px solid #0f172a; padding:10px 12px;
      font-weight:900; text-transform:uppercase; font-size:12px;
      background:#0b1220; color:#fff;
    }
    select { min-width:140px; }
    .status { margin-top:8px; font-size:12px; color:#9ca3af; }
    .btn {
      border:0; border-radius:10px; padding:10px 14px; font-weight:900;
      text-transform:uppercase; cursor:pointer; font-size:12px;
      background:#0ea5e9; color:#001018;
    }
    .btn:active { transform: translateY(1px); }
    .btn-pdf { background:#f97316; color:#220b00; }
    .hint { font-size:12px; color:#cbd5e1; margin:10px 0 0; line-height:1.35; }
    .totalbox { margin-top:10px; font-size:12px; color:#e5e7eb; font-weight:900; text-transform:uppercase; }
    table { width:100%; border-collapse:collapse; margin-top:10px; background:#020617; font-size:12px; }
    thead th {
      position: sticky; top: 0; z-index: 2;
      background:#f97316; color:#fff;
      border:1px solid rgba(255,255,255,.45);
      padding:8px 8px; text-align:center; white-space:nowrap;
      font-weight:900; text-transform:uppercase;
    }
    tbody td {
      border:1px solid rgba(255,255,255,.20);
      padding:6px 6px; text-align:center; white-space:nowrap;
      background:#020617; text-transform:uppercase;
    }
    tbody tr:nth-child(even) td { background:#061024; }
    .col-atleta { text-align:left; font-weight:900; padding-left:10px; }
    .col-valor { font-weight:900; }
    .pverde { color:#22c55e; font-weight:900; }
    .pvermelho { color:#ef4444; font-weight:900; }
    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(2,6,23,.95); border: 1px solid rgba(255,255,255,.15);
      padding: 10px 12px; border-radius: 10px; font-size: 12px; color:#fff;
      display:none; z-index: 9999; box-shadow:0 10px 26px rgba(0,0,0,.35);
    }
    .wrap-table { overflow:auto; max-height: 70vh; border-radius:10px; }
    .chk { width:18px; height:18px; cursor:pointer; }
  </style>
</head>
<body>

<header>
  <h1>TESOURA - MENSALIDADE</h1>
  <button id="btnPdf" class="btn btn-pdf" title="Salvar em PDF">BAIXAR PDF</button>
</header>

<div class="wrap">
  <div class="painel">
    <h2>FILTRO</h2>

    <div class="row">
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="selAno">ANO:</label>
        <select id="selAno"></select>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <label for="selMes">MÊS:</label>
        <select id="selMes"></select>
      </div>

      <button id="btnConsultar" class="btn">CONSULTAR</button>
    </div>

    <div class="hint">
      Regras: valor <b>R$ 70</b> até o <b>2º domingo</b> do mês. Depois: <b>R$ 80</b>.<br/>
      A coluna <b>STATUS</b> é o <b>P</b>: fica <span class="pverde">verde</span> quando marcar pago, e fica <span class="pvermelho">vermelho</span> somente na <b>segunda-feira após o 2º domingo</b> se não pagar.<br/>
      Ao editar, o app salva automaticamente.
    </div>

    <div class="totalbox" id="totalPagoMes">TOTAL PAGO NO MÊS: R$ 0 (0)</div>
    <div class="status" id="status">A lista carrega automaticamente.</div>
  </div>

  <div class="painel">
    <h2>LISTA DE JOGADORES</h2>
    <div class="wrap-table" id="wrapTabela">
      <table>
        <thead>
          <tr>
            <th style="min-width:170px;text-align:left;padding-left:10px;">ATLETA</th>
            <th style="min-width:110px;">VALOR</th>
            <th style="min-width:90px;">PAGO?</th>
            <th style="min-width:160px;">DATA PAGAMENTO</th>
            <th style="min-width:90px;">STATUS</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="app/js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const selAno = document.getElementById("selAno");
  const selMes = document.getElementById("selMes");
  const btnConsultar = document.getElementById("btnConsultar");
  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const toastEl = document.getElementById("toast");
  const btnPdf = document.getElementById("btnPdf");
  const totalPagoMesEl = document.getElementById("totalPagoMes");

  const hoje = new Date();
  const anoAtual = hoje.getFullYear();
  const mesAtual = hoje.getMonth() + 1;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoToday(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display="none", 1800);
  }

  function getSecondSunday(year, month){
    const d = new Date(year, month-1, 1);
    let sundays = 0;
    while(d.getMonth() === month-1){
      if(d.getDay() === 0){
        sundays++;
        if(sundays === 2) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }
      d.setDate(d.getDate()+1);
    }
    return null;
  }

  function mondayAfterSecondSunday(year, month){
    const second = getSecondSunday(year, month);
    if(!second) return null;
    const m = new Date(second.getFullYear(), second.getMonth(), second.getDate());
    m.setDate(m.getDate() + 1);
    m.setHours(0,0,0,0);
    return m;
  }

  function suggestedValueForMonth(year, month){
    const dueMonday = mondayAfterSecondSunday(year, month);
    if(!dueMonday) return 70;
    return (new Date() >= dueMonday) ? 80 : 70;
  }

  function valueByPaymentDate(year, month, isoPayDate){
    if(!isoPayDate) return null;
    const second = getSecondSunday(year, month);
    if(!second) return 70;
    const pay = new Date(isoPayDate + "T00:00:00");
    const s = new Date(second.getFullYear(), second.getMonth(), second.getDate(), 23,59,59,999);
    return (pay <= s) ? 70 : 80;
  }

  function statusP(pago, year, month){
    if(pago) return { text: "P", cls: "pverde" };
    const dueMonday = mondayAfterSecondSunday(year, month);
    if(!dueMonday) return { text:"", cls:"" };
    return (new Date() >= dueMonday) ? { text:"P", cls:"pvermelho" } : { text:"", cls:"" };
  }

  function fillFiltro(){
    for(let a = anoAtual - 1; a <= anoAtual + 1; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      if(a === anoAtual) opt.selected = true;
      selAno.appendChild(opt);
    }
    const meses = ["01 - JAN","02 - FEV","03 - MAR","04 - ABR","05 - MAI","06 - JUN","07 - JUL","08 - AGO","09 - SET","10 - OUT","11 - NOV","12 - DEZ"];
    meses.forEach((txt, idx)=>{
      const m = idx+1;
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = txt;
      if(m === mesAtual) opt.selected = true;
      selMes.appendChild(opt);
    });
  }

  // >>> SALVAMENTO MAIS SEGURO: tenta UPDATE, se não existir tenta INSERT, sem DELETE.
  async function salvarMensalidade(apel, year, month, pago, data_pagamento, valor){
    // tenta achar 1 registro existente
    const { data: existing, error: errSel } = await sb
      .from("mensalidades")
      .select("*")
      .eq("apelido", apel)
      .eq("ano", year)
      .eq("mes", month)
      .limit(1);

    if(errSel){
      alert("ERRO ao salvar (consulta): " + (errSel.message || "sem detalhe"));
      return false;
    }

    const payload = { apelido: apel, ano: year, mes: month, pago: !!pago, data_pagamento: data_pagamento || null, valor: valor };

    if(existing && existing.length){
      const { error: errUp } = await sb
        .from("mensalidades")
        .update(payload)
        .eq("apelido", apel)
        .eq("ano", year)
        .eq("mes", month);

      if(errUp){
        alert("ERRO ao salvar (atualizar): " + (errUp.message || "sem detalhe"));
        return false;
      }
      return true;
    } else {
      const { error: errIns } = await sb
        .from("mensalidades")
        .insert([payload]);

      if(errIns){
        alert("ERRO ao salvar (inserir): " + (errIns.message || "sem detalhe"));
        return false;
      }
      return true;
    }
  }

  async function load(){
    const year = Number(selAno.value);
    const month = Number(selMes.value);

    try{
      statusEl.textContent = "CARREGANDO...";
      tbody.innerHTML = "";
      totalPagoMesEl.textContent = "TOTAL PAGO NO MÊS: R$ 0 (0)";

      const { data: jogadores, error: errJog } = await sb
        .from("jogadores")
        .select("apelido")
        .order("apelido", { ascending:true });
      if(errJog){ statusEl.textContent = "ERRO AO BUSCAR JOGADORES."; return; }

      const { data: mens, error: errMen } = await sb
        .from("mensalidades")
        .select("*")
        .eq("ano", year)
        .eq("mes", month);
      if(errMen){ statusEl.textContent = "ERRO AO BUSCAR MENSALIDADES."; return; }

      const mapa = {};
      (mens || []).forEach(r => { mapa[(r.apelido||"").toUpperCase()] = r; });

      let totalPago = 0;
      let qtdPago = 0;

      const sug = suggestedValueForMonth(year, month);

      (jogadores || []).forEach(j => {
        const apelido = (j.apelido || "").toUpperCase();
        const r = mapa[apelido];

        const pago = !!(r && (r.pago === true || r.pago === 1));
        const dataPag = (r && r.data_pagamento) ? String(r.data_pagamento).slice(0,10) : "";

        let valorExibido = sug;
        if(pago){
          if(r && r.valor != null && r.valor !== "") valorExibido = Number(r.valor);
          else valorExibido = valueByPaymentDate(year, month, dataPag) ?? sug;

          totalPago += Number(valorExibido || 0);
          qtdPago += 1;
        }

        const st = statusP(pago, year, month);

        const tr = document.createElement("tr");

        const tdA = document.createElement("td");
        tdA.className = "col-atleta";
        tdA.textContent = apelido;
        tr.appendChild(tdA);

        const tdV = document.createElement("td");
        tdV.className = "col-valor";
        tdV.textContent = `R$ ${Number(valorExibido).toFixed(0)}`;
        tr.appendChild(tdV);

        const tdP = document.createElement("td");
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chk";
        chk.checked = pago;
        tdP.appendChild(chk);
        tr.appendChild(tdP);

        const tdD = document.createElement("td");
        const inpDate = document.createElement("input");
        inpDate.type = "date";
        inpDate.value = dataPag;
        inpDate.disabled = !chk.checked;
        tdD.appendChild(inpDate);
        tr.appendChild(tdD);

        const tdS = document.createElement("td");
        tdS.textContent = st.text;
        tdS.className = st.cls;
        tr.appendChild(tdS);

        async function salvarAutomatico(){
          const year = Number(selAno.value);
          const month = Number(selMes.value);

          const pagoAgora = chk.checked;

          if(pagoAgora && !inpDate.value){
            inpDate.value = isoToday(); // coloca hoje automaticamente
          }

          inpDate.disabled = !pagoAgora;

          const stNow = statusP(pagoAgora, year, month);
          tdS.textContent = stNow.text;
          tdS.className = stNow.cls;

          // valor
          let valor = null;
          if(pagoAgora){
            const v = valueByPaymentDate(year, month, inpDate.value) ?? suggestedValueForMonth(year, month);
            valor = v;
            tdV.textContent = `R$ ${Number(v).toFixed(0)}`;
          } else {
            const v = suggestedValueForMonth(year, month);
            tdV.textContent = `R$ ${Number(v).toFixed(0)}`;
            inpDate.value = "";
          }

          // salvar
          if(!pagoAgora){
            // não cadastra nada: mantém registro "não pago" vazio (apaga NÃO, para não depender de policy de delete)
            // Só salva quando marcar pago.
            toast("OK (não pago).");
            return;
          }

          const ok = await salvarMensalidade(apelido, year, month, true, inpDate.value, valor);
          if(ok){
            toast(`SALVO: ${apelido}`);
            // recarrega totais (rápido)
            load();
          }
        }

        chk.addEventListener("change", salvarAutomatico);
        inpDate.addEventListener("change", salvarAutomatico);

        tbody.appendChild(tr);
      });

      totalPagoMesEl.textContent = `TOTAL PAGO NO MÊS: R$ ${Number(totalPago).toFixed(0)} (${qtdPago})`;
      statusEl.textContent = `LISTA CARREGADA. (${pad2(month)}/${year})`;
    }catch(e){
      console.error(e);
      statusEl.textContent = "ERRO (ver Console).";
    }
  }

  btnPdf.addEventListener("click", () => window.print());

  fillFiltro();
  btnConsultar.addEventListener("click", load);
  window.addEventListener("load", load);
</script>

</body>
</html>
